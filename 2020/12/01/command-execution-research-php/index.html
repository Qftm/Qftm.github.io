<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="命令执行底层原理探究-PHP, Qftm">
    <meta name="description" content="Maybe a hacker">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>命令执行底层原理探究-PHP | Qftm</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Qftm</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-heartbeat" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Qftm</div>
        <div class="logo-desc">
            
            Maybe a hacker
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-heartbeat"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/banner/bg.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">命令执行底层原理探究-PHP</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/PHP/">
                                <span class="chip bg-color">PHP</span>
                            </a>
                        
                            <a href="/tags/%E5%86%85%E6%A0%B8/">
                                <span class="chip bg-color">内核</span>
                            </a>
                        
                            <a href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">
                                <span class="chip bg-color">命令执行</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/PHP%E5%AE%89%E5%85%A8/" class="post-category">
                                PHP安全
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2020-12-01
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2022-06-08
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    26k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    125 Min
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="命令执行底层原理探究-PHP"><a href="#命令执行底层原理探究-PHP" class="headerlink" title="命令执行底层原理探究-PHP"></a>命令执行底层原理探究-PHP</h1><h2 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h2><pre><code>Author：Qftm
Data：2020/12/01
Blog：https://qftm.github.io</code></pre><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>针对不同平台/语言下的命令执行是不相同的，存在很大的差异性。因此，这里对不同平台/语言下的命令执行函数进行深入的探究分析。</p>
<p>文章开头会对不同平台(Linux、Windows)下：终端的指令执行、语言(PHP、Java、Python)的命令执行进行介绍分析。后面，主要以PHP语言为对象，针对不同平台，对命令执行函数进行底层深入分析，这个过程包括：环境准备、PHP内核源码的编译、运行、调试、审计等，其它语言分析原理思路类似。</p>
<h1 id="平台语言"><a href="#平台语言" class="headerlink" title="平台语言"></a>平台语言</h1><h2 id="不同平台终端指令执行"><a href="#不同平台终端指令执行" class="headerlink" title="不同平台终端指令执行"></a>不同平台终端指令执行</h2><p>不同平台终端中执行的命令方式一般有两种：自身终端封装的指令(内置)、终端下调用其它目录下的可执行程序(外部)。</p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Linux下终端一般为<code>/bin/bash</code>、<code>/bin/sh</code>、<code>/bin/zsh</code>等，这里以<code>bash</code>终端为例测试。</p>
<p>以Linux为例【Windows等平台原理同Linux类似】，Linux下终端内建(内置)的指令类型为：<code>shell built-in command</code>。</p>
<p>所谓<code>shell built-in command</code>，就是那些内建在<code>linux shell</code>里面的<code>command</code>指令。</p>
<p>通常情况下，在<code>linux shell</code>下面执行一个<code>command</code>指令，shell会查找<code>command</code>是否为<code>built-in command</code>类型，对于<code>built-in command</code>指令类型，shell会自己解释执行，而无需fork一个<code>child process</code>子进程来执行该<code>command</code>指令；对于，不是<code>built-in command</code>指令类型，shell会从环境变量中按顺序搜索该<code>command</code>指令，如果能查到则会fork一个<code>child process</code>子进程来执行该<code>command</code>指令；然而，对于找不到的<code>command</code>指令，一般为：执行的指令不存在、指令未加入到环境变量中。</p>
<p>那么如何进行终端内建指令的判断与查看呢，对于内建指令可以使用<code>type</code>指令去判断</p>
<pre class="line-numbers language-bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># type echo  </span>
<span class="token keyword">echo</span> is a shell <span class="token function">builtin</span>
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># type whoami</span>
<span class="token function">whoami</span> is /usr/bin/whoami
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或着也可以使用其它指令进行查找判断：<code>which、where</code></p>
<pre class="line-numbers language-bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># which echo</span>
echo: shell built-in <span class="token function">command</span>
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># which whoami</span>
/usr/bin/whoami
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># </span>


┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># where echo  </span>
echo: shell built-in <span class="token function">command</span>
 <span class="token keyword">echo</span>
/bin/echo
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># where whoami</span>
/usr/bin/whoami
/bin/whoami
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：在Linux平台，有些命令虽然为内建命令，但是系统关键目录也存在其可执行文件。</p>
<p>这里也可以使用<code>enable</code>或<code>help</code>指令，查看终端内建的所有指令</p>
<ul>
<li>第一种：<code>enable</code>指令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># enable</span>
-
<span class="token keyword">.</span>
<span class="token keyword">:</span>
<span class="token punctuation">[</span>
<span class="token function">alias</span>
autoload
<span class="token function">bg</span>
bindkey
<span class="token keyword">break</span>
<span class="token function">builtin</span>
bye
<span class="token function">cd</span>
chdir
<span class="token function">command</span>
compadd
comparguments
compcall
compctl
compdescribe
compfiles
compgroups
compquote
compset
comptags
comptry
compvalues
<span class="token keyword">continue</span>
<span class="token keyword">declare</span>
<span class="token function">dirs</span>
disable
disown
<span class="token keyword">echo</span>
echotc
echoti
emulate
<span class="token function">enable</span>
<span class="token function">eval</span>
<span class="token function">exec</span>
<span class="token keyword">exit</span>
<span class="token function">export</span>
<span class="token boolean">false</span>
fc
<span class="token function">fg</span>
float
functions
getln
<span class="token function">getopts</span>
<span class="token function">hash</span>
<span class="token function">history</span>
integer
<span class="token function">jobs</span>
<span class="token function">kill</span>
<span class="token keyword">let</span>
limit
local
log
<span class="token function">logout</span>
noglob
<span class="token function">popd</span>
print
<span class="token function">printf</span>
private
<span class="token function">pushd</span>
pushln
<span class="token function">pwd</span>
r
<span class="token function">read</span>
<span class="token function">readonly</span>
rehash
<span class="token keyword">return</span>
sched
<span class="token keyword">set</span>
setopt
<span class="token function">shift</span>
<span class="token function">source</span>
<span class="token function">suspend</span>
<span class="token function">test</span>
<span class="token function">times</span>
<span class="token function">trap</span>
<span class="token boolean">true</span>
ttyctl
<span class="token function">type</span>
typeset
<span class="token function">ulimit</span>
<span class="token function">umask</span>
<span class="token function">unalias</span>
unfunction
unhash
unlimit
unset
unsetopt
vared
<span class="token function">wait</span>
whence
where
<span class="token function">which</span>
zcompile
zformat
zle
zmodload
zparseopts
zregexparse
zstat
zstyle
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>第二种：<code>help</code>指令</li>
</ul>
<p><img src="/2020/12/01/command-execution-research-php/image-20201219220936879.png" alt="image-20201219220936879"></p>
<p>接着对终端（内置|外置）命令进行测试，测试终端<code>/bin/zsh</code>：</p>
<ul>
<li>测试：<code>whoami</code>指令</li>
</ul>
<p>先对<code>whoami</code>指令进行类型探测与指令定位查询</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 指令探测：非内置指令</span>
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># type whoami       </span>
<span class="token function">whoami</span> is /usr/bin/whoami

┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true">#</span>


<span class="token comment" spellcheck="true"># 指令定位查询：搜索发现系统特殊目录存在`whoami`可执行程序</span>
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># where whoami</span>
/usr/bin/whoami
/bin/whoami                                 
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：<code>/bin</code>目录为<code>/usr/bin</code>目录的链接</p>
<p>然后，在<code>zsh</code>终端写入<code>For循环</code>执行<code>whoami</code>指令查看是否为内部执行或外部调用</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token punctuation">{</span>0<span class="token punctuation">..</span>10000000<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">whoami</span> <span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>另一侧，使用<code>htop</code>动态进程监控程序对该终端进行监控，可发现<code>whoami</code>指令并非<code>zsh</code>终端内置封装的指令</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201203212952070.png" alt="image-20201203212952070"></p>
<ul>
<li>测试：<code>echo</code>指令</li>
</ul>
<p>同样，对<code>echo</code>指令进行类型探测与指令定位查询</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 指令探测：内置指令</span>
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># type echo     </span>
<span class="token keyword">echo</span> is a shell <span class="token function">builtin</span>

┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true">#</span>


<span class="token comment" spellcheck="true"># 指令定位查询：搜索发现系统特殊目录存在`echo`可执行程序，同时还发现存在`echo: shell built-in command`【终端内置指令】</span>
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># where echo   </span>
echo: shell built-in <span class="token function">command</span>
/usr/bin/echo
/bin/echo                          
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，在<code>zsh</code>终端写入<code>For循环</code>执行<code>echo</code>指令查看是否为内部执行或外部调用</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token punctuation">{</span>0<span class="token punctuation">..</span>10000000<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token keyword">echo</span> 1 <span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>另一侧，使用<code>htop</code>动态进程监控程序对该终端进行监控，可以发现<code>echo</code>指令为<code>zsh</code>终端内置封装的指令，并未出现外部调用</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201203213627739.png" alt="image-20201203213627739"></p>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows下终端一般为<code>cmd.exe</code>、<code>powershell.exe</code>等，这里以<code>cmd</code>来测试。终端指令执行原理同上述Linux讲解原理相同，分为终端内置指令与外部调用指令。</p>
<p>那么，针对Windows平台可执行终端，如何进行终端内建指令的判断与查看呢。可惜Windows平台终端不像Linux终端存在相应的<code>type</code>指令进行判断与<code>enable</code>、<code>help</code>指令查看所有内建指令。不过在Windows终端里可以借助<code>where</code>或<code>set PATH</code>指令进行指令判断。</p>
<ul>
<li>第一种：<code>where</code>指令【不太友好】</li>
</ul>
<p>从系统环境变量<code>PATH</code>里面定位查询（注意人为增添的环境变量的影响），如果能查到一般来说可以判定为外部调用指令（排除非系统特殊目录），否则为内部调用指令（排除不存在指令）</p>
<pre class="line-numbers language-cmd"><code class="language-cmd"># 外部调用指令
C:\Users\Qftm>where whoami
C:\Windows\System32\whoami.exe
C:\Users\Qftm>

# 内部调用指令
C:\Users\Qftm>where cd
INFO: Could not find files for the given pattern(s).
C:\Users\Qftm>

# 不存在指令
C:\Users\Qftm>where qftm
INFO: Could not find files for the given pattern(s).
C:\Users\Qftm>

# 内部调用指令（排除人为增添的环境变量的影响）（排除非系统特殊目录）
C:\Users\Qftm>where echo
D:\QSoftware\W3Server\phpstudy2019\Extensions\MySQL5.7.26\bin\echo.exe
C:\Users\Qftm><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>第二种：<code>set path</code>指令【友好】</li>
</ul>
<p>将系统环境变量临时设置为<code>null</code>，然后对指令进行帮助查询，如果能查到则判定为内置指令，否则为外部调用。</p>
<pre class="line-numbers language-cmd"><code class="language-cmd"># path置空
C:\Users\Qftm>set path=
C:\Users\Qftm>path
PATH=(null)
C:\Users\Qftm>

# 内部调用指令
C:\Users\Qftm>cd /?
Displays the name of or changes the current directory.

CHDIR [/D] [drive:][path]
CHDIR [..]
CD [/D] [drive:][path]
CD [..]

  ..   Specifies that you want to change to the parent directory.

Type CD drive: to display the current directory in the specified drive.
Type CD without parameters to display the current drive and directory.

Use the /D switch to change current drive in addition to changing current
directory for a drive.

If Command Extensions are enabled CHDIR changes as follows:

The current directory string is converted to use the same case as
the on disk names.  So CD C:\TEMP would actually set the current
directory to C:\Temp if that is the case on disk.

CHDIR command does not treat spaces as delimiters, so it is possible to
CD into a subdirectory name that contains a space without surrounding
the name with quotes.  For example:

    cd \winnt\profiles\username\programs\start menu

is the same as:

    cd "\winnt\profiles\username\programs\start menu"

which is what you would have to type if extensions were disabled.
C:\Users\Qftm>

# 外部调用指令
C:\Users\Qftm>whoami /?
'whoami' is not recognized as an internal or external command,
operable program or batch file.
C:\Users\Qftm>

# 不存在指令
C:\Users\Qftm>qftm /?
'qftm' is not recognized as an internal or external command,
operable program or batch file.
C:\Users\Qftm><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：Windows下终端<code>help</code>指令并不能够查询终端内建指令：首先<code>help</code>指令为外部调用指令，然后<code>help</code>指令查询出的所有指令=(内建指令+外部指令)</p>
<pre class="line-numbers language-cmd"><code class="language-cmd"># help：属于外部指令
C:\Users\Qftm>where help
C:\Windows\System32\help.exe
C:\Users\Qftm>

# help：内建指令+外部指令（不同于Linux下bash等终端）
C:\Users\Qftm>help
For more information on a specific command, type HELP command-name
ASSOC          Displays or modifies file extension associations.
ATTRIB         Displays or changes file attributes.
BREAK          Sets or clears extended CTRL+C checking.
BCDEDIT        Sets properties in boot database to control boot loading.
CACLS          Displays or modifies access control lists (ACLs) of files.
CALL           Calls one batch program from another.
CD             Displays the name of or changes the current directory.
CHCP           Displays or sets the active code page number.
CHDIR          Displays the name of or changes the current directory.
CHKDSK         Checks a disk and displays a status report.
CHKNTFS        Displays or modifies the checking of disk at boot time.
CLS            Clears the screen.
CMD            Starts a new instance of the Windows command interpreter.
COLOR          Sets the default console foreground and background colors.
COMP           Compares the contents of two files or sets of files.
COMPACT        Displays or alters the compression of files on NTFS partitions.
CONVERT        Converts FAT volumes to NTFS.  You cannot convert the
               current drive.
COPY           Copies one or more files to another location.
DATE           Displays or sets the date.
DEL            Deletes one or more files.
DIR            Displays a list of files and subdirectories in a directory.
DISKPART       Displays or configures Disk Partition properties.
DOSKEY         Edits command lines, recalls Windows commands, and
               creates macros.
DRIVERQUERY    Displays current device driver status and properties.
ECHO           Displays messages, or turns command echoing on or off.
ENDLOCAL       Ends localization of environment changes in a batch file.
ERASE          Deletes one or more files.
EXIT           Quits the CMD.EXE program (command interpreter).
FC             Compares two files or sets of files, and displays the
               differences between them.
FIND           Searches for a text string in a file or files.
FINDSTR        Searches for strings in files.
FOR            Runs a specified command for each file in a set of files.
FORMAT         Formats a disk for use with Windows.
FSUTIL         Displays or configures the file system properties.
FTYPE          Displays or modifies file types used in file extension
               associations.
GOTO           Directs the Windows command interpreter to a labeled line in
               a batch program.
GPRESULT       Displays Group Policy information for machine or user.
GRAFTABL       Enables Windows to display an extended character set in
               graphics mode.
HELP           Provides Help information for Windows commands.
ICACLS         Display, modify, backup, or restore ACLs for files and
               directories.
IF             Performs conditional processing in batch programs.
LABEL          Creates, changes, or deletes the volume label of a disk.
MD             Creates a directory.
MKDIR          Creates a directory.
MKLINK         Creates Symbolic Links and Hard Links
MODE           Configures a system device.
MORE           Displays output one screen at a time.
MOVE           Moves one or more files from one directory to another
               directory.
OPENFILES      Displays files opened by remote users for a file share.
PATH           Displays or sets a search path for executable files.
PAUSE          Suspends processing of a batch file and displays a message.
POPD           Restores the previous value of the current directory saved by
               PUSHD.
PRINT          Prints a text file.
PROMPT         Changes the Windows command prompt.
PUSHD          Saves the current directory then changes it.
RD             Removes a directory.
RECOVER        Recovers readable information from a bad or defective disk.
REM            Records comments (remarks) in batch files or CONFIG.SYS.
REN            Renames a file or files.
RENAME         Renames a file or files.
REPLACE        Replaces files.
RMDIR          Removes a directory.
ROBOCOPY       Advanced utility to copy files and directory trees
SET            Displays, sets, or removes Windows environment variables.
SETLOCAL       Begins localization of environment changes in a batch file.
SC             Displays or configures services (background processes).
SCHTASKS       Schedules commands and programs to run on a computer.
SHIFT          Shifts the position of replaceable parameters in batch files.
SHUTDOWN       Allows proper local or remote shutdown of machine.
SORT           Sorts input.
START          Starts a separate window to run a specified program or command.
SUBST          Associates a path with a drive letter.
SYSTEMINFO     Displays machine specific properties and configuration.
TASKLIST       Displays all currently running tasks including services.
TASKKILL       Kill or stop a running process or application.
TIME           Displays or sets the system time.
TITLE          Sets the window title for a CMD.EXE session.
TREE           Graphically displays the directory structure of a drive or
               path.
TYPE           Displays the contents of a text file.
VER            Displays the Windows version.
VERIFY         Tells Windows whether to verify that your files are written
               correctly to a disk.
VOL            Displays a disk volume label and serial number.
XCOPY          Copies files and directory trees.
WMIC           Displays WMI information inside interactive command shell.

For more information on tools see the command-line reference in the online help.

C:\Users\Qftm><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着对终端（内置|外置）命令进行测试，测试终端<code>cmd.exe</code>：</p>
<ul>
<li>测试：<code>whoami</code>指令</li>
</ul>
<p>先对<code>whoami</code>指令进行类型探测与指令定位查询</p>
<pre class="line-numbers language-cmd"><code class="language-cmd"># 类型探测：外部调用指令
# 定位查询：系统可执行程序
C:\Users\Qftm>where whoami
C:\Windows\System32\whoami.exe
C:\Users\Qftm><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，在<code>cmd</code>终端写入<code>For</code>循环执行<code>whoami</code>指令查看是否为内部执行或外部调用</p>
<pre class="line-numbers language-cmd"><code class="language-cmd">C:\Users\Qftm>for /l %i in (1,1,1000000) do whoami<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>另一侧，打开任务管理进行<code>cmd</code>终端的监控，可发现<code>whoami</code>指令并非<code>cmd.exe</code>终端内置封装的指令</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201203205913814.png" alt="image-20201203205913814"></p>
<ul>
<li>测试：<code>echo</code>指令</li>
</ul>
<p>同样，对<code>echo</code>指令进行类型探测与指令定位查询</p>
<pre class="line-numbers language-cmd"><code class="language-cmd"># 类型探测：内部调用指令
# 定位查询：非系统可执行程序
C:\Users\Qftm>where echo
D:\QSoftware\W3Server\phpstudy2019\Extensions\MySQL5.7.26\bin\echo.exe
C:\Users\Qftm><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，在<code>cmd</code>终端写入<code>For</code>循环执行<code>echo</code>指令查看是否为内部执行或外部调用</p>
<pre class="line-numbers language-cmd"><code class="language-cmd">for /l %i in (1,1,1000000) do echo 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>另一侧，打开任务管理进行<code>cmd</code>终端的监控，可以发现<code>echo</code>指令为终端内置封装的指令，并未出现外部调用</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201203210747535.png" alt="image-20201203210747535"></p>
<h2 id="语言差异"><a href="#语言差异" class="headerlink" title="语言差异"></a>语言差异</h2><p>针对命令执行函数，底层实现上是否存在命令执行程序 <code>cmd.exe</code>、<code>/bin/sh</code>、<code>/bin/bash</code> 等，去执行命令执行函数传入的参数【系统命令】。这个过程相当于底层是否引入第三方可执行终端去执行相应命令。</p>
<p>比如：<code>可执行函数(系统命令)</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">CommandExecFunc</span><span class="token punctuation">(</span>echo <span class="token number">111</span> <span class="token operator">></span> shell<span class="token punctuation">.</span>txt<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//echo是一个可执行程序</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上述命令执行函数模型在【Linux平台/windows平台】不同语言下面执行效果不同。</p>
<h3 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h3><pre class="line-numbers language-txt"><code class="language-txt">PHP - 底层调用系统终端，执行命令     Mode => Window：cmd.exe /c Command || Linux：sh -c Command<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在<code>PHP</code>语言里面，针对Linux平台，系统命令<code>echo 111 &gt; shell.txt</code>传入<code>CommandExecFunc</code>函数，最终在底层相当于执行<code>/bin/sh -c echo 111 &gt; shell.txt</code>。成功创建文件<code>shell.txt</code>【执行过程相当于：在<code>/bin/sh</code>终端下执行命令<code>echo 111</code>，并将echo结果通过重定向符写入文件<code>shell.txt</code>中。这里的重定向符不是echo中的参数或字符串，而是在<code>/bin/sh</code>下面起特殊作用。这里的echo并不是可执行程序<code>/bin/echo</code>，而是<code>/bin/sh</code>执行终端中的内建命令】【进程相关：一个进程<code>/bin/sh</code>，在<code>/bin/sh</code>进程中执行系统命令，而不是执行系统程序】</p>
<ul>
<li>跟踪一下程序执行流程：<code>For Linux</code></li>
</ul>
<p>利用<code>strace</code>程序执行监视可知，底层通过<code>execve</code>系统调用来启动相关进程、然后通过<code>/bin/sh</code>进程来执行相关指令（此处<code>echo</code>为<code>sh</code>内置指令）。</p>
<pre class="line-numbers language-bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面/CodeDebug/php<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># strace -f -e execve php -r "system('echo 111 > shell.txt');"</span>
execve<span class="token punctuation">(</span><span class="token string">"/usr/bin/php"</span>, <span class="token punctuation">[</span><span class="token string">"php"</span>, <span class="token string">"-r"</span>, <span class="token string">"system('echo 111 > shell.txt');"</span><span class="token punctuation">]</span>, 0x7ffd51277198 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> 0
strace: Process 3436 attached
<span class="token punctuation">[</span>pid  3436<span class="token punctuation">]</span> execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, <span class="token punctuation">[</span><span class="token string">"sh"</span>, <span class="token string">"-c"</span>, <span class="token string">"echo 111 > shell.txt"</span><span class="token punctuation">]</span>, 0x562c96ef1eb0 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> 0
<span class="token punctuation">[</span>pid  3436<span class="token punctuation">]</span> +++ exited with 0 +++
--- SIGCHLD <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGCHLD, si_code<span class="token operator">=</span>CLD_EXITED, si_pid<span class="token operator">=</span>3436, si_uid<span class="token operator">=</span>0, si_status<span class="token operator">=</span>0, si_utime<span class="token operator">=</span>0, si_stime<span class="token operator">=</span>0<span class="token punctuation">}</span> ---
+++ exited with 0 +++

┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面/CodeDebug/php<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># ls</span>
shell.txt

┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面/CodeDebug/php<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理，针对Windows平台：系统命令<code>echo 111 &gt; shell.txt</code>传入<code>CommandExecFunc</code>函数，最终在底层相当于执行<code>cmd.exe /c echo 111 &gt; shell.txt</code>。成功创建文件<code>shell.txt</code>【执行过程相当于：在<code>cmd</code>终端下执行命令<code>echo 111</code>，并将echo结果通过重定向符写入文件<code>shell.txt</code>中。【进程相关：一个进程<code>cmd.exe</code>，在<code>cmd.exe</code>进程中执行系统命令，而不是执行系统程序】</p>
<ul>
<li>跟踪一下程序执行流程：<code>For Windows</code></li>
</ul>
<p>使用OD动态调试，加载<code>php.exe</code>程序，对相关创建进程的系统API下断点（如果不知道是那个<code>CreateProcess API</code>可以把查询到的都进行断点即可）</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201221222850162.png" alt="image-20201221222850162"></p>
<p>断点之后，F9使程序运行至用户交互处，然后输入PHP执行指令<code>system(&#39;echo 111 &gt; shell.txt&#39;);</code></p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201222013620743.png" alt="image-20201222013620743"></p>
<p>运行PHP执行指令后，程序可到断点处，然后通过调用栈可知：底层通过<code>CreateProcessW</code>系统API调用来启动相关进程、然后通过<code>cmd</code>进程来执行相关指令（此处<code>echo</code>为<code>cmd</code>内置指令）（注意：这里也可查看到PHP程序的完整调用链）</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201221233232148.png" alt="image-20201221233232148"></p>
<ul>
<li>进程信息跟踪执行：<code>For Windows</code></li>
</ul>
<p>利用微软官方提供的<code>Process Explorer</code>工具进行跟踪分析：发现底层调用<code>cmd.exe /c xxx</code>来执行</p>
<p><img src="/2020/12/01/command-execution-research-php/BWSWXW1GO103UI.png" alt="img"></p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><pre class="line-numbers language-txt"><code class="language-txt">Java - 底层不调用系统终端，自己启动传入的可执行程序    Mode => Window：Command || Linux：Command<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>但是在<code>Java</code>语言里面，针对Linux平台，系统命令<code>echo 111 &gt; shell.txt</code>传入<code>CommandExecFunc</code>函数，最终在底层相当于执行<code>/bin/echo 111 &gt; shell.txt</code>成功打印一个字符串<code>&quot;111 &gt; shell.txt&quot;</code>并没有创建文件<code>shell.txt</code>。【执行过程相当于：运行可执行程序<code>/bin/echo</code>并传入参数<code>111 &gt; shell.txt</code>进行打印输出，这里的特殊字符<code>&gt;</code>被当作普通字符串被echo程序打印。这里的<code>echo</code>作为可执行程序出现，而不是终端中的命令】【进程相关：一个进程<code>/bin/echo</code>，在<code>/bin/echo</code>进程中传入字符串参数<code>111 &gt; shell.txt</code>进行打印输出】【有关可执行程序怎么查询：从环境变量中进行查询】</p>
<p>测试代码如下</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOUtils<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Runtime<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommandExec1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>

            String str <span class="token operator">=</span> IOUtils<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"whoami"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span>Exception a<span class="token punctuation">)</span><span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>跟踪一下程序执行流程：<code>For Linux</code></li>
</ul>
<p>程序执行监视情况：从系统环境变量中查找输入的指令可执行程序位置，然后由<code>execve</code>系统调用来启动相关程序进程（并未涉及系统终端调用）。</p>
<pre class="line-numbers language-bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面/CodeDebug/java<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># strace -f -e execve java CommandExec1                       </span>
execve<span class="token punctuation">(</span><span class="token string">"/usr/bin/java"</span>, <span class="token punctuation">[</span><span class="token string">"java"</span>, <span class="token string">"CommandExec1"</span><span class="token punctuation">]</span>, 0x7ffdb259ee90 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> 0
strace: Process 3923 attached
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings<span class="token operator">=</span>on -Dswing.aatext<span class="token operator">=</span>true
<span class="token punctuation">[</span>pid  3923<span class="token punctuation">]</span> --- SIGSEGV <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGSEGV, si_code<span class="token operator">=</span>SEGV_MAPERR, si_addr<span class="token operator">=</span>NULL<span class="token punctuation">}</span> ---
strace: Process 3924 attached
strace: Process 3925 attached
strace: Process 3926 attached
strace: Process 3927 attached
strace: Process 3928 attached
strace: Process 3929 attached
strace: Process 3930 attached
strace: Process 3931 attached
strace: Process 3932 attached
<span class="token punctuation">[</span>pid  3932<span class="token punctuation">]</span> execve<span class="token punctuation">(</span><span class="token string">"/mnt/hgfs/QSec/Pentest/Red-Team/\347\245\236\345\205\265\345\210\251\345\231\250/Windows/VSCode/VSCode-linux-x64/whoami"</span>, <span class="token punctuation">[</span><span class="token string">"whoami"</span><span class="token punctuation">]</span>, 0x7ffd28368b80 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> -1 ENOENT <span class="token punctuation">(</span>没有那个文件或目录<span class="token punctuation">)</span>
<span class="token punctuation">[</span>pid  3932<span class="token punctuation">]</span> execve<span class="token punctuation">(</span><span class="token string">"/usr/local/sbin/whoami"</span>, <span class="token punctuation">[</span><span class="token string">"whoami"</span><span class="token punctuation">]</span>, 0x7ffd28368b80 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> -1 ENOENT <span class="token punctuation">(</span>没有那个文件或目录<span class="token punctuation">)</span>
<span class="token punctuation">[</span>pid  3932<span class="token punctuation">]</span> execve<span class="token punctuation">(</span><span class="token string">"/usr/local/bin/whoami"</span>, <span class="token punctuation">[</span><span class="token string">"whoami"</span><span class="token punctuation">]</span>, 0x7ffd28368b80 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> -1 ENOENT <span class="token punctuation">(</span>没有那个文件或目录<span class="token punctuation">)</span>
<span class="token punctuation">[</span>pid  3932<span class="token punctuation">]</span> execve<span class="token punctuation">(</span><span class="token string">"/usr/sbin/whoami"</span>, <span class="token punctuation">[</span><span class="token string">"whoami"</span><span class="token punctuation">]</span>, 0x7ffd28368b80 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> -1 ENOENT <span class="token punctuation">(</span>没有那个文件或目录<span class="token punctuation">)</span>
<span class="token punctuation">[</span>pid  3932<span class="token punctuation">]</span> execve<span class="token punctuation">(</span><span class="token string">"/usr/bin/whoami"</span>, <span class="token punctuation">[</span><span class="token string">"whoami"</span><span class="token punctuation">]</span>, 0x7ffd28368b80 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> 0
<span class="token punctuation">[</span>pid  3932<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3923<span class="token punctuation">]</span> --- SIGCHLD <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGCHLD, si_code<span class="token operator">=</span>CLD_EXITED, si_pid<span class="token operator">=</span>3932, si_uid<span class="token operator">=</span>0, si_status<span class="token operator">=</span>0, si_utime<span class="token operator">=</span>0, si_stime<span class="token operator">=</span>0<span class="token punctuation">}</span> ---
strace: Process 3933 attached
root

<span class="token punctuation">[</span>pid  3931<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3927<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3924<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3923<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3933<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3930<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3929<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3928<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3926<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid  3925<span class="token punctuation">]</span> +++ exited with 0 +++
+++ exited with 0 +++

┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面/CodeDebug/java<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理，针对Windows平台，系统命令<code>echo 111 &gt; shell.txt</code>传入<code>CommandExecFunc</code>函数，最终在底层相当于执行<code>系统环境变量/echo.exe 111 &gt; shell.txt</code>成功打印一个字符串<code>&quot;111 &gt; shell.txt&quot;</code>并没有创建文件<code>shell.txt</code>。</p>
<p>但是，正常情况下，这里执行上述指令会报错，因为Windows平台，默认情况下系统环境变量中不存在<code>echo.exe</code>可执行程序，导致指令无法正常执行</p>
<pre class="line-numbers language-cmd"><code class="language-cmd"># 无法定位echo可执行程序
D:\QSec\Code-Audit\Tools\Java\Kits\RCE>where echo
INFO: Could not find files for the given pattern(s).

D:\QSec\Code-Audit\Tools\Java\Kits\RCE>where whoami
C:\Windows\System32\whoami.exe

D:\QSec\Code-Audit\Tools\Java\Kits\RCE>

# 执行报错
D:\QSec\Code-Audit\Tools\Java\Kits\RCE>javac RuntimeRCE.java

D:\QSec\Code-Audit\Tools\Java\Kits\RCE>java RuntimeRCE
java.io.IOException: Cannot run program "echo": CreateProcess error=2, The system cannot find the file specified

D:\QSec\Code-Audit\Tools\Java\Kits\RCE><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>进程信息跟踪执行：<code>For Windows</code></li>
</ul>
<p>进程分析可知底层直接创建了<code>notepad.exe</code>进程</p>
<p><img src="/2020/12/01/command-execution-research-php/BWSWXW1GO103UI7.png" alt="img"></p>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><pre class="line-numbers language-txt"><code class="language-txt">Python - 底层调用系统终端，执行命令     Mode => Window：cmd.exe /c Command || Linux：sh -c Command<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>而<code>Python</code>语言，命令执行函数底层原理实现同<code>PHP</code>语言。</p>
<p>总结起来，也就是，命令执行函数执行分为两类，一类：传入的命令仅仅作为可执行终端中的命令执行；另一类：传入的命令仅仅是运行传入的命令中的可执行程序。对象不同，一类：是底层语言系统终端帮我们执行传入的命令；另一类：是自己启动传入的可执行程序。</p>
<h1 id="PHP-for-Windows"><a href="#PHP-for-Windows" class="headerlink" title="PHP for Windows"></a>PHP for Windows</h1><p>针对Windows平台下：PHP命令执行函数的底层分析。</p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>环境部署情况：</p>
<ul>
<li>Windows (Win10 Pro)</li>
<li>Visual Studio (Visual Studio Professional 2019)</li>
<li>Visual Studio Code (VSCode-win32-x64-1.51.1)</li>
<li>PHP Source Code (PHP 7.2.9)</li>
<li>PHP Windows SDK (php-sdk-binary-tools-php-sdk-2.2.0)</li>
<li>Source Insight (Source Insight 4.0)</li>
</ul>
<p><a href="https://wiki.php.net/internals/windows/stepbystepbuild_sdk_2" target="_blank" rel="noopener">php官方wiki</a>对不同php版本编译的需求如下：</p>
<ul>
<li>Visual C++ 14.0 (Visual Studio 2015) for <strong>PHP 7.0</strong> or <strong>PHP 7.1</strong>.</li>
<li>Visual C++ 15.0 (Visual Studio 2017) for <strong>PHP 7.2</strong>, <strong>PHP 7.3</strong> or <strong>PHP 7.4</strong>.</li>
<li>Visual C++ 16.0 (Visual Studio 2019) for <strong>master</strong>.</li>
</ul>
<p>虽然官方wiki指出不同VS编译不同PHP版本，但是这里使用VS2019去编译<code>PHP 7.2.9</code>是没有问题的（兼容性）。</p>
<h3 id="Visual-Studio"><a href="#Visual-Studio" class="headerlink" title="Visual Studio"></a>Visual Studio</h3><blockquote>
<p>Visual Studio 面向任何开发者的同类最佳工具，功能完备的 IDE，可用于编码、调试、测试和部署到任何平台。</p>
</blockquote>
<p><code>Visual Studio</code> 官网：介绍、下载</p>
<pre><code># 下载官网最新版 VS2019

https://visualstudio.microsoft.com/zh-hans/</code></pre><p><code>Visual Studio</code> 历史版本下载（这里无论是下载的社区版或企业版等，下载器都是一样的，在社区版下载器里面也可选择安装专业版、企业版）</p>
<pre><code>https://visualstudio.microsoft.com/zh-hans/vs/older-downloads/
or
https://my.visualstudio.com/Downloads?q=Visual%20Studio</code></pre><p>这里下载<code>Visual Studio Professional 2019</code>主要的作用为：提供开发环境，编译PHP内核。</p>
<p><code>Visual Studio Professional 2019</code> 安装情况：仅安装在 Visual Studio 中进行开发所需的工具和组件捆绑包。</p>
<p><img src="/2020/12/01/command-execution-research-php/vs2019.jpg" alt="vs2019"></p>
<h3 id="Visual-Studio-Code"><a href="#Visual-Studio-Code" class="headerlink" title="Visual Studio Code"></a>Visual Studio Code</h3><p><code>Visual Studio Code</code> 常用于不同语言的项目开发、源代码编辑调试等工作。</p>
<ul>
<li>官网：介绍、下载</li>
</ul>
<pre><code>https://code.visualstudio.com/</code></pre><ul>
<li>添加相应扩展：c/c++扩展、代码辅助运行扩展</li>
</ul>
<pre><code>C/C++
Code Runner</code></pre><h3 id="PHP-Source-Code"><a href="#PHP-Source-Code" class="headerlink" title="PHP Source Code"></a>PHP Source Code</h3><ul>
<li>PHP官方各个版本源代码下载</li>
</ul>
<pre><code>https://www.php.net/releases/
or
https://github.com/php/php-src/releases</code></pre><p>这里下载的版本为：<code>PHP 7.2.9</code></p>
<h3 id="PHP-Windows-SDK"><a href="#PHP-Windows-SDK" class="headerlink" title="PHP Windows SDK"></a>PHP Windows SDK</h3><blockquote>
<p>PHP SDK is a tool kit for Windows PHP builds.</p>
</blockquote>
<p><code>PHP SDK</code> 依赖关系</p>
<pre><code>The PHP SDK 2.2+ is compatible with PHP 7.2 and above.

The PHP SDK 2.1 is required to build PHP 7.1 or 7.0.</code></pre><p>新版SDK下载地址：构建PHP7</p>
<pre><code>https://github.com/Microsoft/php-sdk-binary-tools</code></pre><p>旧版SDK下载地址：构建PHP5</p>
<pre><code>https://windows.php.net/downloads/php-sdk/
or
https://github.com/Microsoft/php-sdk-binary-tools/tree/legacy</code></pre><p>这里下载的PHP-SDK版本为<code>2.2.0</code>，下载解压并添加相应环境变量</p>
<pre><code>xxx\php-sdk-binary-tools-php-sdk-2.2.0\bin
xxx\php-sdk-binary-tools-php-sdk-2.2.0\msys2\usr\bin</code></pre><h3 id="Source-Insight"><a href="#Source-Insight" class="headerlink" title="Source Insight"></a>Source Insight</h3><blockquote>
<p>Source Insight是一个强大的面向项目的程序开发编辑器、代码浏览器和分析器，在您工作和规划时帮助您理解代码。</p>
</blockquote>
<ul>
<li>官网：介绍、下载</li>
</ul>
<pre><code>https://www.sourceinsight.com/</code></pre><p>《PHP 7底层设计与源码实现》书中有写到</p>
<blockquote>
<p>在研究PHP7源码之前，我们首先要掌握学习源码的方法论。首先是阅读工具，本章会介绍Windows下的Source lnsight、Mac下的Understand以及Linux下的Vim+Ctags，方便读者根据自己的操作系统选择不同的阅读工具。</p>
<p>Windows环境下有一款功能强大的IDE:Source Insight，内置了C++代码分析功能;同时还能自动维护项目内的符号数据库，使用非常方便。</p>
</blockquote>
<p>有关<code>Source Insight</code>详细参考：<a href="https://www.cnblogs.com/andy-songwei/p/9965714.html" target="_blank" rel="noopener">【工利其器】必会工具之（一）Source Insight篇</a></p>
<p>PS：这里<code>Source Insight</code>给我的使用感觉就一个字：<strong>强</strong>！！！</p>
<h2 id="源码结构"><a href="#源码结构" class="headerlink" title="源码结构"></a>源码结构</h2><p>下面先简单介绍一下PHP源码的目录结构。</p>
<ul>
<li><p>根目录: /</p>
<p>这个目录包含的东西比较多，主要包含一些说明文件以及设计方案。 其实项目中的这些README文件是非常值得阅读的例如：</p>
<ul>
<li><code>/README.PHP4-TO-PHP5-THIN-CHANGES</code> 这个文件就详细列举了PHP4和PHP5的一些差异。</li>
<li>还有有一个比较重要的文件<code>/CODING_STANDARDS</code>，如果要想写PHP扩展的话，这个文件一定要阅读一下，不管你个人的代码风格是什么样，怎么样使用缩进和花括号，既然来到了这样一个团体里就应该去适应这样的规范，这样在阅读代码或者别人阅读你的代码是都会更轻松。</li>
</ul>
</li>
<li><p><strong>build</strong> 顾名思义，这里主要放置一些和源码编译相关的一些文件，比如开始构建之前的buildconf脚本等文件，还有一些检查环境的脚本等。</p>
</li>
<li><p><strong>ext</strong> 官方扩展目录，包括了绝大多数PHP的函数的定义和实现，如array系列，pdo系列，spl系列等函数的实现，都在这个目录中。个人写的扩展在测试时也可以放到这个目录，方便测试和调试。</p>
</li>
<li><p><strong>main</strong> 这里存放的就是PHP最为核心的文件了，主要实现PHP的基本设施，这里和Zend引擎不一样，Zend引擎主要实现语言最核心的语言运行环境。</p>
</li>
<li><p><strong>Zend</strong> Zend引擎的实现目录，比如脚本的词法语法解析，opcode的执行以及扩展机制的实现等等。</p>
</li>
<li><p><strong>pear</strong> “PHP 扩展与应用仓库”，包含PEAR的核心文件。</p>
</li>
<li><p><strong>sapi</strong> 包含了各种服务器抽象层的代码，例如apache的mod_php，cgi，fastcgi以及fpm等等接口。</p>
</li>
<li><p><strong>TSRM</strong> PHP的线程安全是构建在TSRM库之上的，PHP实现中常见的<code>*G</code>宏通常是对TSRM的封装，TSRM(Thread Safe Resource Manager)线程安全资源管理器。</p>
</li>
<li><p><strong>tests</strong> PHP的测试脚本集合，包含PHP各项功能的测试文件</p>
</li>
<li><p><strong>win32</strong> 这个目录主要包括Windows平台相关的一些实现，比如socket的实现在Windows下和<code>*Nix</code>平台就不太一样，同时也包括了Windows下编译PHP相关的脚本。</p>
</li>
</ul>
<h2 id="源码编译"><a href="#源码编译" class="headerlink" title="源码编译"></a>源码编译</h2><p>环境准备部分，安装<code>Visual Studio 2019</code>后，运行在开始菜单里的<code>Visual Studio 2019</code>文件夹下的<code>x86 Native Tools Command Prompt for VS 2019</code>终端。</p>
<p>终端运行后，进入到<code>PHP 7.2.9</code>源代码目录中进行编译配置工作：</p>
<ul>
<li>生成configure配置文件</li>
</ul>
<p>执行源代码下<code>buildconf.bat</code>生成windows下的configure文件(configure.js)</p>
<pre class="line-numbers language-cmd"><code class="language-cmd">xxx\php-7.2.9-windows-debug>buildconf.bat
Rebuilding configure.js
Now run 'configure --help'

xxx\php-7.2.9-windows-debug><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>查看configure支持的编译参数</li>
</ul>
<pre class="line-numbers language-cmd"><code class="language-cmd">xxx\php-7.2.9-windows-debug>configure.bat --help
PHP Version: 7.2.9

Options that enable extensions and SAPI will accept 'yes' or 'no' as a
parameter. They also accept 'shared' as a synonym for 'yes' and request a
shared build of that module. Not all modules can be built as shared modules;
configure will display [shared] after the module name if can be built that
way.

  --enable-snapshot-build           Build a snapshot; turns on everything it
                                    can and ignores build errors
  --with-toolset                    Toolset to use for the compilation, give:
                                    vs, clang, icc. The only recommended and
                                    supported toolset for production use is
                                    Visual Studio. Use others at your own
                                    risk.
  --with-cygwin                     Path to cygwin utilities on your system
  --enable-object-out-dir           Alternate location for binary objects
                                    during build
  --enable-debug                    Compile with debugging symbols
  --enable-debug-pack               Release binaries with external debug
                                    symbols (--enable-debug must not be
                                    specified)
  --enable-pgi                      Generate PGO instrumented binaries
  --with-pgo                        Compile optimized binaries using training
                                    data from folder
  --disable-zts                     Thread safety
  --with-prefix                     where PHP will be installed
  --with-mp                         Tell Visual Studio use up to
                                    [n,auto,disable] processes for compilation
  --with-php-build                  Path to where you extracted the
                                    development libraries
                                    (http://wiki.php.net/internals/windows/libs).
                                    Assumes that it is a sibling of this
                                    source dir (..\deps) if not specified
  --with-extra-includes             Extra include path to use when building
                                    everything
  --with-extra-libs                 Extra library path to use when linking
                                    everything
  --with-analyzer                   Enable static analyzer. Pass vs for Visual
                                    Studio, clang for clang, cppcheck for
                                    Cppcheck, pvs for PVS-Studio
  --disable-ipv6                    Disable IPv6 support (default is turn it
                                    on if available)
  --enable-fd-setsize               Set maximum number of sockets for
                                    select(2)
  --with-snapshot-template          Path to snapshot builder template dir
  --disable-security-flags          Disable the compiler security flags
  --without-uncritical-warn-choke   Disable some uncritical warnings
  --enable-sanitizer                Enable address sanitizer extension
  --with-codegen-arch               Architecture for code generation: ia32,
                                    sse, sse2, avx, avx2
  --with-all-shared                 Force all the non obligatory extensions to
                                    be shared
  --with-config-profile             Name of the configuration profile to save
                                    this to in php-src/config.name.bat
  --disable-test-ini                Enable automatic php.ini generation. The
                                    test.ini will be put into the build dir
                                    and used to automatically load the shared
                                    extensions.
  --with-test-ini-ext-exclude       Comma separated list of shared extensions
                                    to be excluded from the test.ini
  --enable-apache2handler           Build Apache 2.x handler
  --enable-apache2-2handler         Build Apache 2.2.x handler
  --enable-apache2-4handler         Build Apache 2.4.x handler
  --disable-cgi                     Build CGI version of PHP
  --disable-cli                     Build CLI version of PHP
  --enable-crt-debug                Enable CRT memory dumps for debugging sent
                                    to STDERR
  --enable-cli-win32                Build console-less CLI version of PHP
  --enable-embed                    Embedded SAPI library
  --enable-phpdbg                   Build phpdbg
  --enable-phpdbgs                  Build phpdbg shared
  --disable-phpdbg-webhelper        Build phpdbg webhelper
  --disable-bcmath                  bc style precision math functions
  --with-bz2                        BZip2
  --disable-calendar                calendar conversion support
  --disable-com-dotnet              COM and .Net support
  --disable-ctype                   ctype
  --with-curl                       cURL support
  --with-dba                        DBA support
  --with-qdbm                       DBA: QDBM support
  --with-db                         DBA: Berkeley DB support
  --with-lmdb                       DBA: Lightning memory-mapped database
                                    support
  --with-enchant                    Enchant Support
  --enable-fileinfo                 fileinfo support
  --disable-filter                  Filter Support
  --enable-ftp                      ftp support
  --without-gd                      Bundled GD support
  --without-libwebp                 webp support
  --with-gettext                    gettext support
  --with-gmp                        Include GNU MP support.
  --disable-hash                    enable hash support
  --with-mhash                      mhash support
  --without-iconv                   iconv support
  --with-imap                       IMAP Support
  --with-interbase                  InterBase support
  --enable-intl                     Enable internationalization support
  --disable-json                    JavaScript Object Serialization support
  --with-ldap                       LDAP support
  --with-libmbfl                    use external libmbfl
  --enable-mbstring                 multibyte string functions
  --enable-mbregex                  multibyte regex support
  --disable-mbregex-backtrack       check multibyte regex backtrack
  --without-mysqlnd                 Mysql Native Client Driver
  --with-oci8                       OCI8 support
  --with-oci8-11g                   OCI8 support using Oracle 11g Instant
                                    Client
  --with-oci8-12c                   OCI8 support using Oracle Database 12c
                                    Instant Client
  --enable-odbc                     ODBC support
  --with-odbcver                    Force support for the passed ODBC version.
                                    A hex number is expected, default 0x0350.
                                    Use the special value of 0 to prevent an
                                    explicit ODBCVER to be defined.
  --disable-opcache                 whether to enable Zend OPcache support
  --disable-opcache-file            whether to enable file based caching
  --with-openssl                    OpenSSL support
  --without-pcre-jit                Enable PCRE JIT support
  --with-pgsql                      PostgreSQL support
  --with-pspell                     pspell/aspell (whatever it's called this
                                    month) support
  --without-readline                Readline support
  --disable-session                 session support
  --enable-shmop                    shmop support
  --with-snmp                       SNMP support
  --enable-sockets                  SOCKETS support
  --with-sodium                     for libsodium support
  --with-sqlite3                    SQLite 3 support
  --with-password-argon2            Argon2 support
  --with-config-file-scan-dir       Dir to check for additional php ini files
  --enable-sysvshm                  SysV Shared Memory support
  --with-tidy                       TIDY support
  --disable-tokenizer               tokenizer support
  --enable-zend-test                enable zend-test extension
  --disable-zip                     ZIP support
  --disable-zlib                    ZLIB support
  --without-libxml                  LibXML support
  --without-dom                     DOM support
  --enable-exif                     Exchangeable image information (EXIF)
                                    Support
  --with-mysqli                     MySQLi support
  --enable-pdo                      Enable PHP Data Objects support
  --with-pdo-dblib                  freetds dblib (Sybase, MS-SQL) support for
                                    PDO
  --with-pdo-mssql                  Native MS-SQL support for PDO
  --with-pdo-firebird               Firebird support for PDO
  --with-pdo-mysql                  MySQL support for PDO
  --with-pdo-oci                    Oracle OCI support for PDO
  --with-pdo-odbc                   ODBC support for PDO
  --with-pdo-pgsql                  PostgreSQL support for PDO
  --with-pdo-sqlite                 for pdo_sqlite support
  --with-pdo-sqlite-external        for pdo_sqlite support from an external
                                    dll
  --disable-phar                    disable phar support
  --enable-phar-native-ssl          enable phar with native OpenSSL support
  --without-simplexml               Simple XML support
  --enable-soap                     SOAP support
  --without-xml                     XML support
  --without-wddx                    WDDX support
  --disable-xmlreader               XMLReader support
  --with-xmlrpc                     XMLRPC-EPI support
  --disable-xmlwriter               XMLWriter support
  --with-xsl                        xsl support
  xxx\php-7.2.9-windows-debug><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>配置编译参数</li>
</ul>
<p>这里的编译参数为：以Debug模式编译PHP内核源码</p>
<pre class="line-numbers language-cmd"><code class="language-cmd">xxx\php-7.2.9-windows-debug>configure.bat --disable-all --enable-cli --enable-debug
PHP Version: 7.2.9

Saving configure options to config.nice.bat
Checking for cl.exe ...  <in default path>
WARNING: Using unknown MSVC version 19.28.29335

  Detected compiler MSVC 19.28.29335, untested
  Detected 32-bit compiler
Checking for link.exe ...  D:\QSoftware\VS2019Professional\Professional\VC\Tools\MSVC\14.28.29333\bin\HostX86\x86
Checking for nmake.exe ...  <in default path>
Checking for lib.exe ...  <in default path>
Checking for bison.exe ...  <in default path>
Checking for sed.exe ...  <in default path>
Checking for re2c.exe ...  <in default path>
  Detected re2c version 1.1.1
Checking for zip.exe ...  <in default path>
Checking for lemon.exe ...  <in default path>
Checking for mc.exe ...  C:\Program Files (x86)\Windows Kits\10\bin\10.0.18362.0\x86
Checking for mt.exe ...  C:\Program Files (x86)\Windows Kits\10\bin\10.0.18362.0\x86
WARNING: Debug builds cannot be built using multi processing

Build dir: D:\QSec\Code-Audit\PHP\PHP-Source-Code\php-7.2.9-windows-debug\Debug_TS
PHP Core:  php7ts_debug.dll and php7ts_debug.lib

Checking for wspiapi.h ...  <in default path>
Enabling IPv6 support
Enabling SAPI sapi\cli
Checking for library edit_a.lib;edit.lib ... <not found>
Enabling extension ext\date
Enabling extension ext\pcre
Enabling extension ext\reflection
Enabling extension ext\spl
Checking for timelib_config.h ...  ext/date/lib
Enabling extension ext\standard

Creating build dirs...
Generating files...
Generating Makefile
Generating main/internal_functions.c
Generating main/config.w32.h
Generating phpize
Done.

Enabled extensions:
-----------------------
| Extension  | Mode   |
-----------------------
| date       | static |
| pcre       | static |
| reflection | static |
| spl        | static |
| standard   | static |
-----------------------

Enabled SAPI:
-------------
| Sapi Name |
-------------
| cli       |
-------------
------------------------------------------------
|                 |                            |
------------------------------------------------
| Build type      | Debug                      |
| Thread Safety   | Yes                        |
| Compiler        | MSVC 19.28.29335, untested |
| Architecture    | x86                        |
| Optimization    | disabled                   |
| Static analyzer | disabled                   |
------------------------------------------------
Type 'nmake' to build PHP
xxx\php-7.2.9-windows-debug><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>开始编译</li>
</ul>
<p>运行<code>nmake</code>指令进行编译</p>
<pre class="line-numbers language-cmd"><code class="language-cmd">D:\QSec\Code-Audit\PHP\PHP-Source-Code\php-7.2.9-windows-debug>nmake

Microsoft (R) 程序维护实用工具 14.28.29335.0 版
版权所有 (C) Microsoft Corporation。  保留所有权利。

Recreating build dirs
        type ext\pcre\php_pcre.def > D:\QSec\Code-Audit\PHP\PHP-Source-Code\php-7.2.9-windows-debug\Debug_TS\php7ts_debug.dll.def
        "C:\Program Files (x86)\Windows Kits\10\bin\10.0.18362.0\x86\mc.exe" -h win32\ -r D:\QSec\Code-Audit\PHP\PHP-Source-Code\php-7.2.9-windows-debug\Debug_TS\ -x D:\QSec\Code-Audit\PHP\PHP-Source-Code\php-7.2.9-windows-debug\Debug_TS\ win32\build\wsyslog.mc
MC: Compiling win32\build\wsyslog.mc
cl: 命令行 warning D9035 :“Gm”选项已否决，并将在将来的版本中移除
php_cli.c
cl: 命令行 warning D9035 :“Gm”选项已否决，并将在将来的版本中移除
php_cli_process_title.c
、、、、、
、、、、、<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译完成后，在当前源码目录生成：<code>Debug_TS</code>项目（编译后的PHP可执行文件 php.exe-&gt;32位）</p>
<pre class="line-numbers language-cmd"><code class="language-cmd">xxx\php-7.2.9-windows-debug\Debug_TS
λ  Qftm >>>: ls
devel/        php.exe*          php.ilk   php7ts_debug.dll*          php7ts_debug.exp  resp/   wsyslog.dbg
ext/          php.exe.manifest  php.lib   php7ts_debug.dll.def       php7ts_debug.ilk  sapi/   wsyslog.rc
main/         php.exe.res       php.pdb   php7ts_debug.dll.manifest  php7ts_debug.lib  TSRM/   Zend/
MSG00001.bin  php.exp           php-7.2.9-devel-19.28.29335-x86/  php7ts_debug.dll.res       php7ts_debug.pdb  win32/

λ  Qftm >>>:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试<code>Debug_TS/php.exe</code></p>
<pre class="line-numbers language-cmd"><code class="language-cmd">λ  Qftm >>>: php.exe -v
PHP 7.2.9 (cli) (built: Dec 15 2020 14:40:17) ( ZTS MSVC 19.28.29335, untested x86 DEBUG )
Copyright (c) 1997-2018 The PHP Group
Zend Engine v3.2.0, Copyright (c) 1998-2018 Zend Technologies<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="源码调试"><a href="#源码调试" class="headerlink" title="源码调试"></a>源码调试</h2><p>这里通过配置<code>VSCode</code>进行PHP内核源码的调试工作：</p>
<p>先用VSCode打开PHP7.2.9编译的源代码项目，然后，在源代码目录下的<code>Debug_TS</code>里，创建一个用于测试的php文件<code>test.php</code>。</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token shell-comment comment"># /Debug_TS/test.php</span>

<span class="token delimiter">&lt;?php</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"whoami"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>随后点击功能菜单：<code>Run-&gt;Start Debugging</code>【F5】，弹框中任意选择一个，自动生成调试配置文件<code>.vscode/launch.json</code>，修改其内容如下：</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
        <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
        <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Windows PHP7.2.9 Source Code Debug"</span><span class="token punctuation">,</span>
                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cppvsdbg"</span><span class="token punctuation">,</span>
                <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>
                <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"${workspaceRoot}/Debug_TS/php.exe"</span><span class="token punctuation">,</span>
                <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"${file}"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token property">"stopAtEntry"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token property">"cwd"</span><span class="token operator">:</span> <span class="token string">"${workspaceRoot}/Debug_TS/"</span><span class="token punctuation">,</span>
                <span class="token property">"environment"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token property">"externalConsole"</span><span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PS：注意这里需要存在扩展 <code>C/C++</code>，同时这里的调试和gdb没有关系。</p>
<p>打开<code>php-7.2.9-windows-debug/sapi/cli/php_cli.c</code>源文件【程序执行入口文件】，定位到1200行的main函数内打上断点。【在想要调试的源代码特定位置上打上特定的断点即可】</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215151247189.png" alt="image-20201215151247189"></p>
<p>PS：虽然这里的C文件显示有问题<code>Problems</code>，但是不影响调试，准确来说这里的调试和配置C环境没有关系。</p>
<p>点击<code>Run-&gt;Start Debugging</code>【F5】开始调试</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215151415554.png" alt="image-20201215151415554"></p>
<p>VSCode调试窗口介绍</p>
<p><img src="/2020/12/01/command-execution-research-php/debugging_hero.png" alt="Debugging diagram"></p>
<p>VSCode调试快捷键介绍：对应上方调试窗口Debug动作按钮</p>
<pre><code>- Continue/Pause   运行         F5
- Step Over        单步 步过     F10
- Step Into        单步 步入     F11
- Step Out         跳出 函数     Shift+F11
- Restart          重新 调试     Ctrl+Shift+F5
- Stop             关闭 调试     Shift+F5</code></pre><h2 id="源码执行"><a href="#源码执行" class="headerlink" title="源码执行"></a>源码执行</h2><h3 id="任务执行"><a href="#任务执行" class="headerlink" title="任务执行"></a>任务执行</h3><p>如果需要单纯执行PHP代码则需要配置<code>tasks.json</code>任务文件，初始化点击：<code>Terminal-&gt;Configure Tasks</code>进行模板文件的创建，然后选择其它命令执行模板即可</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215153108490.png" alt="image-20201215153108490"></p>
<p>初始任务模板内容：tasks.json</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
    // See https<span class="token operator">:</span>//go.microsoft.com/fwlink/?LinkId=<span class="token number">733558</span>
    // for the documentation about the tasks.json format
    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"2.0.0"</span><span class="token punctuation">,</span>
    <span class="token property">"tasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"echo"</span><span class="token punctuation">,</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell"</span><span class="token punctuation">,</span>
            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"echo Hello"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改任务模板配置文件，配置PHP执行环境</p>
<pre class="line-numbers language-json"><code class="language-json">// tasks.json

<span class="token punctuation">{</span>
    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"2.0.0"</span><span class="token punctuation">,</span>
    <span class="token property">"tasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"Windows php7.2.9.exe x.php"</span><span class="token punctuation">,</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell"</span><span class="token punctuation">,</span>
            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"D:/QSec/Code-Audit/PHP/PHP-Source-Code/php-7.2.9-windows-debug/Debug_TS/php.exe"</span><span class="token punctuation">,</span>
            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"${file}"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行任务<code>Windows php7.2.9.exe x.php</code>来执行特定PHP程序文件</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215154111640.png" alt="image-20201215154111640"></p>
<h3 id="插件执行"><a href="#插件执行" class="headerlink" title="插件执行"></a>插件执行</h3><p>除了上方创建任务执行程序外，还可以借助插件<code>code runner</code>更加方便的去执行程序。</p>
<p><code>code runner</code>扩展自带的默认对PHP运行的配置规则如下</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token property">"code-runner.executorMap"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">"php"</span><span class="token operator">:</span> <span class="token string">"php"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>默认配置使用的是环境变量中的php.exe去执行的，可以更改设置为自己的php.exe路径【避免与环境变量中其它的php.exe发生冲突】</p>
<p>点击<code>File-&gt;Preferences-&gt;settings-&gt;Extensions-&gt;Run Code configuration-&gt;Executor Map-&gt;Edit in settings.json</code>进行设置</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215154649295.png" alt="image-20201215154649295"></p>
<p>插件运行效果</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215154740915.png" alt="image-20201215154740915"></p>
<h2 id="疑难杂症"><a href="#疑难杂症" class="headerlink" title="疑难杂症"></a>疑难杂症</h2><p>针对调试编译的源码所要注意的问题，由于在编译期间会对源代码的路径等信息进行配置，写入编译后的<code>Debug_TS\php.exe</code>以及<code>Debug_TS\resp\*</code>等文件中，使得其可以协助我们进行源代码的调试工作。但是，这里就会出现一个问题：如果以后对源码的路径进行了任何改动都会导致对源代码调试出错。</p>
<p><code>Debug_TS\php.exe</code>中有关PHP源代码路径信息</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215162434399.png" alt="image-20201215162434399"></p>
<p><code>Debug_TS\resp\*</code>中有关PHP源代码路径信息</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215162733526.png" alt="image-20201215162733526"></p>
<p>这里如果对路径稍作修改则会调试出错(找不到源码文件)：<code>php-7.2.9-windows-debug</code> ==&gt; <code>php-7.2.9-windows-debugs</code></p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215163146287.png" alt="image-20201215163146287"></p>
<h2 id="命令执行底层分析"><a href="#命令执行底层分析" class="headerlink" title="命令执行底层分析"></a>命令执行底层分析</h2><p>针对命令执行函数的底层分析，这里主要采用两种手段去分析：静态审计(静态审计内核源码)、动态审计(动态调试内核源码)。</p>
<h3 id="静态审计"><a href="#静态审计" class="headerlink" title="静态审计"></a>静态审计</h3><p>PHP命令执行函数有很多</p>
<pre class="line-numbers language-php"><code class="language-php">system
exec
passthru
shell_exec
proc_open
popen
pcntl_exec
escapeshellarg
escapeshellcmd                                              
、、、、<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大部分命令执行函数于<code>ext/standard/exec.c</code>源码中实现</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* {{{ proto string exec(string command [, array &amp;output [, int &amp;return_value]])
   Execute an external program */</span>
<span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>exec<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">php_exec_ex</span><span class="token punctuation">(</span>INTERNAL_FUNCTION_PARAM_PASSTHRU<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span>

<span class="token comment" spellcheck="true">/* {{{ proto int system(string command [, int &amp;return_value])
   Execute an external program and display output */</span>
<span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">php_exec_ex</span><span class="token punctuation">(</span>INTERNAL_FUNCTION_PARAM_PASSTHRU<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span>

<span class="token comment" spellcheck="true">/* {{{ proto void passthru(string command [, int &amp;return_value])
   Execute an external program and display raw output */</span>
<span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>passthru<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">php_exec_ex</span><span class="token punctuation">(</span>INTERNAL_FUNCTION_PARAM_PASSTHRU<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span>

<span class="token comment" spellcheck="true">/* {{{ proto string shell_exec(string cmd)
   Execute command via shell and return complete output as string */</span>
<span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>shell_exec<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	FILE <span class="token operator">*</span>in<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">;</span>
	size_t command_len<span class="token punctuation">;</span>
	zend_string <span class="token operator">*</span>ret<span class="token punctuation">;</span>
	php_stream <span class="token operator">*</span>stream<span class="token punctuation">;</span>

	<span class="token function">ZEND_PARSE_PARAMETERS_START</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">Z_PARAM_STRING</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> command_len<span class="token punctuation">)</span>
	<span class="token function">ZEND_PARSE_PARAMETERS_END</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> PHP_WIN32</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>in<span class="token operator">=</span><span class="token function">VCWD_POPEN</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token string">"rt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>in<span class="token operator">=</span><span class="token function">VCWD_POPEN</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
		<span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span> <span class="token string">"Unable to execute '%s'"</span><span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>
		RETURN_FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	stream <span class="token operator">=</span> <span class="token function">php_stream_fopen_from_pipe</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">php_stream_copy_to_mem</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> PHP_STREAM_COPY_ALL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">php_stream_close</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token function">ZSTR_LEN</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">RETVAL_STR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>观察上面代码部分，可以发现<code>system、exec、passthru</code>这三个命令执行函数调用函数一样，皆为<code>php_exec_ex()</code>函数，不同点只在于调用函数的第二个参数<code>mode</code>不同<code>0、1、3</code>作为标识。而<code>shell_exec</code>函数则是调用<code>VCWD_POPEN()</code>函数去实现。</p>
<p>下面以<code>system()</code>命令执行函数执行<code>whoami</code>指令为例：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>借助源码审查工具<code>Source Insight</code>【导入<code>php7.2.9</code>源码项目】进行底层函数跟踪分析</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216135904754.png" alt="image-20201216135904754"></p>
<p>首先找到php中system()函数声明处：<code>ext\standard\exec.c:263</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">php_exec_ex</span><span class="token punctuation">(</span>INTERNAL_FUNCTION_PARAM_PASSTHRU<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>很明显system函数由<code>php_exec_ex()</code>函数实现，跟进同文件下找到<code>php_exec_ex()</code>函数实现【<strong>在<code>Source Insight</code>下面可以使用Ctrl+鼠标左键点击定位函数位置</strong>】：<code>ext\standard\exec.c:209</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">php_exec_ex</span><span class="token punctuation">(</span>INTERNAL_FUNCTION_PARAMETERS<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* {{{ */</span>
<span class="token punctuation">{</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">;</span>
	size_t cmd_len<span class="token punctuation">;</span>
	zval <span class="token operator">*</span>ret_code<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>ret_array<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	<span class="token function">ZEND_PARSE_PARAMETERS_START</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>mode <span class="token operator">?</span> <span class="token number">2</span> <span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">Z_PARAM_STRING</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> cmd_len<span class="token punctuation">)</span>
		Z_PARAM_OPTIONAL
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">Z_PARAM_ZVAL_DEREF</span><span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token function">Z_PARAM_ZVAL_DEREF</span><span class="token punctuation">(</span>ret_code<span class="token punctuation">)</span>
	<span class="token function">ZEND_PARSE_PARAMETERS_END_EX</span><span class="token punctuation">(</span>RETURN_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cmd_len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span> <span class="token string">"Cannot execute a blank command"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		RETURN_FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">!=</span> cmd_len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span> <span class="token string">"NULL byte detected. Possible attack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		RETURN_FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret_array<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token function">php_exec</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> return_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Z_TYPE_P</span><span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span> <span class="token operator">!=</span> IS_ARRAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">zval_ptr_dtor</span><span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">array_init</span><span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Z_REFCOUNT_P</span><span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">zval_ptr_dtor</span><span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">ZVAL_ARR</span><span class="token punctuation">(</span>ret_array<span class="token punctuation">,</span> <span class="token function">zend_array_dup</span><span class="token punctuation">(</span><span class="token function">Z_ARR_P</span><span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		ret <span class="token operator">=</span> <span class="token function">php_exec</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> ret_array<span class="token punctuation">,</span> return_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret_code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">zval_ptr_dtor</span><span class="token punctuation">(</span>ret_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ZVAL_LONG</span><span class="token punctuation">(</span>ret_code<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>阅读<code>php_exec_ex()</code>函数实现，会对cmd参数进行初始化处理，然后调用<code>php_exec(mode, cmd, NULL, return_value)</code>函数，mode为不同执行函数标识、cmd为指令参数。</p>
<p>跟踪<code>php_exec()</code>函数调用：<code>ext\standard\exec.c:97</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* {{{ php_exec
 * If type==0, only last line of output is returned (exec)
 * If type==1, all lines will be printed and last lined returned (system)
 * If type==2, all lines will be saved to given array (exec with &amp;$array)
 * If type==3, output will be printed binary, no lines will be saved or returned (passthru)
 *
 */</span>
PHPAPI <span class="token keyword">int</span> <span class="token function">php_exec</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> zval <span class="token operator">*</span>array<span class="token punctuation">,</span> zval <span class="token operator">*</span>return_value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span>
	size_t l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> pclose_return<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token operator">*</span>d<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	php_stream <span class="token operator">*</span>stream<span class="token punctuation">;</span>
	size_t buflen<span class="token punctuation">,</span> bufl <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> PHP_SIGCHILD</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sig_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">if</span> PHP_SIGCHILD</span>
	sig_handler <span class="token operator">=</span> <span class="token function">signal</span> <span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> SIG_DFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> PHP_WIN32</span>
	fp <span class="token operator">=</span> <span class="token function">VCWD_POPEN</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
	fp <span class="token operator">=</span> <span class="token function">VCWD_POPEN</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span> <span class="token string">"Unable to fork [%s]"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	stream <span class="token operator">=</span> <span class="token function">php_stream_fopen_from_pipe</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">emalloc</span><span class="token punctuation">(</span>EXEC_INPUT_BUF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	buflen <span class="token operator">=</span> EXEC_INPUT_BUF<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		b <span class="token operator">=</span> buf<span class="token punctuation">;</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">php_stream_get_line</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> b<span class="token punctuation">,</span> EXEC_INPUT_BUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment" spellcheck="true">/* no new line found, let's read some more */</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">[</span>bufl <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\n'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">php_stream_eof</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>buflen <span class="token operator">&lt;</span> <span class="token punctuation">(</span>bufl <span class="token operator">+</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> buf<span class="token punctuation">)</span> <span class="token operator">+</span> EXEC_INPUT_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					bufl <span class="token operator">+</span><span class="token operator">=</span> b <span class="token operator">-</span> buf<span class="token punctuation">;</span>
					buflen <span class="token operator">=</span> bufl <span class="token operator">+</span> EXEC_INPUT_BUF<span class="token punctuation">;</span>
					buf <span class="token operator">=</span> <span class="token function">erealloc</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">;</span>
					b <span class="token operator">=</span> buf <span class="token operator">+</span> bufl<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					b <span class="token operator">+</span><span class="token operator">=</span> bufl<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				bufl <span class="token operator">+</span><span class="token operator">=</span> b <span class="token operator">-</span> buf<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">PHPWRITE</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> bufl<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">php_output_get_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">sapi_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment" spellcheck="true">/* strip trailing whitespaces */</span>
				l <span class="token operator">=</span> bufl<span class="token punctuation">;</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span>l<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isspace</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">!=</span> <span class="token punctuation">(</span>bufl <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					bufl <span class="token operator">=</span> l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
					buf<span class="token punctuation">[</span>bufl<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">add_next_index_stringl</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> bufl<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			b <span class="token operator">=</span> buf<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>bufl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment" spellcheck="true">/* strip trailing whitespaces if we have not done so already */</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> buf <span class="token operator">!=</span> b<span class="token punctuation">)</span> <span class="token operator">||</span> type <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				l <span class="token operator">=</span> bufl<span class="token punctuation">;</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span>l<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isspace</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">!=</span> <span class="token punctuation">(</span>bufl <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					bufl <span class="token operator">=</span> l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
					buf<span class="token punctuation">[</span>bufl<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">add_next_index_stringl</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> bufl<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token comment" spellcheck="true">/* Return last line from the shell command */</span>
			<span class="token function">RETVAL_STRINGL</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> bufl<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* should return NULL, but for BC we return "" */</span>
			<span class="token function">RETVAL_EMPTY_STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bufl <span class="token operator">=</span> <span class="token function">php_stream_read</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> EXEC_INPUT_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">PHPWRITE</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> bufl<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	pclose_return <span class="token operator">=</span> <span class="token function">php_stream_close</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">efree</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

done<span class="token punctuation">:</span>
<span class="token macro property">#<span class="token directive keyword">if</span> PHP_SIGCHILD</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sig_handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> sig_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">efree</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> pclose_return<span class="token punctuation">;</span>
err<span class="token punctuation">:</span>
	pclose_return <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">goto</span> done<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>审计<code>int php_exec(int type, char *cmd, zval *array, zval *return_value)</code>函数代码，发现函数内部会首先调用<code>VCWD_POPEN()</code>函数去处理<code>cmd</code>指令【<strong>在这里不难发现该部分函数<code>VCWD_POPEN()</code>调用同<code>shell_exec()</code>可执行函数实现原理相同，也就说明<code>system、exec、passthru、shell_exec</code>这类命令执行函数原理相同，底层都调用了相同函数<code>VCWD_POPEN()</code>去执行系统指令</strong>】。</p>
<p>这里的<code>VCWD_POPEN()</code>函数调用会通过相应的平台去执行：PHP_WIN32为Windows平台、另一个为<code>Unix</code>平台</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifdef</span> PHP_WIN32</span>
    fp <span class="token operator">=</span> <span class="token function">VCWD_POPEN</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    fp <span class="token operator">=</span> <span class="token function">VCWD_POPEN</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进入<code>VCWD_POPEN(cmd, &quot;rb&quot;)</code>函数： <code>Zend\zend_virtual_cwd.h:269</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> VCWD_POPEN(command, type) virtual_popen(command, type)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>由于<code>VCWD_POPEN</code>函数为<code>virtual_popen</code>实现，直接进入<code>virtual_popen()</code>函数实现：<code>Zend\zend_virtual_cwd.c:1831</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifdef</span> ZEND_WIN32</span>
CWD_API FILE <span class="token operator">*</span><span class="token function">virtual_popen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* {{{ */</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">popen_ex</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span>
<span class="token macro property">#<span class="token directive keyword">else</span> </span><span class="token comment" spellcheck="true">/* Unix */</span>
CWD_API FILE <span class="token operator">*</span><span class="token function">virtual_popen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* {{{ */</span>
<span class="token punctuation">{</span>
	size_t command_length<span class="token punctuation">;</span>
	<span class="token keyword">int</span> dir_length<span class="token punctuation">,</span> extra <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>command_line<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span>dir<span class="token punctuation">;</span>
	FILE <span class="token operator">*</span>retval<span class="token punctuation">;</span>

	command_length <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>

	dir_length <span class="token operator">=</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd_length<span class="token punctuation">;</span>
	dir <span class="token operator">=</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>dir_length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>dir <span class="token operator">==</span> <span class="token string">'\''</span><span class="token punctuation">)</span> extra<span class="token operator">+</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
		dir<span class="token operator">++</span><span class="token punctuation">;</span>
		dir_length<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	dir_length <span class="token operator">=</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd_length<span class="token punctuation">;</span>
	dir <span class="token operator">=</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd<span class="token punctuation">;</span>

	ptr <span class="token operator">=</span> command_line <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">emalloc</span><span class="token punctuation">(</span>command_length <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"cd '' ; "</span><span class="token punctuation">)</span> <span class="token operator">+</span> dir_length <span class="token operator">+</span> extra<span class="token operator">+</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token string">"cd "</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"cd "</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"cd "</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd_length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> DEFAULT_SLASH<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\''</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>dir_length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>dir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token string">'\''</span><span class="token punctuation">:</span>
				<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\''</span><span class="token punctuation">;</span>
				<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\\'</span><span class="token punctuation">;</span>
				<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\''</span><span class="token punctuation">;</span>
				<span class="token comment" spellcheck="true">/* fall-through */</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>dir<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			dir<span class="token operator">++</span><span class="token punctuation">;</span>
			dir_length<span class="token operator">--</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\''</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">';'</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>

	<span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> command<span class="token punctuation">,</span> command_length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	retval <span class="token operator">=</span> <span class="token function">popen</span><span class="token punctuation">(</span>command_line<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">efree</span><span class="token punctuation">(</span>command_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不难发现，针对<code>virtual_popen()</code>函数实现，也存在于不同平台，这里主要分析Windows平台，针对Unix平台在下面<code>PHP for Linux</code>部分会详细讲述。</p>
<p>针对<code>Windows</code>平台，<code>virtual_popen()</code>函数实现非常简单，直接调用<code>popen_ex()</code>函数进行返回。</p>
<p>进入<code>popen_ex()</code>函数实现：<code>TSRM\tsrm_win32.c:473</code></p>
<pre class="line-numbers language-c"><code class="language-c">TSRM_API FILE <span class="token operator">*</span><span class="token function">popen_ex</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cwd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>env<span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token comment" spellcheck="true">/*{{{*/</span>
	FILE <span class="token operator">*</span>stream <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> fno<span class="token punctuation">,</span> type_len<span class="token punctuation">,</span> read<span class="token punctuation">,</span> mode<span class="token punctuation">;</span>
	STARTUPINFOW startup<span class="token punctuation">;</span>
	PROCESS_INFORMATION process<span class="token punctuation">;</span>
	SECURITY_ATTRIBUTES security<span class="token punctuation">;</span>
	HANDLE in<span class="token punctuation">,</span> out<span class="token punctuation">;</span>
	DWORD dwCreateFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	BOOL res<span class="token punctuation">;</span>
	process_pair <span class="token operator">*</span>proc<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>cmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	wchar_t <span class="token operator">*</span>cmdw <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>cwdw <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>envw <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>ptype <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>type<span class="token punctuation">;</span>
	HANDLE thread_token <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	HANDLE token_user <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	BOOL asuser <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment" spellcheck="true">/*The following two checks can be removed once we drop XP support */</span>
	type_len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>type_len <span class="token operator">&lt;</span><span class="token number">1</span> <span class="token operator">||</span> type_len<span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> type_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>ptype <span class="token operator">==</span> <span class="token string">'r'</span> <span class="token operator">||</span> <span class="token operator">*</span>ptype <span class="token operator">==</span> <span class="token string">'w'</span> <span class="token operator">||</span> <span class="token operator">*</span>ptype <span class="token operator">==</span> <span class="token string">'b'</span> <span class="token operator">||</span> <span class="token operator">*</span>ptype <span class="token operator">==</span> <span class="token string">'t'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		ptype<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	cmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token function">TWG</span><span class="token punctuation">(</span>comspec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">" /c "</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">sprintf</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"%s /c \"%s\""</span><span class="token punctuation">,</span> <span class="token function">TWG</span><span class="token punctuation">(</span>comspec<span class="token punctuation">)</span><span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cmdw <span class="token operator">=</span> <span class="token function">php_win32_cp_any_to_w</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cmdw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">free</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>cwd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cwdw <span class="token operator">=</span> <span class="token function">php_win32_ioutil_any_to_w</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cwdw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">free</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">free</span><span class="token punctuation">(</span>cmdw<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	security<span class="token punctuation">.</span>nLength				<span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SECURITY_ATTRIBUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
	security<span class="token punctuation">.</span>bInheritHandle			<span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
	security<span class="token punctuation">.</span>lpSecurityDescriptor	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type_len <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">CreatePipe</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in<span class="token punctuation">,</span> <span class="token operator">&amp;</span>out<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> <span class="token number">2048L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">free</span><span class="token punctuation">(</span>cmdw<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>cwdw<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>startup<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>STARTUPINFOW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>process<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PROCESS_INFORMATION<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	startup<span class="token punctuation">.</span>cb			<span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>STARTUPINFOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
	startup<span class="token punctuation">.</span>dwFlags		<span class="token operator">=</span> STARTF_USESTDHANDLES<span class="token punctuation">;</span>
	startup<span class="token punctuation">.</span>hStdError	<span class="token operator">=</span> <span class="token function">GetStdHandle</span><span class="token punctuation">(</span>STD_ERROR_HANDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	read <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token operator">?</span> TRUE <span class="token punctuation">:</span> FALSE<span class="token punctuation">;</span>
	mode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type_len <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> O_BINARY <span class="token punctuation">:</span> O_TEXT<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>read<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		in <span class="token operator">=</span> <span class="token function">dupHandle</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		startup<span class="token punctuation">.</span>hStdInput  <span class="token operator">=</span> <span class="token function">GetStdHandle</span><span class="token punctuation">(</span>STD_INPUT_HANDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		startup<span class="token punctuation">.</span>hStdOutput <span class="token operator">=</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		out <span class="token operator">=</span> <span class="token function">dupHandle</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		startup<span class="token punctuation">.</span>hStdInput  <span class="token operator">=</span> in<span class="token punctuation">;</span>
		startup<span class="token punctuation">.</span>hStdOutput <span class="token operator">=</span> <span class="token function">GetStdHandle</span><span class="token punctuation">(</span>STD_OUTPUT_HANDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	dwCreateFlags <span class="token operator">=</span> NORMAL_PRIORITY_CLASS<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>sapi_module<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"cli"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		dwCreateFlags <span class="token operator">|</span><span class="token operator">=</span> CREATE_NO_WINDOW<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment" spellcheck="true">/* Get a token with the impersonated user. */</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">OpenThreadToken</span><span class="token punctuation">(</span><span class="token function">GetCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TOKEN_ALL_ACCESS<span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thread_token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">DuplicateTokenEx</span><span class="token punctuation">(</span>thread_token<span class="token punctuation">,</span> MAXIMUM_ALLOWED<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> SecurityImpersonation<span class="token punctuation">,</span> TokenPrimary<span class="token punctuation">,</span> <span class="token operator">&amp;</span>token_user<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		DWORD err <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> ERROR_NO_TOKEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			asuser <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	envw <span class="token operator">=</span> <span class="token function">php_win32_cp_env_any_to_w</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>envw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		dwCreateFlags <span class="token operator">|</span><span class="token operator">=</span> CREATE_UNICODE_ENVIRONMENT<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">free</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">free</span><span class="token punctuation">(</span>cmdw<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">free</span><span class="token punctuation">(</span>cwdw<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>asuser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res <span class="token operator">=</span> <span class="token function">CreateProcessAsUserW</span><span class="token punctuation">(</span>token_user<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> cmdw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> security<span class="token punctuation">.</span>bInheritHandle<span class="token punctuation">,</span> dwCreateFlags<span class="token punctuation">,</span> envw<span class="token punctuation">,</span> cwdw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>startup<span class="token punctuation">,</span> <span class="token operator">&amp;</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">CloseHandle</span><span class="token punctuation">(</span>token_user<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		res <span class="token operator">=</span> <span class="token function">CreateProcessW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> cmdw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> security<span class="token punctuation">.</span>bInheritHandle<span class="token punctuation">,</span> dwCreateFlags<span class="token punctuation">,</span> envw<span class="token punctuation">,</span> cwdw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>startup<span class="token punctuation">,</span> <span class="token operator">&amp;</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">free</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>cmdw<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>cwdw<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>envw<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">CloseHandle</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	proc <span class="token operator">=</span> <span class="token function">process_get</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>read<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fno <span class="token operator">=</span> <span class="token function">_open_osfhandle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tsrm_intptr_t<span class="token punctuation">)</span>in<span class="token punctuation">,</span> _O_RDONLY <span class="token operator">|</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">CloseHandle</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fno <span class="token operator">=</span> <span class="token function">_open_osfhandle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tsrm_intptr_t<span class="token punctuation">)</span>out<span class="token punctuation">,</span> _O_WRONLY <span class="token operator">|</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">CloseHandle</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	stream <span class="token operator">=</span> <span class="token function">_fdopen</span><span class="token punctuation">(</span>fno<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
	proc<span class="token operator">-></span>prochnd <span class="token operator">=</span> process<span class="token punctuation">.</span>hProcess<span class="token punctuation">;</span>
	proc<span class="token operator">-></span>stream <span class="token operator">=</span> stream<span class="token punctuation">;</span>
	<span class="token keyword">return</span> stream<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token comment" spellcheck="true">/*}}}*/</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token number">1</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从<code>TSRM\tsrm_win32.c</code>文件不难发现，由<code>virtual_popen()</code>函数不同平台到<code>popen_ex()</code>函数可知，<code>virtual_popen()</code>函数是作为不同平台的分割点，此时的调用链已经到了仅和windows平台有联系。</p>
<p>接着对<code>*popen_ex()</code>函数进行分析，参数：<code>command</code>为指令参数、<code>cwd</code>为当前工作目录、<code>env</code>为环境变量信息。</p>
<p>为cmd变量动态分配空间：这里不得不说把cmd变量的空间分配的刚刚好</p>
<pre class="line-numbers language-c"><code class="language-c">cmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token function">TWG</span><span class="token punctuation">(</span>comspec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">" /c "</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>分配空间后，为cmd变量赋值</p>
<pre><code>sprintf(cmd, &quot;%s /c \&quot;%s\&quot;&quot;, TWG(comspec), command);

=&gt; cmd = &quot;cmd.exe /c whoami&quot;</code></pre><p>这部分其实在PHP官方手册的<a href="https://www.php.net/function.exec" target="_blank" rel="noopener">可执行函数</a>中也有说明</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201215213847210.png" alt="image-20201215213847210"></p>
<p>到这里也就会发现<code>system、exec、passthru、shell_exec</code>这类命令执行函数底层都会调用系统终端<code>cmd.exe</code>来执行传入的指令参数。那么既然会调用系统cmd，就要将cmd进程启动起来。</p>
<p>继续向后分析<code>*popen_ex()</code>函数，会找到相关Windows系统API来启动<code>cmd.exe</code>进程，然后由cmd进程执行指令参数(内部|外部指令)。</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">if</span> <span class="token punctuation">(</span>asuser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res <span class="token operator">=</span> <span class="token function">CreateProcessAsUserW</span><span class="token punctuation">(</span>token_user<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> cmdw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> security<span class="token punctuation">.</span>bInheritHandle<span class="token punctuation">,</span> dwCreateFlags<span class="token punctuation">,</span> envw<span class="token punctuation">,</span> cwdw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>startup<span class="token punctuation">,</span> <span class="token operator">&amp;</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>token_user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res <span class="token operator">=</span> <span class="token function">CreateProcessW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> cmdw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> <span class="token operator">&amp;</span>security<span class="token punctuation">,</span> security<span class="token punctuation">.</span>bInheritHandle<span class="token punctuation">,</span> dwCreateFlags<span class="token punctuation">,</span> envw<span class="token punctuation">,</span> cwdw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>startup<span class="token punctuation">,</span> <span class="token operator">&amp;</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>在 Windows 平台上，创建进程有 <code>WinExec</code>，<code>system</code>，<code>_spawn/_wspawn</code>，<code>CreateProcess</code>，<code>ShellExecute</code> 等多种途径，但上述函数基本上还是由 <code>CreateProcess Family</code> 封装的。在 Windows 使用 <code>C/C++</code> 创建进程应当优先使用 <code>CreateProcess</code>，<code>CreateProcess</code>有三个变体，主要是为了支持以其他权限启动进程， <code>CreateProcess</code> 及其变体如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">Function</th>
<th align="left">Feature</th>
<th align="left">Details</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CreateProcessW/A</td>
<td align="left">创建常规进程，权限继承父进程权限</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">CreateProcessAsUserW/A</td>
<td align="left">使用主 Token 创建进程，子进程权限与 Token 限定一致</td>
<td align="left">必须开启 <code>SE_INCREASE_QUOTA_NAME</code></td>
</tr>
<tr>
<td align="left">CreateProcessWithTokenW</td>
<td align="left">使用主 Token 创建进程，子进程权限与 Token 限定一致</td>
<td align="left">必须开启 <code>SE_IMPERSONATE_NAME</code></td>
</tr>
<tr>
<td align="left">CreateProcessWithLogonW/A</td>
<td align="left">使用指定用户凭据启动进程</td>
<td align="left"></td>
</tr>
</tbody></table>
<p>PS：有关Windows系统API的调用情况，一般编程语言启动某个可执行程序的进程，都会调用<code>CreateProcessW</code>系统API，而不使用<code>CreateProcessAsUserW</code>系统API。同时在cmd终端进程下，启动外部指令程序所调用的系统API一般为<code>CreateProcessInternalW</code>。</p>
<p>接着将进程运行的结果信息以流的形式返回，最终完成PHP命令执行函数的整个调用过程。</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">if</span> <span class="token punctuation">(</span>read<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fno <span class="token operator">=</span> <span class="token function">_open_osfhandle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tsrm_intptr_t<span class="token punctuation">)</span>in<span class="token punctuation">,</span> _O_RDONLY <span class="token operator">|</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        fno <span class="token operator">=</span> <span class="token function">_open_osfhandle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tsrm_intptr_t<span class="token punctuation">)</span>out<span class="token punctuation">,</span> _O_WRONLY <span class="token operator">|</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    stream <span class="token operator">=</span> <span class="token function">_fdopen</span><span class="token punctuation">(</span>fno<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    proc<span class="token operator">-></span>prochnd <span class="token operator">=</span> process<span class="token punctuation">.</span>hProcess<span class="token punctuation">;</span>
    proc<span class="token operator">-></span>stream <span class="token operator">=</span> stream<span class="token punctuation">;</span>
    <span class="token keyword">return</span> stream<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理，按照上述整个审计思路，可整理出PHP常见命令执行函数在Windows平台下的底层调用链</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201217160349644.png" alt="image-20201217160349644"></p>
<h3 id="动态审计"><a href="#动态审计" class="headerlink" title="动态审计"></a>动态审计</h3><p>有了上面<code>静态审计</code>部分的分析，后续进行动态调试会很方便。这里同样以<code>system()</code>函数执行<code>whoami</code>指令为例来进行动态调试，其它函数调试原理类似。</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// test.php</span>

<span class="token delimiter">&lt;?php</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"whoami"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>ext/standard/exec.c:265</code>中对system()函数实现入口处下断点，F5启动调试，运行至断点处</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216014553863.png" alt="image-20201216014553863"></p>
<p>F11步入函数<code>php_exec_ex(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1)</code>内部：<code>ext\standard\exec.c:209</code></p>
<p><code>php_exec_ex()</code>对cmd参数初始化处理后调用<code>php_exec(mode, cmd, NULL, return_value)</code>函数</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216015035032.png" alt="image-20201216015035032"></p>
<p>F11步入<code>php_exec()</code>函数：<code>ext\standard\exec.c:97</code>，<code>php_exec()</code>函数会传入cmd指令调用<code>VCWD_POPEN()</code>函数</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216015535875.png" alt="image-20201216015535875"></p>
<p>F11步入<code>VCWD_POPEN()</code>函数实现：</p>
<pre><code>#define VCWD_POPEN(command, type) virtual_popen(command, type)

Zend\zend_virtual_cwd.h:269</code></pre><p>由于<code>VCWD_POPEN</code>函数为<code>virtual_popen</code>实现，直接进入<code>virtual_popen()</code>函数实现：<code>Zend\zend_virtual_cwd.c:1831</code></p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216015758546.png" alt="image-20201216015758546"></p>
<p><code>virtual_popen()</code>函数将cmd指令、当前工作空间等参数传给<code>popen_ex(command, type, CWDG(cwd).cwd, NULL)</code>函数执行返回。</p>
<p>F11步入<code>popen_ex()</code>函数实现：<code>TSRM\tsrm_win32.c:473</code></p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216020123582.png" alt="image-20201216020123582"></p>
<p>跟进<code>popen_ex()</code>函数，对cmd进行动态分配空间及赋值</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216020304963.png" alt="image-20201216020304963"></p>
<p>从cmd赋值的结果上来看，命令执行函数执行命令由底层调用cmd.exe来执行相应系统指令(内部|外部)。</p>
<p>后续调用<code>CreateProcessW()</code>系统API来启动cmd.exe进程，执行相应的指令即可。</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216020932675.png" alt="image-20201216020932675"></p>
<p>查看函数之间的调用栈</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216021745090.png" alt="image-20201216021745090"></p>
<p>如果单纯的是想知道某个命令执行函数是否调用cmd.exe终端去执行系统指令的话，可以在php脚本里面写一个循环，然后观察进程创建情况即可：简单、粗暴。</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216022726906.png" alt="image-20201216022726906"></p>
<h1 id="PHP-for-Linux"><a href="#PHP-for-Linux" class="headerlink" title="PHP for Linux"></a>PHP for Linux</h1><p>针对Linux平台下：PHP命令执行函数的底层分析。</p>
<h2 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h2><p>环境部署情况：</p>
<ul>
<li><p>Linux (kali-linux-2020.4-amd64)</p>
</li>
<li><p>Visual Studio Code (code-stable-x64-1605051992)</p>
</li>
<li><p>PHP Source Code (PHP 7.2.9)</p>
</li>
<li><p>Make (GNU Make 4.3 Built for x86_64-pc-linux-gnu)</p>
</li>
<li><p>GDB (GNU gdb (Debian 10.1-1+b1) 10.1)</p>
</li>
<li><p>Source Insight (Windows Source Insight 4.0)</p>
</li>
</ul>
<h3 id="Visual-Studio-Code-1"><a href="#Visual-Studio-Code-1" class="headerlink" title="Visual Studio Code"></a>Visual Studio Code</h3><p><code>Visual Studio Code</code> 常用于不同语言的项目开发、源代码编辑调试等工作。</p>
<ul>
<li>官网：介绍、下载</li>
</ul>
<pre><code>https://code.visualstudio.com/</code></pre><p>下载deb免安装版本类别，之后解压并配置环境变量</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 下载解压</span>
<span class="token function">tar</span> -zxvf code-stable-x64-1605051992.tar.gz

<span class="token comment" spellcheck="true"># 配置环境变量</span>
vim ~/.bashrc
<span class="token function">export</span> PATH<span class="token operator">=</span><span class="token string">"/mnt/hgfs/QSec/Pentest/Red-Team/神兵利器/Windows/VSCode/VSCode-linux-x64:<span class="token variable">$PATH</span>"</span>

<span class="token comment" spellcheck="true"># 启动文件重命名</span>
<span class="token function">cd</span> VSCode-linux-x64
<span class="token function">mv</span> code vscode<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试使用</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201120182818694.png" alt="image-20201120182818694"></p>
<ul>
<li>添加相应扩展：c/c++扩展、代码辅助运行扩展</li>
</ul>
<pre><code>C/C++
Code Runner</code></pre><h3 id="PHP-Source-Code-1"><a href="#PHP-Source-Code-1" class="headerlink" title="PHP Source Code"></a>PHP Source Code</h3><ul>
<li>PHP官方各个版本源代码下载</li>
</ul>
<pre><code>https://www.php.net/releases/
or
https://github.com/php/php-src/releases</code></pre><p>这里下载的版本为：<code>PHP 7.2.9</code></p>
<h3 id="Make"><a href="#Make" class="headerlink" title="Make"></a>Make</h3><p>代码变成可执行文件，叫做编译(compile)，同C编译型语言，由c代码编译生成可执行文件(PE、ELF)；先编译这个，还是先编译那个（即编译的安排），叫做<a href="http://en.wikipedia.org/wiki/Software_build" target="_blank" rel="noopener">构建</a>（build）。</p>
<p><a href="http://en.wikipedia.org/wiki/Make_(software)" target="_blank" rel="noopener">Make</a>是最常用的构建工具，诞生于1977年，主要用于C语言的项目。但是实际上 ，任何只要某个文件有变化，就要重新构建的项目，都可以用Make构建。</p>
<p>有关Make资料可参考：<a href="https://gist.github.com/isaacs/62a2d1825d04437c6f08" target="_blank" rel="noopener">《Makefile文件教程》</a>、<a href="https://www.gnu.org/software/make/manual/make.html" target="_blank" rel="noopener">《GNU Make手册》</a>、<a href="https://www.w3cschool.cn/mexvtg/" target="_blank" rel="noopener">《Make 命令教程》</a></p>
<pre class="line-numbers language-bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># make -v </span>
GNU Make 4.3
为 x86_64-pc-linux-gnu 编译
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> 1988-2020 Free Software Foundation, Inc.
许可证：GPLv3+：GNU 通用公共许可证第 3 版或更新版本<span class="token operator">&lt;</span>http://gnu.org/licenses/gpl.html<span class="token operator">></span>。
本软件是自由软件：您可以自由修改和重新发布它。
在法律允许的范围内没有其他保证。

┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h3><h4 id="基础介绍"><a href="#基础介绍" class="headerlink" title="基础介绍"></a>基础介绍</h4><p>GDB是一个由GNU开源组织发布的、UNIX/LINUX操作系统下的、基于命令行的、功能强大的程序调试工具。 它使您可以查看一个程序正在执行时的状态或该程序崩溃时正在执行的操作。</p>
<p>官方：介绍、Wiki</p>
<ul>
<li><a href="http://www.gnu.org/software/gdb" target="_blank" rel="noopener">GDB: The GNU Project Debugger</a></li>
<li><a href="https://sourceware.org/gdb/wiki/" target="_blank" rel="noopener">Welcome to the GDB Wiki</a></li>
</ul>
<p>支持语言：</p>
<pre class="line-numbers language-ini"><code class="language-ini">Ada
Assembly
C
C++
D
Fortran
Go
Objective-C
OpenCL
Modula-2
Pascal
Rust<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看GDB调试窗口布局</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216143802216.png" alt="image-20201216143802216"></p>
<h4 id="命令列表"><a href="#命令列表" class="headerlink" title="命令列表"></a>命令列表</h4><ul>
<li>Tab键两次补全显示所有指令</li>
</ul>
<p><img src="/2020/12/01/command-execution-research-php/image-20201209094753797.png" alt="image-20201209094753797"></p>
<ul>
<li>help all 显示所有指令（带注解）</li>
</ul>
<p><img src="/2020/12/01/command-execution-research-php/image-20201209100212848.png" alt="image-20201209100212848"></p>
<h4 id="命令详解"><a href="#命令详解" class="headerlink" title="命令详解"></a>命令详解</h4><p>通过GDB帮助手册总结以下常用调试指令：</p>
<p><strong>《调试程序》</strong></p>
<ul>
<li>gdb binary_file_path：使用gdb载入binary_file_path指定的程序进行调试。</li>
<li>gdb –pid PID：使用gdb attach到指定pid的进程进行调试。</li>
<li>gdb $ file binary_file_path：在gdb中载入binary_file_path指定的程序进行调试。</li>
</ul>
<p><strong>《帮助指令》</strong></p>
<ul>
<li>help command：查看gdb下command指令的帮助信息。</li>
</ul>
<p><strong>《运行指令》</strong></p>
<ul>
<li>start：运行被调试的程序，断在程序入口-main函数，可带参数。</li>
<li>run（简写 r）: 运行被调试的程序。 如果此前没有下过断点，则执行完整个程序；如果有断点，则程序暂停在第一个可用断点处，等待用户输入下一步命令。</li>
<li>continue（简写 c） : 继续执行，到下一个断点停止（或运行结束）</li>
<li>next（简写 n） : <strong>C语言级的断点定位</strong>。相当于其它调试器中的“<strong>Step Over (单步跟踪)</strong>”。单步跟踪程序，当遇到函数调用时，也不进入此函数体；此命令同 step 的主要区别是，step 遇到用户自定义的函数，将步进到函数中去运行，而 next 则直接调用函数，不会进入到函数体内。</li>
<li>step （简写 s）：<strong>C语言级的断点定位</strong>。相当于其它调试器中的“<strong>Step Into (单步跟踪进入)</strong>”。单步调试如果有函数调用，则进入函数；与命令n不同，n是不进入调用的函数体。【<strong>前提： s会进入C函数内部，但是不会进入没有定位信息的函数（比如没有加-g编译的代码，因为其没有C代码的行数标记，没办法定位）。（比如：调试编译PHP内核源码，然后调试php代码底层实现，跟踪到了libc函数后，由于libc没有标记信息，导致s或n之后直接打印输出完成程序的调试）</strong>】</li>
<li>nexti（简写 ni）：Next one instruction exactly。<strong>汇编级别的断点定位</strong>。作用和next指令相同，只是单步跟踪汇编代码，碰到call调用，不会进入汇编函数体。</li>
<li>stepi（简写 si）：Step one instruction exactly。<strong>汇编级别的断点定位</strong>。作用和step指令相同，只是单步跟踪汇编代码，碰到call调用，会进入汇编函数体。【<strong>前提：当要进入没有调试信息的库函数调试的时候，用si是唯一的方法。当进入有调试信息的函数，用si和s都可以进入函数体，但是他们不同，si是定位到汇编级别的第一个语句，但是s是进入到C级别的第一个语句。</strong>】</li>
<li>until（简写 u）：<strong>跳出当前循环</strong>。当你厌倦了在一个循环体内单步跟踪时，这个命令可以运行程序直到退出循环体。</li>
<li>until n（简写 u n）：运行至第n行，不仅仅用来跳出循环。</li>
<li>finish：<strong>跳出当前函数</strong>。运行程序，直到当前函数完成返回，并打印函数返回时的堆栈地址和返回值及参数值等信息。</li>
<li>return：<strong>跳出当前函数</strong>。忽略之后的语句，强制函数返回。</li>
<li>call function(arg)：调用程序中可见的函数，并传递“参数”，如：call gdb_test(55)。</li>
<li>quit（简写 q）：退出GDB调试环境。</li>
</ul>
<p><strong>《断点指令》</strong></p>
<ul>
<li><p>break, brea, bre, br, b：<strong>设置断点</strong>。break设置断点对象包括：行号、函数、地址等。</p>
<ul>
<li><p>break n（简写 b n）：在第n行处设置断点（可以带上代码路径和代码名称：b OAGUPDATE.cpp:578）</p>
</li>
<li><p>break function（简写 b function）：在函数function()的入口处设置断点，如：break cb_button。</p>
</li>
<li><p>break *function（简写 b *function）：将断点设置在“由编译器生成的prolog代码处”。</p>
</li>
<li><p>break *address（简写 b *address）：在指定地址下断点（地址必须是可执行代码段）</p>
</li>
</ul>
</li>
<li><p>catch event：<strong>设置捕捉点</strong>。捕捉点用来补捉程序运行时的一些事件。如：载入共享库（动态链接库）、C++的异常、新的进程、系统调用等。</p>
<ul>
<li><p>catch fork、vfork、exec：捕捉新创建的进程事件，对新进程继续调试。</p>
</li>
<li><p>catch syscall &lt;names|SyscallNumbers&gt;：捕捉系统调用事件。（比如：创建新的进程事件，在libc中由execve()函数调用内核入口{系统调用号对应的系统内核调用函数}进行创建）（catch syscall execve）（捕捉execve()系统调用事件）（catch syscall 59）</p>
</li>
</ul>
</li>
<li><p>info breakpoints（简写 info b、i b） ：查看当前程序设置的断点列表信息。</p>
</li>
<li><p>disable：对已设置的特定断点使其失效（可使用info b指令查看Enb列情况）。</p>
<ul>
<li>disable index：使第index个断点失效。</li>
<li>disable breakpoints：使所有断点失效。</li>
</ul>
</li>
<li><p>enable：对已设置失效的特定断点使其生效（默认调试设置的断点是生效的）（可使用info b指令查看Enb列情况）。</p>
<ul>
<li><p>enable index：使第index个断点生效。</p>
</li>
<li><p>enable breakpoints：使所有断点生效。</p>
</li>
</ul>
</li>
<li><p>watchpoint：<strong>设置观察点</strong>。</p>
<ul>
<li><p>watch expression：当表达式被写入，并且值被改变时中断。</p>
</li>
<li><p>rwatch expression：当表达式被读时中断。</p>
</li>
<li><p>awatch expression：当表达式被读或写时中断。</p>
</li>
</ul>
</li>
<li><p>delete：删除breakpoints、display等设置的信息。</p>
<ul>
<li><p>delete index（简写 d index）：删除指定断点（index可使用info b查看）。</p>
</li>
<li><p>delete breakpoints（简写 d breakpoints）：删除所有断点，包括 断点、捕捉点、观察点。</p>
</li>
</ul>
</li>
</ul>
<p><strong>《文件指令》</strong></p>
<ul>
<li><p>list、l：<strong>源代码显示</strong>。</p>
<ul>
<li>list（简写l）：列出当前程序执行处的源代码，默认每次显示10行。</li>
</ul>
</li>
<li><p>list line（简写l line）：将显示当前文件以“行号 line”为中心的前后10行代码，如：list 12。</p>
<ul>
<li>list function（简写l function）：将显示当前文件“函数名”所在函数的源代码，如：list main。</li>
</ul>
</li>
<li><p>list file_path:line_number：将显示指定file_path的文件，以line_number行为中心的前后10行源代码。</p>
<ul>
<li>list（简写l）：不带参数，将接着上一次 list 命令的，输出下边的内容。</li>
</ul>
</li>
<li><p>disassemble：<strong>汇编代码显示</strong>。列出当前程序执行处的汇编代码。</p>
</li>
<li><p>cd：切换工作目录。</p>
</li>
<li><p>file binary_file_path：在gdb中载入binary_file_path指定的程序进行调试。</p>
</li>
<li><p>pwd：查看工作目录。</p>
</li>
<li><p>edit：编辑当前程序所运行到的文件或源码。</p>
</li>
<li><p>dump filename addr1 addr2：dump指定内存到文件中，dump命令之后还会跟一些其他指令用于特定的操作，具体可到GDB中查看。</p>
</li>
</ul>
<p><strong>《数据指令》</strong></p>
<ul>
<li><p>print、inspect、p：打印表达式的值。</p>
<ul>
<li>print expression（简写 p expression）：其中“表达式”可以是任何当前正在被测试程序的有效表达式，比如当前正在调试C语言的程序，那么“表达式”可以是任何C语言的有效表达式，包括数字，变量甚至是函数调用。</li>
</ul>
</li>
<li><p>print a（简写 p a）：将显示整数 a 的值。</p>
<ul>
<li>print ++a（简写 p ++a）：将把 a 中的值加1，并显示出来。</li>
</ul>
</li>
<li><p>print name（简写 p name）：将显示字符串 name 的值。</p>
<ul>
<li>print gdb_test(22)（简写 p gdb_test(22)）：将以整数22作为参数调用 gdb_test() 函数。</li>
</ul>
</li>
<li><p>print gdb_test(a)（简写 p gdb_test(a)）：将以变量 a 作为参数调用 gdb_test() 函数。</p>
<ul>
<li>print *argv@70（简写 p *argv@70）：打印指针argv的值以数组形式显示。</li>
</ul>
</li>
<li><p>display：随程序的单步调试，在上下文中打印表达式的值。</p>
<ul>
<li><p>display expression：在单步运行时将非常有用，使用display命令设置一个表达式后，它将在每次单步进行指令后，紧接着输出被设置的表达式及值。如：display a。（<strong>在当前设置的文件或程序上下文中，相当于实时跟踪被设置的表达式的变化情况，每单步执行调试一次程序，都会执行显示一次display设置的表达式的结果</strong>）。</p>
</li>
<li><p>info display（简写 i display）：查看display设置要查询的表达式列表信息。</p>
</li>
<li><p>delete display n（简写 d diplay n）：删除display设置要查询的第n个表达式。</p>
</li>
<li><p>delete display（简写 d display）： 删除所有display设置要查询的表达式。</p>
</li>
</ul>
</li>
<li><p>x/nf address|寄存器($esi $rsi等)：打印指定地址开始n个单元的的内存数据，f可表示单元大小（x为默认大小，b为一个字节，h为双字节，wx为四字节，gx为八字节，i表示查看指令(汇编)，c表示查看字符，s表示查看字符串）</p>
<ul>
<li>x/x 0x7fffffffdfc8：显示地址0x7fffffffdfc8（指针）指向的地址。</li>
<li>x/x $rsi：显示寄存器$rsi指向的地址。</li>
<li>x/74s 0x7fffffffe307：以字符串形式打印地址0x7fffffffe307所存储的74个数据(数组长度74)。</li>
<li>x/10i 0x7fffffffe307：打印地址0x7fffffffe307处的10条汇编指令。</li>
</ul>
</li>
<li><p>find expr：在当前进程内存搜索expr的值，可以是整数或是字符串（在peda下使用，对应pwndbg的命令是search）。</p>
</li>
<li><p>set {type} $reg/mem=expr：设置对应寄存器或内存指向的值为expr，type可为int、long long等。</p>
</li>
<li><p>set $reg=expr：设置对应寄存器的值为expr。</p>
</li>
</ul>
<p><strong>《状态指令》</strong></p>
<ul>
<li>info program（简写 i program）：查看程序是否在运行，进程号，被暂停的原因等。</li>
<li>backtrace, where, bt, info stack, i stack, i s：显示当前上下文堆栈调用情况（常用于回溯跟踪，pwndbg可直接在工作窗口显示）</li>
<li>thread apply all bt：查看所用线程堆栈调用信息。</li>
<li>info locals（简写 i locals）：显示当前堆栈页的所有变量。</li>
<li>info functions sefunction：查询函数sefunction的信息（函数定义实现的位置信息：文件、行号、代码）。</li>
<li>stack n: 显示n个单元的栈信息。</li>
</ul>
<p><strong>《扩展指令》</strong></p>
<ul>
<li>peda/pwndbg：查看可用命令（使用对应插件时使用）</li>
</ul>
<h4 id="插件辅助"><a href="#插件辅助" class="headerlink" title="插件辅助"></a>插件辅助</h4><p>GDB调试常用插件：peda、pwndbg、gef，每次启动GDB只能加载一个插件，针对多个插件的处理可以写一个启动选择脚本或者在gdb的配置文件中手动生效某个插件（看个人习惯）。</p>
<p><strong>peda</strong></p>
<ul>
<li>安装</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/longld/peda.git ~/peda
<span class="token keyword">echo</span> <span class="token string">"source ~/peda/peda.py"</span> <span class="token operator">>></span> ~/.gdbinit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>关闭peda插件因每次启动使用而自动生成session文件</li>
</ul>
<p>在peda目录下，<code>cd lib</code>进入<code>lib</code>目录，在config.py里找到autosave选项，然后找到on这个词，改成off，即可关闭。</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201204223737437.png" alt="image-20201204223737437"></p>
<p><strong>pwndbg</strong></p>
<ul>
<li>安装</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/pwndbg/pwndbg
<span class="token function">cd</span> pwndbg
./setup.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>gef</strong></p>
<ul>
<li>安装</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">wget</span> -O ~/gdbinit-gef.py --no-check-certificate http://gef.blah.cat/py
$ <span class="token keyword">echo</span> <span class="token function">source</span> ~/gdbinit-gef.py <span class="token operator">>></span> ~/.gdbinit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="Glibc"><a href="#Glibc" class="headerlink" title="Glibc"></a>Glibc</h3><p><strong>1、基础介绍</strong></p>
<p><code>GNU C</code>库项目提供了<code>GNU</code>系统和<code>GNU/Linux</code>系统以及使用Linux作为内核的许多其他系统的核心库。这些库提供了关键的API，包括ISO C11，POSIX.1-2008，BSD，特定于操作系统的API等。</p>
<p>官方：介绍、Wiki</p>
<ul>
<li><p><a href="http://www.gnu.org/software/libc/" target="_blank" rel="noopener">The GNU C Library (glibc)</a></p>
</li>
<li><p><a href="https://sourceware.org/glibc/wiki/HomePage" target="_blank" rel="noopener">Glibc Wiki</a></p>
</li>
</ul>
<p><strong>2、系统查看</strong></p>
<ul>
<li>查看系统信息：GNU/Linux</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :/<span class="token comment" spellcheck="true"># uname -a</span>
Linux toor 5.9.0-kali1-amd64 <span class="token comment" spellcheck="true">#1 SMP Debian 5.9.1-1kali2 (2020-10-29) x86_64 GNU/Linux</span>
 → Qftm :/<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Debian下查看共享链接库</li>
</ul>
<p>查看共享链接库版本信息</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># dpkg -l libc6 </span>
Desired<span class="token operator">=</span>Unknown/Install/Remove/Purge/Hold
<span class="token operator">|</span> Status<span class="token operator">=</span>Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
<span class="token operator">|</span>/ Err?<span class="token operator">=</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span>/Reinst-required <span class="token punctuation">(</span>Status,Err: uppercase<span class="token operator">=</span>bad<span class="token punctuation">)</span>
<span class="token operator">||</span>/ Name           Version      Architecture Description
+++-<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>-<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>-<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>-<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
ii  libc6:amd64    2.31-5       amd64        GNU C Library: Shared libraries
 → Qftm :~/Desktop<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编写简单的C程序来查看系统的动态链接库位置</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello World!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译运行</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm ← :~/桌面<span class="token comment" spellcheck="true"># gcc te.c -o te</span>
 → Qftm ← :~/桌面<span class="token comment" spellcheck="true"># ./te</span>
Hello World<span class="token operator">!</span>
 → Qftm ← :~/桌面<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看系统的动态链接库位置</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm ← :~/桌面<span class="token comment" spellcheck="true"># ldd te</span>
    linux-vdso.so.1 <span class="token punctuation">(</span>0x00007ffee03a7000<span class="token punctuation">)</span>
    libc.so.6 <span class="token operator">=</span><span class="token operator">></span> /lib/x86_64-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0x00007fc1bf9b2000<span class="token punctuation">)</span>
    /lib64/ld-linux-x86-64.so.2 <span class="token punctuation">(</span>0x00007fc1bfb8d000<span class="token punctuation">)</span>
 → Qftm ← :~/桌面<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>3、在线源码</strong></p>
<p>woboq提供的项目，可以在线查看glibc源代码</p>
<pre><code>https://code.woboq.org/userspace/glibc/</code></pre><p><strong>4、源码下载</strong></p>
<p>各版本glibc源码下载地址</p>
<pre><code>官方镜像仓库：http://ftp.gnu.org/gnu/glibc/

华中科技大学镜像仓库：http://mirror.hust.edu.cn/gnu/glibc/</code></pre><p>由于测试系统Glibc版本为2.31，所以这里下载<code>glibc-2.31</code>源代码项目，后续底层审计分析需要用到。</p>
<h3 id="Source-Insigh"><a href="#Source-Insigh" class="headerlink" title="Source Insigh"></a>Source Insigh</h3><p>在Windows平台使用<code>Source Insight 4</code>进行PHP内核源码的审计工作，具体参考上述<code>PHP for Windows</code>部分介绍。</p>
<h2 id="源码编译-1"><a href="#源码编译-1" class="headerlink" title="源码编译"></a>源码编译</h2><p>进入php7.2.9源码项目中，先构建生成<code>configure</code>文件：默认官方下载的源码项目中包含<code>configure</code>，这里为了避免出现不必要的错误，采取强制重新生成<code>configure</code>文件。</p>
<pre class="line-numbers language-bash"><code class="language-bash">~/php-7.2.9-linux-debug<span class="token comment" spellcheck="true"># ./buildconf --force</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>生成configure脚本文件后，就可以开始编译了。为了调式PHP源码，这里同<code>PHP for Windows</code>部分，编译disable所有的扩展（除了一些必须包含的），使用下面的命令来完成编译安装的工作，安装的路径为<code>/mnt/hgfs/QSec/Code-Audit/PHP/PHP-Source-Code/php-7.2.9-linux-debug/Debug</code>：</p>
<pre class="line-numbers language-bash"><code class="language-bash">~/php-7.2.9-linux-debug<span class="token comment" spellcheck="true"># ./configure --disable-all --enable-debug --prefix=/mnt/hgfs/QSec/Code-Audit/PHP/PHP-Source-Code/php-7.2.9-linux-debug/Debug</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
~/php-7.2.9-linux-debug<span class="token comment" spellcheck="true"># make -j4</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
~/php-7.2.9-linux-debug<span class="token comment" spellcheck="true"># make install</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这里的<code>prefix</code>的参数必须为绝对路径，所以不能写成<code>./Debug</code>这类形式。需要注意一下，这里是以调试模式在编译PHP内核源码，所以需要设置一下<code>prefix</code>参数，不然PHP会被安装到系统默认路径中，影响后续的调试。另外两个编译参数，一个是<code>--disable-all</code>，这个表示禁止安装所有扩展（除了一个必须安装的），另外一个就是<code>--enable-debug</code>，这个选项表示以debug模式编译PHP源码，相当于<code>gcc</code>的<code>-g</code>选项编译c代码，它会把调试信息编译进最终的二进制程序中以方便对程序的调试。</p>
<p>上面的命令<code>make -jN</code>，N表示你的CPU数量（或者是CPU核心的数量），设置了这个参数后就可以使用多个CPU进行并行编译，这可以提高编译效率。</p>
<p>编译完成后，最终用于调式的PHP二进制可执行程序会安装在<code>./Debug</code>这个文件夹中。</p>
<p>查看编译的php.exe</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :/mnt/hgfs/QSec/Code-Audit/PHP/PHP-Source-Code/php-7.2.9-linux-debug/Debug/bin<span class="token comment" spellcheck="true"># ./php -v</span>
PHP 7.2.9 <span class="token punctuation">(</span>cli<span class="token punctuation">)</span> <span class="token punctuation">(</span>built: Nov 20 2020 01:34:01<span class="token punctuation">)</span> <span class="token punctuation">(</span> NTS DEBUG <span class="token punctuation">)</span>
Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 1997-2018 The PHP Group
Zend Engine v3.2.0, Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 1998-2018 Zend Technologies
 → Qftm :/mnt/hgfs/QSec/Code-Audit/PHP/PHP-Source-Code/php-7.2.9-linux-debug/Debug/bin<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="源码调试-1"><a href="#源码调试-1" class="headerlink" title="源码调试"></a>源码调试</h2><h3 id="Visual-Studio-Code-2"><a href="#Visual-Studio-Code-2" class="headerlink" title="Visual Studio Code"></a>Visual Studio Code</h3><p>同<code>PHP for Windows-&gt;源码调试</code>创建相应的<code>launch.json</code>调试配置文件，修改配置如下</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
    <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Linux PHP7.2.9 Source Code Debug"</span><span class="token punctuation">,</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cppdbg"</span><span class="token punctuation">,</span>
            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>
            <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"${workspaceRoot}/Debug/bin/php"</span><span class="token punctuation">,</span>
            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"${file}"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"stopAtEntry"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">"cwd"</span><span class="token operator">:</span> <span class="token string">"${workspaceRoot}/Debug/bin"</span><span class="token punctuation">,</span>
            <span class="token property">"environment"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"externalConsole"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">"MIMode"</span><span class="token operator">:</span> <span class="token string">"gdb"</span><span class="token punctuation">,</span>
            <span class="token property">"miDebuggerPath"</span><span class="token operator">:</span> <span class="token string">"/bin/gdb"</span><span class="token punctuation">,</span>
            <span class="token property">"setupCommands"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Enable pretty-printing for gdb"</span><span class="token punctuation">,</span>
                    <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"-enable-pretty-printing"</span><span class="token punctuation">,</span>
                    <span class="token property">"ignoreFailures"</span><span class="token operator">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PS：注意这里需要存在扩展 <code>C/C++</code>。</p>
<p>打开<code>php-7.2.9-linux-debug/sapi/cli/php_cli.c</code>源文件，定位到1200行的main函数内打上断点。【在想要调试的源代码特定位置上打上特定的断点即可】</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201203005059563.png" alt="image-20201203005059563"></p>
<h3 id="GDB-1"><a href="#GDB-1" class="headerlink" title="GDB"></a>GDB</h3><p>进入编译好的PHP可执行文件目录下</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> Debug/bin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>加载待调式的PHP文件</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># gdb --args ./php -f test1.php      </span>

GNU gdb <span class="token punctuation">(</span>Debian 10.1-1+b1<span class="token punctuation">)</span> 10.1
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> 2020 Free Software Foundation, Inc.                                                                                                                              
License GPLv3+: GNU GPL version 3 or later <span class="token operator">&lt;</span>http://gnu.org/licenses/gpl.html<span class="token operator">></span>
This is <span class="token function">free</span> software: you are <span class="token function">free</span> to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type <span class="token string">"show copying"</span> and <span class="token string">"show warranty"</span> <span class="token keyword">for</span> details.
This GDB was configured as <span class="token string">"x86_64-linux-gnu"</span><span class="token keyword">.</span>
Type <span class="token string">"show configuration"</span> <span class="token keyword">for</span> configuration details.
For bug reporting instructions, please see:
<span class="token operator">&lt;</span>https://www.gnu.org/software/gdb/bugs/<span class="token operator">></span>.
Find the GDB manual and other documentation resources online at:
    <span class="token operator">&lt;</span>http://www.gnu.org/software/gdb/documentation/<span class="token operator">></span>.

For help, <span class="token function">type</span> <span class="token string">"help"</span><span class="token keyword">.</span>
Type <span class="token string">"apropos word"</span> to search <span class="token keyword">for</span> commands related to <span class="token string">"word"</span><span class="token punctuation">..</span>.
pwndbg: loaded 188 commands. Type pwndbg <span class="token punctuation">[</span>filter<span class="token punctuation">]</span> <span class="token keyword">for</span> a list.
pwndbg: created <span class="token variable">$rebase</span>, <span class="token variable">$ida</span> gdb functions <span class="token punctuation">(</span>can be used with print/break<span class="token punctuation">)</span>
Reading symbols from ./php<span class="token punctuation">..</span>.
pwndbg<span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对程序入口函数下断点，并查看断点信息</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> b main
Breakpoint 1 at 0x46430e: <span class="token function">file</span> /mnt/hgfs/QSec/Code-Audit/PHP/PHP-Source-Code/php-7.2.9-linux-debug/sapi/cli/php_cli.c, line 1216.
pwndbg<span class="token operator">></span> i b
Num     Type           Disp Enb Address            What
1       breakpoint     keep y   0x000000000046430e <span class="token keyword">in</span> main at /mnt/hgfs/QSec/Code-Audit/PHP/PHP-Source-Code/php-7.2.9-linux-debug/sapi/cli/php_cli.c:1216
pwndbg<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行至断点处</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> r<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>单步调式：n、ni、s、si</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> n<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="源码执行-1"><a href="#源码执行-1" class="headerlink" title="源码执行"></a>源码执行</h2><h3 id="任务执行-1"><a href="#任务执行-1" class="headerlink" title="任务执行"></a>任务执行</h3><p>同<code>PHP for Windows-&gt;源码执行-&gt;任务执行</code>创建相应的tasks.json任务文件，修改配置如下</p>
<pre class="line-numbers language-json"><code class="language-json">// tasks.json

<span class="token punctuation">{</span>
    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"2.0.0"</span><span class="token punctuation">,</span>
    <span class="token property">"tasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"Linux php"</span><span class="token punctuation">,</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell"</span><span class="token punctuation">,</span>
            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"/mnt/hgfs/QSec/Code-Audit/PHP/PHP-Source-Code/php-7.2.9-linux-debug/Debug/bin/php"</span><span class="token punctuation">,</span>
            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"${file}"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>任务执行效果</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201123180053762.png" alt="image-20201123180053762"></p>
<h3 id="插件执行-1"><a href="#插件执行-1" class="headerlink" title="插件执行"></a>插件执行</h3><p>除了上方创建任务执行程序外，还可以借助插件<code>code runner</code>更加方便的去执行程序</p>
<p><code>code runner</code>自带的默认对PHP运行的配置规则如下</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token property">"code-runner.executorMap"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">"php"</span><span class="token operator">:</span> <span class="token string">"php"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>默认配置使用的是环境变量中的php去执行的，可以更改设置为自己的php路径【避免与环境变量中其它的php发生冲突】</p>
<p>点击<code>settings-&gt;Extensions-&gt;Run Code configuration-&gt;Executor Map-&gt;Edit in settings.json</code>进行设置</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201123175035603.png" alt="image-20201123175035603"></p>
<p>插件运行效果</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201123175138740.png" alt="image-20201123175138740"></p>
<h2 id="命令执行底层分析-1"><a href="#命令执行底层分析-1" class="headerlink" title="命令执行底层分析"></a>命令执行底层分析</h2><p>同样，针对命令执行函数的底层分析，这里主要采用两种手段去分析：静态审计(静态审计内核源码)、动态审计(动态调试内核源码)。</p>
<h3 id="静态审计-1"><a href="#静态审计-1" class="headerlink" title="静态审计"></a>静态审计</h3><p>接着<code>PHP for Windows-&gt;命令执行底层分析-&gt;静态审计</code>部分，里面写到<code>system、exec、passthru、shell_exec</code>这类命令执行函数原理相同，底层都调用了相同函数<code>VCWD_POPEN()</code>去执行系统指令，<code>VCWD_POPEN()</code>函数由<code>virtual_popen()</code>函数实现。</p>
<p>同时，<code>virtual_popen()</code>函数是作为不同平台的分割点，那么针对Linux平台下的PHP命令执行函数底层实现就可以从这里继续分析。</p>
<p>由于<code>VCWD_POPEN</code>函数为<code>virtual_popen</code>实现，直接进入<code>virtual_popen()</code>函数实现：<code>Zend\zend_virtual_cwd.c:1831</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifdef</span> ZEND_WIN32</span>
CWD_API FILE <span class="token operator">*</span><span class="token function">virtual_popen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* {{{ */</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">popen_ex</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span>
<span class="token macro property">#<span class="token directive keyword">else</span> </span><span class="token comment" spellcheck="true">/* Unix */</span>
CWD_API FILE <span class="token operator">*</span><span class="token function">virtual_popen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* {{{ */</span>
<span class="token punctuation">{</span>
	size_t command_length<span class="token punctuation">;</span>
	<span class="token keyword">int</span> dir_length<span class="token punctuation">,</span> extra <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>command_line<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span>dir<span class="token punctuation">;</span>
	FILE <span class="token operator">*</span>retval<span class="token punctuation">;</span>

	command_length <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>

	dir_length <span class="token operator">=</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd_length<span class="token punctuation">;</span>
	dir <span class="token operator">=</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>dir_length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>dir <span class="token operator">==</span> <span class="token string">'\''</span><span class="token punctuation">)</span> extra<span class="token operator">+</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
		dir<span class="token operator">++</span><span class="token punctuation">;</span>
		dir_length<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	dir_length <span class="token operator">=</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd_length<span class="token punctuation">;</span>
	dir <span class="token operator">=</span> <span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd<span class="token punctuation">;</span>

	ptr <span class="token operator">=</span> command_line <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">emalloc</span><span class="token punctuation">(</span>command_length <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"cd '' ; "</span><span class="token punctuation">)</span> <span class="token operator">+</span> dir_length <span class="token operator">+</span> extra<span class="token operator">+</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token string">"cd "</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"cd "</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"cd "</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CWDG</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">.</span>cwd_length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> DEFAULT_SLASH<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\''</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>dir_length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>dir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token string">'\''</span><span class="token punctuation">:</span>
				<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\''</span><span class="token punctuation">;</span>
				<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\\'</span><span class="token punctuation">;</span>
				<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\''</span><span class="token punctuation">;</span>
				<span class="token comment" spellcheck="true">/* fall-through */</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>dir<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			dir<span class="token operator">++</span><span class="token punctuation">;</span>
			dir_length<span class="token operator">--</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\''</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">';'</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>

	<span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> command<span class="token punctuation">,</span> command_length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	retval <span class="token operator">=</span> <span class="token function">popen</span><span class="token punctuation">(</span>command_line<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">efree</span><span class="token punctuation">(</span>command_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不难发现，针对<code>virtual_popen()</code>函数实现，存在于不同平台，这里主要分析Linux平台。</p>
<p>针对Linux平台分析，可发现<code>virtual_popen()</code>函数不像WIN平台那样直接调用<code>popen_ex()</code>函数，而是自身进行了很多处理，事实上看过<code>PHP for Windows-&gt;命令执行底层分析-&gt;静态审计</code>部分，就会发现Linux平台下的<code>virtual_popen()</code>函数实现和windows中<code>TSRM\tsrm_win32.c</code>下的<code>popen_ex()</code>函数实现功能类似，都是对命令参数、当前工作空间等进行处理(分配空间、赋值)，然后去启动相应的进程来完成命令执行过程。</p>
<p>继续向后跟进分析<code>virtual_popen()</code>函数，最终会调用<code>popen(command_line, type)</code>函数来执行命令。到了这里可能会有人疑惑，这里的<code>popen()</code>函数是谁实现的：是平常php里面用的<code>popen()</code>函数吗、是<code>TSRM\tsrm_win32.c:467</code>中的<code>TSRM_API FILE *popen(const char *command, const char *type)</code>函数吗，答案都是否定的，下面来看一下这几种猜想为什么是错误的。</p>
<p>第一种：php中的<code>popen()</code>函数。首先你要明白，你现在审计的是PHP内核源码，而不是在编写php程序代码。在PHP内核源码中，里面大部分都是定义与实现的PHP各种函数。</p>
<p>有关php中的<code>popen()</code>函数定义与实现在源码<code>ext\standard\file.c:927</code>中</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* {{{ proto resource popen(string command, string mode)
   Execute a command and open either a read or a write pipe to it */</span>
<span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>popen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token operator">*</span>mode<span class="token punctuation">;</span>
	size_t command_len<span class="token punctuation">,</span> mode_len<span class="token punctuation">;</span>
	FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
	php_stream <span class="token operator">*</span>stream<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>posix_mode<span class="token punctuation">;</span>

	<span class="token function">ZEND_PARSE_PARAMETERS_START</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token function">Z_PARAM_PATH</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> command_len<span class="token punctuation">)</span>
		<span class="token function">Z_PARAM_STRING</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> mode_len<span class="token punctuation">)</span>
	<span class="token function">ZEND_PARSE_PARAMETERS_END</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	posix_mode <span class="token operator">=</span> <span class="token function">estrndup</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> mode_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> PHP_WIN32</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">char</span> <span class="token operator">*</span>z <span class="token operator">=</span> <span class="token function">memchr</span><span class="token punctuation">(</span>posix_mode<span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> mode_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">memmove</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> z <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> mode_len <span class="token operator">-</span> <span class="token punctuation">(</span>z <span class="token operator">-</span> posix_mode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	fp <span class="token operator">=</span> <span class="token function">VCWD_POPEN</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> posix_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">php_error_docref2</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> posix_mode<span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">efree</span><span class="token punctuation">(</span>posix_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		RETURN_FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	stream <span class="token operator">=</span> <span class="token function">php_stream_fopen_from_pipe</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>	<span class="token punctuation">{</span>
		<span class="token function">php_error_docref2</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		RETVAL_FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">php_stream_to_zval</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> return_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">efree</span><span class="token punctuation">(</span>posix_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二种：<code>TSRM\tsrm_win32.c:467</code>中的<code>*popen()</code>函数。细心的话你会发现在Linux平台编译下，根本不会去加载编译<code>TSRM\tsrm_win32.c:467</code>文件。</p>
<p>继续分析为什么，首先<code>*popen()</code>函数定义是在<code>TSRM\tsrm_win32.h:104</code>头文件中，那么查看<code>TSRM\tsrm_win32.c</code>文件是否包含该头文件</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216175627871.png" alt="image-20201216175627871"></p>
<p>从包含结果可以发现，<code>TSRM\tsrm_win32.c</code>文件只在Windows平台下才会去包含<code>TSRM\tsrm_win32.h</code>头文件，这就说明在Linux平台下无法加载<code>TSRM\tsrm_win32.c:467</code>中的函数。</p>
<p>既然这两种猜想都不对那么<code>*virtual_popen()</code>中的<code>poen()</code>函数是由谁实现的，如果你对Linux平台熟悉的话，就会知道这里的<code>poen()</code>函数是在Linux下共享链接库<code>glibc</code>中实现的。</p>
<p>借助Windows平台下源码审查工具<code>Source Insight</code>【导入<code>glibc-2.31</code>源码项目】进行底层函数<code>poen()</code>跟踪分析</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201216215603891.png" alt="image-20201216215603891"></p>
<p>搜索整个项目定位<code>popen()</code>函数定义与实现位置：<code>libio\iopopen.c:321</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">strong_alias</span> <span class="token punctuation">(</span>_IO_new_popen<span class="token punctuation">,</span> __new_popen<span class="token punctuation">)</span>
<span class="token function">versioned_symbol</span> <span class="token punctuation">(</span>libc<span class="token punctuation">,</span> _IO_new_popen<span class="token punctuation">,</span> _IO_popen<span class="token punctuation">,</span> GLIBC_2_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">versioned_symbol</span> <span class="token punctuation">(</span>libc<span class="token punctuation">,</span> __new_popen<span class="token punctuation">,</span> popen<span class="token punctuation">,</span> GLIBC_2_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">versioned_symbol</span> <span class="token punctuation">(</span>libc<span class="token punctuation">,</span> _IO_new_proc_open<span class="token punctuation">,</span> _IO_proc_open<span class="token punctuation">,</span> GLIBC_2_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">versioned_symbol</span> <span class="token punctuation">(</span>libc<span class="token punctuation">,</span> _IO_new_proc_close<span class="token punctuation">,</span> _IO_proc_close<span class="token punctuation">,</span> GLIBC_2_1<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上代码片段可以看出，<code>popen()</code>最终的实现为<code>_IO_new_popen()</code>，向上索引找到<code>_IO_new_popen()</code>函数实现：<code>libio\iopopen.c:220</code></p>
<pre class="line-numbers language-c"><code class="language-c">FILE <span class="token operator">*</span>
<span class="token function">_IO_new_popen</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> locked_FILE
  <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> _IO_proc_file fpx<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
    _IO_lock_t lock<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  <span class="token punctuation">}</span> <span class="token operator">*</span>new_f<span class="token punctuation">;</span>
  FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>

  new_f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> locked_FILE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> locked_FILE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>new_f <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
  new_f<span class="token operator">-></span>fpx<span class="token punctuation">.</span>file<span class="token punctuation">.</span>file<span class="token punctuation">.</span>_lock <span class="token operator">=</span> <span class="token operator">&amp;</span>new_f<span class="token operator">-></span>lock<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  fp <span class="token operator">=</span> <span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fpx<span class="token punctuation">.</span>file<span class="token punctuation">.</span>file<span class="token punctuation">;</span>
  <span class="token function">_IO_init_internal</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_JUMPS</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fpx<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>_IO_proc_jumps<span class="token punctuation">;</span>
  <span class="token function">_IO_new_file_init_internal</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fpx<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_new_proc_open</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> command<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fpx<span class="token punctuation">.</span>file<span class="token punctuation">;</span>
  <span class="token function">_IO_un_link</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fpx<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span> <span class="token punctuation">(</span>new_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>_IO_new_popen()</code>函数中，除了变量的定义与处理，核心的地方是将command指令参数传给<code>_IO_new_proc_open (fp, command, mode)</code>函数去实现，所以跟进<code>_IO_new_proc_open()</code>函数实现：<code>libio\iopopen.c:109</code></p>
<pre class="line-numbers language-c"><code class="language-c">FILE <span class="token operator">*</span>
<span class="token function">_IO_new_proc_open</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> read_or_write<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* These are indexes for pipe_fds.  */</span>
  <span class="token keyword">int</span> parent_end<span class="token punctuation">,</span> child_end<span class="token punctuation">;</span>
  <span class="token keyword">int</span> pipe_fds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> child_pipe_fd<span class="token punctuation">;</span>
  bool spawn_ok<span class="token punctuation">;</span>

  <span class="token keyword">int</span> do_read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> do_write <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> do_cloexec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>mode <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>mode<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'r'</span><span class="token punctuation">:</span>
    do_read <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'w'</span><span class="token punctuation">:</span>
    do_write <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'e'</span><span class="token punctuation">:</span>
    do_cloexec <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
      errout<span class="token punctuation">:</span>
    <span class="token function">__set_errno</span> <span class="token punctuation">(</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>do_read <span class="token operator">^</span> do_write<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_file_is_open</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Atomically set the O_CLOEXEC flag for the pipe end used by the
     child process (to avoid leaking the file descriptor in case of a
     concurrent fork).  This is later reverted in the child process.
     When popen returns, the parent pipe end can be O_CLOEXEC or not,
     depending on the 'e' open mode, but there is only one flag which
     controls both descriptors.  The parent end is adjusted below,
     after creating the child process.  (In the child process, the
     parent end should be closed on execve, so O_CLOEXEC remains set
     there.)  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__pipe2</span> <span class="token punctuation">(</span>pipe_fds<span class="token punctuation">,</span> O_CLOEXEC<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>do_read<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      parent_end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      child_end <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      read_or_write <span class="token operator">=</span> _IO_NO_WRITES<span class="token punctuation">;</span>
      child_pipe_fd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
      parent_end <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      child_end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      read_or_write <span class="token operator">=</span> _IO_NO_READS<span class="token punctuation">;</span>
      child_pipe_fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  posix_spawn_file_actions_t fa<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* posix_spawn_file_actions_init does not fail.  */</span>
  <span class="token function">__posix_spawn_file_actions_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>fa<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* The descriptor is already the one the child will use.  In this case
     it must be moved to another one otherwise, there is no safe way to
     remove the close-on-exec flag in the child without creating a FD leak
     race in the parent.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pipe_fds<span class="token punctuation">[</span>child_end<span class="token punctuation">]</span> <span class="token operator">==</span> child_pipe_fd<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">int</span> tmp <span class="token operator">=</span> <span class="token function">__fcntl</span> <span class="token punctuation">(</span>child_pipe_fd<span class="token punctuation">,</span> F_DUPFD_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> spawn_failure<span class="token punctuation">;</span>
      <span class="token function">__close_nocancel</span> <span class="token punctuation">(</span>pipe_fds<span class="token punctuation">[</span>child_end<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pipe_fds<span class="token punctuation">[</span>child_end<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__posix_spawn_file_actions_adddup2</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>fa<span class="token punctuation">,</span> pipe_fds<span class="token punctuation">[</span>child_end<span class="token punctuation">]</span><span class="token punctuation">,</span>
      child_pipe_fd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> spawn_failure<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
  <span class="token function">_IO_cleanup_region_start_noarg</span> <span class="token punctuation">(</span>unlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_lock_lock</span> <span class="token punctuation">(</span>proc_file_chain_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  spawn_ok <span class="token operator">=</span> <span class="token function">spawn_process</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>fa<span class="token punctuation">,</span> fp<span class="token punctuation">,</span> command<span class="token punctuation">,</span> do_cloexec<span class="token punctuation">,</span> pipe_fds<span class="token punctuation">,</span>
                parent_end<span class="token punctuation">,</span> child_end<span class="token punctuation">,</span> child_pipe_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
  <span class="token function">_IO_lock_unlock</span> <span class="token punctuation">(</span>proc_file_chain_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_cleanup_region_end</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  <span class="token function">__posix_spawn_file_actions_destroy</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>fa<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spawn_ok<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    spawn_failure<span class="token punctuation">:</span>
      <span class="token function">__close_nocancel</span> <span class="token punctuation">(</span>pipe_fds<span class="token punctuation">[</span>child_end<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">__close_nocancel</span> <span class="token punctuation">(</span>pipe_fds<span class="token punctuation">[</span>parent_end<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">__set_errno</span> <span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token function">_IO_mask_flags</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> read_or_write<span class="token punctuation">,</span> _IO_NO_READS<span class="token operator">|</span>_IO_NO_WRITES<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> fp<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到<code>_IO_new_proc_open()</code>函数代码开始部分对<code>mode</code>参数进行了处理，接着后面核心代码处调用了<code>spawn_process (&amp;fa, fp, command, do_cloexec, pipe_fds, parent_end, child_end, child_pipe_fd)</code>函数，这个函数很明显看起来和进程有关系，不出意外后续代码的实现与调用肯定是创建command进程相关，进入<code>spawn_process()</code>函数实现：<code>libio\iopopen.c:71</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* POSIX states popen shall ensure that any streams from previous popen()
   calls that remain open in the parent process should be closed in the new
   child process.
   To avoid a race-condition between checking which file descriptors need to
   be close (by transversing the proc_file_chain list) and the insertion of a
   new one after a successful posix_spawn this function should be called
   with proc_file_chain_lock acquired.  */</span>
<span class="token keyword">static</span> bool
<span class="token function">spawn_process</span> <span class="token punctuation">(</span>posix_spawn_file_actions_t <span class="token operator">*</span>fa<span class="token punctuation">,</span> FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span>
           <span class="token keyword">int</span> do_cloexec<span class="token punctuation">,</span> <span class="token keyword">int</span> pipe_fds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> parent_end<span class="token punctuation">,</span> <span class="token keyword">int</span> child_end<span class="token punctuation">,</span>
           <span class="token keyword">int</span> child_pipe_fd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> _IO_proc_file <span class="token operator">*</span>p <span class="token operator">=</span> proc_file_chain<span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">_IO_fileno</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">/* If any stream from previous popen() calls has fileno
     child_pipe_fd, it has been already closed by the adddup2 action
     above.  */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">!=</span> child_pipe_fd
      <span class="token operator">&amp;&amp;</span> <span class="token function">__posix_spawn_file_actions_addclose</span> <span class="token punctuation">(</span>fa<span class="token punctuation">,</span> fd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__posix_spawn</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_proc_file <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token operator">-></span>pid<span class="token punctuation">,</span> _PATH_BSHELL<span class="token punctuation">,</span> fa<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"-c"</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> command<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> __environ<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>

  <span class="token function">__close_nocancel</span> <span class="token punctuation">(</span>pipe_fds<span class="token punctuation">[</span>child_end<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>do_cloexec<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">/* Undo the effects of the pipe2 call which set the
       close-on-exec flag.  */</span>
    <span class="token function">__fcntl</span> <span class="token punctuation">(</span>pipe_fds<span class="token punctuation">[</span>parent_end<span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFD<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">_IO_fileno</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">=</span> pipe_fds<span class="token punctuation">[</span>parent_end<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_proc_file <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token operator">-></span>next <span class="token operator">=</span> proc_file_chain<span class="token punctuation">;</span>
  proc_file_chain <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_proc_file <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">;</span>

  <span class="token keyword">return</span> true<span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里很明显<code>spawn_process()</code>函数的实现是由<code>__posix_spawn()</code>函数来完成的</p>
<pre class="line-numbers language-c"><code class="language-c">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__posix_spawn</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_proc_file <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token operator">-></span>pid<span class="token punctuation">,</span> _PATH_BSHELL<span class="token punctuation">,</span> fa<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"-c"</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> command<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> __environ<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查看<code>_PATH_BSHELL</code>预定义参数值：<code>sysdeps\unix\sysv\linux\paths.h:41</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span>    _PATH_BSHELL    "/bin/sh"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>不难看出PHP命令执行函数传入的系统指令参数，底层将调用<code>/bin/sh</code>可执行程序来执行</p>
<pre class="line-numbers language-bash"><code class="language-bash">/bin/sh -c <span class="token function">command</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：这里的<code>/bin/sh</code>在不同平台中所指向的链接不同。</p>
<p>Linux系统，主要分为debian系（主要有Debian，Ubuntu，Mint等及其衍生版本）和redhat系（主要有RedHat，Fedora，CentOs等），还有其它自由的发布版本。debian系默认<code>/bin/sh</code>指向<code>/bin/dash</code>；redhat系默认<code>/bin/sh</code>指向<code>/bin/bash</code>。</p>
<p>Debian Almquist Shell 简称 dash，主要存在于debian类别的Linux系统中。</p>
<blockquote>
<p>最初，bash是GNU/Linux 操作系统中 /bin/sh 的符号链接，但由于bash过于复杂，有人把 bash 从 NetBSD 移植到  Linux 并更名为 dash，且/bin/sh符号连接到dash。Dash Shell 比 Bash Shell  小的多（ubuntu16.04上，bash大概1M，dash只有150K），符合POSIX标准。Ubuntu 6.10开始默认是Dash。</p>
</blockquote>
<p>跟进<code>__posix_spawn()</code>函数实现：<code>posix\spawn.c:25</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Spawn a new process executing PATH with the attributes describes in *ATTRP.
   Before running the process perform the actions described in FILE-ACTIONS. */</span>
<span class="token keyword">int</span>
<span class="token function">__posix_spawn</span> <span class="token punctuation">(</span>pid_t <span class="token operator">*</span>pid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span>
           <span class="token keyword">const</span> posix_spawn_file_actions_t <span class="token operator">*</span>file_actions<span class="token punctuation">,</span>
           <span class="token keyword">const</span> posix_spawnattr_t <span class="token operator">*</span>attrp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
           <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">__spawni</span> <span class="token punctuation">(</span>pid<span class="token punctuation">,</span> path<span class="token punctuation">,</span> file_actions<span class="token punctuation">,</span> attrp<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>__posix_spawn()</code>函数直接调用<code>__spawni()</code>函数来实现，根据<code>__posix_spawn()</code>函数注释描述可知，该函数功能为创建一个新的可执行程序进程也就是<code>/bin/sh</code>进程。</p>
<p>进入<code>__spawni()</code>函数实现：<code>sysdeps\unix\sysv\linux\spawni.c:424</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Spawn a new process executing PATH with the attributes describes in *ATTRP.
   Before running the process perform the actions described in FILE-ACTIONS. */</span>
<span class="token keyword">int</span>
<span class="token function">__spawni</span> <span class="token punctuation">(</span>pid_t <span class="token operator">*</span> pid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>
      <span class="token keyword">const</span> posix_spawn_file_actions_t <span class="token operator">*</span> acts<span class="token punctuation">,</span>
      <span class="token keyword">const</span> posix_spawnattr_t <span class="token operator">*</span> attrp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> xflags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/* It uses __execvpex to avoid run ENOEXEC in non compatibility mode (it
     will be handled by maybe_script_execute).  */</span>
  <span class="token keyword">return</span> <span class="token function">__spawnix</span> <span class="token punctuation">(</span>pid<span class="token punctuation">,</span> file<span class="token punctuation">,</span> acts<span class="token punctuation">,</span> attrp<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">,</span> xflags<span class="token punctuation">,</span>
            xflags <span class="token operator">&amp;</span> SPAWN_XFLAGS_USE_PATH <span class="token operator">?</span> __execvpex <span class="token punctuation">:</span>__execve<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到<code>__spawni()</code>函数的实现，直接调用<code>__spawnix()</code>函数返回。</p>
<p>查看<code>__spawnix()</code>函数的实现：<code>sysdeps\unix\sysv\linux\spawni.c:312</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Spawn a new process executing PATH with the attributes describes in *ATTRP.
   Before running the process perform the actions described in FILE-ACTIONS. */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">__spawnix</span> <span class="token punctuation">(</span>pid_t <span class="token operator">*</span> pid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>
       <span class="token keyword">const</span> posix_spawn_file_actions_t <span class="token operator">*</span> file_actions<span class="token punctuation">,</span>
       <span class="token keyword">const</span> posix_spawnattr_t <span class="token operator">*</span> attrp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> xflags<span class="token punctuation">,</span>
       <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>exec<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  pid_t new_pid<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> posix_spawn_args args<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ec<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* To avoid imposing hard limits on posix_spawn{p} the total number of
     arguments is first calculated to allocate a mmap to hold all possible
     values.  */</span>
  ptrdiff_t argc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Linux allows at most max (0x7FFFFFFF, 1/4 stack size) arguments
     to be used in a execve call.  We limit to INT_MAX minus one due the
     compatiblity code that may execute a shell script (maybe_script_execute)
     where it will construct another argument list with an additional
     argument.  */</span>
  ptrdiff_t limit <span class="token operator">=</span> INT_MAX <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>argc<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> limit<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
    errno <span class="token operator">=</span> E2BIG<span class="token punctuation">;</span>
    <span class="token keyword">return</span> errno<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

  <span class="token keyword">int</span> prot <span class="token operator">=</span> <span class="token punctuation">(</span>PROT_READ <span class="token operator">|</span> PROT_WRITE
         <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">GL</span> <span class="token punctuation">(</span>dl_stack_flags<span class="token punctuation">)</span> <span class="token operator">&amp;</span> PF_X<span class="token punctuation">)</span> <span class="token operator">?</span> PROT_EXEC <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Add a slack area for child's stack.  */</span>
  size_t argv_size <span class="token operator">=</span> <span class="token punctuation">(</span>argc <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">512</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* We need at least a few pages in case the compiler's stack checking is
     enabled.  In some configs, it is known to use at least 24KiB.  We use
     32KiB to be "safe" from anything the compiler might do.  Besides, the
     extra pages won't actually be allocated unless they get used.  */</span>
  argv_size <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t stack_size <span class="token operator">=</span> <span class="token function">ALIGN_UP</span> <span class="token punctuation">(</span>argv_size<span class="token punctuation">,</span> <span class="token function">GLRO</span><span class="token punctuation">(</span>dl_pagesize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>stack <span class="token operator">=</span> <span class="token function">__mmap</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> stack_size<span class="token punctuation">,</span> prot<span class="token punctuation">,</span>
            MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS <span class="token operator">|</span> MAP_STACK<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>stack <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> errno<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Disable asynchronous cancellation.  */</span>
  <span class="token keyword">int</span> state<span class="token punctuation">;</span>
  <span class="token function">__libc_ptf_call</span> <span class="token punctuation">(</span>__pthread_setcancelstate<span class="token punctuation">,</span>
                   <span class="token punctuation">(</span>PTHREAD_CANCEL_DISABLE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Child must set args.err to something non-negative - we rely on
     the parent and child sharing VM.  */</span>
  args<span class="token punctuation">.</span>err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>exec <span class="token operator">=</span> exec<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>fa <span class="token operator">=</span> file_actions<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>attr <span class="token operator">=</span> attrp <span class="token operator">?</span> attrp <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">const</span> posix_spawnattr_t<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>argv <span class="token operator">=</span> argv<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>argc <span class="token operator">=</span> argc<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>envp <span class="token operator">=</span> envp<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>xflags <span class="token operator">=</span> xflags<span class="token punctuation">;</span>

  <span class="token function">__libc_signal_block_all</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">.</span>oldmask<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* The clone flags used will create a new child that will run in the same
     memory space (CLONE_VM) and the execution of calling thread will be
     suspend until the child calls execve or _exit.

     Also since the calling thread execution will be suspend, there is not
     need for CLONE_SETTLS.  Although parent and child share the same TLS
     namespace, there will be no concurrent access for TLS variables (errno
     for instance).  */</span>
  new_pid <span class="token operator">=</span> <span class="token function">CLONE</span> <span class="token punctuation">(</span>__spawni_child<span class="token punctuation">,</span> <span class="token function">STACK</span> <span class="token punctuation">(</span>stack<span class="token punctuation">,</span> stack_size<span class="token punctuation">)</span><span class="token punctuation">,</span> stack_size<span class="token punctuation">,</span>
           CLONE_VM <span class="token operator">|</span> CLONE_VFORK <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* It needs to collect the case where the auxiliary process was created
     but failed to execute the file (due either any preparation step or
     for execve itself).  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>new_pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">/* Also, it handles the unlikely case where the auxiliary process was
     terminated before calling execve as if it was successfully.  The
     args.err is set to 0 as default and changed to a positive value
     only in case of failure, so in case of premature termination
     due a signal args.err will remain zeroed and it will be up to
     caller to actually collect it.  */</span>
      ec <span class="token operator">=</span> args<span class="token punctuation">.</span>err<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ec <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">/* There still an unlikely case where the child is cancelled after
       setting args.err, due to a positive error value.  Also there is
       possible pid reuse race (where the kernel allocated the same pid
       to an unrelated process).  Unfortunately due synchronization
       issues where the kernel might not have the process collected
       the waitpid below can not use WNOHANG.  */</span>
    <span class="token function">__waitpid</span> <span class="token punctuation">(</span>new_pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
    ec <span class="token operator">=</span> <span class="token operator">-</span>new_pid<span class="token punctuation">;</span>

  <span class="token function">__munmap</span> <span class="token punctuation">(</span>stack<span class="token punctuation">,</span> stack_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ec <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">*</span>pid <span class="token operator">=</span> new_pid<span class="token punctuation">;</span>

  <span class="token function">__libc_signal_restore_set</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">.</span>oldmask<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">__libc_ptf_call</span> <span class="token punctuation">(</span>__pthread_setcancelstate<span class="token punctuation">,</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> ec<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>忽略<code>__spawnix()</code>函数内部变量处理外，核心代码在于调用<code>CLONE()</code>函数，作用为克隆父进程以创建新的子进程。</p>
<pre class="line-numbers language-c"><code class="language-c">  <span class="token comment" spellcheck="true">/* The clone flags used will create a new child that will run in the same
     memory space (CLONE_VM) and the execution of calling thread will be
     suspend until the child calls execve or _exit.

     Also since the calling thread execution will be suspend, there is not
     need for CLONE_SETTLS.  Although parent and child share the same TLS
     namespace, there will be no concurrent access for TLS variables (errno
     for instance).  */</span>
  new_pid <span class="token operator">=</span> <span class="token function">CLONE</span> <span class="token punctuation">(</span>__spawni_child<span class="token punctuation">,</span> <span class="token function">STACK</span> <span class="token punctuation">(</span>stack<span class="token punctuation">,</span> stack_size<span class="token punctuation">)</span><span class="token punctuation">,</span> stack_size<span class="token punctuation">,</span>
           CLONE_VM <span class="token operator">|</span> CLONE_VFORK <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>CLONE()</code>函数实现通常位于<code>sysdeps\unix\sysv\linux\平台架构(arm、i386、x86、x86_64等)\clone.S</code>汇编代码文件中。</p>
<p>由于这里测试的平台为<code>x86_64</code>，所以<code>CLONE()</code>函数实现位置为：<code>sysdeps\unix\sysv\linux\x86_64\clone.S</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Copyright (C) 2001-2020 Free Software Foundation, Inc.
   This file is part of the GNU C Library.

   The GNU C Library is free software; you can redistribute it and/or
   modify it under the terms of the GNU Lesser General Public
   License as published by the Free Software Foundation; either
   version 2.1 of the License, or (at your option) any later version.

   The GNU C Library is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
   Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public
   License along with the GNU C Library; if not, see
   &lt;https://www.gnu.org/licenses/>.  */</span>

<span class="token comment" spellcheck="true">/* clone() is even more special than fork() as it mucks with stacks
   and invokes a function in the right context after its all over.  */</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sysdep.h></span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> _ERRNO_H    1</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;bits/errno.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;asm-syntax.h></span></span>

<span class="token comment" spellcheck="true">/* The userland implementation is:
   int clone (int (*fn)(void *arg), void *child_stack, int flags, void *arg),
   the kernel entry is:
   int clone (long flags, void *child_stack).

   The parameters are passed in register and on the stack from userland:
   rdi: fn
   rsi: child_stack
   rdx:    flags
   rcx: arg
   r8d:    TID field in parent
   r9d: thread pointer
%esp+8:    TID field in child

   The kernel expects:
   rax: system call number
   rdi: flags
   rsi: child_stack
   rdx: TID field in parent
   r10: TID field in child
   r8:    thread pointer  */</span>


        <span class="token punctuation">.</span>text
<span class="token function">ENTRY</span> <span class="token punctuation">(</span>__clone<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">/* Sanity check arguments.  */</span>
    movq    $<span class="token operator">-</span>EINVAL<span class="token punctuation">,</span><span class="token operator">%</span>rax
    testq    <span class="token operator">%</span>rdi<span class="token punctuation">,</span><span class="token operator">%</span>rdi        <span class="token comment" spellcheck="true">/* no NULL function pointers */</span>
    jz    SYSCALL_ERROR_LABEL
    testq    <span class="token operator">%</span>rsi<span class="token punctuation">,</span><span class="token operator">%</span>rsi        <span class="token comment" spellcheck="true">/* no NULL stack pointers */</span>
    jz    SYSCALL_ERROR_LABEL

    <span class="token comment" spellcheck="true">/* Insert the argument onto the new stack.  */</span>
    subq    $<span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">%</span>rsi
    movq    <span class="token operator">%</span>rcx<span class="token punctuation">,</span><span class="token function">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsi<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">/* Save the function pointer.  It will be popped off in the
       child in the ebx frobbing below.  */</span>
    movq    <span class="token operator">%</span>rdi<span class="token punctuation">,</span><span class="token function">0</span><span class="token punctuation">(</span><span class="token operator">%</span>rsi<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">/* Do the system call.  */</span>
    movq    <span class="token operator">%</span>rdx<span class="token punctuation">,</span> <span class="token operator">%</span>rdi
    movq    <span class="token operator">%</span>r8<span class="token punctuation">,</span> <span class="token operator">%</span>rdx
    movq    <span class="token operator">%</span>r9<span class="token punctuation">,</span> <span class="token operator">%</span>r8
    mov    <span class="token function">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>R10_LP
    movl    $<span class="token function">SYS_ify</span><span class="token punctuation">(</span>clone<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span>eax

    <span class="token comment" spellcheck="true">/* End FDE now, because in the child the unwind info will be
       wrong.  */</span>
    cfi_endproc<span class="token punctuation">;</span>
    syscall

    testq    <span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token operator">%</span>rax
    jl    SYSCALL_ERROR_LABEL
    jz    <span class="token function">L</span><span class="token punctuation">(</span>thread_start<span class="token punctuation">)</span>

    ret

<span class="token function">L</span><span class="token punctuation">(</span>thread_start<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cfi_startproc<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Clearing frame pointer is insufficient, use CFI.  */</span>
    <span class="token function">cfi_undefined</span> <span class="token punctuation">(</span>rip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Clear the frame pointer.  The ABI suggests this be done, to mark
       the outermost frame obviously.  */</span>
    xorl    <span class="token operator">%</span>ebp<span class="token punctuation">,</span> <span class="token operator">%</span>ebp

    <span class="token comment" spellcheck="true">/* Set up arguments for the function call.  */</span>
    popq    <span class="token operator">%</span>rax        <span class="token comment" spellcheck="true">/* Function to call.  */</span>
    popq    <span class="token operator">%</span>rdi        <span class="token comment" spellcheck="true">/* Argument.  */</span>
    call    <span class="token operator">*</span><span class="token operator">%</span>rax
    <span class="token comment" spellcheck="true">/* Call exit with return value from function call. */</span>
    movq    <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">%</span>rdi
    movl    $<span class="token function">SYS_ify</span><span class="token punctuation">(</span>exit<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>eax
    syscall
    cfi_endproc<span class="token punctuation">;</span>

    cfi_startproc<span class="token punctuation">;</span>
<span class="token function">PSEUDO_END</span> <span class="token punctuation">(</span>__clone<span class="token punctuation">)</span>

<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__clone<span class="token punctuation">)</span>
<span class="token function">weak_alias</span> <span class="token punctuation">(</span>__clone<span class="token punctuation">,</span> clone<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>审计<code>CLONE()</code>函数实现的<code>clone.S</code>汇编代码，由<code>weak_alias (__clone, clone)</code>可知，<code>clone()</code>函数别名为<code>__clone()</code>函数。</p>
<p>跟进分析<code>__clone()</code>函数的实现</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">ENTRY</span> <span class="token punctuation">(</span>__clone<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">/* Sanity check arguments.  */</span>
    movq    $<span class="token operator">-</span>EINVAL<span class="token punctuation">,</span><span class="token operator">%</span>rax
    testq    <span class="token operator">%</span>rdi<span class="token punctuation">,</span><span class="token operator">%</span>rdi        <span class="token comment" spellcheck="true">/* no NULL function pointers */</span>
    jz    SYSCALL_ERROR_LABEL
    testq    <span class="token operator">%</span>rsi<span class="token punctuation">,</span><span class="token operator">%</span>rsi        <span class="token comment" spellcheck="true">/* no NULL stack pointers */</span>
    jz    SYSCALL_ERROR_LABEL

    <span class="token comment" spellcheck="true">/* Insert the argument onto the new stack.  */</span>
    subq    $<span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">%</span>rsi
    movq    <span class="token operator">%</span>rcx<span class="token punctuation">,</span><span class="token function">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsi<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">/* Save the function pointer.  It will be popped off in the
       child in the ebx frobbing below.  */</span>
    movq    <span class="token operator">%</span>rdi<span class="token punctuation">,</span><span class="token function">0</span><span class="token punctuation">(</span><span class="token operator">%</span>rsi<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">/* Do the system call.  */</span>
    movq    <span class="token operator">%</span>rdx<span class="token punctuation">,</span> <span class="token operator">%</span>rdi
    movq    <span class="token operator">%</span>r8<span class="token punctuation">,</span> <span class="token operator">%</span>rdx
    movq    <span class="token operator">%</span>r9<span class="token punctuation">,</span> <span class="token operator">%</span>r8
    mov    <span class="token function">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>R10_LP
    movl    $<span class="token function">SYS_ify</span><span class="token punctuation">(</span>clone<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span>eax

    <span class="token comment" spellcheck="true">/* End FDE now, because in the child the unwind info will be
       wrong.  */</span>
    cfi_endproc<span class="token punctuation">;</span>
    syscall

    testq    <span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token operator">%</span>rax
    jl    SYSCALL_ERROR_LABEL
    jz    <span class="token function">L</span><span class="token punctuation">(</span>thread_start<span class="token punctuation">)</span>

    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>__clone()</code>函数核心代码为系统调用部分</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/* Do the system call.  */</span>
    movq    <span class="token operator">%</span>rdx<span class="token punctuation">,</span> <span class="token operator">%</span>rdi
    movq    <span class="token operator">%</span>r8<span class="token punctuation">,</span> <span class="token operator">%</span>rdx
    movq    <span class="token operator">%</span>r9<span class="token punctuation">,</span> <span class="token operator">%</span>r8
    mov    <span class="token function">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>R10_LP
    movl    $<span class="token function">SYS_ify</span><span class="token punctuation">(</span>clone<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span>eax

    <span class="token comment" spellcheck="true">/* End FDE now, because in the child the unwind info will be
       wrong.  */</span>
    cfi_endproc<span class="token punctuation">;</span>
    syscall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>事实上这里<code>clone()</code>函数是一个系统调用函数，内核入口为<code>sys_clone()</code>，系统调用号为<code>0x38</code>，主要作用是创建子进程：克隆父进程。</p>
<p>有关Linux下系统调用号的查询，根据不同平台查看不同文件：unistd.h（x86）、unistd_64.h（x86_64），针对该Linux系统平台存储在：<code>/usr/include/x86_64-linux-gnu/asm/unistd_64.h</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> _ASM_X86_UNISTD_64_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _ASM_X86_UNISTD_64_H 1</span>

<span class="token macro property">#<span class="token directive keyword">define</span> __NR_read 0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_write 1</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_open 2</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_close 3</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_stat 4</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fstat 5</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_lstat 6</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_poll 7</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_lseek 8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mmap 9</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mprotect 10</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_munmap 11</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_brk 12</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rt_sigaction 13</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rt_sigprocmask 14</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rt_sigreturn 15</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_ioctl 16</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pread64 17</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pwrite64 18</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_readv 19</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_writev 20</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_access 21</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pipe 22</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_select 23</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_yield 24</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mremap 25</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_msync 26</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mincore 27</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_madvise 28</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_shmget 29</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_shmat 30</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_shmctl 31</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_dup 32</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_dup2 33</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pause 34</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_nanosleep 35</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getitimer 36</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_alarm 37</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setitimer 38</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getpid 39</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sendfile 40</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_socket 41</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_connect 42</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_accept 43</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sendto 44</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_recvfrom 45</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sendmsg 46</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_recvmsg 47</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_shutdown 48</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_bind 49</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_listen 50</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getsockname 51</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getpeername 52</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_socketpair 53</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setsockopt 54</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getsockopt 55</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_clone 56</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fork 57</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_vfork 58</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_execve 59</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_exit 60</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_wait4 61</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_kill 62</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_uname 63</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_semget 64</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_semop 65</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_semctl 66</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_shmdt 67</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_msgget 68</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_msgsnd 69</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_msgrcv 70</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_msgctl 71</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fcntl 72</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_flock 73</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fsync 74</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fdatasync 75</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_truncate 76</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_ftruncate 77</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getdents 78</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getcwd 79</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_chdir 80</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fchdir 81</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rename 82</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mkdir 83</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rmdir 84</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_creat 85</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_link 86</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_unlink 87</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_symlink 88</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_readlink 89</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_chmod 90</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fchmod 91</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_chown 92</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fchown 93</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_lchown 94</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_umask 95</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_gettimeofday 96</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getrlimit 97</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getrusage 98</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sysinfo 99</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_times 100</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_ptrace 101</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getuid 102</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_syslog 103</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getgid 104</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setuid 105</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setgid 106</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_geteuid 107</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getegid 108</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setpgid 109</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getppid 110</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getpgrp 111</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setsid 112</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setreuid 113</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setregid 114</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getgroups 115</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setgroups 116</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setresuid 117</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getresuid 118</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setresgid 119</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getresgid 120</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getpgid 121</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setfsuid 122</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setfsgid 123</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getsid 124</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_capget 125</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_capset 126</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rt_sigpending 127</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rt_sigtimedwait 128</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rt_sigqueueinfo 129</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rt_sigsuspend 130</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sigaltstack 131</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_utime 132</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mknod 133</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_uselib 134</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_personality 135</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_ustat 136</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_statfs 137</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fstatfs 138</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sysfs 139</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getpriority 140</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setpriority 141</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_setparam 142</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_getparam 143</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_setscheduler 144</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_getscheduler 145</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_get_priority_max 146</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_get_priority_min 147</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_rr_get_interval 148</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mlock 149</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_munlock 150</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mlockall 151</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_munlockall 152</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_vhangup 153</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_modify_ldt 154</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pivot_root 155</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR__sysctl 156</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_prctl 157</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_arch_prctl 158</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_adjtimex 159</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setrlimit 160</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_chroot 161</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sync 162</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_acct 163</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_settimeofday 164</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mount 165</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_umount2 166</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_swapon 167</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_swapoff 168</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_reboot 169</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sethostname 170</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setdomainname 171</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_iopl 172</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_ioperm 173</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_create_module 174</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_init_module 175</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_delete_module 176</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_get_kernel_syms 177</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_query_module 178</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_quotactl 179</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_nfsservctl 180</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getpmsg 181</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_putpmsg 182</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_afs_syscall 183</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_tuxcall 184</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_security 185</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_gettid 186</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_readahead 187</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setxattr 188</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_lsetxattr 189</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fsetxattr 190</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getxattr 191</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_lgetxattr 192</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fgetxattr 193</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_listxattr 194</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_llistxattr 195</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_flistxattr 196</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_removexattr 197</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_lremovexattr 198</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fremovexattr 199</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_tkill 200</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_time 201</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_futex 202</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_setaffinity 203</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_getaffinity 204</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_set_thread_area 205</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_io_setup 206</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_io_destroy 207</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_io_getevents 208</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_io_submit 209</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_io_cancel 210</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_get_thread_area 211</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_lookup_dcookie 212</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_epoll_create 213</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_epoll_ctl_old 214</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_epoll_wait_old 215</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_remap_file_pages 216</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getdents64 217</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_set_tid_address 218</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_restart_syscall 219</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_semtimedop 220</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fadvise64 221</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_timer_create 222</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_timer_settime 223</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_timer_gettime 224</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_timer_getoverrun 225</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_timer_delete 226</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_clock_settime 227</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_clock_gettime 228</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_clock_getres 229</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_clock_nanosleep 230</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_exit_group 231</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_epoll_wait 232</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_epoll_ctl 233</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_tgkill 234</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_utimes 235</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_vserver 236</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mbind 237</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_set_mempolicy 238</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_get_mempolicy 239</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mq_open 240</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mq_unlink 241</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mq_timedsend 242</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mq_timedreceive 243</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mq_notify 244</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mq_getsetattr 245</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_kexec_load 246</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_waitid 247</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_add_key 248</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_request_key 249</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_keyctl 250</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_ioprio_set 251</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_ioprio_get 252</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_inotify_init 253</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_inotify_add_watch 254</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_inotify_rm_watch 255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_migrate_pages 256</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_openat 257</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mkdirat 258</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mknodat 259</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fchownat 260</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_futimesat 261</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_newfstatat 262</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_unlinkat 263</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_renameat 264</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_linkat 265</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_symlinkat 266</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_readlinkat 267</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fchmodat 268</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_faccessat 269</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pselect6 270</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_ppoll 271</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_unshare 272</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_set_robust_list 273</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_get_robust_list 274</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_splice 275</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_tee 276</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sync_file_range 277</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_vmsplice 278</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_move_pages 279</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_utimensat 280</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_epoll_pwait 281</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_signalfd 282</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_timerfd_create 283</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_eventfd 284</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fallocate 285</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_timerfd_settime 286</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_timerfd_gettime 287</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_accept4 288</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_signalfd4 289</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_eventfd2 290</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_epoll_create1 291</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_dup3 292</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pipe2 293</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_inotify_init1 294</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_preadv 295</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pwritev 296</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rt_tgsigqueueinfo 297</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_perf_event_open 298</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_recvmmsg 299</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fanotify_init 300</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fanotify_mark 301</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_prlimit64 302</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_name_to_handle_at 303</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_open_by_handle_at 304</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_clock_adjtime 305</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_syncfs 306</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sendmmsg 307</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_setns 308</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getcpu 309</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_process_vm_readv 310</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_process_vm_writev 311</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_kcmp 312</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_finit_module 313</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_setattr 314</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_sched_getattr 315</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_renameat2 316</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_seccomp 317</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_getrandom 318</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_memfd_create 319</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_kexec_file_load 320</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_bpf 321</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_execveat 322</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_userfaultfd 323</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_membarrier 324</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_mlock2 325</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_copy_file_range 326</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_preadv2 327</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pwritev2 328</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pkey_mprotect 329</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pkey_alloc 330</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pkey_free 331</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_statx 332</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_io_pgetevents 333</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_rseq 334</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pidfd_send_signal 424</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_io_uring_setup 425</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_io_uring_enter 426</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_io_uring_register 427</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_open_tree 428</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_move_mount 429</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fsopen 430</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fsconfig 431</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fsmount 432</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_fspick 433</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pidfd_open 434</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_clone3 435</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_close_range 436</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_openat2 437</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_pidfd_getfd 438</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __NR_faccessat2 439</span>


<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">/* _ASM_X86_UNISTD_64_H */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者通过在线平台进行查询：<a href="https://fedora.juszkiewicz.com.pl/syscalls.html" target="_blank" rel="noopener">各种平台下的系统调用号</a></p>
<p>这里系统调用之后仅仅是克隆了一个父进程，要想将一个子进程正真启动起来，还需要去调用<code>__spawni_child()</code>函数。</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/* Set up arguments for the function call.  */</span>
    popq    <span class="token operator">%</span>rax        <span class="token comment" spellcheck="true">/* Function to call.  */</span>
    popq    <span class="token operator">%</span>rdi        <span class="token comment" spellcheck="true">/* Argument.  */</span>
    call    <span class="token operator">*</span><span class="token operator">%</span>rax
    <span class="token comment" spellcheck="true">/* Call exit with return value from function call. */</span>
    movq    <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">%</span>rdi
    movl    $<span class="token function">SYS_ify</span><span class="token punctuation">(</span>exit<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>eax
    syscall
    cfi_endproc<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里<code>L(thread_start):</code>中的call指令会调用最初CLONE()函数的第一个参数：<code>__spawni_child()</code>函数。</p>
<p>定位<code>__spawni_child()</code>函数的实现：<code>sysdeps\unix\sysv\linux\spawni.c:121</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Function used in the clone call to setup the signals mask, posix_spawn
   attributes, and file actions.  It run on its own stack (provided by the
   posix_spawn call).  */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">__spawni_child</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arguments<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> posix_spawn_args <span class="token operator">*</span>args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
  <span class="token keyword">const</span> posix_spawnattr_t <span class="token operator">*</span>restrict attr <span class="token operator">=</span> args<span class="token operator">-></span>attr<span class="token punctuation">;</span>
  <span class="token keyword">const</span> posix_spawn_file_actions_t <span class="token operator">*</span>file_actions <span class="token operator">=</span> args<span class="token operator">-></span>fa<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* The child must ensure that no signal handler are enabled because it shared
     memory with parent, so the signal disposition must be either SIG_DFL or
     SIG_IGN.  It does by iterating over all signals and although it could
     possibly be more optimized (by tracking which signal potentially have a
     signal handler), it might requires system specific solutions (since the
     sigset_t data type can be very different on different architectures).  */</span>
  <span class="token keyword">struct</span> sigaction sa<span class="token punctuation">;</span>
  <span class="token function">memset</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  sigset_t hset<span class="token punctuation">;</span>
  <span class="token function">__sigprocmask</span> <span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> sig <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> sig <span class="token operator">&lt;</span> _NSIG<span class="token punctuation">;</span> <span class="token operator">++</span>sig<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr<span class="token operator">-></span>__flags <span class="token operator">&amp;</span> POSIX_SPAWN_SETSIGDEF<span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> <span class="token function">__sigismember</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token operator">-></span>__sd<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SIG_DFL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__sigismember</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>hset<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__is_internal_signal</span> <span class="token punctuation">(</span>sig<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SIG_IGN<span class="token punctuation">;</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
          <span class="token function">__libc_sigaction</span> <span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span>sa_handler <span class="token operator">==</span> SIG_IGN<span class="token punctuation">)</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
          sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SIG_DFL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>

      <span class="token function">__libc_sigaction</span> <span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _POSIX_PRIORITY_SCHEDULING</span>
  <span class="token comment" spellcheck="true">/* Set the scheduling algorithm and parameters.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr<span class="token operator">-></span>__flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>POSIX_SPAWN_SETSCHEDPARAM <span class="token operator">|</span> POSIX_SPAWN_SETSCHEDULER<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">==</span> POSIX_SPAWN_SETSCHEDPARAM<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__sched_setparam</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token operator">-></span>__sp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr<span class="token operator">-></span>__flags <span class="token operator">&amp;</span> POSIX_SPAWN_SETSCHEDULER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__sched_setscheduler</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> attr<span class="token operator">-></span>__policy<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token operator">-></span>__sp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr<span class="token operator">-></span>__flags <span class="token operator">&amp;</span> POSIX_SPAWN_SETSID<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
      <span class="token operator">&amp;&amp;</span> <span class="token function">__setsid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Set the process group ID.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr<span class="token operator">-></span>__flags <span class="token operator">&amp;</span> POSIX_SPAWN_SETPGROUP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
      <span class="token operator">&amp;&amp;</span> <span class="token function">__setpgid</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> attr<span class="token operator">-></span>__pgrp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Set the effective user and group IDs.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr<span class="token operator">-></span>__flags <span class="token operator">&amp;</span> POSIX_SPAWN_RESETIDS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">local_seteuid</span> <span class="token punctuation">(</span><span class="token function">__getuid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
      <span class="token operator">||</span> <span class="token function">local_setegid</span> <span class="token punctuation">(</span><span class="token function">__getgid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Execute the file actions.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_actions <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">int</span> cnt<span class="token punctuation">;</span>
      <span class="token keyword">struct</span> rlimit64 fdlimit<span class="token punctuation">;</span>
      bool have_fdlimit <span class="token operator">=</span> false<span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> cnt <span class="token operator">&lt;</span> file_actions<span class="token operator">-></span>__used<span class="token punctuation">;</span> <span class="token operator">++</span>cnt<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">struct</span> __spawn_action <span class="token operator">*</span>action <span class="token operator">=</span> <span class="token operator">&amp;</span>file_actions<span class="token operator">-></span>__actions<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token operator">-></span>tag<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> spawn_do_close<span class="token punctuation">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__close_nocancel</span> <span class="token punctuation">(</span>action<span class="token operator">-></span>action<span class="token punctuation">.</span>close_action<span class="token punctuation">.</span>fd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_fdlimit<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              <span class="token function">__getrlimit64</span> <span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fdlimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
              have_fdlimit <span class="token operator">=</span> true<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

          <span class="token comment" spellcheck="true">/* Signal errors only for file descriptors out of range.  */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token operator">-></span>action<span class="token punctuation">.</span>close_action<span class="token punctuation">.</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span>
              <span class="token operator">||</span> action<span class="token operator">-></span>action<span class="token punctuation">.</span>close_action<span class="token punctuation">.</span>fd <span class="token operator">>=</span> fdlimit<span class="token punctuation">.</span>rlim_cur<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> spawn_do_open<span class="token punctuation">:</span>
          <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* POSIX states that if fildes was already an open file descriptor,
           it shall be closed before the new file is opened.  This avoid
           pontential issues when posix_spawn plus addopen action is called
           with the process already at maximum number of file descriptor
           opened and also for multiple actions on single-open special
           paths (like /dev/watchdog).  */</span>
        <span class="token function">__close_nocancel</span> <span class="token punctuation">(</span>action<span class="token operator">-></span>action<span class="token punctuation">.</span>open_action<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">__open_nocancel</span> <span class="token punctuation">(</span>action<span class="token operator">-></span>action<span class="token punctuation">.</span>open_action<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
                       action<span class="token operator">-></span>action<span class="token punctuation">.</span>
                       open_action<span class="token punctuation">.</span>oflag <span class="token operator">|</span> O_LARGEFILE<span class="token punctuation">,</span>
                       action<span class="token operator">-></span>action<span class="token punctuation">.</span>open_action<span class="token punctuation">.</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>

        <span class="token keyword">int</span> new_fd <span class="token operator">=</span> ret<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Make sure the desired file descriptor is used.  */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> action<span class="token operator">-></span>action<span class="token punctuation">.</span>open_action<span class="token punctuation">.</span>fd<span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__dup2</span> <span class="token punctuation">(</span>new_fd<span class="token punctuation">,</span> action<span class="token operator">-></span>action<span class="token punctuation">.</span>open_action<span class="token punctuation">.</span>fd<span class="token punctuation">)</span>
            <span class="token operator">!=</span> action<span class="token operator">-></span>action<span class="token punctuation">.</span>open_action<span class="token punctuation">.</span>fd<span class="token punctuation">)</span>
              <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__close_nocancel</span> <span class="token punctuation">(</span>new_fd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> spawn_do_dup2<span class="token punctuation">:</span>
          <span class="token comment" spellcheck="true">/* Austin Group issue #411 requires adddup2 action with source
         and destination being equal to remove close-on-exec flag.  */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token operator">-></span>action<span class="token punctuation">.</span>dup2_action<span class="token punctuation">.</span>fd
          <span class="token operator">==</span> action<span class="token operator">-></span>action<span class="token punctuation">.</span>dup2_action<span class="token punctuation">.</span>newfd<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">int</span> fd <span class="token operator">=</span> action<span class="token operator">-></span>action<span class="token punctuation">.</span>dup2_action<span class="token punctuation">.</span>newfd<span class="token punctuation">;</span>
          <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token function">__fcntl</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFD<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__fcntl</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFD<span class="token punctuation">,</span> flags <span class="token operator">&amp;</span> <span class="token operator">~</span>FD_CLOEXEC<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__dup2</span> <span class="token punctuation">(</span>action<span class="token operator">-></span>action<span class="token punctuation">.</span>dup2_action<span class="token punctuation">.</span>fd<span class="token punctuation">,</span>
                   action<span class="token operator">-></span>action<span class="token punctuation">.</span>dup2_action<span class="token punctuation">.</span>newfd<span class="token punctuation">)</span>
               <span class="token operator">!=</span> action<span class="token operator">-></span>action<span class="token punctuation">.</span>dup2_action<span class="token punctuation">.</span>newfd<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> spawn_do_chdir<span class="token punctuation">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__chdir</span> <span class="token punctuation">(</span>action<span class="token operator">-></span>action<span class="token punctuation">.</span>chdir_action<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> spawn_do_fchdir<span class="token punctuation">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__fchdir</span> <span class="token punctuation">(</span>action<span class="token operator">-></span>action<span class="token punctuation">.</span>fchdir_action<span class="token punctuation">.</span>fd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/* Set the initial signal mask of the child if POSIX_SPAWN_SETSIGMASK
     is set, otherwise restore the previous one.  */</span>
  <span class="token function">__sigprocmask</span> <span class="token punctuation">(</span>SIG_SETMASK<span class="token punctuation">,</span> <span class="token punctuation">(</span>attr<span class="token operator">-></span>__flags <span class="token operator">&amp;</span> POSIX_SPAWN_SETSIGMASK<span class="token punctuation">)</span>
         <span class="token operator">?</span> <span class="token operator">&amp;</span>attr<span class="token operator">-></span>__ss <span class="token punctuation">:</span> <span class="token operator">&amp;</span>args<span class="token operator">-></span>oldmask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args<span class="token operator">-></span><span class="token function">exec</span> <span class="token punctuation">(</span>args<span class="token operator">-></span>file<span class="token punctuation">,</span> args<span class="token operator">-></span>argv<span class="token punctuation">,</span> args<span class="token operator">-></span>envp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* This is compatibility function required to enable posix_spawn run
     script without shebang definition for older posix_spawn versions
     (2.15).  */</span>
  <span class="token function">maybe_script_execute</span> <span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

fail<span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true">/* errno should have an appropriate non-zero value; otherwise,
     there's a bug in glibc or the kernel.  For lack of an error code
     (EINTERNALBUG) describing that, use ECHILD.  Another option would
     be to set args->err to some negative sentinel and have the parent
     abort(), but that seems needlessly harsh.  */</span>
  args<span class="token operator">-></span>err <span class="token operator">=</span> errno <span class="token operator">?</span> <span class="token punctuation">:</span> ECHILD<span class="token punctuation">;</span>
  <span class="token function">_exit</span> <span class="token punctuation">(</span>SPAWN_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>审计<code>__spawni_child()</code>函数，核心代码位于</p>
<pre class="line-numbers language-c"><code class="language-c">  args<span class="token operator">-></span><span class="token function">exec</span> <span class="token punctuation">(</span>args<span class="token operator">-></span>file<span class="token punctuation">,</span> args<span class="token operator">-></span>argv<span class="token punctuation">,</span> args<span class="token operator">-></span>envp<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该部分为动态函数调用，那么<code>args-&gt;exec</code>为什么呢，回头向上追溯该值的传递过程：首先<code>__spawni_child (void *arguments)</code>中<code>arguments</code>的参数由<code>clone()</code>函数传递</p>
<pre class="line-numbers language-c"><code class="language-c">new_pid <span class="token operator">=</span> <span class="token function">CLONE</span> <span class="token punctuation">(</span>__spawni_child<span class="token punctuation">,</span> <span class="token function">STACK</span> <span class="token punctuation">(</span>stack<span class="token punctuation">,</span> stack_size<span class="token punctuation">)</span><span class="token punctuation">,</span> stack_size<span class="token punctuation">,</span>
           CLONE_VM <span class="token operator">|</span> CLONE_VFORK <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>而<code>CLONE()</code>中的<code>args</code>参数由<code>__spawnix()</code>函数传递</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">__spawnix</span> <span class="token punctuation">(</span>pid_t <span class="token operator">*</span> pid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>
       <span class="token keyword">const</span> posix_spawn_file_actions_t <span class="token operator">*</span> file_actions<span class="token punctuation">,</span>
       <span class="token keyword">const</span> posix_spawnattr_t <span class="token operator">*</span> attrp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> xflags<span class="token punctuation">,</span>
       <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>exec<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    、、、、、
  args<span class="token punctuation">.</span>err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>exec <span class="token operator">=</span> exec<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>fa <span class="token operator">=</span> file_actions<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>attr <span class="token operator">=</span> attrp <span class="token operator">?</span> attrp <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">const</span> posix_spawnattr_t<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>argv <span class="token operator">=</span> argv<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>argc <span class="token operator">=</span> argc<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>envp <span class="token operator">=</span> envp<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span>xflags <span class="token operator">=</span> xflags<span class="token punctuation">;</span>
    、、、、、、
  new_pid <span class="token operator">=</span> <span class="token function">CLONE</span> <span class="token punctuation">(</span>__spawni_child<span class="token punctuation">,</span> <span class="token function">STACK</span> <span class="token punctuation">(</span>stack<span class="token punctuation">,</span> stack_size<span class="token punctuation">)</span><span class="token punctuation">,</span> stack_size<span class="token punctuation">,</span>CLONE_VM <span class="token operator">|</span> CLONE_VFORK <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>__spawnix()</code>函数参数中发现<code>exec</code>参数，继续向上追溯到<code>__spawni()</code>的函数调用</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">__spawni</span> <span class="token punctuation">(</span>pid_t <span class="token operator">*</span> pid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>
      <span class="token keyword">const</span> posix_spawn_file_actions_t <span class="token operator">*</span> acts<span class="token punctuation">,</span>
      <span class="token keyword">const</span> posix_spawnattr_t <span class="token operator">*</span> attrp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> xflags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/* It uses __execvpex to avoid run ENOEXEC in non compatibility mode (it
     will be handled by maybe_script_execute).  */</span>
  <span class="token keyword">return</span> <span class="token function">__spawnix</span> <span class="token punctuation">(</span>pid<span class="token punctuation">,</span> file<span class="token punctuation">,</span> acts<span class="token punctuation">,</span> attrp<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">,</span> xflags<span class="token punctuation">,</span>
            xflags <span class="token operator">&amp;</span> SPAWN_XFLAGS_USE_PATH <span class="token operator">?</span> __execvpex <span class="token punctuation">:</span>__execve<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>__spawni()</code>函数调用<code>__spawnix()</code>函数的传参过程中，可追溯到exec的参数值，其值由一个三目运算表达式来决定</p>
<pre class="line-numbers language-c"><code class="language-c">xflags <span class="token operator">&amp;</span> SPAWN_XFLAGS_USE_PATH <span class="token operator">?</span> __execvpex <span class="token punctuation">:</span>__execve<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>表达式的核心在于：<code>与</code>运算，所以分别追溯<code>xflags</code> 与 <code>SPAWN_XFLAGS_USE_PATH</code>的参数值。</p>
<p>追溯<code>xflags</code>：<code>__spawni()</code>函数由<code>__posix_spawn()</code>函数传参调用，得到<code>xflags</code>参数的值为<code>0</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">__posix_spawn</span> <span class="token punctuation">(</span>pid_t <span class="token operator">*</span>pid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span>
           <span class="token keyword">const</span> posix_spawn_file_actions_t <span class="token operator">*</span>file_actions<span class="token punctuation">,</span>
           <span class="token keyword">const</span> posix_spawnattr_t <span class="token operator">*</span>attrp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
           <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">__spawni</span> <span class="token punctuation">(</span>pid<span class="token punctuation">,</span> path<span class="token punctuation">,</span> file_actions<span class="token punctuation">,</span> attrp<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>追溯<code>SPAWN_XFLAGS_USE_PATH</code>：<code>SPAWN_XFLAGS_USE_PATH</code>参数的预定义位于：<code>posix\spawn_int.h:66</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> SPAWN_XFLAGS_USE_PATH    0x1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>知道两个参数值后：与运算的结果为0，exec参数赋值为<code>__execve()</code>。</p>
<p>继续回到上面动态调用部分，可知<code>__spawni_child()</code>函数实现会调用<code>__execve()</code>函数</p>
<pre class="line-numbers language-c"><code class="language-c">  args<span class="token operator">-></span><span class="token function">exec</span> <span class="token punctuation">(</span>args<span class="token operator">-></span>file<span class="token punctuation">,</span> args<span class="token operator">-></span>argv<span class="token punctuation">,</span> args<span class="token operator">-></span>envp<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>__execve()</code>函数为<code>execve()</code>函数的别名</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">weak_alias</span> <span class="token punctuation">(</span>__execve<span class="token punctuation">,</span> execve<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此时<code>execve()</code>函数接收的参数：file为<code>/bin/sh</code>、argv为<code>sh -c whoami</code>。</p>
<p><code>execve()</code>函数主要用于创建进程，第一个参数为要启动的程序完整路径，第二个参数为要执行的程序指令。当<code>execve()</code>函数把<code>/bin/sh</code>进程启动起来后，然后由<code>sh</code>来执行系统指令(内部|外部)，即可完成PHP命令执行函数的整个调用过程。</p>
<p>事实上这里<code>execve()</code>函数为系统调用函数，内核入口为<code>sys_execve()</code>，系统调用号为<code>0x3b</code>，而在C语言的程序库中则又在此基础上向应用程序提供一整套的库函数，包括execl()、execle()、execlp()、execv()、execve()和execvp()。</p>
<p>在Linux C语言编程里面常用exec()函数族来启动程序进程：execl、execle、execlp、execv、execve和execvp函数，exec()函数族的6个成员函数语法如下：</p>
<table>
<thead>
<tr>
<th>所需头文件</th>
<th>函数说明</th>
<th>函数原型</th>
<th>函数返回值</th>
</tr>
</thead>
<tbody><tr>
<td><code>#include &lt;unistd.h&gt;</code></td>
<td>执行程序</td>
<td><code>int execl(const char *pathname, const char *arg, ..., (char *)0)</code><br><code>int execv(const char *pathname, char *const argv[])</code><br><code>int execle(const char *pathname, const char *arg, ..., (char *)0, char *const envp[])</code><br><code>int execve(const char *pathname, char *const argv[], char *const envp[])</code><br><code>int execlp(const char *filename, const char *arg, ..., (char *)0)</code><br><code>int execvp(const char *filename, char *const argv[])</code></td>
<td>成功：函数不会返回<br>出错：返回-1，失败原因记录在error中</td>
</tr>
</tbody></table>
<p>这里以<code>execve()</code>函数为例简单编写一个Demo进行演示：CommandExec1.c</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>env<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
        <span class="token keyword">char</span> <span class="token operator">*</span>argvs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"whoami"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> argvs<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译运行</p>
<pre class="line-numbers language-bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面/CodeDebug/c<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># gcc CommandExec1.c -o CommandExec1                                                                                                                                          </span>
┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面/CodeDebug/c<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># ./CommandExec1  </span>
root

┌──<span class="token punctuation">(</span>root💀toor<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/桌面/CodeDebug/c<span class="token punctuation">]</span>
└─<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理，按照上述整个审计思路，可整理出PHP常见命令执行函数在Linux平台下的底层调用链</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201217163720792.png" alt="image-20201217163720792"></p>
<h3 id="动态审计-1"><a href="#动态审计-1" class="headerlink" title="动态审计"></a>动态审计</h3><p>除了枯燥静态审计PHP内核源码外，还可以使用更加直观的动态审计方式去动态审计PHP命令执行函数的实现原理与底层调用过程。</p>
<p>这里使用的调试工具为：<code>Visual Studio Code</code>、<code>GDB</code>，针对PHP内核源码的调试，VSCode动态调试原理使用的是GDB调试器，可以理解为使用图形化界面去操作GDB来调试；而GDB调试器为纯命令行调试工具，其调试原理为通过一个<code>ptrace()</code>系统调用函数<code>SYS_ptrace()</code>来完成，系统调用号为<code>0x65</code>。</p>
<p>由于动态调试PHP内核源码会调用到Glibc库，所以我们也需要对Glibc进行源码调试，然而我们使用的是系统自带的Glibc。那怎么才能调试Glibc呢，比较麻烦的是以调试模式编译一份Glibc，不过我们不必这么麻烦。其实有一种很简单的方法，下载和系统Glibc相同版本的源码项目，然后在GDB配置文件中声明Glibc的源码目录，之后就可以在PHP内核源码动态调试过程中对Glibc源码进行断点调试。</p>
<p>这里测试的Linux系统Glibc版本为2.31，所以下载配置<code>glibc-2.31</code>源码项目即可，下面是我使用的GDB配置信息：</p>
<pre class="line-numbers language-ini"><code class="language-ini">└─# cat ~/.gdbinit
#source /mnt/hgfs/QSec/Binary/PWN/Tools/GDB/peda/peda.py
source /mnt/hgfs/QSec/Binary/PWN/Tools/GDB/pwndbg/gdbinit.py
#source /mnt/hgfs/QSec/Binary/PWN/Tools/GDB/gef/gdbinit-gef.py
directory /mnt/hgfs/QSec/Code-Audit/glibc/glibc-2.31/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Visual-Studio-Code-3"><a href="#Visual-Studio-Code-3" class="headerlink" title="Visual Studio Code"></a>Visual Studio Code</h4><p>由于VSCode相比GDB调试简单，所以这里直接给出一些关键断点，然后给出动态调试命令执行函数的底层实现调用链。具体动态调试过程会在下面GDB调试部分叙述。</p>
<p>关键断点：<code>BreakPoints</code></p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201217221514453.png" alt="image-20201217221514453"></p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201217222153934.png" alt="image-20201217222153934"></p>
<p>程序完整的调用栈：<code>CallStack</code>，程序入口到底层调用</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201217205057913.png" alt="image-20201217205057913"></p>
<h4 id="GDB-2"><a href="#GDB-2" class="headerlink" title="GDB"></a>GDB</h4><p>启动GDB调试，加载程序</p>
<pre class="line-numbers language-bash"><code class="language-bash">└─<span class="token comment" spellcheck="true"># gdb --args ./php -r "system('whoami');"                                                                                            1 ⚙</span>
GNU gdb <span class="token punctuation">(</span>Debian 10.1-1+b1<span class="token punctuation">)</span> 10.1
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> 2020 Free Software Foundation, Inc.                                                                                          
License GPLv3+: GNU GPL version 3 or later <span class="token operator">&lt;</span>http://gnu.org/licenses/gpl.html<span class="token operator">></span>
This is <span class="token function">free</span> software: you are <span class="token function">free</span> to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type <span class="token string">"show copying"</span> and <span class="token string">"show warranty"</span> <span class="token keyword">for</span> details.
This GDB was configured as <span class="token string">"x86_64-linux-gnu"</span><span class="token keyword">.</span>
Type <span class="token string">"show configuration"</span> <span class="token keyword">for</span> configuration details.
For bug reporting instructions, please see:
<span class="token operator">&lt;</span>https://www.gnu.org/software/gdb/bugs/<span class="token operator">></span>.
Find the GDB manual and other documentation resources online at:
    <span class="token operator">&lt;</span>http://www.gnu.org/software/gdb/documentation/<span class="token operator">></span>.

For help, <span class="token function">type</span> <span class="token string">"help"</span><span class="token keyword">.</span>
Type <span class="token string">"apropos word"</span> to search <span class="token keyword">for</span> commands related to <span class="token string">"word"</span><span class="token punctuation">..</span>.
pwndbg: loaded 188 commands. Type pwndbg <span class="token punctuation">[</span>filter<span class="token punctuation">]</span> <span class="token keyword">for</span> a list.
pwndbg: created <span class="token variable">$rebase</span>, <span class="token variable">$ida</span> gdb functions <span class="token punctuation">(</span>can be used with print/break<span class="token punctuation">)</span>
Reading symbols from ./php<span class="token punctuation">..</span>.
pwndbg<span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>开始运行到主函数入口</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>system()</code>在PHP内核源码实现：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* {{{ proto int system(string command [, int &amp;return_value])
   Execute an external program and display output */</span>
<span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">php_exec_ex</span><span class="token punctuation">(</span>INTERNAL_FUNCTION_PARAM_PASSTHRU<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* }}} */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首次，对<code>php_exec_ex()</code>函数下断点</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> b php_exec_ex
Breakpoint 2 at 0x5555557a4942: <span class="token function">file</span> /mnt/hgfs/QSec/Code-Audit/PHP/PHP-Source-Code/php-7.2.9-linux-debug/ext/standard/exec.c, line 213.
pwndbg<span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>运行至断点处：<code>php_exec_ex()</code>函数实现</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218003801777.png" alt="image-20201218003801777"></p>
<p>查看<code>php_exec_ex()</code>函数源码</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> l 209,248
209     static void php_exec_ex<span class="token punctuation">(</span>INTERNAL_FUNCTION_PARAMETERS, int mode<span class="token punctuation">)</span>
210     <span class="token punctuation">{</span>
211             char *cmd<span class="token punctuation">;</span>
212             size_t cmd_len<span class="token punctuation">;</span>
213             zval *ret_code<span class="token operator">=</span>NULL, *ret_array<span class="token operator">=</span>NULL<span class="token punctuation">;</span>
214             int ret<span class="token punctuation">;</span>
215
216             ZEND_PARSE_PARAMETERS_START<span class="token punctuation">(</span>1, <span class="token punctuation">(</span>mode ? 2 <span class="token keyword">:</span> 3<span class="token punctuation">))</span>
217                     Z_PARAM_STRING<span class="token punctuation">(</span>cmd, cmd_len<span class="token punctuation">)</span>
218                     Z_PARAM_OPTIONAL
219                     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
220                             Z_PARAM_ZVAL_DEREF<span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span>
221                     <span class="token punctuation">}</span>
222                     Z_PARAM_ZVAL_DEREF<span class="token punctuation">(</span>ret_code<span class="token punctuation">)</span>
223             ZEND_PARSE_PARAMETERS_END_EX<span class="token punctuation">(</span>RETURN_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
224
225             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cmd_len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
226                     php_error_docref<span class="token punctuation">(</span>NULL, E_WARNING, <span class="token string">"Cannot execute a blank command"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
227                     RETURN_FALSE<span class="token punctuation">;</span>
228             <span class="token punctuation">}</span>
229             <span class="token keyword">if</span> <span class="token punctuation">(</span>strlen<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">!=</span> cmd_len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
230                     php_error_docref<span class="token punctuation">(</span>NULL, E_WARNING, <span class="token string">"NULL byte detected. Possible attack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
231                     RETURN_FALSE<span class="token punctuation">;</span>
232             <span class="token punctuation">}</span>
233
234             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret_array<span class="token punctuation">)</span> <span class="token punctuation">{</span>
235                     ret <span class="token operator">=</span> php_exec<span class="token punctuation">(</span>mode, cmd, NULL, return_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
236             <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
237                     <span class="token keyword">if</span> <span class="token punctuation">(</span>Z_TYPE_P<span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span> <span class="token operator">!=</span> IS_ARRAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
238                             zval_ptr_dtor<span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
239                             array_init<span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
240                     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Z_REFCOUNT_P<span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span> <span class="token operator">></span> 1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
241                             zval_ptr_dtor<span class="token punctuation">(</span>ret_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
242                             ZVAL_ARR<span class="token punctuation">(</span>ret_array, zend_array_dup<span class="token punctuation">(</span>Z_ARR_P<span class="token punctuation">(</span>ret_array<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
243                     <span class="token punctuation">}</span>
244                     ret <span class="token operator">=</span> php_exec<span class="token punctuation">(</span>2, cmd, ret_array, return_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
245             <span class="token punctuation">}</span>
246             <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
247                     zval_ptr_dtor<span class="token punctuation">(</span>ret_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
248                     ZVAL_LONG<span class="token punctuation">(</span>ret_code, ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
pwndbg<span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>单步调试至<code>php_exec()</code>函数</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> n<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218004941997.png" alt="image-20201218004941997"></p>
<p>打印有关参数的值</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> p mode
<span class="token variable">$3</span> <span class="token operator">=</span> 1
pwndbg<span class="token operator">></span> p cmd
<span class="token variable">$4</span> <span class="token operator">=</span> 0x7ffff7a6eb98 <span class="token string">"whoami"</span>
pwndbg<span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进入<code>php_exec()</code>函数实现</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218005115473.png" alt="image-20201218005115473"></p>
<p>查看源码信息</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> l
96       */
97      PHPAPI int php_exec<span class="token punctuation">(</span>int type, char *cmd, zval *array, zval *return_value<span class="token punctuation">)</span>
98      <span class="token punctuation">{</span>
99              FILE *fp<span class="token punctuation">;</span>
100             char *buf<span class="token punctuation">;</span>
101             size_t l <span class="token operator">=</span> 0<span class="token punctuation">;</span>
102             int pclose_return<span class="token punctuation">;</span>
103             char *b, *d<span class="token operator">=</span>NULL<span class="token punctuation">;</span>
104             php_stream *stream<span class="token punctuation">;</span>
105             size_t buflen, bufl <span class="token operator">=</span> 0<span class="token punctuation">;</span>
pwndbg<span class="token operator">></span> l
106     <span class="token comment" spellcheck="true">#if PHP_SIGCHILD</span>
107             void <span class="token punctuation">(</span>*sig_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
108     <span class="token comment" spellcheck="true">#endif</span>
109
110     <span class="token comment" spellcheck="true">#if PHP_SIGCHILD</span>
111             sig_handler <span class="token operator">=</span> signal <span class="token punctuation">(</span>SIGCHLD, SIG_DFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
112     <span class="token comment" spellcheck="true">#endif</span>
113
114     <span class="token comment" spellcheck="true">#ifdef PHP_WIN32</span>
115             fp <span class="token operator">=</span> VCWD_POPEN<span class="token punctuation">(</span>cmd, <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pwndbg<span class="token operator">></span> 
116     <span class="token comment" spellcheck="true">#else</span>
117             fp <span class="token operator">=</span> VCWD_POPEN<span class="token punctuation">(</span>cmd, <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
118     <span class="token comment" spellcheck="true">#endif</span>
119             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
120                     php_error_docref<span class="token punctuation">(</span>NULL, E_WARNING, <span class="token string">"Unable to fork [%s]"</span>, cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
121                     goto err<span class="token punctuation">;</span>
122             <span class="token punctuation">}</span>
123
124             stream <span class="token operator">=</span> php_stream_fopen_from_pipe<span class="token punctuation">(</span>fp, <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
125
pwndbg<span class="token operator">></span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结合源码及汇编代码，可知<code>VCWD_POPEN(cmd, &quot;r&quot;);</code>函数实现为<code>popen@plt &lt;popen@plt&gt;</code>，即glibc库函数<code>popen()</code></p>
<p>单步调试汇编至call调用处</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> si<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218011141990.png" alt="image-20201218011141990"></p>
<p>进入call函数调用体：<code>popen@plt &lt;popen@plt&gt;</code></p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> si
pwndbg<span class="token operator">></span> s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>glibc中<code>popen()</code>函数的实现即调用<code>_IO_new_popen()</code>函数</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218011919530.png" alt="image-20201218011919530"></p>
<p>查看<code>_IO_new_popen()</code>函数源码</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> l
226         _IO_lock_t lock<span class="token punctuation">;</span>
227     <span class="token comment" spellcheck="true">#endif</span>
228       <span class="token punctuation">}</span> *new_f<span class="token punctuation">;</span>
229       FILE *fp<span class="token punctuation">;</span>
230
231       new_f <span class="token operator">=</span> <span class="token punctuation">(</span>struct locked_FILE *<span class="token punctuation">)</span> malloc <span class="token punctuation">(</span>sizeof <span class="token punctuation">(</span>struct locked_FILE<span class="token punctuation">))</span><span class="token punctuation">;</span>
232       <span class="token keyword">if</span> <span class="token punctuation">(</span>new_f <span class="token operator">==</span> NULL<span class="token punctuation">)</span>
233         <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
234     <span class="token comment" spellcheck="true">#ifdef _IO_MTSAFE_IO</span>
235       new_f-<span class="token operator">></span>fpx.file.file._lock <span class="token operator">=</span> <span class="token operator">&amp;</span>new_f-<span class="token operator">></span>lock<span class="token punctuation">;</span>
pwndbg<span class="token operator">></span> l
236     <span class="token comment" spellcheck="true">#endif</span>
237       fp <span class="token operator">=</span> <span class="token operator">&amp;</span>new_f-<span class="token operator">></span>fpx.file.file<span class="token punctuation">;</span>
238       _IO_init_internal <span class="token punctuation">(</span>fp, 0<span class="token punctuation">)</span><span class="token punctuation">;</span>
239       _IO_JUMPS <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f-<span class="token operator">></span>fpx.file<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>_IO_proc_jumps<span class="token punctuation">;</span>
240       _IO_new_file_init_internal <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f-<span class="token operator">></span>fpx.file<span class="token punctuation">)</span><span class="token punctuation">;</span>
241       <span class="token keyword">if</span> <span class="token punctuation">(</span>_IO_new_proc_open <span class="token punctuation">(</span>fp, command, mode<span class="token punctuation">)</span> <span class="token operator">!=</span> NULL<span class="token punctuation">)</span>
242         <span class="token keyword">return</span> <span class="token punctuation">(</span>FILE *<span class="token punctuation">)</span> <span class="token operator">&amp;</span>new_f-<span class="token operator">></span>fpx.file<span class="token punctuation">;</span>
243       _IO_un_link <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f-<span class="token operator">></span>fpx.file<span class="token punctuation">)</span><span class="token punctuation">;</span>
244       <span class="token function">free</span> <span class="token punctuation">(</span>new_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
245       <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
pwndbg<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>观察<code>_IO_new_popen()</code>函数，末尾会调用<code>_IO_new_proc_open()</code>函数来执行处理系统指令，可对<code>_IO_new_proc_open()</code>函数下断点，然后运行进入<code>_IO_new_proc_open()</code>函数的实现。</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> b _IO_new_proc_open
Breakpoint 2 at 0x7ffff7d010f0: <span class="token function">file</span> iopopen.c, line 110.
pwndbg<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218012859492.png" alt="image-20201218012859492"></p>
<p>继续单步调试，<code>_IO_new_proc_open()</code>函数会调用<code>spawn_process()</code>函数</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> l
195       _IO_lock_lock <span class="token punctuation">(</span>proc_file_chain_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
196     <span class="token comment" spellcheck="true">#endif</span>
197       spawn_ok <span class="token operator">=</span> spawn_process <span class="token punctuation">(</span><span class="token operator">&amp;</span>fa, fp, command, do_cloexec, pipe_fds,
198                                 parent_end, child_end, child_pipe_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
199     <span class="token comment" spellcheck="true">#ifdef _IO_MTSAFE_IO</span>
200       _IO_lock_unlock <span class="token punctuation">(</span>proc_file_chain_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
201       _IO_cleanup_region_end <span class="token punctuation">(</span>0<span class="token punctuation">)</span><span class="token punctuation">;</span>
202     <span class="token comment" spellcheck="true">#endif</span>
203
204       __posix_spawn_file_actions_destroy <span class="token punctuation">(</span><span class="token operator">&amp;</span>fa<span class="token punctuation">)</span><span class="token punctuation">;</span>
pwndbg<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>单步调试进入<code>spawn_process()</code>函数实现</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218014037354.png" alt="image-20201218014037354"></p>
<p><code>spawn_process()</code>函数会调用<code>__posix_spawn()</code>函数</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> l
81               child_pipe_fd, it has been already closed by the adddup2 action
82               above.  */
83            <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">!=</span> child_pipe_fd
84                <span class="token operator">&amp;&amp;</span> __posix_spawn_file_actions_addclose <span class="token punctuation">(</span>fa, fd<span class="token punctuation">)</span> <span class="token operator">!=</span> 0<span class="token punctuation">)</span>
85              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
86          <span class="token punctuation">}</span>
87
88        <span class="token keyword">if</span> <span class="token punctuation">(</span>__posix_spawn <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">((</span>_IO_proc_file *<span class="token punctuation">)</span> fp<span class="token punctuation">)</span>-<span class="token operator">></span>pid, _PATH_BSHELL, fa, 0,
89                           <span class="token punctuation">(</span>char *const<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token punctuation">(</span>char*<span class="token punctuation">)</span> <span class="token string">"sh"</span>, <span class="token punctuation">(</span>char*<span class="token punctuation">)</span> <span class="token string">"-c"</span>,
90                           <span class="token punctuation">(</span>char *<span class="token punctuation">)</span> command, NULL <span class="token punctuation">}</span>, __environ<span class="token punctuation">)</span> <span class="token operator">!=</span> 0<span class="token punctuation">)</span>
pwndbg<span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>单步汇编调试至<code>__posix_spawn()</code>函数调用处</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> si<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218014520495.png" alt="image-20201218014520495"></p>
<p>可以看到<code>__posix_spawn()</code>函数被传入的参数：<code>sh -c command</code>，可以判断php命令执行函数，底层会调用<code>sh</code>来执行系统指令，进入<code>__posix_spawn()</code>函数实现</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> si<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218014904077.png" alt="image-20201218014904077"></p>
<p><code>__posix_spawn()</code>函数实现直接调用的<code>__spawni()</code>函数，单步步入调试进入<code>__spawni()</code>函数</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218015152928.png" alt="image-20201218015152928"></p>
<p><code>__spawni()</code>函数实现调用<code>__spawnix()</code>函数，单步步入调试进入<code>__spawnix()</code>函数</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218015445402.png" alt="image-20201218015445402"></p>
<p><code>__spawnix()</code>函数的核心代码：克隆父进程，为后续<code>/bin/sh</code>子进程的创建做准备</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> l
382       new_pid <span class="token operator">=</span> CLONE <span class="token punctuation">(</span>__spawni_child, STACK <span class="token punctuation">(</span>stack, stack_size<span class="token punctuation">)</span>, stack_size,
383                        CLONE_VM <span class="token operator">|</span> CLONE_VFORK <span class="token operator">|</span> SIGCHLD, <span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
384
385       /* It needs to collect the <span class="token keyword">case</span> where the auxiliary process was created
386          but failed to execute the <span class="token function">file</span> <span class="token punctuation">(</span>due either any preparation step or
387          <span class="token keyword">for</span> execve itself<span class="token punctuation">)</span>.  */
388       <span class="token keyword">if</span> <span class="token punctuation">(</span>new_pid <span class="token operator">></span> 0<span class="token punctuation">)</span>
389         <span class="token punctuation">{</span>
390           /* Also, it handles the unlikely <span class="token keyword">case</span> where the auxiliary process was
391              terminated before calling execve as <span class="token keyword">if</span> it was successfully.  The
pwndbg<span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>CLONE()</code>函数处下断点，并进入<code>CLONE()</code>函数的实现：函数的实现为汇编代码</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218015901000.png" alt="image-20201218015901000"></p>
<p>对<code>clone()</code>函数汇编代码进行单步汇编调试：<code>clone()</code>函数是一个系统调用函数，内核入口为<code>sys_clone()</code>，调用号为<code>0x38</code></p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218020719449.png" alt="image-20201218020719449"></p>
<p>继续单步汇编步入，执行系统调用</p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> si
<span class="token punctuation">[</span>Attaching after process 48284 vfork to child process 48289<span class="token punctuation">]</span>
<span class="token punctuation">[</span>New inferior 2 <span class="token punctuation">(</span>process 48289<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>Switching to process 48289<span class="token punctuation">]</span>
clone <span class="token punctuation">(</span><span class="token punctuation">)</span> at <span class="token punctuation">..</span>/sysdeps/unix/sysv/linux/x86_64/clone.S:79
79              jl      SYSCALL_ERROR_LABEL
LEGEND: STACK <span class="token operator">|</span> HEAP <span class="token operator">|</span> CODE <span class="token operator">|</span> DATA <span class="token operator">|</span> RWX <span class="token operator">|</span> RODATA
─────────────────────────────────────────────────────────<span class="token punctuation">[</span> REGISTERS <span class="token punctuation">]</span>─────────
 RAX  0x0
 RBX  0x4
 RCX  0x7ffff7d88d81 <span class="token punctuation">(</span>clone+49<span class="token punctuation">)</span> ◂— <span class="token function">test</span>   rax, rax
 RDX  0xffffffff
 RDI  0x4111
 RSI  0x7ffff7c14ff0 —▸ 0x7ffff7d789d0 <span class="token punctuation">(</span>__spawni_child<span class="token punctuation">)</span> ◂— push   rbp
 R8   0x0
 R9   0x0
 R10  0x7ffff7e15156 ◂— 0x68732f6e69622f /* <span class="token string">'/bin/sh'</span> */
 R11  0x306
 R12  0x7ffff7c0c000 ◂— 0x0
 R13  0x7fffffffc480 —▸ 0x7ffff7e1515b ◂— 0x2074697865006873 /* <span class="token string">'sh'</span> */
 R14  0x7fffffffc190 ◂— 0x0
 R15  0x7ffff7d56660 <span class="token punctuation">(</span>execve<span class="token punctuation">)</span> ◂— mov    eax, 0x3b
 RBP  0x9000
 RSP  0x7ffff7c14ff0 —▸ 0x7ffff7d789d0 <span class="token punctuation">(</span>__spawni_child<span class="token punctuation">)</span> ◂— push   rbp
 RIP  0x7ffff7d88d84 <span class="token punctuation">(</span>clone+52<span class="token punctuation">)</span> ◂— jl     0x7ffff7d88d99
─────────────────────────────────────────────────<span class="token punctuation">[</span> DISASM <span class="token punctuation">]</span>───────────────────────────
   0x7ffff7d88d72 <span class="token operator">&lt;</span>clone+34<span class="token operator">></span>    mov    r8, r9
   0x7ffff7d88d75 <span class="token operator">&lt;</span>clone+37<span class="token operator">></span>    mov    r10, qword ptr <span class="token punctuation">[</span>rsp + 8<span class="token punctuation">]</span>
   0x7ffff7d88d7a <span class="token operator">&lt;</span>clone+42<span class="token operator">></span>    mov    eax, 0x38
   0x7ffff7d88d7f <span class="token operator">&lt;</span>clone+47<span class="token operator">></span>    syscall 
   0x7ffff7d88d81 <span class="token operator">&lt;</span>clone+49<span class="token operator">></span>    <span class="token function">test</span>   rax, rax
 ► 0x7ffff7d88d84 <span class="token operator">&lt;</span>clone+52<span class="token operator">></span>    jl     clone+73 <span class="token operator">&lt;</span>clone+73<span class="token operator">></span>

   0x7ffff7d88d86 <span class="token operator">&lt;</span>clone+54<span class="token operator">></span>    je     clone+57 <span class="token operator">&lt;</span>clone+57<span class="token operator">></span>
    ↓
   0x7ffff7d88d89 <span class="token operator">&lt;</span>clone+57<span class="token operator">></span>    xor    ebp, ebp
   0x7ffff7d88d8b <span class="token operator">&lt;</span>clone+59<span class="token operator">></span>    pop    rax
   0x7ffff7d88d8c <span class="token operator">&lt;</span>clone+60<span class="token operator">></span>    pop    rdi
   0x7ffff7d88d8d <span class="token operator">&lt;</span>clone+61<span class="token operator">></span>    call   rax
──────────────────────────────────────────────────<span class="token punctuation">[</span> SOURCE <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>─────────────────────────
In file: /mnt/hgfs/QSec/Code-Audit/glibc/glibc-2.31/sysdeps/unix/sysv/linux/x86_64/clone.S
   74      wrong.  */
   75   cfi_endproc<span class="token punctuation">;</span>
   76   syscall
   77 
   78   testq   %rax,%rax
 ► 79   jl      SYSCALL_ERROR_LABEL
   80   jz      L<span class="token punctuation">(</span>thread_start<span class="token punctuation">)</span>
   81 
   82   ret
   83 
   84 L<span class="token punctuation">(</span>thread_start<span class="token punctuation">)</span>:
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>clone函数作用，创建子进程：克隆父进程</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218025705141.png" alt="image-20201218025705141"></p>
<p>接着clone函数内部会调用<code>__spawni_child()</code>函数，将克隆的子进程给真正起起来</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218021711315.png" alt="image-20201218021711315"></p>
<p>单步汇编步入<code>__spawni_child</code>函数实现</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218021834010.png" alt="image-20201218021834010"></p>
<p><code>__spawni_child</code>函数内部会动态调用<code>execve()</code>函数，最终来将子进程给启动起来</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218022045868.png" alt="image-20201218022045868"></p>
<p>步入<code>execve()</code>函数的实现：函数实现为汇编代码<code>sysdeps/unix/syscall-template.S</code>。<code>execve()</code>函数为系统调用函数，内核入口为<code>sys_execve()</code>，系统调用号为<code>0x3b</code></p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218022242241.png" alt="image-20201218022242241"></p>
<p>这里如果继续单步汇编步入，就会导致执行<code>execve()</code>函数系统调用，成功创建子进程，同时GDB调试就会完成，输出程序的执行结果。因为，这里并没有捕捉创建子进程这一事件，无法对创建的子进程进行调试，从而导致程序的执行完毕。</p>
<p>为了避免这一结果发生，我们可以在<code>execve()</code>函数系统调用前，设置捕捉点用来补捉程序运行时的一些事件：这里捕捉系统调用事件<code>execve</code></p>
<pre class="line-numbers language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> catch syscall execve<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>捕捉点设置完毕后，就可以步入执行<code>execve()</code>函数系统调用，查看此时的所有进程的栈调用情况</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218024508562.png" alt="image-20201218024508562"></p>
<p>执行<code>execve()</code>函数系统调用：成功创建子进程<code>/bin/sh-&gt;/bin/dash</code></p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218030328262.png" alt="image-20201218030328262"></p>
<p>此时GDB调试已进入<code>/bin/sh</code>进程中</p>
<p><img src="/2020/12/01/command-execution-research-php/image-20201218030555535.png" alt="image-20201218030555535"></p>
<p>后续工作执行未执行完的<code>sh -c Command</code>，在<code>/bin/sh</code>进程中执行<code>Command</code>指令（内部|外部），外部指令则会在<code>/bin/sh</code>进程下启动相应的子进程。</p>
<p>最后，这里也可以通过Linux下<code>strace</code>工具来追踪PHP命令执行函数的底层调用执行情况：</p>
<ul>
<li>PHP命令执行函数底层系统调用函数统计</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">└─<span class="token comment" spellcheck="true"># strace -f -c ./php -r "system('whoami');"      </span>
strace: Process 48432 attached
strace: Process 48433 attached
root
% <span class="token function">time</span>     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
  0.00    0.000000           0        14           <span class="token function">read</span>
  0.00    0.000000           0         2           <span class="token function">write</span>
  0.00    0.000000           0        23           close
  0.00    0.000000           0         7         4 <span class="token function">stat</span>
  0.00    0.000000           0        24           fstat
  0.00    0.000000           0        10           lstat
  0.00    0.000000           0         5         3 lseek
  0.00    0.000000           0        49           mmap
  0.00    0.000000           0        17           mprotect
  0.00    0.000000           0        12           munmap
  0.00    0.000000           0        14           brk
  0.00    0.000000           0       206           rt_sigaction
  0.00    0.000000           0         5           rt_sigprocmask
  0.00    0.000000           0         1           rt_sigreturn
  0.00    0.000000           0         4         3 access
  0.00    0.000000           0         1           madvise
  0.00    0.000000           0         1           dup2
  0.00    0.000000           0         1           getpid
  0.00    0.000000           0         2           socket
  0.00    0.000000           0         2         2 connect
  0.00    0.000000           0         2           clone
  0.00    0.000000           0         3           execve
  0.00    0.000000           0         2           wait4
  0.00    0.000000           0         1           fcntl
  0.00    0.000000           0         2           getcwd
  0.00    0.000000           0         1           getuid
  0.00    0.000000           0         1           getgid
  0.00    0.000000           0         3           geteuid
  0.00    0.000000           0         1           getegid
  0.00    0.000000           0         1           getppid
  0.00    0.000000           0         3           arch_prctl
  0.00    0.000000           0        20         4 openat
  0.00    0.000000           0         1           pipe2
  0.00    0.000000           0         3           prlimit64
------ ----------- ----------- --------- --------- ----------------
100.00    0.000000                   444        16 total

└─<span class="token comment" spellcheck="true">#  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>PHP命令执行函数底层创建进程情况</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">└─<span class="token comment" spellcheck="true"># strace -f -e execve php -r "system('whoami');"</span>
execve<span class="token punctuation">(</span><span class="token string">"/usr/bin/php"</span>, <span class="token punctuation">[</span><span class="token string">"php"</span>, <span class="token string">"-r"</span>, <span class="token string">"system('whoami');"</span><span class="token punctuation">]</span>, 0x7ffe259e22c8 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> 0
strace: Process 48440 attached
<span class="token punctuation">[</span>pid 48440<span class="token punctuation">]</span> execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, <span class="token punctuation">[</span><span class="token string">"sh"</span>, <span class="token string">"-c"</span>, <span class="token string">"whoami"</span><span class="token punctuation">]</span>, 0x56260233beb0 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> 0
strace: Process 48441 attached
<span class="token punctuation">[</span>pid 48441<span class="token punctuation">]</span> execve<span class="token punctuation">(</span><span class="token string">"/usr/bin/whoami"</span>, <span class="token punctuation">[</span><span class="token string">"whoami"</span><span class="token punctuation">]</span>, 0x563b845c2ed8 /* 53 vars */<span class="token punctuation">)</span> <span class="token operator">=</span> 0
root
<span class="token punctuation">[</span>pid 48441<span class="token punctuation">]</span> +++ exited with 0 +++
<span class="token punctuation">[</span>pid 48440<span class="token punctuation">]</span> --- SIGCHLD <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGCHLD, si_code<span class="token operator">=</span>CLD_EXITED, si_pid<span class="token operator">=</span>48441, si_uid<span class="token operator">=</span>0, si_status<span class="token operator">=</span>0, si_utime<span class="token operator">=</span>0, si_stime<span class="token operator">=</span>0<span class="token punctuation">}</span> ---
<span class="token punctuation">[</span>pid 48440<span class="token punctuation">]</span> +++ exited with 0 +++
--- SIGCHLD <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGCHLD, si_code<span class="token operator">=</span>CLD_EXITED, si_pid<span class="token operator">=</span>48440, si_uid<span class="token operator">=</span>0, si_status<span class="token operator">=</span>0, si_utime<span class="token operator">=</span>0, si_stime<span class="token operator">=</span>0<span class="token punctuation">}</span> ---
+++ exited with 0 +++<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="总-结"><a href="#总-结" class="headerlink" title="总 结"></a>总 结</h1><p>这篇文章主要是讲述不同平台下PHP语言命令执行函数的底层实现与分析。而有关其它语言(Python、Java等)这里不在讲述分析，因为针对不同语言的分析思路都是一样的，归结到系统底层调用：大差不差（PHP和Python底层调用原理类似；Java与PHP和Python相比，少了一步系统可执行终端调用）。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a href="https://wiki.php.net/internals/windows/stepbystepbuild_sdk_2" target="_blank" rel="noopener">Build your own PHP on Windows</a></li>
<li><a href="https://visualstudio.microsoft.com/zh-hans/vs/" target="_blank" rel="noopener">Visual Studio docs</a></li>
<li><a href="https://code.visualstudio.com/docs" target="_blank" rel="noopener">Visual Studio Code docs</a></li>
<li><a href="https://item.jd.com/28435383700.html" target="_blank" rel="noopener">《PHP 7底层设计与源码实现+PHP7内核剖析》</a></li>
<li><a href="https://www.bookstack.cn/books/php-internals" target="_blank" rel="noopener">深入理解 PHP 内核</a></li>
<li><a href="https://www.jianshu.com/p/29bc0443b586" target="_blank" rel="noopener">WINDOWS下用VSCODE调试PHP7源代码</a></li>
<li><a href="https://gywbd.github.io/posts/2016/2/debug-php-source-code.html" target="_blank" rel="noopener">调式PHP源码</a></li>
<li><a href="https://blog.csdn.net/Dont_talk/article/details/107719466" target="_blank" rel="noopener">用vscode调试php源码</a></li>
<li><a href="http://www.gnu.org/software/gdb" target="_blank" rel="noopener">GDB: The GNU Project Debugger</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw" target="_blank" rel="noopener">CreateProcessW function</a></li>
<li><a href="https://xz.aliyun.com/t/6542" target="_blank" rel="noopener">命令注入成因小谈</a></li>
<li><a href="https://paper.seebug.org/papers/old_sebug_paper/pst_WebZine/pst_WebZine_0x05/0x07_%E6%B5%85%E8%B0%88%E4%BB%8EPHP%E5%86%85%E6%A0%B8%E5%B1%82%E9%9D%A2%E9%98%B2%E8%8C%83PHP_WebShell.html" target="_blank" rel="noopener">浅谈从PHP内核层面防范PHP WebShell</a></li>
<li><a href="https://www.php.net/manual/en/ref.exec.php" target="_blank" rel="noopener">Program execution Functions</a></li>
<li><a href="http://huhaipeng.top/2019/04/20/linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" target="_blank" rel="noopener">linux系统调用</a></li>
<li><a href="https://fedora.juszkiewicz.com.pl/syscalls.html" target="_blank" rel="noopener">system calls</a></li>
</ul>
<pre><code>文章首发于安全客：
https://www.anquanke.com/post/id/226292
https://www.anquanke.com/post/id/226293
https://www.anquanke.com/post/id/226294
https://www.anquanke.com/post/id/226295</code></pre>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Qftm</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://Qftm.github.io/2020/12/01/command-execution-research-php/">http://Qftm.github.io/2020/12/01/command-execution-research-php/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Qftm</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/PHP/">
                                    <span class="chip bg-color">PHP</span>
                                </a>
                            
                                <a href="/tags/%E5%86%85%E6%A0%B8/">
                                    <span class="chip bg-color">内核</span>
                                </a>
                            
                                <a href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">
                                    <span class="chip bg-color">命令执行</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/08/15/Kubernetes-Security/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/Kubernetes.jfif" class="responsive-img" alt="云原生安全-Kubernetes Security">
                        
                        <span class="card-title">云原生安全-Kubernetes Security</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Kubernetes Learning (Core Architecture、Components)、Security (Attack Kube、Kubelet、Etcd、Kube-proxy、Docker)
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%BA%91%E5%AE%89%E5%85%A8/" class="post-category">
                                    云安全
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Cloud/">
                        <span class="chip bg-color">Cloud</span>
                    </a>
                    
                    <a href="/tags/Kubernetes/">
                        <span class="chip bg-color">Kubernetes</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/webmin-1.jpg" class="responsive-img" alt="CVE-2019-15107 Webmin RCE 后门深入分析">
                        
                        <span class="card-title">CVE-2019-15107 Webmin RCE 后门深入分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            最近，有关webmin CVE-2019-15107，看了网上几篇分析文章，发现有些文章并没有把该有的细节讲清楚，比如：chybeta师傅分析的文章中root用户可以直接利用攻击，这里并没有说明白：如果系统用户（root等）被加入到webm
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-10-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="post-category">
                                    代码审计
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Webmin/">
                        <span class="chip bg-color">Webmin</span>
                    </a>
                    
                    <a href="/tags/Perl/">
                        <span class="chip bg-color">Perl</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Qftm<br />'
            + 'Author: Qftm<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2018</span>
            <a href="/about" target="_blank">Qftm</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">370.8k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/Qftm" 
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:Qftmbin@gmail.com" 
        <i class="fas fa-envelope-open"></i>
    </a>





    <a href="https://twitter.com/Qftmer" 
        <i class="fab fa-twitter"></i>
    </a>









</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
